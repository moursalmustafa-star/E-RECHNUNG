<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Rechnung (Business Ready)</title>

  <!-- PDF libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --blue:#0b5fa8; --blue2:#0a4d86; --bg:#f2f5f9; --card:#fff; --ink:#0b1220;
      --muted:#6b7a90; --line:#d7e0ea; --ok:#21d19f; --bad:#ff4d6d; --r:16px;
      --shadow:0 12px 34px rgba(0,0,0,.12);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--sans)}
    .topbar{position:sticky;top:0;z-index:5;background:linear-gradient(90deg,var(--blue2),var(--blue));color:#fff;padding:14px 16px;box-shadow:var(--shadow)}
    .topbar .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;min-width:260px}
    .logo{width:42px;height:42px;border-radius:12px;background:rgba(255,255,255,.14);display:grid;place-items:center;overflow:hidden;border:1px solid rgba(255,255,255,.22)}
    .logo img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:800;line-height:1.1}
    .subtitle{font-size:12px;opacity:.85}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
    button{border:0;border-radius:999px;padding:10px 12px;font-weight:700;cursor:pointer;background:rgba(255,255,255,.14);color:#fff;border:1px solid rgba(255,255,255,.22);backdrop-filter: blur(6px)}
    button:hover{filter:brightness(1.05)}
    button.primary{background:#fff;color:var(--blue2);border-color:#fff}
    button.ghost{background:transparent}
    button.danger{background:rgba(255,77,109,.20);border-color:rgba(255,77,109,.35)}
    button.ok{background:rgba(33,209,159,.18);border-color:rgba(33,209,159,.35)}
    .wrap{max-width:1200px;margin:18px auto;padding:0 14px 50px}
    .grid{display:grid;gap:14px}
    @media (min-width:980px){.grid{grid-template-columns:1.2fr .9fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .card h2{margin:0;padding:14px 16px;font-size:14px;letter-spacing:.2px;background:linear-gradient(180deg,#fff,#f7fafc);border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card .body{padding:14px 16px}
    .row2{display:grid;gap:10px}
    @media (min-width:720px){.row2{grid-template-columns:1fr 1fr}}
    .row3{display:grid;gap:10px}
    @media (min-width:720px){.row3{grid-template-columns:1fr 1fr 1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    input,select,textarea{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 10px;font:inherit;background:#fff;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#9cc7ef;box-shadow:0 0 0 4px rgba(11,95,168,.12)}
    textarea{min-height:90px;resize:vertical}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted)}
    .kpi{display:grid;gap:10px}
    @media (min-width:720px){.kpi{grid-template-columns:1fr 1fr}}
    .kpi .box{border:1px dashed var(--line);border-radius:14px;padding:12px;background:linear-gradient(180deg,#fff,#fbfdff)}
    .kpi .big{font-size:22px;font-weight:900}
    .kpi .small{font-size:12px;color:var(--muted)}
    .table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .table th,.table td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:13px}
    .table th{background:#f7fafc;text-align:left;color:#223;font-weight:800}
    .table tr:last-child td{border-bottom:0}
    .right{text-align:right}
    .mono{font-family:var(--mono)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .note{font-size:12px;color:var(--muted);background:#fbfdff;border:1px solid var(--line);border-radius:14px;padding:10px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--ok)}
    .list{display:grid;gap:10px}
    .item{border:1px solid var(--line);border-radius:14px;padding:10px;display:flex;gap:10px;align-items:flex-start;justify-content:space-between;background:#fff}
    .item b{display:block}
    .item small{color:var(--muted)}
    .item .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .item .btns button{color:var(--blue2);background:#fff;border:1px solid var(--line)}
    .item .btns button.danger{color:#b90d2a;border-color:rgba(255,77,109,.55)}
    .footerbar{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .brandSub{margin-top:10px;font-size:12px;color:rgba(255,255,255,.9);opacity:.95;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .linkbtn{padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.12);color:#fff;cursor:pointer;font-weight:800}

    /* Printable area */
    #printArea{background:#fff;color:#111;padding:18px;width:210mm;min-height:297mm;margin:0 auto}
    @media print{body{background:#fff}.topbar,.wrap{display:none!important}#printArea{display:block!important;box-shadow:none;border:none}}
    #printAreaWrap{display:none}
    .mini{font-size:11px;color:#444}
    .invHeader{display:flex;justify-content:space-between;gap:16px}
    .invHeader .left{display:flex;gap:12px;align-items:center}
    .invLogo{width:52px;height:52px;border-radius:14px;overflow:hidden;border:1px solid #e5e8ef}
    .invLogo img{width:100%;height:100%;object-fit:cover}
    .invTitle{font-size:22px;font-weight:900;margin:0}
    .invMeta{font-size:12px;color:#333}
    .invGrid2{display:grid;gap:10px}
    @media (min-width:900px){.invGrid2{grid-template-columns:1fr 1fr}}
    .invBox{border:1px solid #e5e8ef;border-radius:14px;padding:12px}
    .invBox h4{margin:0 0 8px;font-size:12px;color:#222}
    .invBox .line{display:flex;justify-content:space-between;gap:10px;font-size:12px;margin:4px 0}
    .invTable{width:100%;border-collapse:collapse;margin-top:10px}
    .invTable th,.invTable td{border:1px solid #e5e8ef;padding:8px;font-size:12px}
    .invTable th{background:#f5f7fb;text-align:left}
    .invRight{text-align:right}
    .invTotals{display:grid;gap:8px;margin-top:10px}
    .invTotals .tline{display:flex;justify-content:space-between;font-size:12px}
    .invTotals .grand{font-size:14px;font-weight:900}
    .invFooter{margin-top:14px;font-size:11px;color:#333}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="row">
      <div class="brand">
        <div class="logo" title="Logo (fest gespeichert)">
          <img id="logoImg" alt="Logo"/>
        </div>
        <div>
          <div class="title">Masculine Security — Rechnung</div>
          <div class="subtitle">Business Ready • Hybrid Zuschläge (%/Festpreis) • Auto Tag/Nacht • PDF/Print • Kunden/Rechnungen speichern</div>
        </div>
      </div>

      <div class="actions">
        <button class="ghost" id="btnLogo" type="button">Logo ändern</button>
        <button class="ghost" id="btnNew" type="button">Neu</button>
        <button class="ok" id="btnSave" type="button">Rechnung speichern</button>
        <button class="ghost" id="btnList" type="button">Rechnungen</button>
        <button class="danger" id="btnReset" type="button">Reset</button>
        <button class="primary" id="btnPdf" type="button">PDF speichern</button>
        <button class="primary" id="btnPrint" type="button">Print</button>
      </div>
    </div>

    <div class="brandSub">
      Tel:
      <button class="linkbtn" id="btnCall" type="button">015778697052</button>
      • E-Mail:
      <button class="linkbtn" id="btnMail" type="button">Kontakt.mass.bremen@hotmail.com</button>
      <span class="badge"><span class="dot"></span> Auto-Save aktiviert</span>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <!-- LEFT -->
      <div class="card">
        <h2>
          <span>Rechnungsdaten</span>
          <span class="pill mono" id="liveStatus">Bereit</span>
        </h2>
        <div class="body">

          <!-- Firmenname/Brand + Adresse -->
          <div class="row2">
            <div>
              <label>Firmenname / Brand *</label>
              <input id="issuerCompany" value="Masculine Security"/>
            </div>
            <div>
              <label>Adresse *</label>
              <input id="issuerAddress" value="Werschenregerstraße 6 • 28237 Bremen" />
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Telefon</label>
              <input id="issuerPhone" value="015778697052" />
            </div>
            <div>
              <label>E-Mail *</label>
              <input id="issuerEmail" value="Kontakt.mass.bremen@hotmail.com" />
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Steuernummer / Hinweis *</label>
              <input id="issuerTaxNo" value="wird nachgereicht" />
              <div class="note" style="margin-top:8px">Wenn du noch keine Steuernummer hast: „wird nachgereicht“ ist ok.</div>
            </div>
            <div>
              <label>USt-IdNr (optional)</label>
              <input id="issuerVatId" placeholder="DE123456789" />
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>IBAN *</label>
              <input id="issuerIban" value="DE98 1001 1001 2333 0146 96" />
            </div>
            <div>
              <label>BIC *</label>
              <input id="issuerBic" value="NTSBDEB1XXX" />
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Kontoinhaber *</label>
              <input id="issuerHolder" value="MUSTAFA MURSAL ABDI" />
            </div>
            <div>
              <label>—</label>
              <input disabled value=""/>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row2">
            <div>
              <label>Kunde auswählen</label>
              <select id="customerPick"></select>
              <div class="footerbar">
                <button id="btnSaveCustomer" class="ghost" type="button" style="color:var(--blue2);background:#fff;border:1px solid var(--line)">Kunde speichern</button>
                <button id="btnDeleteCustomer" class="danger" type="button" style="color:#b90d2a;background:#fff;border:1px solid rgba(255,77,109,.55)">Kunde löschen</button>
              </div>
            </div>
            <div>
              <label>Kundenname (zum Speichern) *</label>
              <input id="custName" placeholder="Firma / Name" />
              <div class="row2" style="margin-top:10px">
                <div>
                  <label>E-Mail (optional)</label>
                  <input id="custEmail" placeholder="kunde@email.de" />
                </div>
                <div>
                  <label>Ansprechpartner (optional)</label>
                  <input id="custContact" placeholder="Ansprechpartner" />
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Kundendaten (Adresse / Ansprechpartner) *</label>
            <textarea id="custAddress" placeholder="Straße • PLZ Ort&#10;Ansprechpartner"></textarea>
          </div>

          <div class="hr"></div>

          <div class="row3">
            <div>
              <label>Rechnungsdatum *</label>
              <input id="invDate" type="date"/>
            </div>
            <div>
              <label>Fällig am *</label>
              <input id="dueDate" type="date"/>
              <div class="note" style="margin-top:8px">Standard = +14 Tage (du kannst ändern).</div>
            </div>
            <div>
              <label>Rechnungsnummer *</label>
              <input id="invNo" class="mono" />
              <div class="note" style="margin-top:8px">Auto pro Tag laufend (YYYYMMDD-0001).</div>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>USt-Status *</label>
              <select id="vatMode">
                <option value="kmu">0% (Kleinunternehmer §19)</option>
                <option value="vat19">19% USt</option>
              </select>
              <div class="note" style="margin-top:8px" id="vatHint">Gemäß §19 UStG wird keine Umsatzsteuer berechnet.</div>
            </div>
            <div>
              <label>Leistungsbeschreibung *</label>
              <input id="serviceTitle" value="Sicherheitsdienstleistung – Objektschutz" />
              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Objekt / Ort (optional)</label>
                  <input id="objekt" placeholder="z.B. Baustelle – Bremen" />
                </div>
                <div>
                  <label>Auftragszeitraum (optional)</label>
                  <input id="zeitraum" placeholder="z.B. 08.03.2026 – 09.03.2026" />
                </div>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row2">
            <div>
              <label>Anzahl Mitarbeiter *</label>
              <input id="mitarbeiter" type="number" min="0" value="5"/>
            </div>
            <div>
              <label>Basis-Stundensatz Tag (€) *</label>
              <input id="tagPreis" type="number" min="0" step="0.01" value="23"/>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Berechnungsart Zuschläge *</label>
              <select id="modus">
                <option value="percent">Zuschlag % (auf Tagpreis)</option>
                <option value="fixed">Festpreis (eigener Preis pro Std.)</option>
              </select>
              <div class="note" style="margin-top:8px">Empfehlung: Kunde % → Prozent. Feste Stundensätze → Festpreis.</div>
            </div>
            <div>
              <label>Verwendungszweck (auto)</label>
              <input id="purpose" class="mono" readonly />
              <div class="note" style="margin-top:8px">Kunde kann bei Überweisung so schreiben.</div>
            </div>
          </div>

          <div class="hr"></div>

          <!-- ✅ AUTO TAG/NACHT -->
          <div class="row3">
            <div>
              <label>Schicht Beginn</label>
              <input id="shiftStart" type="time" value="18:00"/>
            </div>
            <div>
              <label>Schicht Ende</label>
              <input id="shiftEnd" type="time" value="06:00"/>
            </div>
            <div>
              <label>Nachtzeit Regel</label>
              <select id="nachtRule">
                <option value="22-06">22:00 – 06:00 (Standard)</option>
                <option value="23-06">23:00 – 06:00</option>
                <option value="20-06">20:00 – 06:00</option>
              </select>
            </div>
          </div>
          <div class="note" style="margin-top:10px">
            Auto-Funktion berechnet <b>Tagstunden</b> und <b>Nachtstunden</b> aus Beginn/Ende. Sonntag/Feiertag trägst du weiterhin separat ein.
          </div>

          <div class="hr"></div>

          <!-- Hours -->
          <div class="row3">
            <div>
              <label>Tagstunden</label>
              <input id="tagH" type="number" min="0" step="0.25" value="0"/>
            </div>
            <div>
              <label>Nachtstunden</label>
              <input id="nachtH" type="number" min="0" step="0.25" value="0"/>
            </div>
            <div>
              <label>Sonntagstunden</label>
              <input id="sonntagH" type="number" min="0" step="0.25" value="0"/>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Feiertagstunden</label>
              <input id="feiertagH" type="number" min="0" step="0.25" value="0"/>
              <div class="note" style="margin-top:8px">Keine Doppelzählung: Stunden nur in <b>eine</b> Kategorie eintragen.</div>
            </div>
            <div>
              <label>Hinweis / Notiz (optional)</label>
              <textarea id="note" placeholder="z.B. laut Vereinbarung / Einsatzzeiten / Ansprechpartner..."></textarea>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row3">
            <div id="percentBox">
              <label>Nachtzuschlag (%)</label>
              <input id="nachtPercent" type="number" min="0" step="0.01" value="0"/>
              <label style="margin-top:10px">Sonntag (%)</label>
              <input id="sonntagPercent" type="number" min="0" step="0.01" value="50"/>
              <label style="margin-top:10px">Feiertag (%)</label>
              <input id="feiertagPercent" type="number" min="0" step="0.01" value="100"/>
            </div>

            <div id="fixedBox" style="display:none">
              <label>Festpreis Nacht (€)</label>
              <input id="nachtFest" type="number" min="0" step="0.01" value="24"/>
              <label style="margin-top:10px">Festpreis Sonntag (€)</label>
              <input id="sonntagFest" type="number" min="0" step="0.01" value="30"/>
              <label style="margin-top:10px">Festpreis Feiertag (€)</label>
              <input id="feiertagFest" type="number" min="0" step="0.01" value="36"/>
            </div>

            <div>
              <label>Rechnung Text (auto)</label>
              <textarea id="rechnungText"></textarea>
              <div class="note" style="margin-top:8px">Text wird automatisch aktualisiert (du kannst trotzdem manuell ändern).</div>
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT -->
      <div class="grid" style="grid-template-columns:1fr;gap:14px">
        <div class="card">
          <h2>
            <span>Berechnung & Summe</span>
            <span class="pill mono" id="modeBadge">MODE: %</span>
          </h2>
          <div class="body">
            <div class="kpi">
              <div class="box">
                <div class="small">Zwischensumme (netto)</div>
                <div class="big mono" id="subTotal">0,00 €</div>
              </div>
              <div class="box">
                <div class="small">Gesamt (brutto)</div>
                <div class="big mono" id="grandTotal">0,00 €</div>
              </div>
            </div>

            <div class="hr"></div>

            <table class="table">
              <thead>
                <tr>
                  <th>Position</th>
                  <th class="right">Std.</th>
                  <th class="right">Preis/Std.</th>
                  <th class="right">Summe</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Tagdienst</td>
                  <td class="right mono" id="t_tagStd">0</td>
                  <td class="right mono" id="t_tagPreis">0,00 €</td>
                  <td class="right mono" id="t_tagSum">0,00 €</td>
                </tr>
                <tr>
                  <td>Nachtdienst</td>
                  <td class="right mono" id="t_nachtStd">0</td>
                  <td class="right mono" id="t_nachtPreis">0,00 €</td>
                  <td class="right mono" id="t_nachtSum">0,00 €</td>
                </tr>
                <tr>
                  <td>Sonntag</td>
                  <td class="right mono" id="t_sonntagStd">0</td>
                  <td class="right mono" id="t_sonntagPreis">0,00 €</td>
                  <td class="right mono" id="t_sonntagSum">0,00 €</td>
                </tr>
                <tr>
                  <td>Feiertag</td>
                  <td class="right mono" id="t_feiertagStd">0</td>
                  <td class="right mono" id="t_feiertagPreis">0,00 €</td>
                  <td class="right mono" id="t_feiertagSum">0,00 €</td>
                </tr>
              </tbody>
            </table>

            <div class="hr"></div>

            <div class="note">
              <b>Wichtig:</b> Mitarbeiter werden automatisch multipliziert:
              <span class="mono">(Mitarbeiter × Stunden × Preis)</span>.
            </div>
          </div>
        </div>

        <div class="card" id="listCard" style="display:none">
          <h2>
            <span>Gespeicherte Rechnungen</span>
            <span class="pill mono" id="invCount">0</span>
          </h2>
          <div class="body">
            <div class="list" id="invList"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- PRINT/PDF AREA -->
  <div id="printAreaWrap"><div id="printArea"></div></div>

  <!-- FEST LOGO upload -->
  <input id="logoFile" type="file" accept="image/*" style="display:none"/>

  <script>
    // ===== Storage Keys =====
    const KEY_APP = "ms_rechnung_app_v2";      // bumped version
    const KEY_CUSTOMERS = "ms_customers_v1";
    const KEY_INVOICES = "ms_invoices_v1";
    const KEY_COUNTERS = "ms_inv_counters_v1";
    const KEY_LOGO = "ms_logo_v1";            // FEST LOGO

    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const fmtEUR = (n)=>{
      const v = Number(n||0);
      return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}) + " €";
    };
    const todayISO = ()=>{
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const addDaysISO = (iso, days)=>{
      const d = new Date(iso+"T00:00:00");
      d.setDate(d.getDate()+days);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const yyyymmdd = (iso)=> iso.replaceAll("-","");
    const safeNum = (v)=> {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };
    const setStatus = (txt, ok=true)=>{
      $("liveStatus").textContent = txt;
      $("liveStatus").style.borderColor = ok ? "rgba(33,209,159,.35)" : "rgba(255,77,109,.45)";
      $("liveStatus").style.color = ok ? "var(--muted)" : "#b90d2a";
    };

    const loadJSON = (k, fallback)=>{
      try{ const v = localStorage.getItem(k); return v? JSON.parse(v) : fallback; }catch(e){ return fallback; }
    };
    const saveJSON = (k, v)=> localStorage.setItem(k, JSON.stringify(v));

    // ===== FEST LOGO =====
    function setLogo(dataUrl, persist=true){
      $("logoImg").src = dataUrl;
      if(persist) localStorage.setItem(KEY_LOGO, dataUrl);
    }
    function loadLogo(){
      const saved = localStorage.getItem(KEY_LOGO);
      if(saved){
        setLogo(saved, false);
      }else{
        const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="120" height="120" rx="24" fill="#0b5fa8"/><text x="60" y="72" font-size="54" text-anchor="middle" fill="white" font-family="Arial" font-weight="900">M</text></svg>`);
        setLogo(`data:image/svg+xml,${svg}`, false);
      }
    }

    // ===== Invoice number =====
    function nextInvoiceNo(invDateISO){
      const counters = loadJSON(KEY_COUNTERS, {});
      const d = yyyymmdd(invDateISO || todayISO());
      const cur = safeNum(counters[d]) || 0;
      const next = cur + 1;
      counters[d] = next;
      saveJSON(KEY_COUNTERS, counters);
      return `MS-${d}-${String(next).padStart(4,"0")}`;
    }

    function updateVatHint(){
      $("vatHint").textContent = ($("vatMode").value==="kmu")
        ? "Gemäß §19 UStG wird keine Umsatzsteuer berechnet."
        : "Umsatzsteuer 19% wird berechnet und ausgewiesen.";
    }

    function updatePurpose(){
      const no = $("invNo").value || "";
      $("purpose").value = `Rechnung: ${no}`;
    }

    function toggleModeUI(){
      const m = $("modus").value;
      $("percentBox").style.display = (m==="percent") ? "" : "none";
      $("fixedBox").style.display = (m==="fixed") ? "" : "none";
      $("modeBadge").textContent = (m==="percent") ? "MODE: %" : "MODE: FEST";
    }

    function validateCore(){
      const must = [
        ["issuerCompany","Firmenname"],
        ["issuerAddress","Adresse"],
        ["issuerEmail","E-Mail"],
        ["issuerTaxNo","Steuernummer/Hinweis"],
        ["issuerIban","IBAN"],
        ["issuerBic","BIC"],
        ["issuerHolder","Kontoinhaber"],
        ["custName","Kundenname"],
        ["custAddress","Kundendaten"],
        ["invDate","Rechnungsdatum"],
        ["dueDate","Fällig am"],
        ["invNo","Rechnungsnummer"],
        ["serviceTitle","Leistungsbeschreibung"]
      ];
      for(const [id,label] of must){
        if(!String($(id).value||"").trim()){
          setStatus(`Fehlt: ${label}`, false);
          return false;
        }
      }
      setStatus("OK", true);
      return true;
    }

    // ===== AUTO Tag/Nacht calculation =====
    function parseTimeToMinutes(t){
      if(!t) return null;
      const [h,m] = t.split(":").map(Number);
      if(!Number.isFinite(h) || !Number.isFinite(m)) return null;
      return h*60 + m;
    }
    function getNightWindow(){
      const rule = $("nachtRule").value;
      if(rule==="23-06") return {start: 23*60, end: 30*60}; // 06 next day
      if(rule==="20-06") return {start: 20*60, end: 30*60};
      return {start: 22*60, end: 30*60}; // default 22-06
    }
    function calculateDayNight(){
      const start = parseTimeToMinutes($("shiftStart").value);
      const endRaw = parseTimeToMinutes($("shiftEnd").value);
      if(start===null || endRaw===null) return;

      let end = endRaw;
      if(end <= start) end += 1440; // pass midnight

      const totalMin = end - start;
      if(totalMin < 0) return;

      const {start: nightStart, end: nightEnd} = getNightWindow();

      // count night minutes by iterating minute by minute (simple & reliable)
      let nightMin = 0;
      for(let i=start;i<end;i++){
        const mod = i % 1440;
        const isNight = (mod >= nightStart) || (mod < (nightEnd % 1440)); // nightEnd%1440 = 360
        if(isNight) nightMin++;
      }

      const nightH = nightMin / 60;
      const dayH = (totalMin/60) - nightH;

      // write hours (keep 2 decimals)
      $("tagH").value = Math.max(0, dayH).toFixed(2);
      $("nachtH").value = Math.max(0, nightH).toFixed(2);
    }

    function calculate(){
      toggleModeUI();
      updateVatHint();
      updatePurpose();

      const m = safeNum($("mitarbeiter").value);
      const tagPreis = safeNum($("tagPreis").value);

      const tagH = safeNum($("tagH").value);
      const nachtH = safeNum($("nachtH").value);
      const sonntagH = safeNum($("sonntagH").value);
      const feiertagH = safeNum($("feiertagH").value);

      const mode = $("modus").value;

      let nachtPreisFinal = 0, sonntagPreisFinal = 0, feiertagPreisFinal = 0;
      if(mode==="percent"){
        const nachtP = safeNum($("nachtPercent").value);
        const sonntagP = safeNum($("sonntagPercent").value);
        const feiertagP = safeNum($("feiertagPercent").value);
        nachtPreisFinal = tagPreis + (tagPreis * nachtP/100);
        sonntagPreisFinal = tagPreis + (tagPreis * sonntagP/100);
        feiertagPreisFinal = tagPreis + (tagPreis * feiertagP/100);
      }else{
        nachtPreisFinal = safeNum($("nachtFest").value);
        sonntagPreisFinal = safeNum($("sonntagFest").value);
        feiertagPreisFinal = safeNum($("feiertagFest").value);
      }

      const tagSum = m * tagH * tagPreis;
      const nachtSum = m * nachtH * nachtPreisFinal;
      const sonntagSum = m * sonntagH * sonntagPreisFinal;
      const feiertagSum = m * feiertagH * feiertagPreisFinal;

      const subTotal = tagSum + nachtSum + sonntagSum + feiertagSum;

      const vatMode = $("vatMode").value;
      const vatRate = (vatMode==="vat19") ? 0.19 : 0;
      const vatAmount = subTotal * vatRate;
      const grandTotal = subTotal + vatAmount;

      $("t_tagStd").textContent = String(tagH);
      $("t_nachtStd").textContent = String(nachtH);
      $("t_sonntagStd").textContent = String(sonntagH);
      $("t_feiertagStd").textContent = String(feiertagH);

      $("t_tagPreis").textContent = fmtEUR(tagPreis);
      $("t_nachtPreis").textContent = fmtEUR(nachtPreisFinal);
      $("t_sonntagPreis").textContent = fmtEUR(sonntagPreisFinal);
      $("t_feiertagPreis").textContent = fmtEUR(feiertagPreisFinal);

      $("t_tagSum").textContent = fmtEUR(tagSum);
      $("t_nachtSum").textContent = fmtEUR(nachtSum);
      $("t_sonntagSum").textContent = fmtEUR(sonntagSum);
      $("t_feiertagSum").textContent = fmtEUR(feiertagSum);

      $("subTotal").textContent = fmtEUR(subTotal);
      $("grandTotal").textContent = fmtEUR(grandTotal);

      // Rechnung text
      const obj = String($("objekt").value||"").trim();
      const zr = String($("zeitraum").value||"").trim();
      const note = String($("note").value||"").trim();
      const company = String($("issuerCompany").value||"Masculine Security").trim();

      const nightRuleText = $("nachtRule").value.replace("-", ":00 – ").replace("06", "06:00");
      const modeLine = (mode==="percent")
        ? `Zuschläge gemäß Prozent (auf Tagpreis ${fmtEUR(tagPreis)}).`
        : `Stundensätze laut Vereinbarung (Festpreise).`;

      const vatLine = (vatMode==="kmu")
        ? `Gemäß §19 UStG wird keine Umsatzsteuer berechnet.`
        : `Umsatzsteuer 19%: ${fmtEUR(vatAmount)} (in Gesamtbetrag enthalten).`;

      const extraA = obj ? `Objekt/Ort: ${obj}` : "";
      const extraB = zr ? `Zeitraum: ${zr}` : "";

      $("rechnungText").value = [
        `${$("serviceTitle").value} — Einsatz mit ${m} Mitarbeitern`,
        extraA, extraB,
        "",
        `Tagdienst (${fmtEUR(tagPreis)}/Std)`,
        `${m} Mitarbeiter × ${tagH} Std`,
        "",
        `Nachtdienst (${fmtEUR(nachtPreisFinal)}/Std)`,
        `${m} Mitarbeiter × ${nachtH} Std`,
        "",
        `Sonntag (${fmtEUR(sonntagPreisFinal)}/Std)`,
        `${m} Mitarbeiter × ${sonntagH} Std`,
        "",
        `Feiertag (${fmtEUR(feiertagPreisFinal)}/Std)`,
        `${m} Mitarbeiter × ${feiertagH} Std`,
        "",
        `Zwischensumme (netto): ${fmtEUR(subTotal)}`,
        `${vatLine}`,
        `Gesamtbetrag: ${fmtEUR(grandTotal)}`,
        "",
        modeLine,
        `Nachtzeit laut Vereinbarung: ${$("nachtRule").value==="22-06" ? "22:00 – 06:00" : ($("nachtRule").value==="23-06" ? "23:00 – 06:00" : "20:00 – 06:00")}`,
        "Abrechnung gemäß Einsatzzeiten.",
        note ? `Hinweis: ${note}` : ""
      ].filter(Boolean).join("\n");

      autoSave();
    }

    // ===== Customers =====
    function renderCustomers(){
      const customers = loadJSON(KEY_CUSTOMERS, []);
      const sel = $("customerPick");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "— auswählen —";
      sel.appendChild(opt0);

      for(const c of customers){
        const o = document.createElement("option");
        o.value = c.id;
        o.textContent = c.name;
        sel.appendChild(o);
      }
    }
    function saveCustomer(){
      const name = String($("custName").value||"").trim();
      const address = String($("custAddress").value||"").trim();
      if(!name || !address){ setStatus("Kunde: Name/Adresse fehlt", false); return; }
      const customers = loadJSON(KEY_CUSTOMERS, []);
      const id = cryptoRandomId();
      customers.push({
        id,
        name,
        email: String($("custEmail").value||"").trim(),
        contact: String($("custContact").value||"").trim(),
        address
      });
      saveJSON(KEY_CUSTOMERS, customers);
      renderCustomers();
      $("customerPick").value = id;
      setStatus("Kunde gespeichert", true);
    }
    function loadCustomer(id){
      const customers = loadJSON(KEY_CUSTOMERS, []);
      const c = customers.find(x=>x.id===id);
      if(!c) return;
      $("custName").value = c.name || "";
      $("custEmail").value = c.email || "";
      $("custContact").value = c.contact || "";
      $("custAddress").value = c.address || "";
      setStatus("Kunde geladen", true);
      calculate();
    }
    function deleteCustomer(){
      const id = $("customerPick").value;
      if(!id){ setStatus("Kein Kunde ausgewählt", false); return; }
      const customers = loadJSON(KEY_CUSTOMERS, []).filter(x=>x.id!==id);
      saveJSON(KEY_CUSTOMERS, customers);
      renderCustomers();
      $("customerPick").value = "";
      setStatus("Kunde gelöscht", true);
    }

    // ===== Invoices =====
    function collectInvoice(){
      const fields = [
        "issuerCompany",
        "issuerAddress","issuerPhone","issuerEmail","issuerTaxNo","issuerVatId",
        "issuerIban","issuerBic","issuerHolder",
        "custName","custEmail","custContact","custAddress",
        "invDate","dueDate","invNo","vatMode","serviceTitle","objekt","zeitraum",
        "mitarbeiter","tagPreis","modus","purpose",
        "shiftStart","shiftEnd","nachtRule",
        "tagH","nachtH","sonntagH","feiertagH",
        "nachtPercent","sonntagPercent","feiertagPercent",
        "nachtFest","sonntagFest","feiertagFest",
        "note","rechnungText"
      ];
      const form = {};
      for(const id of fields){ if($(id)) form[id] = $(id).value; }
      return {
        invNo: $("invNo").value,
        invDate: $("invDate").value,
        custName: $("custName").value,
        serviceTitle: $("serviceTitle").value,
        purpose: $("purpose").value,
        subTotalFmt: $("subTotal").textContent,
        grandTotalFmt: $("grandTotal").textContent,
        logoDataUrl: $("logoImg").src || "",
        form
      };
    }

    function saveInvoice(){
      if(!validateCore()) return;
      const inv = collectInvoice();
      const invoices = loadJSON(KEY_INVOICES, []);
      const idx = invoices.findIndex(x=>x.invNo===inv.invNo);
      if(idx>=0) invoices[idx] = inv; else invoices.unshift(inv);
      saveJSON(KEY_INVOICES, invoices);
      setStatus("Rechnung gespeichert", true);
      renderInvoices();
    }

    function renderInvoices(){
      const invoices = loadJSON(KEY_INVOICES, []);
      $("invCount").textContent = String(invoices.length);
      const wrap = $("invList");
      wrap.innerHTML = "";
      for(const inv of invoices){
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <b class="mono">${escapeHtml(inv.invNo)}</b>
            <small>${escapeHtml(inv.invDate)} • ${escapeHtml(inv.custName)} • ${escapeHtml(inv.serviceTitle)}</small><br/>
            <small class="mono">Gesamt: ${escapeHtml(inv.grandTotalFmt)} • Zweck: ${escapeHtml(inv.purpose)}</small>
          </div>
          <div class="btns">
            <button type="button" data-act="load" data-no="${escapeAttr(inv.invNo)}">Laden</button>
            <button type="button" data-act="pdf" data-no="${escapeAttr(inv.invNo)}">PDF</button>
            <button type="button" data-act="del" class="danger" data-no="${escapeAttr(inv.invNo)}">Löschen</button>
          </div>
        `;
        wrap.appendChild(el);
      }
      wrap.querySelectorAll("button").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const act = b.getAttribute("data-act");
          const no = b.getAttribute("data-no");
          if(act==="load") loadInvoice(no);
          if(act==="del") deleteInvoice(no);
          if(act==="pdf") {
            const inv = loadJSON(KEY_INVOICES, []).find(x=>x.invNo===no);
            if(inv){ await exportPdfFromInvoice(inv); }
          }
        });
      });
    }

    function loadInvoice(invNo){
      const invoices = loadJSON(KEY_INVOICES, []);
      const inv = invoices.find(x=>x.invNo===invNo);
      if(!inv){ setStatus("Rechnung nicht gefunden", false); return; }
      for(const [k,v] of Object.entries(inv.form || {})){ if($(k)) $(k).value = v; }
      if(inv.logoDataUrl){ setLogo(inv.logoDataUrl, true); } // keep fest
      setStatus("Rechnung geladen", true);
      calculate();
      showList(false);
    }
    function deleteInvoice(invNo){
      const invoices = loadJSON(KEY_INVOICES, []).filter(x=>x.invNo!==invNo);
      saveJSON(KEY_INVOICES, invoices);
      setStatus("Rechnung gelöscht", true);
      renderInvoices();
    }

    // ===== wait images before PDF/Print =====
    function waitImagesLoaded(root){
      const imgs = Array.from(root.querySelectorAll("img")).filter(i=>i.src);
      return Promise.all(imgs.map(img => new Promise(res=>{
        if(img.complete) return res();
        img.onload = ()=>res();
        img.onerror = ()=>res();
      })));
    }

    // ===== PDF/Print =====
    function buildPrintHtml(inv){
      const f = inv.form;
      const company = String(f.issuerCompany || "Masculine Security").trim();

      const logoSrc = inv.logoDataUrl || $("logoImg").src || "";
      const logo = logoSrc ? `<div class="invLogo"><img src="${escapeAttr(logoSrc)}"/></div>` : "";

      const vatMode = f.vatMode;
      const vatLine = (vatMode==="kmu")
        ? "Gemäß §19 UStG wird keine Umsatzsteuer berechnet."
        : "Umsatzsteuer 19% wird berechnet und ausgewiesen.";

      const mode = f.modus;
      const modeLine = (mode==="percent")
        ? `Zuschläge gemäß Prozent (auf Tagpreis).`
        : `Stundensätze laut Vereinbarung (Festpreise).`;

      const m = safeNum(f.mitarbeiter);
      const tagPreis = safeNum(f.tagPreis);
      const tagH = safeNum(f.tagH);
      const nachtH = safeNum(f.nachtH);
      const sonntagH = safeNum(f.sonntagH);
      const feiertagH = safeNum(f.feiertagH);

      let nachtPreisFinal=0, sonntagPreisFinal=0, feiertagPreisFinal=0;
      if(mode==="percent"){
        const nachtP = safeNum(f.nachtPercent);
        const sonntagP = safeNum(f.sonntagPercent);
        const feiertagP = safeNum(f.feiertagPercent);
        nachtPreisFinal = tagPreis + (tagPreis * nachtP/100);
        sonntagPreisFinal = tagPreis + (tagPreis * sonntagP/100);
        feiertagPreisFinal = tagPreis + (tagPreis * feiertagP/100);
      }else{
        nachtPreisFinal = safeNum(f.nachtFest);
        sonntagPreisFinal = safeNum(f.sonntagFest);
        feiertagPreisFinal = safeNum(f.feiertagFest);
      }

      const tagSum = m * tagH * tagPreis;
      const nachtSum = m * nachtH * nachtPreisFinal;
      const sonntagSum = m * sonntagH * sonntagPreisFinal;
      const feiertagSum = m * feiertagH * feiertagPreisFinal;
      const subTotal = tagSum+nachtSum+sonntagSum+feiertagSum;
      const vatRate = (vatMode==="vat19") ? 0.19 : 0;
      const vatAmount = subTotal*vatRate;
      const grand = subTotal+vatAmount;

      const obj = String(f.objekt||"").trim();
      const zr = String(f.zeitraum||"").trim();
      const note = String(f.note||"").trim();

      const nightText = f.nachtRule==="23-06" ? "23:00 – 06:00" : (f.nachtRule==="20-06" ? "20:00 – 06:00" : "22:00 – 06:00");

      return `
        <div class="invHeader">
          <div class="left">
            ${logo}
            <div>
              <p class="invTitle">Rechnung</p>
              <div class="invMeta"><b>${escapeHtml(company)}</b></div>
              <div class="invMeta"><b>${escapeHtml(f.serviceTitle||"")}</b></div>
              ${obj ? `<div class="invMeta">Objekt/Ort: ${escapeHtml(obj)}</div>` : ``}
              ${zr ? `<div class="invMeta">Zeitraum: ${escapeHtml(zr)}</div>` : ``}
            </div>
          </div>
          <div class="invBox" style="min-width:260px">
            <div class="line"><span><b>Rechnungsnr.</b></span><span class="mono">${escapeHtml(f.invNo||"")}</span></div>
            <div class="line"><span>Datum</span><span>${escapeHtml(f.invDate||"")}</span></div>
            <div class="line"><span>Fällig</span><span>${escapeHtml(f.dueDate||"")}</span></div>
            <div class="line"><span>Zweck</span><span class="mono">${escapeHtml(f.purpose||"")}</span></div>
          </div>
        </div>

        <div class="invGrid2" style="margin-top:12px">
          <div class="invBox">
            <h4>Rechnungssteller</h4>
            <div class="mini"><b>${escapeHtml(company)}</b></div>
            <div class="mini">${escapeHtml(f.issuerAddress||"")}</div>
            <div class="mini">Tel: ${escapeHtml(f.issuerPhone||"")}</div>
            <div class="mini">E-Mail: ${escapeHtml(f.issuerEmail||"")}</div>
            <div class="mini">Steuernr./Hinweis: ${escapeHtml(f.issuerTaxNo||"")}</div>
            ${String(f.issuerVatId||"").trim() ? `<div class="mini">USt-IdNr: ${escapeHtml(f.issuerVatId||"")}</div>` : ``}
          </div>

          <div class="invBox">
            <h4>Rechnung an</h4>
            <div class="mini"><b>${escapeHtml(f.custName||"")}</b></div>
            <div class="mini">${escapeHtml(f.custAddress||"").replaceAll("\n","<br/>")}</div>
            ${String(f.custEmail||"").trim() ? `<div class="mini">E-Mail: ${escapeHtml(f.custEmail||"")}</div>` : ``}
            ${String(f.custContact||"").trim() ? `<div class="mini">Ansprechpartner: ${escapeHtml(f.custContact||"")}</div>` : ``}
          </div>
        </div>

        <div class="invBox" style="margin-top:12px">
          <h4>Leistungsübersicht</h4>
          <div class="mini">Nachtzeit laut Vereinbarung: ${escapeHtml(nightText)}</div>
          <table class="invTable">
            <thead>
              <tr>
                <th>Position</th>
                <th class="invRight">Mitarbeiter</th>
                <th class="invRight">Std.</th>
                <th class="invRight">Preis/Std.</th>
                <th class="invRight">Summe</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Tagdienst</td>
                <td class="invRight">${m}</td>
                <td class="invRight">${tagH}</td>
                <td class="invRight">${fmtEUR(tagPreis)}</td>
                <td class="invRight">${fmtEUR(tagSum)}</td>
              </tr>
              <tr>
                <td>Nachtdienst</td>
                <td class="invRight">${m}</td>
                <td class="invRight">${nachtH}</td>
                <td class="invRight">${fmtEUR(nachtPreisFinal)}</td>
                <td class="invRight">${fmtEUR(nachtSum)}</td>
              </tr>
              <tr>
                <td>Sonntag</td>
                <td class="invRight">${m}</td>
                <td class="invRight">${sonntagH}</td>
                <td class="invRight">${fmtEUR(sonntagPreisFinal)}</td>
                <td class="invRight">${fmtEUR(sonntagSum)}</td>
              </tr>
              <tr>
                <td>Feiertag</td>
                <td class="invRight">${m}</td>
                <td class="invRight">${feiertagH}</td>
                <td class="invRight">${fmtEUR(feiertagPreisFinal)}</td>
                <td class="invRight">${fmtEUR(feiertagSum)}</td>
              </tr>
            </tbody>
          </table>

          <div class="invTotals">
            <div class="tline"><span>Zwischensumme (netto)</span><span>${fmtEUR(subTotal)}</span></div>
            ${vatRate>0 ? `<div class="tline"><span>USt 19%</span><span>${fmtEUR(vatAmount)}</span></div>` : ``}
            <div class="tline grand"><span>Gesamtbetrag</span><span>${fmtEUR(grand)}</span></div>
          </div>

          <div class="invFooter">
            <div>${escapeHtml(vatLine)}</div>
            <div>${escapeHtml(modeLine)} Abrechnung gemäß Einsatzzeiten.</div>
            ${note ? `<div><b>Hinweis:</b> ${escapeHtml(note)}</div>` : ``}
            <div style="margin-top:10px">
              <b>Bankverbindung:</b> IBAN ${escapeHtml(f.issuerIban||"")} • BIC ${escapeHtml(f.issuerBic||"")} • Inhaber ${escapeHtml(f.issuerHolder||"")}
            </div>
          </div>
        </div>
      `;
    }

    async function exportPdf(){
      if(!validateCore()) return;
      const inv = collectInvoice();
      await exportPdfFromInvoice(inv);
    }

    async function exportPdfFromInvoice(inv){
      const printArea = $("printArea");
      printArea.innerHTML = buildPrintHtml(inv);
      $("printAreaWrap").style.display = "block";
      await waitImagesLoaded(printArea);

      const canvas = await html2canvas(printArea, {scale:2, useCORS:true, backgroundColor:"#ffffff"});
      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;

      const pdf = new jsPDF("p","mm","a4");
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const imgProps = pdf.getImageProperties(imgData);
      const imgW = pageW;
      const imgH = (imgProps.height * imgW) / imgProps.width;

      if(imgH <= pageH){
        pdf.addImage(imgData, "PNG", 0, 0, imgW, imgH);
      }else{
        let y = 0;
        let remaining = imgH;
        while(remaining > 0){
          pdf.addImage(imgData, "PNG", 0, y ? -y : 0, imgW, imgH);
          remaining -= pageH;
          if(remaining > 0) pdf.addPage();
          y += pageH;
        }
      }

      pdf.save(`${inv.invNo}.pdf`);
      $("printAreaWrap").style.display = "none";
      setStatus("PDF gespeichert", true);
    }

    async function doPrint(){
      if(!validateCore()) return;
      const inv = collectInvoice();
      $("printArea").innerHTML = buildPrintHtml(inv);
      $("printAreaWrap").style.display = "block";
      await waitImagesLoaded($("printArea"));
      window.print();
      $("printAreaWrap").style.display = "none";
    }

    // ===== Auto Save =====
    let autoSaveTimer = null;
    function autoSave(){
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(()=>{
        const state = collectInvoice().form;
        saveJSON(KEY_APP, state);
      }, 250);
    }
    function restoreAutoSave(){
      const state = loadJSON(KEY_APP, null);
      if(!state) return;
      for(const [k,v] of Object.entries(state)){
        if($(k)) $(k).value = v;
      }
    }

    // ===== UI actions =====
    function showList(show){
      $("listCard").style.display = show ? "" : "none";
      if(show){ renderInvoices(); }
    }
    function resetAll(){
      localStorage.removeItem(KEY_APP);
      location.reload();
    }
    function newInvoice(){
      const keep = [
        "issuerCompany","issuerAddress","issuerPhone","issuerEmail","issuerTaxNo","issuerVatId","issuerIban","issuerBic","issuerHolder",
        "custName","custEmail","custContact","custAddress","customerPick",
        "vatMode","serviceTitle","objekt","zeitraum",
        "mitarbeiter","tagPreis","modus",
        "nachtPercent","sonntagPercent","feiertagPercent",
        "nachtFest","sonntagFest","feiertagFest",
        "nachtRule"
      ];
      const snapshot = {};
      for(const id of keep){ if($(id)) snapshot[id] = $(id).value; }

      document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.id==="logoFile") return;
        if(el.type==="date") return;
        el.value = "";
      });

      for(const [id,val] of Object.entries(snapshot)){ if($(id)) $(id).value = val; }

      $("invDate").value = todayISO();
      $("dueDate").value = addDaysISO($("invDate").value, 14);
      $("invNo").value = nextInvoiceNo($("invDate").value);

      $("shiftStart").value = "18:00";
      $("shiftEnd").value = "06:00";
      calculateDayNight();

      $("sonntagH").value = 0;
      $("feiertagH").value = 0;
      $("note").value = "";
      $("rechnungText").value = "";

      setStatus("Neue Rechnung", true);
      calculate();
    }

    // ===== Security helpers =====
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }
    function cryptoRandomId(){
      if(window.crypto?.getRandomValues){
        const a = new Uint32Array(2);
        window.crypto.getRandomValues(a);
        return a[0].toString(16)+a[1].toString(16);
      }
      return String(Date.now()) + Math.random().toString(16).slice(2);
    }

    // ===== Event wiring =====
    function wire(){
      $("btnCall").addEventListener("click", ()=>{
        const tel = String($("issuerPhone").value || "015778697052").replace(/\s+/g,"");
        window.location.href = `tel:${tel}`;
      });
      $("btnMail").addEventListener("click", ()=>{
        const mail = String($("issuerEmail").value || "Kontakt.mass.bremen@hotmail.com").trim();
        window.location.href = `mailto:${mail}`;
      });

      // FEST LOGO
      $("btnLogo").addEventListener("click", ()=> $("logoFile").click());
      $("logoFile").addEventListener("change", (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        const rd = new FileReader();
        rd.onload = ()=> { setLogo(String(rd.result||""), true); setStatus("Logo gespeichert", true); };
        rd.readAsDataURL(file);
      });

      // actions
      $("btnSave").addEventListener("click", saveInvoice);
      $("btnPdf").addEventListener("click", exportPdf);
      $("btnPrint").addEventListener("click", doPrint);
      $("btnReset").addEventListener("click", resetAll);
      $("btnNew").addEventListener("click", newInvoice);
      $("btnList").addEventListener("click", ()=>{
        const now = $("listCard").style.display==="none";
        showList(now);
      });

      // customers
      $("btnSaveCustomer").addEventListener("click", saveCustomer);
      $("btnDeleteCustomer").addEventListener("click", deleteCustomer);
      $("customerPick").addEventListener("change", (e)=> loadCustomer(e.target.value));

      // date change
      $("invDate").addEventListener("change", ()=>{
        $("dueDate").value = addDaysISO($("invDate").value, 14);
        $("invNo").value = nextInvoiceNo($("invDate").value);
        calculate();
      });

      // mode changes
      $("vatMode").addEventListener("change", calculate);
      $("modus").addEventListener("change", calculate);

      // AUTO day/night
      $("shiftStart").addEventListener("input", ()=>{ calculateDayNight(); calculate(); });
      $("shiftEnd").addEventListener("input", ()=>{ calculateDayNight(); calculate(); });
      $("nachtRule").addEventListener("change", ()=>{ calculateDayNight(); calculate(); });

      // all inputs
      document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.id==="logoFile") return;
        if(el.id==="shiftStart" || el.id==="shiftEnd" || el.id==="nachtRule") return; // handled above
        el.addEventListener("input", calculate);
      });
    }

    function initDefaults(){
      $("invDate").value = $("invDate").value || todayISO();
      $("dueDate").value = $("dueDate").value || addDaysISO($("invDate").value, 14);
      $("invNo").value = $("invNo").value || nextInvoiceNo($("invDate").value);
      updateVatHint();
      updatePurpose();
      renderCustomers();
      toggleModeUI();
      calculateDayNight();
      setStatus("Bereit", true);
    }

    // ===== Boot =====
    window.addEventListener("load", ()=>{
      loadLogo();
      restoreAutoSave();
      wire();
      initDefaults();
      calculate();
      showList(false);
    });
  </script>
</body>
</html>
