<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Rechnung</title>

  <!-- libs (CDN) -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --blue:#0b5fa8;
      --blue2:#0a4d86;
      --bg:#f2f5f9;
      --card:#ffffff;
      --ink:#0b1220;
      --muted:#6b7a90;
      --line:#d7e0ea;
      --ok:#21d19f;
      --warn:#ffce54;
      --bad:#ff4d6d;
      --r:16px;
      --shadow:0 12px 34px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .topbar{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--blue2),var(--blue));
      color:#fff;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.18);
    }
    .topbar .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;min-width:260px}
    .brand .mark{
      width:34px;height:34px;border-radius:10px;background:rgba(255,255,255,.14);
      display:grid;place-items:center;font-weight:800;
      border:1px solid rgba(255,255,255,.18);
      overflow:hidden;
    }
    .brand .mark img{width:100%;height:100%;object-fit:cover;display:block}
    .brand .title{font-weight:800;letter-spacing:.2px}
    .brand .sub{font-size:12px;opacity:.9}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
    button{
      appearance:none;border:0;cursor:pointer;
      padding:9px 12px;border-radius:999px;
      background:rgba(255,255,255,.16);color:#fff;
      border:1px solid rgba(255,255,255,.18);
      font-weight:700;font-size:13px;
    }
    button:hover{background:rgba(255,255,255,.22)}
    button.primary{background:#fff;color:var(--blue2);border-color:#fff}
    button.danger{background:rgba(255,80,110,.20);border-color:rgba(255,80,110,.28)}
    .wrap{max-width:1180px;margin:14px auto;padding:0 14px 26px}
    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);border:1px solid var(--line);
      border-radius:var(--r);box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h3{
      margin:0;padding:12px 14px;background:#fbfcfe;
      border-bottom:1px solid var(--line);
      font-size:14px;letter-spacing:.2px;
      display:flex;align-items:center;justify-content:space-between;
    }
    .pill{
      padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800;
      border:1px solid var(--line);background:#fff;color:var(--muted);
    }
    .pill.ok{border-color:rgba(33,209,159,.4);background:rgba(33,209,159,.10);color:#0b6b52}
    .pill.off{border-color:rgba(255,206,84,.45);background:rgba(255,206,84,.16);color:#7a5a00}
    .content{padding:14px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:540px){.two{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,textarea{
      width:100%;padding:10px 11px;border-radius:12px;
      border:1px solid var(--line);background:#fff;color:var(--ink);
      outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#9cc4ea;box-shadow:0 0 0 3px rgba(11,95,168,.12)}
    textarea{min-height:84px;resize:vertical}
    .rowline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .smallnote{font-size:12px;color:var(--muted);line-height:1.35}
    .hr{height:1px;background:var(--line);margin:12px 0}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:13px}
    th{font-size:12px;color:var(--muted);text-align:left;background:#fbfcfe}
    tr:last-child td{border-bottom:0}
    td.right{text-align:right}
    .sumgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:stretch}
    @media (max-width:720px){.sumgrid{grid-template-columns:1fr}}
    .sumcard{
      border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff
    }
    .sumcard .big{font-size:18px;font-weight:900}
    .footerNote{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      font-size:12px;color:var(--muted);padding-top:10px
    }

    /* PRINT AREA (for PDF capture) */
    #printArea{
      display:none;
      position:fixed;left:-9999px;top:0;
      width:210mm;background:#fff;color:#000;
    }
    .printSheet{
      width:210mm;min-height:297mm;
      padding:14mm 14mm 12mm 14mm;
      font-family:Arial,Helvetica,sans-serif;
    }
    .pHeader{display:flex;gap:10mm;align-items:flex-start;justify-content:space-between}
    .pBrand{display:flex;gap:8mm;align-items:center}
    .pLogo{
      width:20mm;height:20mm;border-radius:6mm;object-fit:cover;border:1px solid #e3e7ee;
      background:#fff;
    }
    .pTitle{font-size:18pt;font-weight:800;margin:0}
    .pMeta{font-size:9.5pt;color:#223}
    .pBox{border:1px solid #e3e7ee;border-radius:4mm;padding:6mm;margin-top:6mm}
    .pGrid{display:grid;grid-template-columns:1fr 1fr;gap:6mm}
    .pH{font-size:9pt;color:#556;font-weight:800;margin:0 0 2mm}
    .pT{font-size:10pt;color:#111;margin:0}
    .pTable{margin-top:6mm;border:1px solid #e3e7ee;border-radius:4mm;overflow:hidden}
    .pTable table{width:100%;border-collapse:collapse}
    .pTable th,.pTable td{border-bottom:1px solid #e3e7ee;padding:3.5mm 3.5mm;font-size:9.8pt}
    .pTable th{background:#f6f8fb;color:#445;font-size:9pt}
    .pTable tr:last-child td{border-bottom:0}
    .pSum{display:grid;grid-template-columns:1fr 1fr;gap:6mm;margin-top:6mm}
    .pSum .pBox{margin-top:0}
    .pFine{font-size:9pt;color:#445;line-height:1.35;margin-top:4mm}
    .pFoot{margin-top:6mm;border-top:1px solid #e3e7ee;padding-top:3mm;font-size:8.8pt;color:#667;display:flex;justify-content:space-between;gap:6mm}
    .muted{color:#667}

    /* toast */
    .toast{
      position:fixed;right:14px;bottom:14px;z-index:99;
      background:#0b1220;color:#fff;border-radius:14px;
      padding:10px 12px;box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.10);
      display:none;max-width:360px;font-size:13px
    }
    .toast.show{display:block}

    /* PRINT ONLY */
    @media print{
      body{background:#fff}
      .topbar,.wrap,.toast{display:none !important}
      #printArea{
        display:block !important;
        position:static !important;
        left:auto !important;
        top:auto !important;
        width:auto !important;
      }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="row">
      <div class="brand">
        <div class="mark" id="mark">
          <img id="topLogo" alt="Logo" style="display:none"/>
          <span id="topLogoFallback">MS</span>
        </div>
        <div>
          <div class="title">Masculine Security — Rechnung</div>
          <div class="sub">Rechnung • Kunden • PDF • gespeichert</div>
        </div>
      </div>

      <div class="actions">
        <button id="btnLogo">Logo ändern</button>
        <button id="btnNew">Neu</button>
        <button class="primary" id="btnSaveInv">Rechnung speichern</button>
        <button id="btnList">Rechnungen</button>
        <button class="danger" id="btnReset">Reset</button>
        <button class="primary" id="btnPdf">PDF speichern</button>
        <!-- ✅ ONLY PRINT button added -->
        <button class="primary" id="btnPrint">Print</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h3>
          <span>RECHNUNGSSTELLER & KUNDE</span>
          <span class="pill" id="statusPill">Status: Entwurf</span>
        </h3>
        <div class="content">
          <div class="two">
            <div>
              <label>Firma</label>
              <input id="firmName" value="Masculine Security"/>
            </div>
            <div>
              <label>Status wählen</label>
              <select id="statusSel">
                <option value="Entwurf">Entwurf</option>
                <option value="Offen">Offen</option>
                <option value="Bezahlt">Bezahlt</option>
                <option value="Storniert">Storniert</option>
              </select>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Adresse</label>
              <input id="firmAddr" value="Werschenregerstraße 6 • 28237 Bremen"/>
            </div>
            <div>
              <label>Telefon</label>
              <input id="firmTel" value="015778697052"/>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>E-Mail</label>
              <input id="firmMail" value="Kontakt.mass.bremen@hotmail.com"/>
            </div>
            <div>
              <label>Steuernummer</label>
              <input id="firmTax" value="in Bearbeitung"/>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>IBAN</label>
              <input id="firmIban" value="DE98 1001 1001 2333 0146 96"/>
            </div>
            <div>
              <label>BIC</label>
              <input id="firmBic" value="NTSBDEB1XXX"/>
            </div>
          </div>

          <div class="hr"></div>

          <div class="two">
            <div>
              <label>Kunde auswählen</label>
              <select id="customerSelect"></select>
              <div class="rowline" style="margin-top:8px">
                <button id="btnCustNew" style="padding:7px 10px">Neu</button>
                <button id="btnCustDelete" class="danger" style="padding:7px 10px">Kunde löschen</button>
              </div>
            </div>
            <div>
              <label>Kundenname (zum Speichern)</label>
              <input id="custName" placeholder="Firma / Name"/>
              <label style="margin-top:10px">E-Mail (optional)</label>
              <input id="custMail" placeholder="kunde@email.de"/>
            </div>
          </div>

          <label style="margin-top:10px">Kundendaten (Adresse / Ansprechpartner)</label>
          <textarea id="custData" placeholder="Straße • PLZ Ort&#10;Ansprechpartner"></textarea>

          <div class="rowline" style="margin-top:10px">
            <button id="btnCustSave" class="primary" style="background:var(--blue2);color:#fff;border-color:var(--blue2)">Kunde speichern</button>
            <span class="smallnote">Kunden werden im Browser gespeichert (localStorage).</span>
          </div>

          <div class="hr"></div>

          <div class="two">
            <div>
              <label>Einsatzort / Objekt</label>
              <input id="place" placeholder="z. B. Hotel / Baustelle / Adresse" value="Bremen"/>
            </div>
            <div>
              <label>Leistungszeitraum</label>
              <input id="period" placeholder="z. B. 01.02.2026 – 15.02.2026" value=""/>
            </div>
          </div>

          <label style="margin-top:10px">Leistungsbeschreibung</label>
          <textarea id="desc">Security Dienstleistung</textarea>

          <label style="margin-top:10px">Referenz / PO (optional)</label>
          <input id="refpo" placeholder="z. B. Auftrag-Nr. / Ansprechpartner" value=""/>

          <div class="footerNote">
            <div class="smallnote">Tipp: Rechnungsdatum / Rechnungsnummer kannst du manuell ändern.</div>
            <div class="smallnote">Auto-Save: Änderungen werden automatisch gespeichert.</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h3>
          <span>RECHNUNGSDATEN & BERECHNUNG</span>
          <span class="pill ok" id="autoPill">Auto aktiv</span>
        </h3>
        <div class="content">
          <div class="two">
            <div>
              <label>Rechnungsdatum</label>
              <input id="invDate" type="date"/>
              <div class="smallnote">Standard = heute (du kannst ändern).</div>
            </div>
            <div>
              <label>Zahlungsziel</label>
              <select id="payTerm">
                <option value="7">7 Tage</option>
                <option value="14" selected>14 Tage</option>
                <option value="30">30 Tage</option>
              </select>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Fällig am</label>
              <input id="dueDate" type="date"/>
              <div class="smallnote">Auto berechnet – du kannst auch manuell ändern.</div>
            </div>
            <div>
              <label>Rechnungsnummer</label>
              <input id="invNo"/>
              <div class="smallnote">Format: MS-YYYYMMDD-0001 (pro Tag laufend)</div>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>USt-Status</label>
              <select id="vatMode">
                <option value="Klein">0% (Kleinunternehmer §19)</option>
                <option value="Regel">19% (Regelbesteuerung)</option>
              </select>
              <div class="smallnote" id="vatNote">Gemäß §19 UStG wird keine Umsatzsteuer berechnet.</div>
            </div>
            <div>
              <label>Schicht-Modus</label>
              <div class="rowline">
                <input id="shiftMode" type="checkbox" style="width:auto;transform:scale(1.2)"/>
                <span class="smallnote" id="shiftText">AUS — du gibst nur Gesamtstunden + Zuschlagsstunden ein.</span>
              </div>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Stundensatz (€/h)</label>
              <input id="rate" type="number" min="0" step="0.01" value="23"/>
            </div>
            <div>
              <label>Nachtschicht %</label>
              <input id="nightPct" type="number" min="0" step="1" value="5"/>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Sonntag %</label>
              <input id="sunPct" type="number" min="0" step="1" value="50"/>
            </div>
            <div>
              <label>Feiertag %</label>
              <input id="holPct" type="number" min="0" step="1" value="100"/>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Anzahl Mitarbeiter</label>
              <input id="ma" type="number" min="1" step="1" value="10"/>
            </div>
            <div>
              <label>Stunden gesamt</label>
              <input id="totalHours" type="number" min="0" step="0.01" value="0"/>
            </div>
          </div>

          <div class="smallnote" style="margin-top:8px">
            Keine Doppelzählung: Feiertag &gt; Sonntag &gt; Nacht (Zuschläge werden nur für ihre Stunden gerechnet).
          </div>

          <div class="hr"></div>

          <div class="pTable" style="border:1px solid var(--line);border-radius:14px;overflow:hidden">
            <table>
              <thead>
                <tr>
                  <th style="width:44%">Position</th>
                  <th style="width:18%">Stunden</th>
                  <th style="width:18%">Zuschlag %</th>
                  <th class="right" style="width:20%">Betrag</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><b>Grundlohn</b><div class="smallnote">Arbeitszeit (normal)</div></td>
                  <td><input id="hBase" type="number" step="0.01" min="0" value="0"></td>
                  <td class="muted">—</td>
                  <td class="right" id="amtBase">0,00 €</td>
                </tr>
                <tr>
                  <td><b>Nachtschicht</b><div class="smallnote">Zuschlag</div></td>
                  <td><input id="hNight" type="number" step="0.01" min="0" value="0"></td>
                  <td id="pctNight">5%</td>
                  <td class="right" id="amtNight">0,00 €</td>
                </tr>
                <tr>
                  <td><b>Sonntag</b><div class="smallnote">Zuschlag</div></td>
                  <td><input id="hSun" type="number" step="0.01" min="0" value="0"></td>
                  <td id="pctSun">50%</td>
                  <td class="right" id="amtSun">0,00 €</td>
                </tr>
                <tr>
                  <td><b>Feiertag</b><div class="smallnote">Zuschlag</div></td>
                  <td><input id="hHol" type="number" step="0.01" min="0" value="0"></td>
                  <td id="pctHol">100%</td>
                  <td class="right" id="amtHol">0,00 €</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="sumgrid" style="margin-top:12px">
            <div class="sumcard">
              <div class="smallnote"><b>Stunden/MA (Auto)</b></div>
              <div class="big" id="perMA">0,00</div>
              <div class="smallnote">= Stunden gesamt ÷ Mitarbeiter</div>
            </div>
            <div class="sumcard">
              <div class="smallnote"><b>Stunden gesamt</b></div>
              <div class="big" id="sumH">0,00</div>
              <div class="smallnote" id="autoRule">Grundlohn-Stunden werden automatisch berechnet.</div>
            </div>
          </div>

          <div class="sumgrid" style="margin-top:12px">
            <div class="sumcard">
              <div class="smallnote"><b>Zwischensumme (Netto)</b></div>
              <div class="big" id="net">0,00 €</div>
            </div>
            <div class="sumcard">
              <div class="smallnote"><b>Umsatzsteuer</b></div>
              <div class="big" id="vat">0,00 €</div>
            </div>
          </div>

          <div class="sumcard" style="margin-top:12px">
            <div class="smallnote"><b>Gesamt</b></div>
            <div class="big" id="gross">0,00 €</div>
            <div class="smallnote">Hinweis: Zahlung bitte innerhalb der Zahlungsfrist auf das unten angegebene Konto.</div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- PRINT AREA for PDF + Print -->
  <div id="printArea"></div>

  <div class="toast" id="toast"></div>

  <input id="logoFile" type="file" accept="image/*" style="display:none"/>

  <script>
  ;(()=>{

    // ---------- helpers ----------
    const $ = (id)=>document.getElementById(id);
    const fmtEUR = (n)=> (Number(n||0)).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}) + " €";
    const fmtN = (n)=> (Number(n||0)).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2});
    const ymd = (d)=> {
      const yyyy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const ymdCompact = (dateStr)=> String(dateStr||"").replaceAll("-","");
    const toast = (msg)=>{
      const t=$("toast"); t.textContent=msg; t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"),2200);
    };
    const safe = (s)=> String(s||"").replace(/[^\w\-\.]+/g,"_");

    // ---------- storage keys ----------
    const KEY_APP="MS_INV_APP_V1";
    const KEY_CUSTOMERS="MS_INV_CUSTOMERS_V1";
    const KEY_INVS="MS_INV_LIST_V1";
    const KEY_LOGO="MS_INV_LOGO_DATAURL_V1";
    const KEY_INVSEQ="MS_INV_SEQ_V1"; // per day running numbers

    // ---------- FEST logo (auto, persistent) ----------
    // Put your logo file in repo root as: logo.png
    const DEFAULT_LOGO_PATH = "logo.png";

    // ---------- state ----------
    const defaultState = ()=>({
      firmName:"Masculine Security",
      firmAddr:"Werschenregerstraße 6 • 28237 Bremen",
      firmTel:"015778697052",
      firmMail:"Kontakt.mass.bremen@hotmail.com",
      firmTax:"in Bearbeitung",
      firmIban:"DE98 1001 1001 2333 0146 96",
      firmBic:"NTSBDEB1XXX",
      status:"Entwurf",

      custKey:"",
      custName:"",
      custMail:"",
      custData:"",

      place:"Bremen",
      period:"",
      desc:"Security Dienstleistung",
      refpo:"",

      invDate: ymd(new Date()),
      dueDate: "",
      payTerm: "14",
      invNo: "",

      vatMode:"Klein",
      rate:23,
      nightPct:5,
      sunPct:50,
      holPct:100,

      ma:10,
      totalHours:0,

      hNight:0,
      hSun:0,
      hHol:0,

      // if user manually edits base hours, we keep it, otherwise auto
      hBaseManual:false,
      hBase:0
    });

    const loadJSON = (k, fallback)=>{
      try{ const v=localStorage.getItem(k); return v? JSON.parse(v) : fallback; }catch{ return fallback; }
    };
    const saveJSON = (k, obj)=>{
      try{ localStorage.setItem(k, JSON.stringify(obj)); }catch(e){ console.warn(e); }
    };

    let state = loadJSON(KEY_APP, null) || defaultState();
    let customers = loadJSON(KEY_CUSTOMERS, {});
    let invoices = loadJSON(KEY_INVS, []);

    // ---------- Logo handling (FEST) ----------
    let logoDataUrl = localStorage.getItem(KEY_LOGO) || "";

    const setTopLogo = (dataUrl)=>{
      const img=$("topLogo"), fb=$("topLogoFallback");
      if(dataUrl){
        img.src=dataUrl;
        img.style.display="block";
        fb.style.display="none";
      }else{
        img.style.display="none";
        fb.style.display="block";
      }
    };

    const fetchAsDataURL = async (url)=>{
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error("Logo nicht gefunden: " + url);
      const blob = await res.blob();
      return await new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload=()=>resolve(String(r.result||""));
        r.onerror=reject;
        r.readAsDataURL(blob);
      });
    };

    const ensureFestLogo = async ()=>{
      if(logoDataUrl){
        setTopLogo(logoDataUrl);
        return;
      }
      // Try auto-load logo.png once
      try{
        const d = await fetchAsDataURL(DEFAULT_LOGO_PATH);
        logoDataUrl = d;
        localStorage.setItem(KEY_LOGO, logoDataUrl);
        setTopLogo(logoDataUrl);
      }catch{
        // fallback stays MS
        setTopLogo("");
      }
    };

    // ---------- DOM sync ----------
    const bindToState = ()=>{
      $("firmName").value = state.firmName;
      $("firmAddr").value = state.firmAddr;
      $("firmTel").value = state.firmTel;
      $("firmMail").value = state.firmMail;
      $("firmTax").value = state.firmTax;
      $("firmIban").value = state.firmIban;
      $("firmBic").value = state.firmBic;

      $("statusSel").value = state.status;

      $("custName").value = state.custName;
      $("custMail").value = state.custMail;
      $("custData").value = state.custData;

      $("place").value = state.place;
      $("period").value = state.period;
      $("desc").value = state.desc;
      $("refpo").value = state.refpo;

      $("invDate").value = state.invDate || ymd(new Date());
      $("payTerm").value = String(state.payTerm||"14");
      $("dueDate").value = state.dueDate || "";

      $("invNo").value = state.invNo || "";

      $("vatMode").value = state.vatMode;
      $("rate").value = Number(state.rate||0);
      $("nightPct").value = Number(state.nightPct||0);
      $("sunPct").value = Number(state.sunPct||0);
      $("holPct").value = Number(state.holPct||0);

      $("ma").value = Number(state.ma||1);
      $("totalHours").value = Number(state.totalHours||0);

      $("hNight").value = Number(state.hNight||0);
      $("hSun").value = Number(state.hSun||0);
      $("hHol").value = Number(state.hHol||0);

      $("hBase").value = Number(state.hBase||0);

      syncVatNote();
      syncStatusPill();
      refreshCustomerSelect();
      ensureInvNo();
      syncDueDate(true);
      recalc();
      autoSave();
    };

    const autoSave = ()=>{
      saveJSON(KEY_APP, state);
    };

    const syncStatusPill = ()=>{
      const pill = $("statusPill");
      pill.textContent = "Status: " + (state.status||"Entwurf");
      pill.classList.remove("ok","off");
      if(state.status==="Bezahlt") pill.classList.add("ok");
      if(state.status==="Offen") pill.classList.add("off");
    };

    const syncVatNote = ()=>{
      const note = $("vatNote");
      const mode = $("vatMode").value;
      if(mode==="Klein"){
        note.textContent = "Gemäß §19 UStG wird keine Umsatzsteuer berechnet.";
      }else{
        note.textContent = "Umsatzsteuer wird mit 19% ausgewiesen (Regelbesteuerung).";
      }
    };

    const syncDueDate = (silent)=>{
      const inv = $("invDate").value;
      const term = Number($("payTerm").value||14);
      if(!inv) return;
      const d = new Date(inv + "T00:00:00");
      d.setDate(d.getDate() + term);
      const calc = ymd(d);
      // only auto-fill if empty OR silent requested
      if(!state.dueDate || silent){
        $("dueDate").value = calc;
        state.dueDate = calc;
      }
    };

    const ensureInvNo = ()=>{
      // If invNo empty => generate per day sequence
      const dateStr = $("invDate").value || ymd(new Date());
      if(state.invNo && state.invNo.trim()) return;

      const dayKey = ymdCompact(dateStr);
      const seqMap = loadJSON(KEY_INVSEQ, {});
      const next = (Number(seqMap[dayKey]||0) + 1);
      seqMap[dayKey] = next;
      saveJSON(KEY_INVSEQ, seqMap);

      const running = String(next).padStart(4,"0");
      const invNo = `MS-${dayKey}-${running}`;
      $("invNo").value = invNo;
      state.invNo = invNo;
    };

    // ---------- customers ----------
    const refreshCustomerSelect = ()=>{
      const sel = $("customerSelect");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "— auswählen —";
      sel.appendChild(opt0);

      const keys = Object.keys(customers||{}).sort((a,b)=>a.localeCompare(b));
      for(const k of keys){
        const c = customers[k];
        const o = document.createElement("option");
        o.value = k;
        o.textContent = c.name || k;
        sel.appendChild(o);
      }
      sel.value = state.custKey || "";
    };

    const loadCustomerToForm = (key)=>{
      if(!key || !customers[key]) return;
      const c = customers[key];
      state.custKey = key;
      state.custName = c.name || "";
      state.custMail = c.mail || "";
      state.custData = c.data || "";
      $("custName").value = state.custName;
      $("custMail").value = state.custMail;
      $("custData").value = state.custData;
      autoSave();
      toast("Kunde geladen");
    };

    const saveCustomerFromForm = ()=>{
      const name = $("custName").value.trim();
      if(!name){ toast("Bitte Kundenname eingeben"); return; }
      const key = safe(name.toLowerCase());
      customers[key] = {
        name,
        mail: $("custMail").value.trim(),
        data: $("custData").value.trim()
      };
      saveJSON(KEY_CUSTOMERS, customers);
      state.custKey = key;
      refreshCustomerSelect();
      $("customerSelect").value = key;
      toast("Kunde gespeichert");
      autoSave();
    };

    const deleteCustomer = ()=>{
      const key = $("customerSelect").value;
      if(!key){ toast("Kein Kunde ausgewählt"); return; }
      if(!confirm("Kunde wirklich löschen?")) return;
      delete customers[key];
      saveJSON(KEY_CUSTOMERS, customers);
      if(state.custKey===key){
        state.custKey="";
        state.custName="";
        state.custMail="";
        state.custData="";
        $("custName").value="";
        $("custMail").value="";
        $("custData").value="";
      }
      refreshCustomerSelect();
      toast("Kunde gelöscht");
      autoSave();
    };

    // ---------- calculation ----------
    const clamp0 = (n)=> Math.max(0, Number(n||0));
    const pct = (n)=> clamp0(n)/100;

    const recalc = ()=>{
      // read inputs -> state
      state.status = $("statusSel").value;

      state.firmName = $("firmName").value;
      state.firmAddr = $("firmAddr").value;
      state.firmTel = $("firmTel").value;
      state.firmMail = $("firmMail").value;
      state.firmTax = $("firmTax").value;
      state.firmIban = $("firmIban").value;
      state.firmBic = $("firmBic").value;

      state.invDate = $("invDate").value;
      state.payTerm = $("payTerm").value;
      state.dueDate = $("dueDate").value;
      state.invNo = $("invNo").value;

      state.vatMode = $("vatMode").value;
      state.rate = clamp0($("rate").value);
      state.nightPct = clamp0($("nightPct").value);
      state.sunPct = clamp0($("sunPct").value);
      state.holPct = clamp0($("holPct").value);

      state.ma = Math.max(1, Math.floor(clamp0($("ma").value)||1));
      state.totalHours = clamp0($("totalHours").value);

      state.hNight = clamp0($("hNight").value);
      state.hSun = clamp0($("hSun").value);
      state.hHol = clamp0($("hHol").value);

      // base hours: auto = total - (night+sun+hol)
      const z = state.hNight + state.hSun + state.hHol;
      let baseAuto = Math.max(0, state.totalHours - z);

      // if user edits base directly -> we respect but keep totals view accurate
      const baseInput = clamp0($("hBase").value);
      // detect manual edit: if input differs from expected and totalHours is 0, keep it
      // simple rule: if user changes hBase input -> manual on
      // (we set manual true only on input event below)
      const base = state.hBaseManual ? baseInput : baseAuto;
      state.hBase = base;

      // update UI hours displays
      $("hBase").value = base.toFixed(2);

      // amounts
      const rate = state.rate;
      const amtBase = base * rate;

      const amtNight = state.hNight * rate * pct(state.nightPct);
      const amtSun   = state.hSun   * rate * pct(state.sunPct);
      const amtHol   = state.hHol   * rate * pct(state.holPct);

      $("pctNight").textContent = `${state.nightPct}%`;
      $("pctSun").textContent = `${state.sunPct}%`;
      $("pctHol").textContent = `${state.holPct}%`;

      $("amtBase").textContent = fmtEUR(amtBase);
      $("amtNight").textContent = fmtEUR(amtNight);
      $("amtSun").textContent = fmtEUR(amtSun);
      $("amtHol").textContent = fmtEUR(amtHol);

      const sumH = base + state.hNight + state.hSun + state.hHol;
      $("sumH").textContent = fmtN(sumH);
      const perMA = sumH / Math.max(1, state.ma);
      $("perMA").textContent = fmtN(perMA);

      const net = amtBase + amtNight + amtSun + amtHol;
      $("net").textContent = fmtEUR(net);

      let vatAmt = 0;
      if(state.vatMode==="Regel"){
        vatAmt = net * 0.19;
      }
      $("vat").textContent = fmtEUR(vatAmt);

      const gross = net + vatAmt;
      $("gross").textContent = fmtEUR(gross);

      syncVatNote();
      syncStatusPill();
      autoSave();
    };

    // ---------- print sheet html ----------
    const buildPrintHTML = ()=>{
      const firmName = $("firmName").value.trim();
      const firmAddr = $("firmAddr").value.trim();
      const firmTel  = $("firmTel").value.trim();
      const firmMail = $("firmMail").value.trim();
      const firmTax  = $("firmTax").value.trim();
      const iban     = $("firmIban").value.trim();
      const bic      = $("firmBic").value.trim();

      const custName = $("custName").value.trim();
      const custMail = $("custMail").value.trim();
      const custData = $("custData").value.trim();

      const place = $("place").value.trim();
      const period = $("period").value.trim();
      const desc = $("desc").value.trim();
      const refpo = $("refpo").value.trim();

      const invDate = $("invDate").value;
      const dueDate = $("dueDate").value;
      const invNo = $("invNo").value.trim();
      const vatMode = $("vatMode").value;

      const rate = Number($("rate").value||0);
      const hBase = Number($("hBase").value||0);
      const hNight = Number($("hNight").value||0);
      const hSun = Number($("hSun").value||0);
      const hHol = Number($("hHol").value||0);

      const nightPct = Number($("nightPct").value||0);
      const sunPct = Number($("sunPct").value||0);
      const holPct = Number($("holPct").value||0);

      const amtBase = hBase * rate;
      const amtNight = hNight * rate * (nightPct/100);
      const amtSun = hSun * rate * (sunPct/100);
      const amtHol = hHol * rate * (holPct/100);

      const net = amtBase + amtNight + amtSun + amtHol;
      const vatAmt = vatMode==="Regel" ? net*0.19 : 0;
      const gross = net + vatAmt;

      const vatLine = vatMode==="Klein"
        ? `Gemäß §19 UStG wird keine Umsatzsteuer berechnet.`
        : `Umsatzsteuer 19% (Regelbesteuerung) wird ausgewiesen.`;

      const telLink = firmTel ? `<a href="tel:${firmTel.replace(/\s+/g,"")}" style="color:#223;text-decoration:none">${firmTel}</a>` : "";
      const mailLink = firmMail ? `<a href="mailto:${firmMail}" style="color:#223;text-decoration:none">${firmMail}</a>` : "";

      const custMailLine = custMail ? `<div class="pMeta">E-Mail: <a href="mailto:${custMail}" style="color:#223;text-decoration:none">${custMail}</a></div>` : "";

      const logoImg = logoDataUrl ? `<img class="pLogo" src="${logoDataUrl}" alt="Logo"/>` : `<div class="pLogo" style="display:grid;place-items:center;font-weight:800;color:#223">MS</div>`;

      return `
        <div class="printSheet">
          <div class="pHeader">
            <div class="pBrand">
              ${logoImg}
              <div>
                <h1 class="pTitle">Rechnung</h1>
                <div class="pMeta"><b>${firmName}</b></div>
                <div class="pMeta">${firmAddr}</div>
                <div class="pMeta">Tel: ${telLink} • E-Mail: ${mailLink}</div>
                <div class="pMeta">Steuernummer: ${firmTax}</div>
              </div>
            </div>
            <div style="text-align:right">
              <div class="pMeta"><b>Rechnungsnr.:</b> ${invNo}</div>
              <div class="pMeta"><b>Rechnungsdatum:</b> ${invDate}</div>
              <div class="pMeta"><b>Fällig am:</b> ${dueDate}</div>
              <div class="pMeta"><b>Status:</b> ${$("statusSel").value}</div>
            </div>
          </div>

          <div class="pGrid">
            <div class="pBox">
              <div class="pH">Rechnung an</div>
              <p class="pT"><b>${custName || "—"}</b></p>
              <p class="pT" style="white-space:pre-line">${custData || ""}</p>
              ${custMailLine}
            </div>
            <div class="pBox">
              <div class="pH">Leistung</div>
              <p class="pT"><b>Einsatzort/Objekt:</b> ${place || "—"}</p>
              <p class="pT"><b>Zeitraum:</b> ${period || "—"}</p>
              <p class="pT" style="white-space:pre-line"><b>Beschreibung:</b> ${desc || "—"}</p>
              <p class="pT"><b>Referenz/PO:</b> ${refpo || "—"}</p>
            </div>
          </div>

          <div class="pTable">
            <table>
              <thead>
                <tr>
                  <th>Position</th>
                  <th style="text-align:right">Stunden</th>
                  <th style="text-align:right">Satz</th>
                  <th style="text-align:right">Betrag</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><b>Grundlohn</b></td>
                  <td style="text-align:right">${fmtN(hBase)}</td>
                  <td style="text-align:right">${fmtEUR(rate).replace(" €","")} €/h</td>
                  <td style="text-align:right">${fmtEUR(amtBase)}</td>
                </tr>
                <tr>
                  <td><b>Nachtschicht</b> <span class="muted">(${nightPct}%)</span></td>
                  <td style="text-align:right">${fmtN(hNight)}</td>
                  <td style="text-align:right">—</td>
                  <td style="text-align:right">${fmtEUR(amtNight)}</td>
                </tr>
                <tr>
                  <td><b>Sonntag</b> <span class="muted">(${sunPct}%)</span></td>
                  <td style="text-align:right">${fmtN(hSun)}</td>
                  <td style="text-align:right">—</td>
                  <td style="text-align:right">${fmtEUR(amtSun)}</td>
                </tr>
                <tr>
                  <td><b>Feiertag</b> <span class="muted">(${holPct}%)</span></td>
                  <td style="text-align:right">${fmtN(hHol)}</td>
                  <td style="text-align:right">—</td>
                  <td style="text-align:right">${fmtEUR(amtHol)}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="pSum">
            <div class="pBox">
              <div class="pH">Hinweis</div>
              <div class="pFine">${vatLine}</div>
              <div class="pFine">Bitte überweisen Sie den Rechnungsbetrag innerhalb der Zahlungsfrist.</div>
            </div>
            <div class="pBox">
              <div class="pH">Summen</div>
              <div class="pT" style="display:flex;justify-content:space-between"><span>Zwischensumme (Netto)</span><b>${fmtEUR(net)}</b></div>
              <div class="pT" style="display:flex;justify-content:space-between"><span>Umsatzsteuer</span><b>${fmtEUR(vatAmt)}</b></div>
              <div class="pT" style="display:flex;justify-content:space-between;font-size:12pt"><span><b>Gesamt</b></span><b>${fmtEUR(gross)}</b></div>
            </div>
          </div>

          <div class="pFoot">
            <div><b>IBAN:</b> ${iban} • <b>BIC:</b> ${bic}</div>
            <div class="muted">${firmName}</div>
          </div>
        </div>
      `;
    };

    const renderPrintArea = ()=>{
      $("printArea").innerHTML = buildPrintHTML();
    };

    // ---------- PDF ----------
    const savePDF = async ()=>{
      renderPrintArea();
      const node = $("printArea");
      // temporarily show for capture (off-screen)
      node.style.display = "block";

      const canvas = await html2canvas(node, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: "#ffffff"
      });

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p","mm","a4");

      const imgData = canvas.toDataURL("image/png");
      const pageWidth = 210;
      const pageHeight = 297;

      // canvas pixels -> mm
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pageWidth;
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

      // if taller than a4 -> scale to fit
      const finalH = Math.min(pdfHeight, pageHeight);

      pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, finalH);

      const name = `${safe($("custName").value||"Kunde")}_${safe($("invNo").value||"Rechnung")}.pdf`;
      pdf.save(name);

      node.style.display = "none";
      toast("PDF gespeichert");
    };

    // ---------- Print (ONLY PRINT button) ----------
    const doPrint = ()=>{
      renderPrintArea();
      window.print();
      toast("Print geöffnet");
    };

    // ---------- invoices ----------
    const snapshotInvoice = ()=>{
      return {
        ts: Date.now(),
        invNo: $("invNo").value,
        invDate: $("invDate").value,
        dueDate: $("dueDate").value,
        status: $("statusSel").value,
        customer: $("custName").value,
        total: $("gross").textContent,
        state: JSON.parse(JSON.stringify(state))
      };
    };

    const saveInvoiceToList = ()=>{
      const invNo = $("invNo").value.trim();
      if(!invNo){ toast("Rechnungsnummer fehlt"); return; }
      const snap = snapshotInvoice();
      const idx = invoices.findIndex(x=>x.invNo===invNo);
      if(idx>=0) invoices[idx]=snap; else invoices.unshift(snap);
      saveJSON(KEY_INVS, invoices);
      toast("Rechnung gespeichert");
    };

    const showInvoiceList = ()=>{
      if(!invoices.length){ alert("Keine Rechnungen gespeichert."); return; }
      const lines = invoices.slice(0,30).map((x,i)=>`${i+1}) ${x.invNo} • ${x.customer||"—"} • ${x.total||""} • ${x.status||""}`).join("\n");
      const pick = prompt("Rechnungen (Tippe Nummer zum Laden):\n\n"+lines+"\n\n0 = Abbrechen");
      const n = Number(pick||0);
      if(!n || n<1 || n>invoices.length) return;
      const inv = invoices[n-1];
      if(inv && inv.state){
        state = inv.state;
        state.hBaseManual = false; // reset auto base unless user changes it again
        bindToState();
        toast("Rechnung geladen");
      }
    };

    // ---------- reset/new ----------
    const newInvoice = ()=>{
      const keepFirm = {
        firmName: state.firmName,
        firmAddr: state.firmAddr,
        firmTel: state.firmTel,
        firmMail: state.firmMail,
        firmTax: state.firmTax,
        firmIban: state.firmIban,
        firmBic: state.firmBic
      };
      state = defaultState();
      Object.assign(state, keepFirm);
      state.invDate = ymd(new Date());
      state.dueDate = "";
      state.invNo = "";
      state.hBaseManual = false;
      bindToState();
      toast("Neu gestartet");
    };

    const hardReset = ()=>{
      if(!confirm("Alles zurücksetzen (inkl. Kunden & Rechnungen)?")) return;
      localStorage.removeItem(KEY_APP);
      localStorage.removeItem(KEY_CUSTOMERS);
      localStorage.removeItem(KEY_INVS);
      localStorage.removeItem(KEY_INVSEQ);
      // ✅ keep FEST logo unless you want to remove it:
      // localStorage.removeItem(KEY_LOGO);
      customers = {};
      invoices = [];
      state = defaultState();
      bindToState();
      toast("Reset fertig");
    };

    // ---------- logo upload ----------
    const pickLogo = ()=> $("logoFile").click();

    const onLogoPicked = async (file)=>{
      if(!file) return;
      const dataUrl = await new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=()=>resolve(String(r.result||""));
        r.onerror=reject;
        r.readAsDataURL(file);
      });
      logoDataUrl = dataUrl;
      localStorage.setItem(KEY_LOGO, logoDataUrl);
      setTopLogo(logoDataUrl);
      toast("Logo gespeichert (FEST)");
    };

    // ---------- events ----------
    const wireEvents = ()=>{
      // recalc on change
      const ids = [
        "firmName","firmAddr","firmTel","firmMail","firmTax","firmIban","firmBic",
        "statusSel",
        "custName","custMail","custData",
        "place","period","desc","refpo",
        "invDate","payTerm","dueDate","invNo",
        "vatMode","rate","nightPct","sunPct","holPct",
        "ma","totalHours","hNight","hSun","hHol"
      ];
      for(const id of ids){
        $(id).addEventListener("input", ()=>{
          if(id==="invDate" || id==="payTerm"){
            state.invNo = ""; // allow new invNo if date changes and empty
            syncDueDate(true);
            ensureInvNo();
          }
          recalc();
        });
        $(id).addEventListener("change", ()=>{
          if(id==="invDate" || id==="payTerm"){
            state.invNo = "";
            syncDueDate(true);
            ensureInvNo();
          }
          recalc();
        });
      }

      // base hours manual detection
      $("hBase").addEventListener("input", ()=>{
        state.hBaseManual = true;
        recalc();
      });

      // customers
      $("customerSelect").addEventListener("change", (e)=>loadCustomerToForm(e.target.value));
      $("btnCustSave").addEventListener("click", saveCustomerFromForm);
      $("btnCustDelete").addEventListener("click", deleteCustomer);
      $("btnCustNew").addEventListener("click", ()=>{
        state.custKey=""; $("customerSelect").value="";
        $("custName").value=""; $("custMail").value=""; $("custData").value="";
        state.custName=""; state.custMail=""; state.custData="";
        autoSave();
        toast("Neuer Kunde");
      });

      // top actions
      $("btnNew").addEventListener("click", newInvoice);
      $("btnReset").addEventListener("click", hardReset);

      $("btnSaveInv").addEventListener("click", saveInvoiceToList);
      $("btnList").addEventListener("click", showInvoiceList);

      $("btnPdf").addEventListener("click", savePDF);

      // ✅ ONLY PRINT
      $("btnPrint").addEventListener("click", doPrint);

      // logo
      $("btnLogo").addEventListener("click", pickLogo);
      $("logoFile").addEventListener("change", (e)=>onLogoPicked(e.target.files && e.target.files[0]));
    };

    // ---------- init ----------
    const init = async ()=>{
      // default invDate if missing
      if(!state.invDate) state.invDate = ymd(new Date());
      // set date inputs now
      $("invDate").value = state.invDate;

      await ensureFestLogo();         // ✅ FEST logo (auto from logo.png or stored)
      wireEvents();
      bindToState();

      // if dueDate empty -> compute
      if(!state.dueDate){
        syncDueDate(true);
        state.dueDate = $("dueDate").value;
      }
      ensureInvNo();
      recalc();

      toast("Bereit");
    };

    init();

  })();
  </script>
</body>
</html>
