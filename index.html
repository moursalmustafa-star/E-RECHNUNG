<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Masculine Security — Rechnung (Pro · Auto · Archiv + PDF)</title>

<style>
:root{
  --ink:#0b1220;
  --muted:#4b5563;
  --line:#e5e7eb;
  --panel:#ffffff;
  --bg:#f7f9fc;
  --accent:#1e4ed8;
  --accent2:#0ea5e9;
  --soft:#f1f5ff;
  --radius:14px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.topbar{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  border-radius:18px;
  padding:14px;
  color:#fff;
  box-shadow:0 10px 24px rgba(2,6,23,.12);
}
.brandRow{display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
.brandLeft{display:flex;align-items:center;gap:12px}
.logoBox{width:46px;height:46px;border-radius:12px;background:#fff;display:grid;place-items:center;overflow:hidden}
.logoBox img{width:100%;height:100%;object-fit:cover;display:block}
.h1{font-weight:900;font-size:18px;line-height:1.2}
.sub{opacity:.9;font-size:12px;margin-top:2px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{
  border:1px solid rgba(255,255,255,.35);
  background:rgba(255,255,255,.12);
  color:#fff;
  padding:9px 12px;
  border-radius:12px;
  font-weight:900;
  font-size:13px;
  cursor:pointer;
  backdrop-filter: blur(6px);
}
.btn.white{
  background:#fff;color:var(--ink);border-color:#fff;
}
.btn.white:hover{background:#f7f7f7}
.btn:hover{filter:brightness(1.05)}
.main{margin-top:12px;display:grid;grid-template-columns:1.05fr .95fr;gap:12px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:12px}
.title{font-size:12px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px}
label{display:block;font-size:12px;font-weight:900;color:var(--ink);margin-top:10px}
input,select,textarea{
  width:100%;padding:10px 11px;border:1px solid var(--line);
  border-radius:12px;font-size:14px;background:#fff;outline:none
}
textarea{min-height:78px;resize:vertical}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.small{font-size:12px;color:var(--muted);line-height:1.45}
a{color:inherit}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
.pill{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--soft);border:1px solid #dbeafe;color:#0b3aa6;
  border-radius:999px;padding:6px 10px;font-size:12px;font-weight:900
}
.tableWrap{margin-top:12px;background:#fff;border:1px solid var(--line);border-radius:var(--radius);overflow:hidden}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:13.5px}
th{background:#f8fafc;color:#334155;font-size:12px;text-transform:uppercase;letter-spacing:.06em}
td.right,th.right{text-align:right}
.kpiRow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
.kpi{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff}
.kpi .k{font-size:12px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.08em}
.kpi .v{margin-top:6px;font-weight:900;font-size:18px}
.sumBox{margin-top:12px;background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:12px}
.sumRow{display:flex;justify-content:space-between;gap:10px;padding:6px 0}
.sumRow span{color:var(--muted);font-weight:900}
.sumRow b{font-weight:900}
.sumRow.total{border-top:1px dashed #cbd5e1;margin-top:8px;padding-top:10px;font-size:16px}
.badge{font-weight:900;font-size:12px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff}
.rowBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.btn2{border:1px solid var(--line);background:#fff;color:var(--ink);padding:9px 12px;border-radius:12px;font-weight:900;font-size:13px;cursor:pointer}
.btn2.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn2:hover{filter:brightness(1.02)}
.shiftHead{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.toggle{display:flex;align-items:center;gap:8px}
.toggle input{width:18px;height:18px}
.shiftTableWrap{margin-top:10px;border:1px solid var(--line);border-radius:14px;overflow:auto;background:#fff}
.shiftTable{min-width:980px}
.shiftTable th, .shiftTable td{border-bottom:1px solid #eef2f7}
.shiftTable input{border-radius:10px;padding:8px 9px;font-size:13px}
.miniBtn{padding:7px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:900}
.miniBtn.danger{border-color:#fecaca;color:#b91c1c;background:#fff5f5}
.noteBox{margin-top:10px;background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px}
.printOnly{display:none}

 /* Drawer (Archiv) */
.drawer{
  position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;
  background:rgba(2,6,23,.45);z-index:9999;padding:14px;
}
.drawer.open{display:flex}
.drawerPanel{
  width:min(920px,100%);background:#fff;border:1px solid var(--line);
  border-radius:18px;box-shadow:0 30px 80px rgba(2,6,23,.35);overflow:hidden;
}
.drawerHead{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:12px 14px;background:linear-gradient(90deg,#0b2a5a,#0ea5e9);color:#fff;
}
.drawerHead b{font-size:14px}
.drawerBody{padding:12px 14px;max-height:70vh;overflow:auto}
.archRow{
  display:grid;grid-template-columns:1.2fr .8fr .6fr auto;gap:10px;align-items:center;
  border:1px solid var(--line);border-radius:14px;padding:10px;margin-bottom:10px;background:#fff;
}
.archRow .meta{font-size:12px;color:var(--muted)}
.archBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.sep{height:1px;background:#eef2f7;margin:10px 0}

@page{size:A4;margin:10mm}
@media (max-width:980px){.main{grid-template-columns:1fr}}
@media print{
  body{background:#fff}
  .wrap{padding:0}
  .topbar,.rowBtns,.miniBtn,.shiftHead .toggle,.noteBox,.drawer{display:none !important}
  .printOnly{display:block}
  input,select,textarea{border:none !important;padding:0 !important}
  textarea{min-height:0 !important}
  .card,.tableWrap,.sumBox{box-shadow:none !important}
}
</style>
</head>

<body>
<div class="wrap" id="app">

  <div class="topbar">
    <div class="brandRow">
      <div class="brandLeft">
        <div class="logoBox"><img id="logoImg" src="logo.png" alt="Logo"></div>
        <div>
          <div class="h1">Masculine Security — Rechnung</div>
          <div class="sub">Pro Style · Auto Kundenliste · Auto Rechnungsnummer · Auto Zuschläge (Schichten) · Rechnung-Archiv · PDF</div>
        </div>
      </div>
      <div class="actions">
        <label class="btn" style="margin:0">
          Logo ändern <input id="logoFile" type="file" accept="image/*" style="display:none">
        </label>
        <button class="btn white" id="btnNew" type="button">Neu</button>
        <button class="btn white" id="btnSave" type="button">Rechnung speichern</button>
        <button class="btn white" id="btnArchive" type="button">Rechnungen</button>
        <button class="btn white" id="btnReset" type="button">Reset</button>
        <button class="btn" id="btnPdf" type="button">PDF speichern</button>
      </div>
    </div>
  </div>

  <div class="printOnly" style="margin:12px 0 8px 0;">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="logoBox" style="border:1px solid #ddd"><img id="logoImg2" src="logo.png" alt="Logo"></div>
      <div>
        <div style="font-weight:900;font-size:16px">Masculine Security — Rechnung</div>
        <div class="small">Automatisch · Zuschläge · USt · Kundenliste · Archiv</div>
      </div>
    </div>
  </div>

  <div class="main">
    <!-- LEFT -->
    <div class="card">
      <div class="title">Rechnungssteller & Kunde</div>

      <div style="font-size:14px;line-height:1.5">
        <b>Masculine Security</b><br>
        Werschenregerstraße 6 · 28237 Bremen<br>
        Tel: <a href="tel:+4915778697052">015778697052</a> ·
        E-Mail: <a href="mailto:Kontakt.mass.bremen@hotmail.com">Kontakt.mass.bremen@hotmail.com</a><br>
        <span class="small">Steuernummer: (in Bearbeitung)</span>
      </div>

      <label>Kunde (Auswahl)</label>
      <div class="grid2" style="grid-template-columns:1fr auto">
        <select id="kundeSelect"></select>
        <button class="btn2" id="btnKundeNew" type="button">Neu</button>
      </div>

      <div class="grid2">
        <div>
          <label>Kundenname (zum Speichern)</label>
          <input id="kundeName" placeholder="Firma / Name">
        </div>
        <div>
          <label>E-Mail (optional)</label>
          <input id="kundeEmail" placeholder="kunde@example.com">
        </div>
      </div>

      <label>Kundendaten</label>
      <textarea id="kundeText" placeholder="Firma / Name&#10;Straße Hausnr.&#10;PLZ Ort&#10;Ansprechpartner (optional)"></textarea>

      <div class="rowBtns">
        <button class="btn2" id="btnKundeSave" type="button">Kunde speichern</button>
        <button class="btn2" id="btnKundeDelete" type="button">Kunde löschen</button>
      </div>

      <hr>

      <div class="grid2">
        <div>
          <label>Einsatzort / Objekt</label>
          <input id="objekt" placeholder="z.B. Hotel / Baustelle / Adresse">
        </div>
        <div>
          <label>Leistungszeitraum</label>
          <input id="zeitraum" placeholder="z.B. 01.02.2026 – 15.02.2026">
        </div>
      </div>

      <label>Leistungsbeschreibung</label>
      <textarea id="leistung">Security Dienstleistung</textarea>

      <label>Referenz / PO (optional)</label>
      <input id="ref" placeholder="z.B. Auftrag-Nr. / Ansprechpartner">
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="shiftHead">
        <div>
          <div class="title" style="margin-bottom:6px">Rechnungsdaten & Berechnung</div>
          <span class="pill">Auto-Zuschläge: Nacht 22–06 · Sonntag · Feiertag (Bremen)</span>
        </div>
        <div class="toggle">
          <input id="modeShifts" type="checkbox" checked>
          <label for="modeShifts" style="margin:0;font-weight:900">Schicht-Modus (Auto)</label>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Rechnungsdatum</label>
          <input id="invDate" type="date">
        </div>
        <div>
          <label>Zahlungsziel</label>
          <select id="terms">
            <option value="7">7 Tage</option>
            <option value="14" selected>14 Tage</option>
            <option value="21">21 Tage</option>
            <option value="30">30 Tage</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Fällig am (Auto)</label>
          <input id="dueDate" type="date" readonly>
        </div>
        <div>
          <label>Rechnungsnummer (Auto)</label>
          <input id="invNo" readonly>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Status wählen</label>
          <select id="status">
            <option>Entwurf</option>
            <option>Offen</option>
            <option>Bezahlt</option>
            <option>Storniert</option>
          </select>
        </div>
        <div>
          <label>Stundensatz (€/h)</label>
          <input id="rate" type="number" min="0" step="0.01" value="25">
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>USt-Status</label>
          <select id="vatMode">
            <option value="0" selected>0% (Kleinunternehmer §19)</option>
            <option value="19">19% (Regelbesteuerung)</option>
          </select>
        </div>
        <div>
          <label>Zuschläge editierbar</label>
          <div class="grid3">
            <input id="p_night" type="number" min="0" step="0.1" value="5" title="Nachtschicht %">
            <input id="p_sun" type="number" min="0" step="0.1" value="50" title="Sonntag %">
            <input id="p_hol" type="number" min="0" step="0.1" value="100" title="Feiertag %">
          </div>
          <div class="small">Reihenfolge (keine Doppelzählung): Feiertag &gt; Sonntag &gt; Nacht.</div>
        </div>
      </div>

      <div class="kpiRow">
        <div class="kpi"><div class="k">Stunden gesamt</div><div class="v" id="k_total">0,00</div></div>
        <div class="kpi"><div class="k">Netto</div><div class="v" id="k_net">0,00 €</div></div>
        <div class="kpi"><div class="k">Gesamt</div><div class="v" id="k_all">0,00 €</div></div>
      </div>

      <div class="noteBox" id="vatHint"></div>

      <!-- fallback simple mode -->
      <div id="simpleModeBox" style="margin-top:10px;display:none">
        <div class="title">Einfach-Modus (MA × Ø Std)</div>
        <div class="grid3">
          <div>
            <label>Anzahl Mitarbeiter</label>
            <input id="ma_count" type="number" min="0" step="1" placeholder="z.B. 10">
          </div>
          <div>
            <label>Ø Std/MA</label>
            <input id="hours_per_ma" type="number" min="0" step="0.25" placeholder="z.B. 216">
          </div>
          <div>
            <label>Stunden gesamt (Auto)</label>
            <input id="hours_total" type="number" readonly>
          </div>
        </div>
        <div class="small" style="margin-top:8px">
          In diesem Modus gibst du Nacht/Sonntag/Feiertag-Stunden manuell unten ein.
        </div>
      </div>
    </div>
  </div>

  <!-- SHIFT MODE -->
  <div class="card" style="margin-top:12px" id="shiftModeBox">
    <div class="shiftHead">
      <div>
        <div class="title" style="margin-bottom:6px">Schichten (Auto-Berechnung)</div>
        <div class="small">Start/Ende + Mitarbeiter → System berechnet automatisch: Grundlohn, Nacht, Sonntag, Feiertag (Bremen).</div>
      </div>
      <div class="rowBtns" style="margin:0">
        <button class="btn2" id="btnAddShift" type="button">+ Schicht hinzufügen</button>
        <button class="btn2" id="btnDemoShift" type="button">Demo füllen</button>
        <span class="badge" id="holidayInfo">Feiertage: Bremen</span>
      </div>
    </div>

    <div class="shiftTableWrap">
      <table class="shiftTable" id="shiftTable">
        <thead>
          <tr>
            <th style="width:220px">Start (Datum+Zeit)</th>
            <th style="width:220px">Ende (Datum+Zeit)</th>
            <th style="width:140px">Mitarbeiter</th>
            <th class="right" style="width:140px">Stunden</th>
            <th style="width:140px">Aktion</th>
          </tr>
        </thead>
        <tbody id="shiftBody"></tbody>
      </table>
    </div>

    <div class="small" style="margin-top:8px">Tipp: Einsatz über Mitternacht → Ende am nächsten Tag wählen.</div>
  </div>

  <!-- POSITIONS -->
  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Position</th>
          <th style="width:160px">Stunden</th>
          <th style="width:140px">Zuschlag %</th>
          <th class="right" style="width:180px">Betrag</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><b>Grundlohn</b><div class="small">Arbeitszeit (normal)</div></td>
          <td><input id="h_base" type="number" readonly></td>
          <td class="small">—</td>
          <td class="right" id="sum_base">0,00 €</td>
        </tr>
        <tr>
          <td><b>Nachtschicht</b><div class="small">22:00–06:00</div></td>
          <td><input id="h_night" type="number" min="0" step="0.25" placeholder="0"></td>
          <td><input id="p_night2" type="number" min="0" step="0.1" value="5"></td>
          <td class="right" id="sum_night">0,00 €</td>
        </tr>
        <tr>
          <td><b>Sonntag</b><div class="small">Auto</div></td>
          <td><input id="h_sun" type="number" min="0" step="0.25" placeholder="0"></td>
          <td><input id="p_sun2" type="number" min="0" step="0.1" value="50"></td>
          <td class="right" id="sum_sun">0,00 €</td>
        </tr>
        <tr>
          <td><b>Feiertag</b><div class="small">Bremen · Auto</div></td>
          <td><input id="h_hol" type="number" min="0" step="0.25" placeholder="0"></td>
          <td><input id="p_hol2" type="number" min="0" step="0.1" value="100"></td>
          <td class="right" id="sum_hol">0,00 €</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="sumBox">
    <div class="sumRow"><span>Zwischensumme (Netto)</span><b id="netto">0,00 €</b></div>
    <div class="sumRow"><span>Umsatzsteuer</span><b id="vat">0,00 €</b></div>
    <div class="sumRow total"><span>Gesamt</span><b id="total">0,00 €</b></div>
    <div class="small" id="legalNote" style="margin-top:6px"></div>
    <div class="small" style="margin-top:10px">
      <b>Bank:</b> MUSTAFA MURSAL ABDI · IBAN: DE98 1001 1001 2333 0146 96 · BIC: NTSBDEB1XXX
    </div>
  </div>

</div>

<!-- ARCHIV DRAWER -->
<div class="drawer" id="drawer">
  <div class="drawerPanel">
    <div class="drawerHead">
      <b>Rechnungen (Archiv)</b>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn white" id="btnExportJson" type="button">Export JSON</button>
        <button class="btn white" id="btnImportJson" type="button">Import JSON</button>
        <button class="btn" id="btnCloseDrawer" type="button">Schließen</button>
        <input id="importFile" type="file" accept="application/json" style="display:none">
      </div>
    </div>
    <div class="drawerBody">
      <div class="small">Speichert jede Rechnung (Daten + Berechnung) im Browser. PDF kannst du jederzeit pro Rechnung erzeugen.</div>
      <div class="sep"></div>
      <div id="archList"></div>
      <div class="small" id="archEmpty"></div>
    </div>
  </div>
</div>

<script>
/* ========= STORAGE KEYS ========= */
const LS_STATE="ms_pro_invoice_v3";
const LS_CUSTOMERS="ms_customers_pro_v2";
const LS_COUNTER="ms_counter_pro_v2";
const LS_ARCHIVE="ms_invoice_archive_v1";

/* ========= HELPERS ========= */
const $=id=>document.getElementById(id);
const pad2=n=>String(n).padStart(2,"0");
const toISO=d=>{const x=new Date(d);return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;}
const toISODayKey=d=>{const x=new Date(d);return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;}
const num=el=>{const v=parseFloat(el.value);return Number.isFinite(v)?v:0;}
const money=x=>(x||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+" €";
const round2=x=>Math.round((x||0)*100)/100;
const safeJSON=(v,fallback)=>{try{return JSON.parse(v);}catch(e){return fallback;}};

function nextInvoiceNo(){
  const d=new Date();
  const key=`${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}`;
  let store=safeJSON(localStorage.getItem(LS_COUNTER)||"{}",{});
  store[key]=(store[key]||0)+1;
  localStorage.setItem(LS_COUNTER,JSON.stringify(store));
  return `MS-${key}-${store[key]}`;
}

function setDue(){
  const days=parseInt($("terms").value,10)||14;
  const inv=$("invDate").value||toISO(new Date());
  $("invDate").value=inv;
  const base=new Date(inv); const due=new Date(base); due.setDate(due.getDate()+days);
  $("dueDate").value=toISO(due);
}

function updateVatText(){
  const v=$("vatMode").value;
  if(v==="0"){
    $("vatHint").innerHTML = `<div class="small"><b>Hinweis:</b> Gemäß §19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).</div>`;
    $("legalNote").textContent = "Gemäß §19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).";
  }else{
    $("vatHint").innerHTML = `<div class="small"><b>Hinweis:</b> Umsatzsteuer wird gemäß Regelbesteuerung ausgewiesen (19%).</div>`;
    $("legalNote").textContent = "Umsatzsteuer wird gemäß Regelbesteuerung ausgewiesen (19%).";
  }
}

/* ========= CUSTOMERS ========= */
function getCustomers(){
  const a=safeJSON(localStorage.getItem(LS_CUSTOMERS)||"[]",[]);
  return Array.isArray(a)?a:[];
}
function setCustomers(a){localStorage.setItem(LS_CUSTOMERS,JSON.stringify(a))}
function refreshCustomerSelect(selected=""){
  const sel=$("kundeSelect");
  const list=getCustomers().slice().sort((a,b)=>(a.name||"").localeCompare(b.name||"","de"));
  sel.innerHTML=`<option value="">— Kunde wählen —</option>`+list.map(c=>{
    const n=(c.name||"").replace(/"/g,"&quot;");
    return `<option value="${n}">${n}</option>`;
  }).join("");
  sel.value=selected||"";
}
function loadCustomer(){
  const name=$("kundeSelect").value;
  const c=getCustomers().find(x=>x.name===name);
  if(!c) return;
  $("kundeName").value=c.name||"";
  $("kundeEmail").value=c.email||"";
  $("kundeText").value=c.text||"";
  saveSoon();
}
function saveCustomer(){
  const name=($("kundeName").value||"").trim();
  const email=($("kundeEmail").value||"").trim();
  const text=($("kundeText").value||"").trim();
  if(!name){alert("Bitte Kundenname eingeben.");return;}
  if(!text){alert("Bitte Kundendaten eingeben.");return;}
  const list=getCustomers();
  const idx=list.findIndex(x=>x.name===name);
  const entry={name,email,text,updatedAt:Date.now()};
  if(idx>=0) list[idx]=entry; else list.push(entry);
  setCustomers(list);
  refreshCustomerSelect(name);
  $("kundeSelect").value=name;
  saveSoon();
}
function deleteCustomer(){
  const name=$("kundeSelect").value || ($("kundeName").value||"").trim();
  if(!name){alert("Kein Kunde ausgewählt.");return;}
  if(!confirm(`Kunde "${name}" löschen?`)) return;
  const list=getCustomers().filter(x=>x.name!==name);
  setCustomers(list);
  refreshCustomerSelect("");
  $("kundeName").value=""; $("kundeEmail").value=""; $("kundeText").value="";
  saveSoon();
}

/* ========= LOGO EMBED (PDF SAFE) ========= */
async function embedLogoIfNeeded(){
  try{
    const img=$("logoImg");
    if((img.getAttribute("src")||"").startsWith("data:")) return;
    const res=await fetch("logo.png",{cache:"no-store"});
    if(!res.ok) return;
    const blob=await res.blob();
    const r=new FileReader();
    r.onload=()=>{
      img.src=String(r.result);
      $("logoImg2").src=String(r.result);
      saveSoon();
    };
    r.readAsDataURL(blob);
  }catch(e){}
}
$("logoFile").addEventListener("change",e=>{
  const f=e.target.files && e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    $("logoImg").src=String(r.result);
    $("logoImg2").src=String(r.result);
    saveSoon();
  };
  r.readAsDataURL(f);
});

/* ========= HOLIDAYS (BREMEN) OFFLINE ========= */
function easterSunday(year){
  const a=year%19;
  const b=Math.floor(year/100);
  const c=year%100;
  const d=Math.floor(b/4);
  const e=b%4;
  const f=Math.floor((b+8)/25);
  const g=Math.floor((b-f+1)/3);
  const h=(19*a + b - d - g + 15)%30;
  const i=Math.floor(c/4);
  const k=c%4;
  const l=(32 + 2*e + 2*i - h - k)%7;
  const m=Math.floor((a + 11*h + 22*l)/451);
  const month=Math.floor((h + l - 7*m + 114)/31);
  const day=((h + l - 7*m + 114)%31) + 1;
  return new Date(year, month-1, day);
}
function addDays(d, n){const x=new Date(d); x.setDate(x.getDate()+n); return x;}
function holidayKeysBremen(year){
  const keys=new Set();
  const add=(y,m,d)=>keys.add(`${y}-${pad2(m)}-${pad2(d)}`);
  add(year,1,1);
  add(year,5,1);
  add(year,10,3);
  add(year,12,25);
  add(year,12,26);
  add(year,10,31); // Reformationstag (Bremen)
  const eas=easterSunday(year);
  [addDays(eas,-2), addDays(eas,1), addDays(eas,39), addDays(eas,50)].forEach(dt=>keys.add(toISODayKey(dt)));
  return keys;
}
function isHolidayBremen(dt){
  const keys=holidayKeysBremen(dt.getFullYear());
  return keys.has(toISODayKey(dt));
}

/* ========= SHIFT AUTO CALC ========= */
function classifyHour(dt){
  if(isHolidayBremen(dt)) return "holiday";
  if(dt.getDay()===0) return "sunday";
  const h=dt.getHours() + dt.getMinutes()/60;
  if(h>=22 || h<6) return "night";
  return "base";
}
function calcShiftCategories(start,end){
  if(!(start instanceof Date) || !(end instanceof Date) || end<=start) return {base:0,night:0,sunday:0,holiday:0,total:0};
  const stepMin=15;
  let base=0, night=0, sunday=0, holiday=0;
  let cur=new Date(start);
  while(cur<end){
    const nxt=new Date(cur); nxt.setMinutes(nxt.getMinutes()+stepMin);
    const segEnd = nxt>end ? end : nxt;
    const segH = (segEnd-cur)/36e5;
    const cat = classifyHour(cur);
    if(cat==="holiday") holiday+=segH;
    else if(cat==="sunday") sunday+=segH;
    else if(cat==="night") night+=segH;
    else base+=segH;
    cur = segEnd;
  }
  const total=base+night+sunday+holiday;
  return {base:round2(base),night:round2(night),sunday:round2(sunday),holiday:round2(holiday),total:round2(total)};
}
function shiftRowTemplate(rowId){
  return `
    <tr data-id="${rowId}">
      <td><input type="datetime-local" class="s_start"></td>
      <td><input type="datetime-local" class="s_end"></td>
      <td><input type="number" class="s_ma" min="1" step="1" value="1"></td>
      <td class="right"><span class="s_hours">0.00</span></td>
      <td><button class="miniBtn danger s_del" type="button">Löschen</button></td>
    </tr>
  `;
}
function addShiftRow(data=null){
  const id="r"+Math.random().toString(16).slice(2);
  $("shiftBody").insertAdjacentHTML("beforeend", shiftRowTemplate(id));
  const tr = $("shiftBody").querySelector(`tr[data-id="${id}"]`);
  const start=tr.querySelector(".s_start");
  const end=tr.querySelector(".s_end");
  const ma=tr.querySelector(".s_ma");
  const del=tr.querySelector(".s_del");
  if(data){
    start.value=data.start||"";
    end.value=data.end||"";
    ma.value=data.ma||1;
  }
  const onChange=()=>{recalcAll(); saveSoon();};
  start.addEventListener("change",onChange);
  end.addEventListener("change",onChange);
  ma.addEventListener("input",onChange);
  del.addEventListener("click",()=>{tr.remove(); recalcAll(); saveSoon();});
  recalcAll();
}
function getShiftRows(){
  return Array.from($("shiftBody").querySelectorAll("tr")).map(tr=>{
    const start=tr.querySelector(".s_start").value;
    const end=tr.querySelector(".s_end").value;
    const ma=parseInt(tr.querySelector(".s_ma").value,10)||1;
    return {start,end,ma};
  });
}
function recalcFromShifts(){
  let hBase=0,hNight=0,hSun=0,hHol=0,hTotal=0;
  $("shiftBody").querySelectorAll("tr").forEach(tr=>{
    const s=tr.querySelector(".s_start").value;
    const e=tr.querySelector(".s_end").value;
    const ma=parseInt(tr.querySelector(".s_ma").value,10)||1;
    if(!s || !e){ tr.querySelector(".s_hours").textContent="0.00"; return; }
    const start=new Date(s);
    const end=new Date(e);
    const cats=calcShiftCategories(start,end);
    const mult=Math.max(1,ma);
    const rowTotal=round2(cats.total*mult);
    tr.querySelector(".s_hours").textContent=rowTotal.toFixed(2);
    hBase += cats.base*mult;
    hNight += cats.night*mult;
    hSun += cats.sunday*mult;
    hHol += cats.holiday*mult;
    hTotal += cats.total*mult;
  });
  hBase=round2(hBase); hNight=round2(hNight); hSun=round2(hSun); hHol=round2(hHol); hTotal=round2(hTotal);
  $("h_night").value = hNight.toFixed(2);
  $("h_sun").value   = hSun.toFixed(2);
  $("h_hol").value   = hHol.toFixed(2);
  const baseCalc = Math.max(0, round2(hTotal - (hNight+hSun+hHol)));
  $("h_base").value = baseCalc.toFixed(2);
  $("k_total").textContent = hTotal.toFixed(2);
}
function recalcSimpleMode(){
  const ma=Math.max(0,Math.floor(num($("ma_count"))));
  const per=num($("hours_per_ma"));
  const hNight=num($("h_night"));
  const hSun=num($("h_sun"));
  const hHol=num($("h_hol"));
  let total=0;
  if(ma>0 && per>0) total=ma*per;
  $("hours_total").value = total>0 ? total.toFixed(2) : "";
  const base=Math.max(0, round2(total-(hNight+hSun+hHol)));
  $("h_base").value = total>0 ? base.toFixed(2) : "0.00";
  $("k_total").textContent = (total||0).toFixed(2);
}
function calcMoney(){
  const rate=num($("rate"));
  const hBase=num($("h_base"));
  const hNight=num($("h_night"));
  const hSun=num($("h_sun"));
  const hHol=num($("h_hol"));
  $("p_night2").value = $("p_night").value;
  $("p_sun2").value   = $("p_sun").value;
  $("p_hol2").value   = $("p_hol").value;
  const pNight=num($("p_night"));
  const pSun=num($("p_sun"));
  const pHol=num($("p_hol"));
  const base=hBase*rate;
  const night=hNight*rate*(pNight/100);
  const sun=hSun*rate*(pSun/100);
  const hol=hHol*rate*(pHol/100);
  $("sum_base").textContent=money(base);
  $("sum_night").textContent=money(night);
  $("sum_sun").textContent=money(sun);
  $("sum_hol").textContent=money(hol);
  const net=Math.max(0,base+night+sun+hol);
  const vatRate=(parseFloat($("vatMode").value)||0)/100;
  const vat=net*vatRate;
  const total=net+vat;
  $("netto").textContent=money(net);
  $("vat").textContent=money(vat);
  $("total").textContent=money(total);
  $("k_net").textContent = money(net);
  $("k_all").textContent = money(total);
}

/* ========= MODE SWITCH ========= */
function applyMode(){
  const shifts = $("modeShifts").checked;
  $("shiftModeBox").style.display = shifts ? "block" : "none";
  $("simpleModeBox").style.display = shifts ? "none" : "block";
  ["h_night","h_sun","h_hol"].forEach(id=>{
    $(id).readOnly = shifts;
    $(id).style.opacity = shifts ? ".75" : "1";
  });
  recalcAll();
}

/* ========= SAVE / LOAD (CURRENT STATE) ========= */
let t;
function saveSoon(){clearTimeout(t);t=setTimeout(saveState,180);}
function collectState(){
  return {
    version:"v3",
    savedAt:Date.now(),
    logoSrc:$("logoImg").src||"logo.png",
    invDate:$("invDate").value, dueDate:$("dueDate").value, invNo:$("invNo").value,
    terms:$("terms").value, vatMode:$("vatMode").value, rate:$("rate").value, status:$("status").value,
    p_night:$("p_night").value, p_sun:$("p_sun").value, p_hol:$("p_hol").value,
    kundeSelect:$("kundeSelect").value,
    kundeName:$("kundeName").value, kundeEmail:$("kundeEmail").value, kundeText:$("kundeText").value,
    objekt:$("objekt").value, zeitraum:$("zeitraum").value, leistung:$("leistung").value, ref:$("ref").value,
    modeShifts:$("modeShifts").checked,
    ma_count: $("ma_count")?$("ma_count").value:"",
    hours_per_ma: $("hours_per_ma")?$("hours_per_ma").value:"",
    hours_total: $("hours_total")?$("hours_total").value:"",
    h_night:$("h_night").value, h_sun:$("h_sun").value, h_hol:$("h_hol").value,
    shifts:getShiftRows()
  };
}
function applyState(s){
  if(!s) return;
  if(s.logoSrc){
    $("logoImg").src=s.logoSrc; $("logoImg2").src=s.logoSrc;
  }
  $("invDate").value=s.invDate||"";
  $("dueDate").value=s.dueDate||"";
  $("invNo").value=s.invNo||"";
  $("terms").value=s.terms||"14";
  $("vatMode").value=s.vatMode||"0";
  $("rate").value=s.rate||"25";
  $("status").value=s.status||"Entwurf";
  $("p_night").value=s.p_night||"5";
  $("p_sun").value=s.p_sun||"50";
  $("p_hol").value=s.p_hol||"100";
  refreshCustomerSelect(s.kundeSelect||"");
  $("kundeName").value=s.kundeName||"";
  $("kundeEmail").value=s.kundeEmail||"";
  $("kundeText").value=s.kundeText||"";
  $("objekt").value=s.objekt||"";
  $("zeitraum").value=s.zeitraum||"";
  $("leistung").value=s.leistung||"Security Dienstleistung";
  $("ref").value=s.ref||"";
  $("modeShifts").checked = (s.modeShifts!==false);
  if($("ma_count")) $("ma_count").value=s.ma_count||"";
  if($("hours_per_ma")) $("hours_per_ma").value=s.hours_per_ma||"";
  if($("hours_total")) $("hours_total").value=s.hours_total||"";
  $("h_night").value=s.h_night||"";
  $("h_sun").value=s.h_sun||"";
  $("h_hol").value=s.h_hol||"";
  $("shiftBody").innerHTML="";
  if(Array.isArray(s.shifts) && s.shifts.length){
    s.shifts.forEach(r=>addShiftRow(r));
  }else{
    addShiftRow();
  }
  applyMode();
  recalcAll();
  saveSoon();
}
function saveState(){
  localStorage.setItem(LS_STATE,JSON.stringify(collectState()));
}
function loadState(){
  const raw=localStorage.getItem(LS_STATE);
  if(!raw) return false;
  const s=safeJSON(raw,null);
  if(!s) return false;
  applyState(s);
  return true;
}

/* ========= ARCHIVE (SAVE RECHNUNGEN) ========= */
function getArchive(){
  const a=safeJSON(localStorage.getItem(LS_ARCHIVE)||"[]",[]);
  return Array.isArray(a)?a:[];
}
function setArchive(a){localStorage.setItem(LS_ARCHIVE,JSON.stringify(a))}
function archiveAdd(){
  recalcAll(); // ensure totals are fresh
  const s=collectState();
  const totalText=$("total").textContent || "0,00 €";
  const netText=$("netto").textContent || "0,00 €";
  const kunde=(s.kundeName||s.kundeSelect||"").trim() || "—";
  const item={
    id: crypto && crypto.randomUUID ? crypto.randomUUID() : ("id_"+Date.now()+"_"+Math.random().toString(16).slice(2)),
    invNo: s.invNo || "",
    invDate: s.invDate || "",
    status: s.status || "Entwurf",
    kunde,
    net: netText,
    total: totalText,
    state: s
  };
  const list=getArchive();
  // if same invNo exists -> update
  const idx=list.findIndex(x=>x.invNo===item.invNo && item.invNo);
  if(idx>=0) list[idx]=item; else list.unshift(item);
  setArchive(list);
  renderArchive();
  alert("Rechnung im Archiv gespeichert ✓");
}
function archiveDelete(id){
  if(!confirm("Diese Rechnung löschen?")) return;
  const list=getArchive().filter(x=>x.id!==id);
  setArchive(list);
  renderArchive();
}
function archiveLoad(id){
  const item=getArchive().find(x=>x.id===id);
  if(!item) return;
  applyState(item.state);
  closeDrawer();
}
function renderArchive(){
  const list=getArchive();
  const wrap=$("archList");
  wrap.innerHTML="";
  if(!list.length){
    $("archEmpty").textContent="Keine gespeicherten Rechnungen.";
    return;
  }
  $("archEmpty").textContent="";
  list.forEach(it=>{
    const div=document.createElement("div");
    div.className="archRow";
    div.innerHTML=`
      <div>
        <div style="font-weight:900">${(it.invNo||"Ohne Nr.")} · ${it.status||""}</div>
        <div class="meta">${it.invDate||""} · Kunde: ${escapeHtml(it.kunde||"—")}</div>
      </div>
      <div>
        <div class="meta">Netto</div>
        <div style="font-weight:900">${it.net||""}</div>
      </div>
      <div>
        <div class="meta">Gesamt</div>
        <div style="font-weight:900">${it.total||""}</div>
      </div>
      <div class="archBtns">
        <button class="btn2 primary" data-act="load">Öffnen</button>
        <button class="btn2" data-act="pdf">PDF</button>
        <button class="btn2" data-act="del">Löschen</button>
      </div>
    `;
    div.querySelector('[data-act="load"]').addEventListener("click",()=>archiveLoad(it.id));
    div.querySelector('[data-act="del"]').addEventListener("click",()=>archiveDelete(it.id));
    div.querySelector('[data-act="pdf"]').addEventListener("click",async ()=>{
      // Load state first, then export PDF with invoice filename
      applyState(it.state);
      closeDrawer();
      await exportPdf(it.invNo || "Rechnung");
    });
    wrap.appendChild(div);
  });
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

/* ========= PDF EXPORT (DOWNLOAD) =========
   Uses html2pdf.js via CDN when online. If blocked/offline -> fallback to print dialog.
*/
function loadScriptOnce(src){
  return new Promise((resolve,reject)=>{
    const existing=[...document.scripts].find(s=>s.src===src);
    if(existing){resolve();return;}
    const s=document.createElement("script");
    s.src=src; s.async=true;
    s.onload=()=>resolve();
    s.onerror=()=>reject(new Error("script load failed"));
    document.head.appendChild(s);
  });
}
async function ensureHtml2Pdf(){
  if(window.html2pdf) return true;
  try{
    await loadScriptOnce("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js");
    return !!window.html2pdf;
  }catch(e){
    return false;
  }
}
async function exportPdf(filenameBase){
  // Make sure logo is embedded (data URL) so it appears in PDF
  await embedLogoIfNeeded();
  // Temporarily hide drawer if open
  $("drawer").classList.remove("open");

  const ok = await ensureHtml2Pdf();
  const name = (filenameBase||"Rechnung").replace(/[^\w\-]+/g,"_");

  if(ok){
    // Better PDF: use the #app container (includes everything). Print-only is hidden by default.
    const element = document.getElementById("app");
    const opt = {
      margin:       [10, 10, 10, 10],
      filename:     `${name}.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak:    { mode: ['css','legacy'] }
    };
    await window.html2pdf().set(opt).from(element).save();
  }else{
    alert("PDF-Download (Auto) ist offline/blockiert. Ich öffne stattdessen Drucken → 'Als PDF speichern'.");
    window.print();
  }
}

/* ========= RECALC ========= */
function recalcAll(){
  setDue();
  updateVatText();
  $("p_night2").value = $("p_night").value;
  $("p_sun2").value   = $("p_sun").value;
  $("p_hol2").value   = $("p_hol").value;
  const shifts=$("modeShifts").checked;
  if(shifts) recalcFromShifts(); else recalcSimpleMode();
  calcMoney();
}

/* ========= UI ACTIONS ========= */
function newInvoice(){
  $("invNo").value=nextInvoiceNo();
  $("invDate").value=toISO(new Date());
  setDue();
  saveSoon();
}
function openDrawer(){
  $("drawer").classList.add("open");
  renderArchive();
}
function closeDrawer(){
  $("drawer").classList.remove("open");
}
function archiveExportJson(){
  const blob = new Blob([JSON.stringify(getArchive(),null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="rechnungen-archiv.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function archiveImportJsonFile(file){
  const r=new FileReader();
  r.onload=()=>{
    const data=safeJSON(String(r.result||""),null);
    if(!Array.isArray(data)){alert("Ungültige JSON-Datei.");return;}
    // Merge by invNo or id
    const existing=getArchive();
    const map=new Map();
    existing.forEach(x=>map.set(x.id||x.invNo, x));
    data.forEach(x=>{
      if(!x) return;
      const k=x.id||x.invNo||("imp_"+Math.random());
      map.set(k,x);
    });
    const merged=[...map.values()].sort((a,b)=((b.state?.savedAt||b.savedAt||0)-(a.state?.savedAt||a.savedAt||0)));
    setArchive(merged);
    renderArchive();
    alert("Import OK ✓");
  };
  r.readAsText(file);
}

/* ========= EVENTS ========= */
$("btnNew").addEventListener("click",()=>{newInvoice(); recalcAll();});
$("btnSave").addEventListener("click",()=>{saveState(); archiveAdd();});
$("btnArchive").addEventListener("click",openDrawer);
$("btnCloseDrawer").addEventListener("click",closeDrawer);
$("drawer").addEventListener("click",(e)=>{ if(e.target===e.currentTarget) closeDrawer(); });

$("btnExportJson").addEventListener("click",archiveExportJson);
$("btnImportJson").addEventListener("click",()=>$("importFile").click());
$("importFile").addEventListener("change",(e)=>{
  const f=e.target.files && e.target.files[0];
  if(f) archiveImportJsonFile(f);
  e.target.value="";
});

$("btnReset").addEventListener("click",()=>{
  if(!confirm("Reset? (Eingaben löschen, Kundenliste + Archiv bleiben)")) return;
  localStorage.removeItem(LS_STATE);
  location.reload();
});
$("btnPdf").addEventListener("click",async ()=>{ await exportPdf($("invNo").value || "Rechnung"); });

$("kundeSelect").addEventListener("change",loadCustomer);
$("btnKundeNew").addEventListener("click",()=>{$("kundeSelect").value="";$("kundeName").value="";$("kundeEmail").value="";$("kundeText").value="";saveSoon();});
$("btnKundeSave").addEventListener("click",saveCustomer);
$("btnKundeDelete").addEventListener("click",deleteCustomer);

$("modeShifts").addEventListener("change",applyMode);

["invDate","terms","vatMode","rate","status"].forEach(id=>$(id).addEventListener("change",()=>{recalcAll(); saveSoon();}));
["p_night","p_sun","p_hol"].forEach(id=>$(id).addEventListener("input",()=>{recalcAll(); saveSoon();}));

["h_night","h_sun","h_hol"].forEach(id=>{
  $(id).addEventListener("input",()=>{ if(!$("modeShifts").checked){recalcAll();} saveSoon(); });
});
["kundeName","kundeEmail","kundeText","objekt","zeitraum","leistung","ref"].forEach(id=>{
  $(id).addEventListener("input",saveSoon);
});

$("btnAddShift").addEventListener("click",()=>addShiftRow());
$("btnDemoShift").addEventListener("click",()=>{
  $("shiftBody").innerHTML="";
  addShiftRow({start:"2026-01-01T18:00", end:"2026-01-02T06:00", ma:5});
  addShiftRow({start:"2026-01-04T18:00", end:"2026-01-05T06:00", ma:5});
  addShiftRow({start:"2026-01-11T18:00", end:"2026-01-12T06:00", ma:5});
  addShiftRow({start:"2026-01-18T18:00", end:"2026-01-19T06:00", ma:5});
  addShiftRow({start:"2026-01-25T18:00", end:"2026-01-26T06:00", ma:5});
  recalcAll(); saveSoon();
});

/* ========= INIT ========= */
(function init(){
  refreshCustomerSelect("");
  const loaded = loadState();
  if(!loaded){
    addShiftRow();
    newInvoice();
    $("leistung").value="Security Dienstleistung";
  }
  setDue();
  updateVatText();
  embedLogoIfNeeded();
  $("holidayInfo").textContent = `Feiertage: Bremen (${new Date().getFullYear()})`;
  applyMode();
  recalcAll();
})();
</script>
</body>
</html>
