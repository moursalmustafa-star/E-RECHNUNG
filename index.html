<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Masculine Security ‚Äî B2B Rechnung (1 Datei)</title>

  <!-- PDF (stable) -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --brand:#0b5fa8;
      --brand2:#0a4d86;
      --bg:#f6f8fc;
      --card:#ffffff;
      --ink:#0b1220;
      --muted:#64748b;
      --line:#e2e8f0;
      --r:16px;
      --shadow:0 18px 50px rgba(15,23,42,.10);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1000px 500px at 10% -10%, rgba(11,95,168,.16), transparent 55%),
        radial-gradient(900px 500px at 90% 0%, rgba(10,77,134,.12), transparent 55%),
        var(--bg);
    }

    /* TOPBAR */
    .top{
      position:sticky; top:0; z-index:9;
      background:rgba(255,255,255,.90);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(226,232,240,.9);
    }
    .topInner{max-width:1180px;margin:0 auto;padding:12px 12px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;min-width:260px}
    .logo{
      width:44px;height:44px;border-radius:14px;overflow:hidden;
      border:1px solid rgba(11,95,168,.18);
      background:linear-gradient(180deg, rgba(11,95,168,.12), rgba(11,95,168,.04));
      box-shadow:0 10px 26px rgba(15,23,42,.08);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:950;color:#0a2540;line-height:1.1}
    .sub{font-size:12px;color:var(--muted)}
    .actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    button{
      border:1px solid var(--line);
      background:#fff;
      color:#0a2540;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: box-shadow .15s ease, transform .06s ease;
    }
    button:hover{box-shadow:0 10px 24px rgba(15,23,42,.10)}
    button:active{transform:translateY(1px)}
    button.primary{
      background:linear-gradient(180deg, var(--brand), var(--brand2));
      color:#fff;border-color:rgba(11,95,168,.28);
      box-shadow:0 14px 32px rgba(11,95,168,.22);
    }
    button.ok{
      background:linear-gradient(180deg, #17b897, #12a988);
      color:#fff;border-color:rgba(18,169,136,.28);
      box-shadow:0 14px 32px rgba(18,169,136,.20);
    }
    button.danger{
      background:linear-gradient(180deg, #ff4d6d, #e11d48);
      color:#fff;border-color:rgba(225,29,72,.28);
      box-shadow:0 14px 32px rgba(225,29,72,.18);
    }

    .chips{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;font-size:12px;color:var(--muted)}
    .chipLink{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:#fff;color:#0a2540;font-weight:900;text-decoration:none;
      box-shadow:0 8px 20px rgba(15,23,42,.06);
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:#fff;color:var(--muted);font-weight:800;
      box-shadow:0 8px 20px rgba(15,23,42,.06);
    }
    .dot{width:8px;height:8px;border-radius:99px;background:#22c55e}

    /* LAYOUT */
    .wrap{max-width:1180px;margin:0 auto;padding:14px 12px 60px}
    .grid{display:grid;gap:14px;margin-top:14px}
    @media(min-width:1000px){.grid{grid-template-columns:1.25fr .75fr}}
    .card{
      background:var(--card);
      border:1px solid rgba(226,232,240,.95);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;padding:14px 16px;
      font-size:13px;color:#0a2540;font-weight:950;
      background:linear-gradient(180deg,#fff,#fbfdff);
      border-bottom:1px solid rgba(226,232,240,.95);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .body{padding:14px 16px}
    .row2{display:grid;gap:10px}
    @media(min-width:760px){.row2{grid-template-columns:1fr 1fr}}
    .row3{display:grid;gap:10px}
    @media(min-width:760px){.row3{grid-template-columns:1fr 1fr 1fr}}
    label{display:block;font-size:12px;color:var(--muted);font-weight:800;margin:0 0 6px}
    input,select,textarea{
      width:100%;
      border:1px solid rgba(226,232,240,.98);
      border-radius:14px;
      padding:11px 12px;
      background:#fff;
      outline:none;
      font:inherit;
    }
    input:focus,select:focus,textarea:focus{
      border-color:rgba(11,95,168,.45);
      box-shadow:0 0 0 4px rgba(11,95,168,.10);
    }
    textarea{min-height:88px;resize:vertical}
    .mono{font-family:var(--mono)}
    .hr{height:1px;background:rgba(226,232,240,.95);margin:12px 0}
    .note{
      font-size:12px;color:var(--muted);
      border:1px solid rgba(226,232,240,.98);
      background:linear-gradient(180deg,#fff,#fbfdff);
      border-radius:14px;
      padding:10px;
    }

    /* KPI + TABLE */
    .kpi{display:grid;gap:10px}
    @media(min-width:760px){.kpi{grid-template-columns:1fr 1fr}}
    .kpi .box{
      border:1px solid rgba(226,232,240,.98);
      border-radius:16px;
      padding:12px;background:linear-gradient(180deg,#fff,#fbfdff);
    }
    .kpi .big{font-size:22px;font-weight:950}
    .kpi .small{font-size:12px;color:var(--muted);font-weight:800}
    table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      border:1px solid rgba(226,232,240,.98);
      border-radius:16px;overflow:hidden;
      background:#fff;
    }
    th,td{padding:10px;border-bottom:1px solid rgba(226,232,240,.98);font-size:13px}
    th{background:#f7fafc;text-align:left;font-weight:950;color:#0a2540}
    tr:last-child td{border-bottom:0}
    .right{text-align:right}
    .list{display:grid;gap:10px}
    .item{
      border:1px solid rgba(226,232,240,.98);
      border-radius:16px;padding:12px;
      display:flex;gap:12px;justify-content:space-between;align-items:flex-start;
      box-shadow:0 10px 26px rgba(15,23,42,.06);
      background:#fff;
    }
    .item small{color:var(--muted)}
    .item .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .item .btns button{border-radius:12px}

    /* ===== A4 PRINT/PDF TEMPLATE ===== */
    @page { size: A4; margin: 10mm; }
    #printWrap{display:none;background:#fff}
    #invoiceA4{
      width:190mm; /* A4 - margins */
      margin:0 auto;
      background:#fff;
      color:#111;
      padding:0;
    }
    .a4Header{display:flex;justify-content:space-between;gap:14px;align-items:flex-start}
    .a4Left{display:flex;gap:10px;align-items:center}
    .a4Logo{width:50px;height:50px;border-radius:16px;overflow:hidden;border:1px solid #e5e8ef;flex:0 0 auto}
    .a4Logo img{width:100%;height:100%;object-fit:cover}
    .a4Title{margin:0;font-size:22px;font-weight:950}
    .a4Meta{font-size:12px;color:#334155;line-height:1.35}
    .a4Box{border:1px solid #e5e8ef;border-radius:16px;padding:10px}
    .a4Box h4{margin:0 0 8px;font-size:12px;color:#0a2540}
    .a4Line{display:flex;justify-content:space-between;gap:10px;font-size:12px;margin:4px 0}
    .a4Grid2{display:grid;gap:10px;margin-top:12px;grid-template-columns:1fr 1fr}
    .a4Table{width:100%;border-collapse:collapse;margin-top:10px}
    .a4Table th,.a4Table td{border:1px solid #e5e8ef;padding:7px;font-size:12px}
    .a4Table th{background:#f5f7fb;text-align:left}
    .a4Right{text-align:right}
    .a4Totals{display:grid;gap:6px;margin-top:10px}
    .a4Totals .tline{display:flex;justify-content:space-between;font-size:12px}
    .a4Totals .grand{font-size:14px;font-weight:950}
    .a4Footer{margin-top:12px;font-size:11px;color:#334155;line-height:1.35}

    @media print{
      body{background:#fff}
      .top,.wrap{display:none!important}
      #printWrap{display:block!important}
    }
  </style>
</head>

<body>
  <!-- TOPBAR -->
  <div class="top">
    <div class="topInner">
      <div class="row">
        <div class="brand">
          <div class="logo" title="Festes Logo (lokal gespeichert)">
            <img id="logoImg" alt="Logo"/>
          </div>
          <div>
            <div class="title" id="topBrand">Masculine Security</div>
            <div class="sub">B2B Rechnung ‚Ä¢ Positionslogik wie Firmen ‚Ä¢ Stabil & einfach</div>
          </div>
        </div>

        <div class="actions">
          <button type="button" id="btnLogo">Logo √§ndern</button>
          <button type="button" id="btnNew">Neu</button>
          <button type="button" class="ok" id="btnSave">Rechnung speichern</button>
          <button type="button" id="btnRefreshLists">Listen</button>
          <button type="button" class="danger" id="btnReset">Reset</button>
          <button type="button" class="primary" id="btnPdf">PDF</button>
          <button type="button" class="primary" id="btnPrint">Print</button>
        </div>
      </div>

      <div class="chips">
        <span class="badge"><span class="dot"></span> Auto-Save</span>
        <a class="chipLink" id="telLink" href="tel:015778697052">üìû <span id="telText">015778697052</span></a>
        <a class="chipLink" id="mailLink" href="mailto:Kontakt.mass.bremen@hotmail.com">‚úâÔ∏è <span id="mailText">Kontakt.mass.bremen@hotmail.com</span></a>
        <span class="badge">B2B ‚Ä¢ Positions-Rechnung</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- FORM -->
      <div class="card" id="viewForm">
        <h2><span>Rechnung erstellen</span><span class="badge" id="status">Bereit</span></h2>
        <div class="body">

          <!-- ISSUER -->
          <div class="row2">
            <div>
              <label>Rechnungssteller (Firma) *</label>
              <input id="issuerCompany" value="Masculine Security"/>
            </div>
            <div>
              <label>Adresse *</label>
              <input id="issuerAddress" value="Werschenregerstra√üe 6 ‚Ä¢ 28237 Bremen"/>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Telefon</label>
              <input id="issuerPhone" value="015778697052"/>
            </div>
            <div>
              <label>E-Mail *</label>
              <input id="issuerEmail" value="Kontakt.mass.bremen@hotmail.com"/>
            </div>
          </div>

          <div class="row3" style="margin-top:10px">
            <div>
              <label>Steuernummer / Hinweis *</label>
              <input id="issuerTax" value="wird nachgereicht"/>
            </div>
            <div>
              <label>USt-IdNr (optional)</label>
              <input id="issuerVatId" placeholder="DE123456789"/>
            </div>
            <div>
              <label>USt-Status *</label>
              <select id="vatMode">
                <option value="kmu">Kleinunternehmer (¬ß19)</option>
                <option value="vat19">USt 19%</option>
              </select>
            </div>
          </div>

          <div class="row3" style="margin-top:10px">
            <div>
              <label>IBAN *</label>
              <input id="iban" value="DE98 1001 1001 2333 0146 96"/>
            </div>
            <div>
              <label>BIC *</label>
              <input id="bic" value="NTSBDEB1XXX"/>
            </div>
            <div>
              <label>Kontoinhaber *</label>
              <input id="holder" value="MUSTAFA MURSAL ABDI"/>
            </div>
          </div>

          <div class="hr"></div>

          <!-- CUSTOMER (100% working) -->
          <div class="row2">
            <div>
              <label>Kunde w√§hlen (100% funktioniert)</label>
              <select id="customerSelect"></select>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
                <button type="button" id="btnSaveCustomer">Kunde speichern</button>
                <button type="button" class="danger" id="btnDeleteCustomer">Kunde l√∂schen</button>
              </div>
              <div class="note" style="margin-top:10px">
                Workflow: Kundendaten eintragen ‚Üí <b>Kunde speichern</b> ‚Üí danach im Dropdown ausw√§hlen.
              </div>
            </div>

            <div>
              <label>Rechnungsempf√§nger (Kundenname) *</label>
              <input id="custName" placeholder="Firma / Name"/>
              <div class="row2" style="margin-top:10px">
                <div>
                  <label>E-Mail (optional)</label>
                  <input id="custEmail" placeholder="kunde@email.de"/>
                </div>
                <div>
                  <label>Ansprechpartner (optional)</label>
                  <input id="custContact" placeholder="Ansprechpartner"/>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Kundenadresse (B2B) *</label>
            <textarea id="custAddress" placeholder="Stra√üe ‚Ä¢ PLZ Ort&#10;Ansprechpartner"></textarea>
          </div>

          <div class="hr"></div>

          <!-- INVOICE META -->
          <div class="row3">
            <div>
              <label>Rechnungsdatum *</label>
              <input id="invDate" type="date"/>
            </div>
            <div>
              <label>F√§llig am *</label>
              <input id="dueDate" type="date"/>
            </div>
            <div>
              <label>Rechnungsnummer *</label>
              <input id="invNo" class="mono"/>
            </div>
          </div>

          <div class="row3" style="margin-top:10px">
            <div>
              <label>Leistungsdatum (optional)</label>
              <input id="serviceDate" placeholder="z.B. 25.02.2026"/>
            </div>
            <div>
              <label>Objekt / Ort (optional)</label>
              <input id="objekt" placeholder="z.B. Bremen"/>
            </div>
            <div>
              <label>Zeitraum (optional)</label>
              <input id="zeitraum" placeholder="z.B. 08.03.2026 ‚Äì 09.03.2026"/>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Leistungsbeschreibung *</label>
              <input id="serviceTitle" value="Sicherheitsdienstleistung ‚Äì Objektschutz"/>
            </div>
            <div>
              <label>Verwendungszweck (auto)</label>
              <input id="purpose" class="mono" readonly/>
            </div>
          </div>

          <div class="hr"></div>

          <!-- B2B POSITIONS (1:1 style) -->
          <div class="row2">
            <div>
              <label>Anzahl Mitarbeiter *</label>
              <input id="mCount" type="number" min="0" value="5"/>
            </div>
            <div>
              <label>Einheit</label>
              <input id="unit" value="Std."/>
            </div>
          </div>

          <div class="note" style="margin-top:10px">
            <b>Positions-Logik wie B2B Firmen:</b> Position ‚Üí Menge (Stunden) ‚Üí Einzelpreis ‚Üí Betrag.
            Mitarbeiter wird automatisch multipliziert.
          </div>

          <div class="hr"></div>

          <div class="row3">
            <div>
              <label>Tag (‚Ç¨/Std.)</label>
              <input id="pTag" type="number" step="0.01" value="23"/>
              <label style="margin-top:10px">Tag Stunden</label>
              <input id="hTag" type="number" step="0.25" value="0"/>
            </div>
            <div>
              <label>Nacht (‚Ç¨/Std.)</label>
              <input id="pNacht" type="number" step="0.01" value="24"/>
              <label style="margin-top:10px">Nacht Stunden</label>
              <input id="hNacht" type="number" step="0.25" value="0"/>
            </div>
            <div>
              <label>Sonntag (‚Ç¨/Std.)</label>
              <input id="pSonntag" type="number" step="0.01" value="32"/>
              <label style="margin-top:10px">Sonntag Stunden</label>
              <input id="hSonntag" type="number" step="0.25" value="0"/>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Feiertag (‚Ç¨/Std.)</label>
              <input id="pFeiertag" type="number" step="0.01" value="36"/>
            </div>
            <div>
              <label>Feiertag Stunden</label>
              <input id="hFeiertag" type="number" step="0.25" value="0"/>
            </div>
          </div>

          <div class="note" style="margin-top:10px">
            Hinweis: Stunden nur in <b>eine</b> Kategorie eintragen (keine Doppelz√§hlung).
          </div>

          <div class="hr"></div>

          <div class="row2">
            <div>
              <label>Notiz / Hinweis (optional)</label>
              <textarea id="note" placeholder="z.B. laut Vereinbarung / Ansprechpartner / Einsatzzeiten..."></textarea>
            </div>
            <div>
              <label>Zahlungsbedingungen (optional)</label>
              <textarea id="paymentTerms" placeholder="z.B. Zahlbar ohne Abzug bis F√§lligkeitsdatum."></textarea>
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT: SUMMARY + LISTS -->
      <div class="card">
        <h2><span>Summe & Listen</span><span class="badge mono" id="modeBadge">B2B</span></h2>
        <div class="body">

          <div class="kpi">
            <div class="box">
              <div class="small">Zwischensumme (netto)</div>
              <div class="big mono" id="subTotal">0,00 ‚Ç¨</div>
            </div>
            <div class="box">
              <div class="small">Gesamt (brutto)</div>
              <div class="big mono" id="grandTotal">0,00 ‚Ç¨</div>
            </div>
          </div>

          <div class="hr"></div>

          <table>
            <thead>
              <tr>
                <th>Pos.</th>
                <th>Bezeichnung</th>
                <th class="right">Menge</th>
                <th class="right">Einzelpreis</th>
                <th class="right">Betrag</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="mono">1</td><td>Tagdienst</td>
                <td class="right mono" id="tQty1">0</td>
                <td class="right mono" id="tP1">0,00 ‚Ç¨</td>
                <td class="right mono" id="tS1">0,00 ‚Ç¨</td>
              </tr>
              <tr>
                <td class="mono">2</td><td>Nachtdienst</td>
                <td class="right mono" id="tQty2">0</td>
                <td class="right mono" id="tP2">0,00 ‚Ç¨</td>
                <td class="right mono" id="tS2">0,00 ‚Ç¨</td>
              </tr>
              <tr>
                <td class="mono">3</td><td>Sonntag</td>
                <td class="right mono" id="tQty3">0</td>
                <td class="right mono" id="tP3">0,00 ‚Ç¨</td>
                <td class="right mono" id="tS3">0,00 ‚Ç¨</td>
              </tr>
              <tr>
                <td class="mono">4</td><td>Feiertag</td>
                <td class="right mono" id="tQty4">0</td>
                <td class="right mono" id="tP4">0,00 ‚Ç¨</td>
                <td class="right mono" id="tS4">0,00 ‚Ç¨</td>
              </tr>
            </tbody>
          </table>

          <div class="hr"></div>

          <div class="note">
            <b>Formel:</b> Betrag = <span class="mono">Mitarbeiter √ó Stunden √ó Einzelpreis</span>
            <div class="mono" style="margin-top:6px" id="formulaLine">5 √ó 0 √ó 23,00 ‚Ç¨</div>
          </div>

          <div class="hr"></div>

          <div class="row2">
            <div>
              <h3 style="margin:0 0 8px;font-size:13px;color:#0a2540">Rechnungen</h3>
              <div class="list" id="invList"></div>
            </div>
            <div>
              <h3 style="margin:0 0 8px;font-size:13px;color:#0a2540">Kunden</h3>
              <div class="list" id="custList"></div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- PRINT/PDF WRAP -->
  <div id="printWrap">
    <div id="invoiceA4"></div>
  </div>

  <!-- Logo upload -->
  <input id="logoFile" type="file" accept="image/*" style="display:none"/>

  <script>
    // =========================
    // 100% STABLE B2B APP CORE
    // =========================

    const VERSION = "b2b_rechnung_v1_0001"; // change only if you want fresh storage
    const KEY = {
      LOGO: `${VERSION}:logo`,
      CUSTOMERS: `${VERSION}:customers`,
      INVOICES: `${VERSION}:invoices`,
      COUNTERS: `${VERSION}:counters`,
      AUTOSAVE: `${VERSION}:autosave`
    };

    const $ = (id)=>document.getElementById(id);

    // ---------- helpers ----------
    const fmtEUR = (n)=>{
      const v = Number(n||0);
      return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨";
    };
    const safeNum = (v)=> {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };
    const todayISO = ()=>{
      const d=new Date();
      const yyyy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const addDaysISO=(iso,days)=>{
      const d=new Date(iso+"T00:00:00");
      d.setDate(d.getDate()+days);
      const yyyy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const yyyymmdd=(iso)=>String(iso||"").replaceAll("-","");
    const loadJSON=(k,fallback)=>{
      try{const v=localStorage.getItem(k);return v?JSON.parse(v):fallback;}catch(e){return fallback;}
    };
    const saveJSON=(k,v)=>localStorage.setItem(k, JSON.stringify(v));

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

    function setStatus(txt, ok=true){
      $("status").innerHTML = (ok?`<span class="dot"></span> `:`‚ö†Ô∏è `) + escapeHtml(txt);
      $("status").style.borderColor = ok ? "rgba(34,197,94,.25)" : "rgba(225,29,72,.25)";
    }

    // ---------- logo ----------
    function setLogo(dataUrl, persist=true){
      $("logoImg").src = dataUrl;
      if(persist) localStorage.setItem(KEY.LOGO, dataUrl);
    }
    function loadLogo(){
      const saved = localStorage.getItem(KEY.LOGO);
      if(saved){ setLogo(saved,false); return; }
      const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="120" height="120" rx="24" fill="#0b5fa8"/><text x="60" y="72" font-size="54" text-anchor="middle" fill="white" font-family="Arial" font-weight="900">M</text></svg>`);
      setLogo(`data:image/svg+xml,${svg}`, false);
    }

    // ---------- invoice number ----------
    function nextInvoiceNo(dateISO){
      const counters = loadJSON(KEY.COUNTERS,{});
      const d = yyyymmdd(dateISO || todayISO());
      const cur = safeNum(counters[d]) || 0;
      const next = cur + 1;
      counters[d]=next;
      saveJSON(KEY.COUNTERS,counters);
      return `MS-${d}-${String(next).padStart(4,"0")}`;
    }
    function updatePurpose(){
      $("purpose").value = `Rechnung: ${$("invNo").value||""}`;
    }

    // ---------- clickable contacts ----------
    function syncContacts(){
      const company = String($("issuerCompany").value||"Masculine Security").trim();
      $("topBrand").textContent = company || "Masculine Security";

      const tel = String($("issuerPhone").value||"").replace(/\s+/g,"");
      const mail = String($("issuerEmail").value||"").trim();

      if(tel){
        $("telLink").href = `tel:${tel}`;
        $("telText").textContent = tel;
      }
      if(mail){
        $("mailLink").href = `mailto:${mail}`;
        $("mailText").textContent = mail;
      }
    }

    // ---------- customers (100% working) ----------
    function customers(){ return loadJSON(KEY.CUSTOMERS, []); }
    function saveCustomers(arr){ saveJSON(KEY.CUSTOMERS, arr); }

    function cryptoId(){
      if(window.crypto?.getRandomValues){
        const a=new Uint32Array(2);
        window.crypto.getRandomValues(a);
        return a[0].toString(16)+a[1].toString(16);
      }
      return String(Date.now()) + Math.random().toString(16).slice(2);
    }

    function refreshCustomerSelect(selectedId=""){
      const list = customers();
      const sel = $("customerSelect");
      sel.innerHTML = "";
      const o0=document.createElement("option");
      o0.value=""; o0.textContent="‚Äî ausw√§hlen ‚Äî";
      sel.appendChild(o0);

      for(const c of list){
        const o=document.createElement("option");
        o.value=c.id;
        o.textContent=c.name;
        sel.appendChild(o);
      }
      sel.value = selectedId || "";
      renderCustomerList();
    }

    function saveCustomer(){
      const name = String($("custName").value||"").trim();
      const addr = String($("custAddress").value||"").trim();
      if(!name || !addr){ setStatus("Kunde: Name/Adresse fehlt", false); return; }

      const list = customers();
      const id = cryptoId();
      list.unshift({
        id,
        name,
        email: String($("custEmail").value||"").trim(),
        contact: String($("custContact").value||"").trim(),
        address: addr
      });
      saveCustomers(list);
      refreshCustomerSelect(id);
      setStatus("Kunde gespeichert", true);
    }

    function loadCustomerById(id){
      if(!id) return;
      const c = customers().find(x=>x.id===id);
      if(!c) return;
      $("custName").value = c.name || "";
      $("custEmail").value = c.email || "";
      $("custContact").value = c.contact || "";
      $("custAddress").value = c.address || "";
      setStatus("Kunde geladen", true);
      autoSave();
    }

    function deleteCustomer(){
      const id = $("customerSelect").value;
      if(!id){ setStatus("Kein Kunde ausgew√§hlt", false); return; }
      const list = customers().filter(x=>x.id!==id);
      saveCustomers(list);
      refreshCustomerSelect("");
      setStatus("Kunde gel√∂scht", true);
    }

    function renderCustomerList(){
      const wrap = $("custList");
      const list = customers();
      wrap.innerHTML = "";
      for(const c of list.slice(0,12)){
        const el=document.createElement("div");
        el.className="item";
        el.innerHTML = `
          <div>
            <b>${escapeHtml(c.name)}</b><br/>
            <small>${escapeHtml((c.address||"").slice(0,90))}${(c.address||"").length>90?"‚Ä¶":""}</small>
          </div>
          <div class="btns">
            <button type="button" data-id="${escapeAttr(c.id)}">W√§hlen</button>
          </div>
        `;
        wrap.appendChild(el);
      }
      wrap.querySelectorAll("button[data-id]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id=b.getAttribute("data-id");
          $("customerSelect").value=id;
          loadCustomerById(id);
        });
      });
    }

    // ---------- invoices ----------
    function invoices(){ return loadJSON(KEY.INVOICES, []); }
    function saveInvoices(arr){ saveJSON(KEY.INVOICES, arr); }

    function requiredOk(){
      const must = [
        ["issuerCompany","Rechnungssteller"],["issuerAddress","Adresse"],["issuerEmail","E-Mail"],
        ["issuerTax","Steuernr./Hinweis"],["iban","IBAN"],["bic","BIC"],["holder","Kontoinhaber"],
        ["custName","Kunde"],["custAddress","Kundenadresse"],
        ["invDate","Rechnungsdatum"],["dueDate","F√§lligkeit"],["invNo","Rechnungsnummer"],
        ["serviceTitle","Leistungsbeschreibung"]
      ];
      for(const [id,label] of must){
        if(!String($(id).value||"").trim()){
          setStatus(`Fehlt: ${label}`, false);
          return false;
        }
      }
      return true;
    }

    function collectForm(){
      const ids = [
        "issuerCompany","issuerAddress","issuerPhone","issuerEmail","issuerTax","issuerVatId","vatMode",
        "iban","bic","holder",
        "custName","custEmail","custContact","custAddress",
        "invDate","dueDate","invNo","purpose",
        "serviceTitle","serviceDate","objekt","zeitraum",
        "mCount","unit",
        "pTag","pNacht","pSonntag","pFeiertag",
        "hTag","hNacht","hSonntag","hFeiertag",
        "note","paymentTerms"
      ];
      const f={};
      ids.forEach(id=>f[id]=$(id).value);
      f.logo = $("logoImg").src||"";
      f.subTotal = $("subTotal").textContent;
      f.grandTotal = $("grandTotal").textContent;
      return f;
    }

    function saveInvoice(){
      if(!requiredOk()) return;
      const f=collectForm();
      const list=invoices();
      const idx=list.findIndex(x=>x.invNo===f.invNo);
      if(idx>=0) list[idx]=f; else list.unshift(f);
      saveInvoices(list);
      setStatus("Rechnung gespeichert", true);
      renderInvoiceList();
    }

    function loadInvoice(no){
      const inv = invoices().find(x=>x.invNo===no);
      if(!inv){ setStatus("Rechnung nicht gefunden", false); return; }
      Object.entries(inv).forEach(([k,v])=>{ if($(k)) $(k).value = v; });
      if(inv.logo) setLogo(inv.logo, true);
      syncContacts();
      updatePurpose();
      calculate();
      setStatus("Rechnung geladen", true);
    }

    function deleteInvoice(no){
      const list=invoices().filter(x=>x.invNo!==no);
      saveInvoices(list);
      renderInvoiceList();
      setStatus("Rechnung gel√∂scht", true);
    }

    function renderInvoiceList(){
      const wrap=$("invList");
      const list=invoices();
      wrap.innerHTML="";
      for(const inv of list.slice(0,12)){
        const el=document.createElement("div");
        el.className="item";
        el.innerHTML=`
          <div>
            <b class="mono">${escapeHtml(inv.invNo||"")}</b><br/>
            <small>${escapeHtml(inv.invDate||"")} ‚Ä¢ ${escapeHtml(inv.custName||"")}</small><br/>
            <small class="mono">Gesamt: ${escapeHtml(inv.grandTotal||"")}</small>
          </div>
          <div class="btns">
            <button type="button" data-act="load" data-no="${escapeAttr(inv.invNo)}">Load</button>
            <button type="button" data-act="pdf" data-no="${escapeAttr(inv.invNo)}">PDF</button>
            <button type="button" class="danger" data-act="del" data-no="${escapeAttr(inv.invNo)}">Del</button>
          </div>
        `;
        wrap.appendChild(el);
      }
      wrap.querySelectorAll("button[data-act]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const act=b.getAttribute("data-act");
          const no=b.getAttribute("data-no");
          if(act==="load") loadInvoice(no);
          if(act==="del") deleteInvoice(no);
          if(act==="pdf"){
            const inv=invoices().find(x=>x.invNo===no);
            if(inv) await exportPdfFromForm(inv);
          }
        });
      });
    }

    // ---------- calculation (B2B positions) ----------
    function calculate(){
      syncContacts();
      updatePurpose();

      const m=safeNum($("mCount").value);
      const unit = String($("unit").value||"Std.").trim() || "Std.";

      const h1=safeNum($("hTag").value);
      const h2=safeNum($("hNacht").value);
      const h3=safeNum($("hSonntag").value);
      const h4=safeNum($("hFeiertag").value);

      const p1=safeNum($("pTag").value);
      const p2=safeNum($("pNacht").value);
      const p3=safeNum($("pSonntag").value);
      const p4=safeNum($("pFeiertag").value);

      const s1=m*h1*p1, s2=m*h2*p2, s3=m*h3*p3, s4=m*h4*p4;
      const sub=s1+s2+s3+s4;

      const vatMode=$("vatMode").value;
      const vatRate = (vatMode==="vat19")?0.19:0;
      const vatAmount=sub*vatRate;
      const grand=sub+vatAmount;

      // quantities shown as "Std. √ó Mitarbeiter" style like firms
      $("tQty1").textContent = `${h1} ${unit} √ó ${m}`;
      $("tQty2").textContent = `${h2} ${unit} √ó ${m}`;
      $("tQty3").textContent = `${h3} ${unit} √ó ${m}`;
      $("tQty4").textContent = `${h4} ${unit} √ó ${m}`;

      $("tP1").textContent = fmtEUR(p1);
      $("tP2").textContent = fmtEUR(p2);
      $("tP3").textContent = fmtEUR(p3);
      $("tP4").textContent = fmtEUR(p4);

      $("tS1").textContent = fmtEUR(s1);
      $("tS2").textContent = fmtEUR(s2);
      $("tS3").textContent = fmtEUR(s3);
      $("tS4").textContent = fmtEUR(s4);

      $("subTotal").textContent = fmtEUR(sub);
      $("grandTotal").textContent = fmtEUR(grand);

      $("formulaLine").textContent = `${m} √ó ${h1} √ó ${fmtEUR(p1)}`;

      autoSave();
    }

    // ---------- autosave ----------
    let autosaveTimer=null;
    function autoSave(){
      clearTimeout(autosaveTimer);
      autosaveTimer=setTimeout(()=>saveJSON(KEY.AUTOSAVE, collectForm()), 250);
    }
    function restoreAutoSave(){
      const f=loadJSON(KEY.AUTOSAVE,null);
      if(!f) return;
      Object.entries(f).forEach(([k,v])=>{ if($(k)) $(k).value=v; });
      if(f.logo) setLogo(f.logo,false);
    }

    // ---------- A4 build ----------
    function buildA4Html(f){
      const company=escapeHtml(f.issuerCompany||"");
      const logo = f.logo ? `<div class="a4Logo"><img src="${escapeAttr(f.logo)}"/></div>` : "";

      const vatMode=f.vatMode;
      const vatText = (vatMode==="kmu")
        ? "Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet."
        : "Umsatzsteuer 19% wird berechnet und ausgewiesen.";

      const m=safeNum(f.mCount);
      const unit=String(f.unit||"Std.").trim() || "Std.";

      const h1=safeNum(f.hTag), h2=safeNum(f.hNacht), h3=safeNum(f.hSonntag), h4=safeNum(f.hFeiertag);
      const p1=safeNum(f.pTag), p2=safeNum(f.pNacht), p3=safeNum(f.pSonntag), p4=safeNum(f.pFeiertag);

      const s1=m*h1*p1, s2=m*h2*p2, s3=m*h3*p3, s4=m*h4*p4;
      const sub=s1+s2+s3+s4;
      const vatRate=(vatMode==="vat19")?0.19:0;
      const vatAmount=sub*vatRate;
      const grand=sub+vatAmount;

      const custAddr=escapeHtml(f.custAddress||"").replaceAll("\n","<br/>");
      const note=escapeHtml(f.note||"");
      const terms=escapeHtml(f.paymentTerms||"");

      const obj=escapeHtml(f.objekt||"");
      const zr=escapeHtml(f.zeitraum||"");
      const sdate=escapeHtml(f.serviceDate||"");

      return `
        <div>
          <div class="a4Header">
            <div class="a4Left">
              ${logo}
              <div>
                <p class="a4Title">Rechnung</p>
                <div class="a4Meta"><b>${company}</b></div>
                <div class="a4Meta"><b>${escapeHtml(f.serviceTitle||"")}</b></div>
                ${obj?`<div class="a4Meta">Objekt/Ort: ${obj}</div>`:""}
                ${zr?`<div class="a4Meta">Zeitraum: ${zr}</div>`:""}
                ${sdate?`<div class="a4Meta">Leistungsdatum: ${sdate}</div>`:""}
              </div>
            </div>

            <div class="a4Box" style="min-width:270px">
              <div class="a4Line"><span><b>Rechnungsnr.</b></span><span class="mono">${escapeHtml(f.invNo||"")}</span></div>
              <div class="a4Line"><span>Rechnungsdatum</span><span>${escapeHtml(f.invDate||"")}</span></div>
              <div class="a4Line"><span>F√§llig am</span><span>${escapeHtml(f.dueDate||"")}</span></div>
              <div class="a4Line"><span>Verwendungszweck</span><span class="mono">${escapeHtml(f.purpose||"")}</span></div>
            </div>
          </div>

          <div class="a4Grid2">
            <div class="a4Box">
              <h4>Rechnungssteller</h4>
              <div class="a4Meta"><b>${company}</b></div>
              <div class="a4Meta">${escapeHtml(f.issuerAddress||"")}</div>
              <div class="a4Meta">Tel: ${escapeHtml(f.issuerPhone||"")}</div>
              <div class="a4Meta">E-Mail: ${escapeHtml(f.issuerEmail||"")}</div>
              <div class="a4Meta">Steuernr./Hinweis: ${escapeHtml(f.issuerTax||"")}</div>
              ${String(f.issuerVatId||"").trim()?`<div class="a4Meta">USt-IdNr: ${escapeHtml(f.issuerVatId||"")}</div>`:""}
            </div>

            <div class="a4Box">
              <h4>Rechnungsempf√§nger</h4>
              <div class="a4Meta"><b>${escapeHtml(f.custName||"")}</b></div>
              <div class="a4Meta">${custAddr}</div>
              ${String(f.custEmail||"").trim()?`<div class="a4Meta">E-Mail: ${escapeHtml(f.custEmail||"")}</div>`:""}
              ${String(f.custContact||"").trim()?`<div class="a4Meta">Ansprechpartner: ${escapeHtml(f.custContact||"")}</div>`:""}
            </div>
          </div>

          <div class="a4Box" style="margin-top:12px">
            <h4>Leistungs√ºbersicht</h4>

            <table class="a4Table">
              <thead>
                <tr>
                  <th>Pos.</th>
                  <th>Bezeichnung</th>
                  <th class="a4Right">Menge</th>
                  <th class="a4Right">Einzelpreis</th>
                  <th class="a4Right">Betrag</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="mono">1</td>
                  <td>Tagdienst</td>
                  <td class="a4Right">${h1} ${unit} √ó ${m}</td>
                  <td class="a4Right">${fmtEUR(p1)}</td>
                  <td class="a4Right">${fmtEUR(s1)}</td>
                </tr>
                <tr>
                  <td class="mono">2</td>
                  <td>Nachtdienst</td>
                  <td class="a4Right">${h2} ${unit} √ó ${m}</td>
                  <td class="a4Right">${fmtEUR(p2)}</td>
                  <td class="a4Right">${fmtEUR(s2)}</td>
                </tr>
                <tr>
                  <td class="mono">3</td>
                  <td>Sonntag</td>
                  <td class="a4Right">${h3} ${unit} √ó ${m}</td>
                  <td class="a4Right">${fmtEUR(p3)}</td>
                  <td class="a4Right">${fmtEUR(s3)}</td>
                </tr>
                <tr>
                  <td class="mono">4</td>
                  <td>Feiertag</td>
                  <td class="a4Right">${h4} ${unit} √ó ${m}</td>
                  <td class="a4Right">${fmtEUR(p4)}</td>
                  <td class="a4Right">${fmtEUR(s4)}</td>
                </tr>
              </tbody>
            </table>

            <div class="a4Totals">
              <div class="tline"><span>Zwischensumme (netto)</span><span>${fmtEUR(sub)}</span></div>
              ${vatRate>0?`<div class="tline"><span>USt 19%</span><span>${fmtEUR(vatAmount)}</span></div>`:""}
              <div class="tline grand"><span>Gesamtbetrag</span><span>${fmtEUR(grand)}</span></div>
            </div>

            <div class="a4Footer">
              <div>${vatText}</div>
              ${terms?`<div><b>Zahlungsbedingungen:</b> ${terms}</div>`:""}
              ${note?`<div><b>Hinweis:</b> ${note}</div>`:""}
              <div style="margin-top:10px">
                <b>Bankverbindung:</b> IBAN ${escapeHtml(f.iban||"")} ‚Ä¢ BIC ${escapeHtml(f.bic||"")} ‚Ä¢ Inhaber ${escapeHtml(f.holder||"")}
              </div>
            </div>

          </div>
        </div>
      `;
    }

    function waitImagesLoaded(root){
      const imgs = Array.from(root.querySelectorAll("img")).filter(i=>i.src);
      return Promise.all(imgs.map(img=>new Promise(res=>{
        if(img.complete) return res();
        img.onload=()=>res(); img.onerror=()=>res();
      })));
    }

    // ---------- PDF export (NO blank page) ----------
    async function exportPdfFromForm(f){
      if(!window.jspdf?.jsPDF){ setStatus("PDF Lib fehlt (jspdf).", false); return; }

      const wrap = $("invoiceA4");
      wrap.innerHTML = buildA4Html(f);
      $("printWrap").style.display="block";
      await waitImagesLoaded(wrap);

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p","mm","a4");

      // Best method: jsPDF.html (stable sizing)
      try{
        await pdf.html(wrap, {
          x: 10, y: 10, // margins in mm (works with html mode)
          html2canvas: { scale: 2, useCORS: true, backgroundColor:"#ffffff" },
          autoPaging: "text",
          windowWidth: 1000
        });
        pdf.save(`${f.invNo||"Rechnung"}.pdf`);
        $("printWrap").style.display="none";
        setStatus("PDF gespeichert", true);
        return;
      }catch(e){
        // Fallback: single canvas
      }

      // Fallback: canvas -> image
      const canvas = await html2canvas(wrap, {scale:2, useCORS:true, backgroundColor:"#ffffff"});
      const imgData = canvas.toDataURL("image/png");
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const imgProps = pdf.getImageProperties(imgData);
      const imgW = pageW;
      const imgH = (imgProps.height * imgW) / imgProps.width;

      if(imgH <= pageH){
        pdf.addImage(imgData,"PNG",0,0,imgW,imgH);
      }else{
        let y=0, remaining=imgH, EPS=1;
        while(remaining>EPS){
          pdf.addImage(imgData,"PNG",0,y? -y : 0,imgW,imgH);
          remaining -= pageH;
          if(remaining>EPS) pdf.addPage();
          y += pageH;
        }
      }
      pdf.save(`${f.invNo||"Rechnung"}.pdf`);
      $("printWrap").style.display="none";
      setStatus("PDF gespeichert (Fallback)", true);
    }

    async function exportPdf(){
      if(!requiredOk()) return;
      await exportPdfFromForm(collectForm());
    }

    async function doPrint(){
      if(!requiredOk()) return;
      const f=collectForm();
      $("invoiceA4").innerHTML = buildA4Html(f);
      $("printWrap").style.display="block";
      await waitImagesLoaded($("invoiceA4"));
      window.print();
      $("printWrap").style.display="none";
    }

    // ---------- reset/new ----------
    function resetAll(){
      Object.values(KEY).forEach(k=>localStorage.removeItem(k));
      location.reload();
    }

    function newInvoice(){
      // keep issuer + pricing + VAT
      const keep = [
        "issuerCompany","issuerAddress","issuerPhone","issuerEmail","issuerTax","issuerVatId","vatMode",
        "iban","bic","holder",
        "mCount","unit",
        "pTag","pNacht","pSonntag","pFeiertag",
        "serviceTitle","paymentTerms"
      ];
      const snap={}; keep.forEach(id=>snap[id]=$(id).value);

      document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.id==="logoFile") return;
        if(el.type==="date") return;
        el.value="";
      });
      Object.entries(snap).forEach(([k,v])=>{ if($(k)) $(k).value=v; });

      $("invDate").value=todayISO();
      $("dueDate").value=addDaysISO($("invDate").value,14);
      $("invNo").value=nextInvoiceNo($("invDate").value);
      updatePurpose();

      $("hTag").value=0; $("hNacht").value=0; $("hSonntag").value=0; $("hFeiertag").value=0;
      $("customerSelect").value="";
      setStatus("Neue Rechnung", true);
      calculate();
    }

    // ---------- wire ----------
    function wire(){
      $("btnLogo").addEventListener("click", ()=> $("logoFile").click());
      $("logoFile").addEventListener("change",(e)=>{
        const file=e.target.files?.[0];
        if(!file) return;
        const rd=new FileReader();
        rd.onload=()=>{ setLogo(String(rd.result||""),true); setStatus("Logo gespeichert", true); };
        rd.readAsDataURL(file);
      });

      $("btnPdf").addEventListener("click", exportPdf);
      $("btnPrint").addEventListener("click", doPrint);
      $("btnReset").addEventListener("click", resetAll);
      $("btnNew").addEventListener("click", newInvoice);

      $("btnSave").addEventListener("click", saveInvoice);
      $("btnRefreshLists").addEventListener("click", ()=>{
        renderInvoiceList();
        renderCustomerList();
        setStatus("Listen aktualisiert", true);
      });

      $("btnSaveCustomer").addEventListener("click", saveCustomer);
      $("btnDeleteCustomer").addEventListener("click", deleteCustomer);
      $("customerSelect").addEventListener("change", (e)=> loadCustomerById(e.target.value));

      $("invDate").addEventListener("change", ()=>{
        $("dueDate").value = addDaysISO($("invDate").value,14);
        $("invNo").value = nextInvoiceNo($("invDate").value);
        updatePurpose();
        calculate();
      });

      // stable input listeners
      const watchIds = [
        "issuerCompany","issuerAddress","issuerPhone","issuerEmail","issuerTax","issuerVatId","vatMode",
        "iban","bic","holder",
        "custName","custEmail","custContact","custAddress",
        "serviceTitle","serviceDate","objekt","zeitraum",
        "mCount","unit",
        "pTag","pNacht","pSonntag","pFeiertag",
        "hTag","hNacht","hSonntag","hFeiertag",
        "note","paymentTerms"
      ];
      watchIds.forEach(id=>{
        const el=$(id);
        if(!el) return;
        el.addEventListener("input", calculate);
        el.addEventListener("change", calculate);
      });
    }

    // ---------- init ----------
    function init(){
      loadLogo();
      restoreAutoSave();

      $("invDate").value = $("invDate").value || todayISO();
      $("dueDate").value = $("dueDate").value || addDaysISO($("invDate").value,14);
      $("invNo").value = $("invNo").value || nextInvoiceNo($("invDate").value);
      updatePurpose();

      refreshCustomerSelect("");
      renderInvoiceList();
      renderCustomerList();

      syncContacts();
      calculate();
      setStatus("Bereit", true);
    }

    window.addEventListener("load", ()=>{
      wire();
      init();
    });
  </script>
</body>
</html>
