<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- ‚úÖ Strong cache-bust (fix blank/old versions on GitHub Pages / Android) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>

  <title>Masculine Security ‚Äî B2B Rechnung (Lexoffice-Style)</title>

  <!-- ‚úÖ PDF libs (stable CDN) -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand:#0b5fa8;
      --brand2:#0a4d86;
      --bg:#f6f8fc;
      --card:#ffffff;
      --ink:#0b1220;
      --muted:#66758f;
      --line:#e3e9f2;

      --r:18px;
      --shadow:0 18px 55px rgba(15,23,42,.10);
      --shadow2:0 10px 26px rgba(15,23,42,.08);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(11,95,168,.14), transparent 55%),
        radial-gradient(1000px 600px at 90% 0%, rgba(10,77,134,.10), transparent 50%),
        var(--bg);
    }

    /* ===== Topbar ===== */
    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.78);
      backdrop-filter: blur(12px);
      border-bottom:1px solid rgba(227,233,242,.75);
    }
    .topbarInner{max-width:1240px;margin:0 auto;padding:14px 16px}
    .row{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:12px; min-width:280px}
    .logo{
      width:46px;height:46px;border-radius:14px;
      display:grid;place-items:center;overflow:hidden;
      background:linear-gradient(180deg, rgba(11,95,168,.10), rgba(11,95,168,.02));
      border:1px solid rgba(11,95,168,.18);
      box-shadow: var(--shadow2);
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:950;letter-spacing:-.2px;line-height:1.1;font-size:15px;color:#0a2540}
    .subtitle{font-size:12px;color:var(--muted);margin-top:2px}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-left:auto}

    /* ===== Buttons ===== */
    button{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:#0a2540;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: transform .06s ease, box-shadow .15s ease, border-color .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    button:hover{box-shadow:0 10px 24px rgba(15,23,42,.10); border-color:#d7e2f0}
    button:active{transform: translateY(1px)}
    button.primary{
      background:linear-gradient(180deg, var(--brand), var(--brand2));
      color:#fff;
      border-color:rgba(11,95,168,.35);
      box-shadow:0 14px 32px rgba(11,95,168,.22);
    }
    button.primary:hover{box-shadow:0 18px 42px rgba(11,95,168,.28)}
    button.ghost{background:transparent; box-shadow:none}
    button.ok{
      background:linear-gradient(180deg, #17b897, #12a988);
      border-color:rgba(18,169,136,.35);
      color:#fff;
      box-shadow:0 14px 32px rgba(18,169,136,.20);
    }
    button.danger{
      background:linear-gradient(180deg, #ff4d6d, #e11d48);
      border-color:rgba(225,29,72,.35);
      color:#fff;
      box-shadow:0 14px 32px rgba(225,29,72,.18);
    }

    /* ‚úÖ Clickable chips (anchors) */
    .brandSub{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    a.linkbtn{
      text-decoration:none;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:#0a2540;
      font-weight:900;
      box-shadow:0 8px 20px rgba(15,23,42,.06);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      box-shadow:0 8px 20px rgba(15,23,42,.06);
    }
    .dot{width:8px;height:8px;border-radius:99px;background:#22c55e}

    /* ===== Error banner (100% no-blank debugging) ===== */
    .err{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(225,29,72,.25);
      background:rgba(225,29,72,.06);
      color:#991b1b;
      font-size:12px;
      font-weight:800;
      white-space:pre-wrap;
    }

    /* ===== Layout ===== */
    .appShell{
      max-width:1240px;
      margin:0 auto;
      padding:18px 14px 50px;
      display:grid;
      gap:14px;
    }
    @media (min-width:1020px){
      .appShell{ grid-template-columns: 260px 1fr; }
    }
    .sidebar{
      background:#fff;
      border:1px solid rgba(227,233,242,.85);
      border-radius:18px;
      box-shadow: 0 18px 55px rgba(15,23,42,.08);
      overflow:hidden;
      position:sticky;
      top:92px;
      height: calc(100vh - 110px);
    }
    .sideHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(227,233,242,.85);
      background:linear-gradient(180deg,#ffffff,#fbfdff);
    }
    .sideHead .h1{font-weight:950;color:#0a2540;font-size:14px}
    .sideHead .h2{font-size:12px;color:#66758f;margin-top:4px}
    .sideNav{padding:10px}
    .sideBtn{
      width:100%;
      text-align:left;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid transparent;
      background:transparent;
      cursor:pointer;
      font-weight:950;
      color:#0a2540;
      box-shadow:none;
    }
    .sideBtn:hover{background:rgba(11,95,168,.06);border-color:rgba(11,95,168,.12)}
    .sideBtn.active{
      background:linear-gradient(180deg, rgba(11,95,168,.12), rgba(11,95,168,.05));
      border-color:rgba(11,95,168,.18);
    }
    .sideTag{
      font-size:12px;
      color:#66758f;
      border:1px solid rgba(227,233,242,.95);
      background:#fff;
      padding:4px 8px;
      border-radius:999px;
      font-family: var(--mono);
    }
    .mainArea{min-width:0}

    /* ‚úÖ IMPORTANT: avoid "blank page" if JS fails (Create view visible by default) */
    .view{display:none}
    #viewCreate{display:block}
    .view.active{display:block}

    /* ===== Cards ===== */
    .grid{display:grid;gap:14px}
    @media (min-width:1020px){.grid{grid-template-columns:1.35fr .85fr}}
    .card{
      background:var(--card);
      border:1px solid rgba(227,233,242,.85);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:14px 16px;
      font-size:13px;
      letter-spacing:.2px;
      color:#0a2540;
      background:linear-gradient(180deg,#ffffff,#fbfdff);
      border-bottom:1px solid rgba(227,233,242,.85);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .body{padding:14px 16px}

    .row2{display:grid;gap:10px}
    @media (min-width:760px){.row2{grid-template-columns:1fr 1fr}}
    .row3{display:grid;gap:10px}
    @media (min-width:760px){.row3{grid-template-columns:1fr 1fr 1fr}}

    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px;font-weight:700}
    input, select, textarea{
      width:100%;
      border:1px solid rgba(227,233,242,.95);
      border-radius:14px;
      padding:11px 12px;
      font:inherit;
      background:#fff;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(11,95,168,.45);
      box-shadow:0 0 0 4px rgba(11,95,168,.10);
    }
    textarea{min-height:92px;resize:vertical}

    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-family:var(--mono);
    }
    .mono{font-family:var(--mono)}
    .hr{height:1px;background:rgba(227,233,242,.85);margin:12px 0}
    .note{
      font-size:12px;
      color:var(--muted);
      background:linear-gradient(180deg,#ffffff,#fbfdff);
      border:1px solid rgba(227,233,242,.95);
      border-radius:14px;
      padding:10px;
    }

    /* ===== KPI ===== */
    .kpi{display:grid;gap:10px}
    @media (min-width:760px){.kpi{grid-template-columns:1fr 1fr}}
    .kpi .box{
      border:1px solid rgba(227,233,242,.95);
      border-radius:16px;
      padding:12px;
      background:linear-gradient(180deg,#fff,#fbfdff);
    }
    .kpi .big{font-size:22px;font-weight:950}
    .kpi .small{font-size:12px;color:var(--muted);font-weight:700}

    /* ===== Table ===== */
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid rgba(227,233,242,.95);
      border-radius:16px;
      overflow:hidden;
    }
    .table th,.table td{padding:10px 10px;border-bottom:1px solid rgba(227,233,242,.95);font-size:13px}
    .table th{background:#f7fafc;text-align:left;color:#0a2540;font-weight:900}
    .table tr:last-child td{border-bottom:0}
    .right{text-align:right}

    /* ===== Lists ===== */
    .list{display:grid;gap:10px}
    .item{
      border:1px solid rgba(227,233,242,.95);
      border-radius:16px;
      padding:12px;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      background:#fff;
      box-shadow:0 10px 26px rgba(15,23,42,.06);
    }
    .item b{display:block}
    .item small{color:var(--muted)}
    .item .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .item .btns button{border-radius:12px}

    /* ‚úÖ PRINT/PDF FIX (NO MORE BLANK SECOND PAGE ON ANDROID / LETTER) */
    @page{
      size: A4;
      margin: 12mm;
    }

    #printAreaWrap{display:none}
    #printArea{
      background:#fff;
      color:#111;
      padding:0;
      width:auto;
      min-height:auto;
      margin:0;
    }
    .printDoc{
      max-width: 780px;
      margin:0 auto;
      padding:0;
      page-break-inside: avoid;
    }
    @media print{
      body{background:#fff}
      .topbar,.appShell{display:none!important}
      #printAreaWrap{display:block!important}
      #printArea{display:block!important}
      /* keep tables together */
      .invBox, .invHeader, .invGrid2, .invTable { page-break-inside: avoid; }
    }

    /* Invoice print design (steuerberater / lexoffice style) */
    .mini{font-size:11px;color:#444}
    .invHeader{display:flex;justify-content:space-between;gap:16px;align-items:flex-start}
    .invHeader .left{display:flex;gap:12px;align-items:center}
    .invLogo{width:54px;height:54px;border-radius:16px;overflow:hidden;border:1px solid #e5e8ef}
    .invLogo img{width:100%;height:100%;object-fit:cover}
    .invTitle{font-size:24px;font-weight:950;margin:0}
    .invMeta{font-size:12px;color:#334155}
    .invGrid2{display:grid;gap:10px}
    @media (min-width:900px){.invGrid2{grid-template-columns:1fr 1fr}}
    .invBox{border:1px solid #e5e8ef;border-radius:16px;padding:12px}
    .invBox h4{margin:0 0 8px;font-size:12px;color:#0a2540}
    .invBox .line{display:flex;justify-content:space-between;gap:10px;font-size:12px;margin:4px 0}
    .invTable{width:100%;border-collapse:collapse;margin-top:10px}
    .invTable th,.invTable td{border:1px solid #e5e8ef;padding:8px;font-size:12px}
    .invTable th{background:#f5f7fb;text-align:left}
    .invRight{text-align:right}
    .invTotals{display:grid;gap:8px;margin-top:10px}
    .invTotals .tline{display:flex;justify-content:space-between;font-size:12px}
    .invTotals .grand{font-size:14px;font-weight:950}
    .invFooter{margin-top:14px;font-size:11px;color:#334155}
  </style>
</head>

<body>

  <div class="topbar">
    <div class="topbarInner">

      <div class="row">
        <div class="brand">
          <div class="logo" title="Logo (fest gespeichert)">
            <img id="logoImg" alt="Logo"/>
          </div>
          <div>
            <div class="title" id="brandTitle">Masculine Security</div>
            <div class="subtitle">B2B Rechnung ‚Ä¢ Lexoffice-Style ‚Ä¢ Steuerberater-Design ‚Ä¢ Auto 99%</div>
          </div>
        </div>

        <div class="actions">
          <button class="ghost" id="btnLogo" type="button">Logo √§ndern</button>
          <button class="ghost" id="btnNew" type="button">Neu</button>
          <button class="ok" id="btnSave" type="button">Rechnung speichern</button>
          <button class="ghost" id="btnList" type="button">Rechnungen</button>
          <button class="danger" id="btnReset" type="button">Reset</button>
          <button class="primary" id="btnPdf" type="button">PDF speichern</button>
          <button class="primary" id="btnPrint" type="button">Print</button>
        </div>
      </div>

      <div class="brandSub">
        <span class="badge"><span class="dot"></span> Auto-Save aktiv</span>
        <span class="badge">B2B: ON</span>
        <a class="linkbtn" id="callLink" href="tel:015778697052">üìû <span id="callText">015778697052</span></a>
        <a class="linkbtn" id="mailLink" href="mailto:Kontakt.mass.bremen@hotmail.com">‚úâÔ∏è <span id="mailText">Kontakt.mass.bremen@hotmail.com</span></a>
      </div>

      <div class="err" id="errBox"></div>

    </div>
  </div>

  <div class="appShell">

    <aside class="sidebar">
      <div class="sideHead">
        <div class="h1" id="sideBrand">Masculine Security</div>
        <div class="h2">B2B Rechnungssystem</div>
      </div>

      <div class="sideNav">
        <button class="sideBtn active" id="navCreate" type="button">
          <span>‚ûï Rechnung</span>
          <span class="sideTag">FORM</span>
        </button>

        <button class="sideBtn" id="navInvoices" type="button">
          <span>üìÑ Rechnungen</span>
          <span class="sideTag" id="navInvCount">0</span>
        </button>

        <button class="sideBtn" id="navCustomers" type="button">
          <span>üë§ Kunden</span>
          <span class="sideTag" id="navCustCount">0</span>
        </button>

        <button class="sideBtn" id="navSettings" type="button">
          <span>‚öô Einstellungen</span>
          <span class="sideTag">PRO</span>
        </button>
      </div>
    </aside>

    <main class="mainArea">

      <div class="view active" id="viewCreate">
        <div class="grid">

          <div class="card">
            <h2>
              <span>Rechnungsdaten</span>
              <span class="pill" id="liveStatus">Bereit</span>
            </h2>

            <div class="body">

              <div class="row2">
                <div>
                  <label>Firmenname / Brand *</label>
                  <input id="issuerCompany" value="Masculine Security"/>
                </div>
                <div>
                  <label>Adresse *</label>
                  <input id="issuerAddress" value="Werschenregerstra√üe 6 ‚Ä¢ 28237 Bremen"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Telefon</label>
                  <input id="issuerPhone" value="015778697052"/>
                </div>
                <div>
                  <label>E-Mail *</label>
                  <input id="issuerEmail" value="Kontakt.mass.bremen@hotmail.com"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Steuernummer / Hinweis *</label>
                  <input id="issuerTaxNo" value="wird nachgereicht"/>
                  <div class="note" style="margin-top:8px">Wenn du noch keine Steuernummer hast: ‚Äûwird nachgereicht‚Äú ist ok.</div>
                </div>
                <div>
                  <label>USt-IdNr (optional)</label>
                  <input id="issuerVatId" placeholder="DE123456789"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>IBAN *</label>
                  <input id="issuerIban" value="DE98 1001 1001 2333 0146 96"/>
                </div>
                <div>
                  <label>BIC *</label>
                  <input id="issuerBic" value="NTSBDEB1XXX"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Kontoinhaber *</label>
                  <input id="issuerHolder" value="MUSTAFA MURSAL ABDI"/>
                </div>
                <div>
                  <label>‚Äî</label>
                  <input disabled value=""/>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row2">
                <div>
                  <label>Kunde ausw√§hlen</label>
                  <select id="customerPick"></select>

                  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
                    <button id="btnSaveCustomer" class="ghost" type="button">Kunde speichern</button>
                    <button id="btnDeleteCustomer" class="danger" type="button">Kunde l√∂schen</button>
                  </div>
                </div>

                <div>
                  <label>Kundenname (zum Speichern) *</label>
                  <input id="custName" placeholder="Firma / Name"/>
                  <div class="row2" style="margin-top:10px">
                    <div>
                      <label>E-Mail (optional)</label>
                      <input id="custEmail" placeholder="kunde@email.de"/>
                    </div>
                    <div>
                      <label>Ansprechpartner (optional)</label>
                      <input id="custContact" placeholder="Ansprechpartner"/>
                    </div>
                  </div>
                </div>
              </div>

              <div style="margin-top:10px">
                <label>Kundendaten (Adresse / Ansprechpartner) *</label>
                <textarea id="custAddress" placeholder="Stra√üe ‚Ä¢ PLZ Ort&#10;Ansprechpartner"></textarea>
              </div>

              <div class="hr"></div>

              <div class="row3">
                <div>
                  <label>Rechnungsdatum *</label>
                  <input id="invDate" type="date"/>
                </div>
                <div>
                  <label>F√§llig am *</label>
                  <input id="dueDate" type="date"/>
                  <div class="note" style="margin-top:8px">Standard = +14 Tage (du kannst √§ndern).</div>
                </div>
                <div>
                  <label>Rechnungsnummer *</label>
                  <input id="invNo" class="mono"/>
                  <div class="note" style="margin-top:8px">Auto pro Tag laufend (YYYYMMDD-0001).</div>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>USt-Status *</label>
                  <select id="vatMode">
                    <option value="kmu">0% (Kleinunternehmer ¬ß19)</option>
                    <option value="vat19">19% USt</option>
                  </select>
                  <div class="note" style="margin-top:8px" id="vatHint">Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet.</div>
                </div>

                <div>
                  <label>Leistungsbeschreibung *</label>
                  <input id="serviceTitle" value="Sicherheitsdienstleistung ‚Äì Objektschutz"/>
                  <div class="row2" style="margin-top:10px">
                    <div>
                      <label>Objekt / Ort (optional)</label>
                      <input id="objekt" placeholder="z.B. Baustelle ‚Äì Bremen"/>
                    </div>
                    <div>
                      <label>Auftragszeitraum (optional)</label>
                      <input id="zeitraum" placeholder="z.B. 08.03.2026 ‚Äì 09.03.2026"/>
                    </div>
                  </div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row2">
                <div>
                  <label>Anzahl Mitarbeiter *</label>
                  <input id="mitarbeiter" type="number" min="0" value="1"/>
                </div>
                <div>
                  <label>Basis-Stundensatz Tag (‚Ç¨) *</label>
                  <input id="tagPreis" type="number" min="0" step="0.01" value="23"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Berechnungsart Zuschl√§ge *</label>
                  <select id="modus">
                    <option value="fixed">Festpreis (eigener Preis pro Std.)</option>
                    <option value="percent">Zuschlag % (auf Tagpreis)</option>
                  </select>
                  <div class="note" style="margin-top:8px">‚úÖ B2B meist bevorzugt: <b>Festpreise</b>. Prozent ist optional.</div>
                </div>
                <div>
                  <label>Verwendungszweck (auto)</label>
                  <input id="purpose" class="mono" readonly/>
                  <div class="note" style="margin-top:8px">Kunde kann bei √úberweisung so schreiben.</div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row3">
                <div>
                  <label>Schicht Beginn</label>
                  <input id="shiftStart" type="time" value="18:00"/>
                </div>
                <div>
                  <label>Schicht Ende</label>
                  <input id="shiftEnd" type="time" value="06:00"/>
                </div>
                <div>
                  <label>Nachtzeit Regel</label>
                  <select id="nachtRule">
                    <option value="22-06">22:00 ‚Äì 06:00 (Standard)</option>
                    <option value="23-06">23:00 ‚Äì 06:00</option>
                    <option value="20-06">20:00 ‚Äì 06:00</option>
                  </select>
                </div>
              </div>

              <div class="note" style="margin-top:10px">
                Auto-Funktion berechnet <b>Tagstunden</b> und <b>Nachtstunden</b> aus Beginn/Ende.
                Sonntag/Feiertag tr√§gst du separat ein (keine Doppelz√§hlung).
              </div>

              <div class="hr"></div>

              <div class="row3">
                <div>
                  <label>Tagstunden</label>
                  <input id="tagH" type="number" min="0" step="0.25" value="0"/>
                </div>
                <div>
                  <label>Nachtstunden</label>
                  <input id="nachtH" type="number" min="0" step="0.25" value="0"/>
                </div>
                <div>
                  <label>Sonntagstunden</label>
                  <input id="sonntagH" type="number" min="0" step="0.25" value="0"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Feiertagstunden</label>
                  <input id="feiertagH" type="number" min="0" step="0.25" value="0"/>
                  <div class="note" style="margin-top:8px">Stunden nur in <b>eine</b> Kategorie eintragen.</div>
                </div>
                <div>
                  <label>Hinweis / Notiz (optional)</label>
                  <textarea id="note" placeholder="z.B. laut Vereinbarung / Einsatzzeiten / Ansprechpartner..."></textarea>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row3">
                <div id="percentBox" style="display:none">
                  <label>Nachtzuschlag (%)</label>
                  <input id="nachtPercent" type="number" min="0" step="0.01" value="0"/>
                  <label style="margin-top:10px">Sonntag (%)</label>
                  <input id="sonntagPercent" type="number" min="0" step="0.01" value="0"/>
                  <label style="margin-top:10px">Feiertag (%)</label>
                  <input id="feiertagPercent" type="number" min="0" step="0.01" value="0"/>
                </div>

                <div id="fixedBox">
                  <label>Festpreis Nacht (‚Ç¨)</label>
                  <input id="nachtFest" type="number" min="0" step="0.01" value="24"/>
                  <label style="margin-top:10px">Festpreis Sonntag (‚Ç¨)</label>
                  <input id="sonntagFest" type="number" min="0" step="0.01" value="32"/>
                  <label style="margin-top:10px">Festpreis Feiertag (‚Ç¨)</label>
                  <input id="feiertagFest" type="number" min="0" step="0.01" value="36"/>
                </div>

                <div>
                  <label>Rechnung Text (auto)</label>
                  <textarea id="rechnungText"></textarea>
                  <div class="note" style="margin-top:8px">Text wird automatisch aktualisiert (du kannst trotzdem manuell √§ndern).</div>
                </div>
              </div>

            </div>
          </div>

          <div class="card">
            <h2>
              <span>Berechnung & Summe</span>
              <span class="pill mono" id="modeBadge">MODE: FEST</span>
            </h2>
            <div class="body">
              <div class="kpi">
                <div class="box">
                  <div class="small">Zwischensumme (netto)</div>
                  <div class="big mono" id="subTotal">0,00 ‚Ç¨</div>
                </div>
                <div class="box">
                  <div class="small">Gesamt (brutto)</div>
                  <div class="big mono" id="grandTotal">0,00 ‚Ç¨</div>
                </div>
              </div>

              <div class="hr"></div>

              <table class="table">
                <thead>
                  <tr>
                    <th>Position</th>
                    <th class="right">Std.</th>
                    <th class="right">Preis/Std.</th>
                    <th class="right">Summe</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Tagdienst</td>
                    <td class="right mono" id="t_tagStd">0</td>
                    <td class="right mono" id="t_tagPreis">0,00 ‚Ç¨</td>
                    <td class="right mono" id="t_tagSum">0,00 ‚Ç¨</td>
                  </tr>
                  <tr>
                    <td>Nachtdienst</td>
                    <td class="right mono" id="t_nachtStd">0</td>
                    <td class="right mono" id="t_nachtPreis">0,00 ‚Ç¨</td>
                    <td class="right mono" id="t_nachtSum">0,00 ‚Ç¨</td>
                  </tr>
                  <tr>
                    <td>Sonntag</td>
                    <td class="right mono" id="t_sonntagStd">0</td>
                    <td class="right mono" id="t_sonntagPreis">0,00 ‚Ç¨</td>
                    <td class="right mono" id="t_sonntagSum">0,00 ‚Ç¨</td>
                  </tr>
                  <tr>
                    <td>Feiertag</td>
                    <td class="right mono" id="t_feiertagStd">0</td>
                    <td class="right mono" id="t_feiertagPreis">0,00 ‚Ç¨</td>
                    <td class="right mono" id="t_feiertagSum">0,00 ‚Ç¨</td>
                  </tr>
                </tbody>
              </table>

              <div class="hr"></div>

              <div class="note">
                <b>Wichtig:</b> Mitarbeiter werden automatisch multipliziert:
                <span class="mono">(Mitarbeiter √ó Stunden √ó Preis)</span>.
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="view" id="viewInvoices">
        <div class="card">
          <h2>
            <span>Gespeicherte Rechnungen</span>
            <span class="pill mono" id="invCount">0</span>
          </h2>
          <div class="body">
            <div class="list" id="invList"></div>
          </div>
        </div>
      </div>

      <div class="view" id="viewCustomers">
        <div class="card">
          <h2>
            <span>Kunden</span>
            <span class="pill mono" id="custCount">0</span>
          </h2>
          <div class="body">
            <div class="note">Liste deiner gespeicherten Kunden (Ausw√§hlen f√ºhrt zur√ºck zum Formular).</div>
            <div class="hr"></div>
            <div class="list" id="custList"></div>
          </div>
        </div>
      </div>

      <div class="view" id="viewSettings">
        <div class="card">
          <h2>
            <span>Einstellungen</span>
            <span class="pill mono">Brand</span>
          </h2>
          <div class="body">
            <div class="note">Logo (fest gespeichert) + Firmenname kannst du hier schnell √§ndern.</div>
            <div class="hr"></div>
            <div class="row2">
              <div>
                <label>Firmenname / Brand</label>
                <input id="issuerCompanyMirror" placeholder="Masculine Security"/>
              </div>
              <div>
                <label>Logo</label>
                <button class="primary" type="button" id="btnLogo2">Logo √§ndern</button>
              </div>
            </div>

            <div class="hr"></div>
            <div class="note">
              ‚úÖ Wenn mal ‚Äúblank‚Äù passiert: Cache wurde fixiert + ServiceWorker wird automatisch entfernt.<br/>
              ‚úÖ Print/PDF ist A4 (kein 2. leeres Blatt).
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <div id="printAreaWrap"><div id="printArea"></div></div>

  <input id="logoFile" type="file" accept="image/*" style="display:none"/>

  <script>
    /* ============================
       100% STABILITY PATCHES
       ============================ */

    // ‚úÖ Remove any Service Worker (prevents old blank cached app on GitHub Pages)
    (function killSW(){
      try{
        if("serviceWorker" in navigator){
          navigator.serviceWorker.getRegistrations()
            .then(regs=>regs.forEach(r=>r.unregister()))
            .catch(()=>{});
        }
        if(window.caches?.keys){
          caches.keys().then(keys=>keys.forEach(k=>caches.delete(k))).catch(()=>{});
        }
      }catch(e){}
    })();

    // ‚úÖ Global error banner (no silent blank)
    const errBox = document.getElementById("errBox");
    function showErr(msg){
      if(!errBox) return;
      errBox.style.display = "block";
      errBox.textContent = "Fehler (Fix needed):\n" + String(msg || "");
    }
    window.addEventListener("error", (e)=> showErr(e.message || e.error || e));
    window.addEventListener("unhandledrejection", (e)=> showErr(e.reason || e));

    // ===== Storage Keys (versioned) =====
    const KEY_APP = "ms_b2b_rechnung_app_v4";       // ‚úÖ version bump = fixes old storage conflicts
    const KEY_CUSTOMERS = "ms_b2b_customers_v2";
    const KEY_INVOICES = "ms_b2b_invoices_v2";
    const KEY_COUNTERS = "ms_b2b_inv_counters_v2";
    const KEY_LOGO = "ms_b2b_logo_v2";

    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const fmtEUR = (n)=>{
      const v = Number(n||0);
      return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}) + " ‚Ç¨";
    };
    const todayISO = ()=>{
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const addDaysISO = (iso, days)=>{
      const d = new Date(iso+"T00:00:00");
      d.setDate(d.getDate()+days);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const yyyymmdd = (iso)=> iso.replaceAll("-","");
    const safeNum = (v)=> {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };
    const setStatus = (txt, ok=true)=>{
      $("liveStatus").textContent = txt;
      $("liveStatus").style.borderColor = ok ? "rgba(34,197,94,.35)" : "rgba(225,29,72,.35)";
      $("liveStatus").style.color = ok ? "var(--muted)" : "#b91c1c";
    };
    const loadJSON = (k, fallback)=>{
      try{ const v = localStorage.getItem(k); return v? JSON.parse(v) : fallback; }catch(e){ return fallback; }
    };
    const saveJSON = (k, v)=> localStorage.setItem(k, JSON.stringify(v));

    // ‚úÖ Keep header/side brand always synced
    function syncBrandEverywhere(){
      const name = String($("issuerCompany").value || "Masculine Security").trim() || "Masculine Security";
      $("brandTitle").textContent = name;
      $("sideBrand").textContent = name;
    }

    // ‚úÖ Clickable tel/mail always synced to inputs
    function syncClickableLinks(){
      const telRaw = String($("issuerPhone").value || "").trim();
      const tel = telRaw.replace(/\s+/g,"");
      const mail = String($("issuerEmail").value || "").trim();

      $("callText").textContent = telRaw || "‚Äî";
      $("mailText").textContent = mail || "‚Äî";

      $("callLink").href = tel ? `tel:${tel}` : "#";
      $("mailLink").href = mail ? `mailto:${mail}` : "#";
    }

    // ===== FEST LOGO =====
    function setLogo(dataUrl, persist=true){
      $("logoImg").src = dataUrl;
      if(persist) localStorage.setItem(KEY_LOGO, dataUrl);
    }
    function loadLogo(){
      const saved = localStorage.getItem(KEY_LOGO);
      if(saved){
        setLogo(saved, false);
      }else{
        const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="120" height="120" rx="24" fill="#0b5fa8"/><text x="60" y="72" font-size="54" text-anchor="middle" fill="white" font-family="Arial" font-weight="900">M</text></svg>`);
        setLogo(`data:image/svg+xml,${svg}`, false);
      }
    }

    // ===== Invoice number =====
    function nextInvoiceNo(invDateISO){
      const counters = loadJSON(KEY_COUNTERS, {});
      const d = yyyymmdd(invDateISO || todayISO());
      const cur = safeNum(counters[d]) || 0;
      const next = cur + 1;
      counters[d] = next;
      saveJSON(KEY_COUNTERS, counters);
      return `MS-${d}-${String(next).padStart(4,"0")}`;
    }

    function updateVatHint(){
      $("vatHint").textContent = ($("vatMode").value==="kmu")
        ? "Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet."
        : "Umsatzsteuer 19% wird berechnet und ausgewiesen.";
    }

    function updatePurpose(){
      const no = $("invNo").value || "";
      $("purpose").value = `Rechnung: ${no}`;
    }

    function toggleModeUI(){
      const m = $("modus").value;
      $("percentBox").style.display = (m==="percent") ? "" : "none";
      $("fixedBox").style.display = (m==="fixed") ? "" : "none";
      $("modeBadge").textContent = (m==="percent") ? "MODE: %" : "MODE: FEST";
    }

    function validateCore(){
      const must = [
        ["issuerCompany","Firmenname"],
        ["issuerAddress","Adresse"],
        ["issuerEmail","E-Mail"],
        ["issuerTaxNo","Steuernummer/Hinweis"],
        ["issuerIban","IBAN"],
        ["issuerBic","BIC"],
        ["issuerHolder","Kontoinhaber"],
        ["custName","Kundenname"],
        ["custAddress","Kundendaten"],
        ["invDate","Rechnungsdatum"],
        ["dueDate","F√§llig am"],
        ["invNo","Rechnungsnummer"],
        ["serviceTitle","Leistungsbeschreibung"]
      ];
      for(const [id,label] of must){
        if(!String($(id).value||"").trim()){
          setStatus(`Fehlt: ${label}`, false);
          return false;
        }
      }
      setStatus("OK", true);
      return true;
    }

    // ===== AUTO Tag/Nacht =====
    function parseTimeToMinutes(t){
      if(!t) return null;
      const [h,m] = t.split(":").map(Number);
      if(!Number.isFinite(h) || !Number.isFinite(m)) return null;
      return h*60 + m;
    }
    function getNightWindow(){
      const rule = $("nachtRule").value;
      if(rule==="23-06") return {start: 23*60, end: 30*60};
      if(rule==="20-06") return {start: 20*60, end: 30*60};
      return {start: 22*60, end: 30*60};
    }
    function calculateDayNight(){
      const start = parseTimeToMinutes($("shiftStart").value);
      const endRaw = parseTimeToMinutes($("shiftEnd").value);
      if(start===null || endRaw===null) return;

      let end = endRaw;
      if(end <= start) end += 1440;

      const totalMin = end - start;
      const {start: nightStart, end: nightEnd} = getNightWindow();

      let nightMin = 0;
      const nightEndMod = nightEnd % 1440;
      for(let i=start;i<end;i++){
        const mod = i % 1440;
        const isNight = (mod >= nightStart) || (mod < nightEndMod);
        if(isNight) nightMin++;
      }

      const nightH = nightMin / 60;
      const dayH = (totalMin/60) - nightH;

      $("tagH").value = Math.max(0, dayH).toFixed(2);
      $("nachtH").value = Math.max(0, nightH).toFixed(2);
    }

    // ===== Calculation =====
    function calculate(){
      toggleModeUI();
      updateVatHint();
      updatePurpose();
      syncBrandEverywhere();
      syncClickableLinks();

      const m = safeNum($("mitarbeiter").value);
      const tagPreis = safeNum($("tagPreis").value);

      const tagH = safeNum($("tagH").value);
      const nachtH = safeNum($("nachtH").value);
      const sonntagH = safeNum($("sonntagH").value);
      const feiertagH = safeNum($("feiertagH").value);

      const mode = $("modus").value;

      let nachtPreisFinal = 0, sonntagPreisFinal = 0, feiertagPreisFinal = 0;
      if(mode==="percent"){
        const nachtP = safeNum($("nachtPercent").value);
        const sonntagP = safeNum($("sonntagPercent").value);
        const feiertagP = safeNum($("feiertagPercent").value);
        nachtPreisFinal = tagPreis + (tagPreis * nachtP/100);
        sonntagPreisFinal = tagPreis + (tagPreis * sonntagP/100);
        feiertagPreisFinal = tagPreis + (tagPreis * feiertagP/100);
      }else{
        nachtPreisFinal = safeNum($("nachtFest").value);
        sonntagPreisFinal = safeNum($("sonntagFest").value);
        feiertagPreisFinal = safeNum($("feiertagFest").value);
      }

      const tagSum = m * tagH * tagPreis;
      const nachtSum = m * nachtH * nachtPreisFinal;
      const sonntagSum = m * sonntagH * sonntagPreisFinal;
      const feiertagSum = m * feiertagH * feiertagPreisFinal;

      const subTotal = tagSum + nachtSum + sonntagSum + feiertagSum;

      const vatMode = $("vatMode").value;
      const vatRate = (vatMode==="vat19") ? 0.19 : 0;
      const vatAmount = subTotal * vatRate;
      const grandTotal = subTotal + vatAmount;

      $("t_tagStd").textContent = String(tagH);
      $("t_nachtStd").textContent = String(nachtH);
      $("t_sonntagStd").textContent = String(sonntagH);
      $("t_feiertagStd").textContent = String(feiertagH);

      $("t_tagPreis").textContent = fmtEUR(tagPreis);
      $("t_nachtPreis").textContent = fmtEUR(nachtPreisFinal);
      $("t_sonntagPreis").textContent = fmtEUR(sonntagPreisFinal);
      $("t_feiertagPreis").textContent = fmtEUR(feiertagPreisFinal);

      $("t_tagSum").textContent = fmtEUR(tagSum);
      $("t_nachtSum").textContent = fmtEUR(nachtSum);
      $("t_sonntagSum").textContent = fmtEUR(sonntagSum);
      $("t_feiertagSum").textContent = fmtEUR(feiertagSum);

      $("subTotal").textContent = fmtEUR(subTotal);
      $("grandTotal").textContent = fmtEUR(grandTotal);

      const obj = String($("objekt").value||"").trim();
      const zr = String($("zeitraum").value||"").trim();
      const note = String($("note").value||"").trim();

      const modeLine = (mode==="percent")
        ? `Zuschl√§ge gem√§√ü Prozent (auf Tagpreis ${fmtEUR(tagPreis)}).`
        : `Stundens√§tze laut Vereinbarung (Festpreise).`;

      const vatLine = (vatMode==="kmu")
        ? `Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet.`
        : `Umsatzsteuer 19%: ${fmtEUR(vatAmount)} (in Gesamtbetrag enthalten).`;

      const nightText = $("nachtRule").value==="23-06" ? "23:00 ‚Äì 06:00" : ($("nachtRule").value==="20-06" ? "20:00 ‚Äì 06:00" : "22:00 ‚Äì 06:00");

      $("rechnungText").value = [
        `${$("serviceTitle").value} ‚Äî Einsatz mit ${m} Mitarbeiter(n)`,
        obj ? `Objekt/Ort: ${obj}` : "",
        zr ? `Zeitraum: ${zr}` : "",
        "",
        `Tagdienst (${fmtEUR(tagPreis)}/Std): ${m} √ó ${tagH} Std`,
        `Nachtdienst (${fmtEUR(nachtPreisFinal)}/Std): ${m} √ó ${nachtH} Std`,
        `Sonntag (${fmtEUR(sonntagPreisFinal)}/Std): ${m} √ó ${sonntagH} Std`,
        `Feiertag (${fmtEUR(feiertagPreisFinal)}/Std): ${m} √ó ${feiertagH} Std`,
        "",
        `Zwischensumme (netto): ${fmtEUR(subTotal)}`,
        `${vatLine}`,
        `Gesamtbetrag: ${fmtEUR(grandTotal)}`,
        "",
        modeLine,
        `Nachtzeit laut Vereinbarung: ${nightText}`,
        "Abrechnung gem√§√ü Einsatzzeiten.",
        note ? `Hinweis: ${note}` : ""
      ].filter(Boolean).join("\n");

      autoSave();
    }

    // ===== Customers =====
    function renderCustomers(){
      const customers = loadJSON(KEY_CUSTOMERS, []);
      const sel = $("customerPick");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "‚Äî ausw√§hlen ‚Äî";
      sel.appendChild(opt0);

      for(const c of customers){
        const o = document.createElement("option");
        o.value = c.id;
        o.textContent = c.name;
        sel.appendChild(o);
      }
      $("custCount").textContent = String(customers.length);
      $("navCustCount").textContent = String(customers.length);
    }

    function cryptoRandomId(){
      if(window.crypto?.getRandomValues){
        const a = new Uint32Array(2);
        window.crypto.getRandomValues(a);
        return a[0].toString(16)+a[1].toString(16);
      }
      return String(Date.now()) + Math.random().toString(16).slice(2);
    }
    function saveCustomer(){
      const name = String($("custName").value||"").trim();
      const address = String($("custAddress").value||"").trim();
      if(!name || !address){ setStatus("Kunde: Name/Adresse fehlt", false); return; }
      const customers = loadJSON(KEY_CUSTOMERS, []);
      const id = cryptoRandomId();
      customers.push({
        id,
        name,
        email: String($("custEmail").value||"").trim(),
        contact: String($("custContact").value||"").trim(),
        address
      });
      saveJSON(KEY_CUSTOMERS, customers);
      renderCustomers();
      $("customerPick").value = id;
      setStatus("Kunde gespeichert", true);
      renderCustomerList();
    }
    function loadCustomer(id){
      const customers = loadJSON(KEY_CUSTOMERS, []);
      const c = customers.find(x=>x.id===id);
      if(!c) return;
      $("custName").value = c.name || "";
      $("custEmail").value = c.email || "";
      $("custContact").value = c.contact || "";
      $("custAddress").value = c.address || "";
      setStatus("Kunde geladen", true);
      calculate();
    }
    function deleteCustomer(){
      const id = $("customerPick").value;
      if(!id){ setStatus("Kein Kunde ausgew√§hlt", false); return; }
      const customers = loadJSON(KEY_CUSTOMERS, []).filter(x=>x.id!==id);
      saveJSON(KEY_CUSTOMERS, customers);
      renderCustomers();
      $("customerPick").value = "";
      setStatus("Kunde gel√∂scht", true);
      renderCustomerList();
    }

    // ===== Invoices =====
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

    function collectInvoice(){
      const fields = [
        "issuerCompany","issuerAddress","issuerPhone","issuerEmail","issuerTaxNo","issuerVatId",
        "issuerIban","issuerBic","issuerHolder",
        "custName","custEmail","custContact","custAddress",
        "invDate","dueDate","invNo","vatMode","serviceTitle","objekt","zeitraum",
        "mitarbeiter","tagPreis","modus","purpose",
        "shiftStart","shiftEnd","nachtRule",
        "tagH","nachtH","sonntagH","feiertagH",
        "nachtPercent","sonntagPercent","feiertagPercent",
        "nachtFest","sonntagFest","feiertagFest",
        "note","rechnungText"
      ];
      const form = {};
      for(const id of fields){ if($(id)) form[id] = $(id).value; }
      return {
        invNo: $("invNo").value,
        invDate: $("invDate").value,
        custName: $("custName").value,
        serviceTitle: $("serviceTitle").value,
        purpose: $("purpose").value,
        subTotalFmt: $("subTotal").textContent,
        grandTotalFmt: $("grandTotal").textContent,
        logoDataUrl: $("logoImg").src || "",
        form
      };
    }

    function saveInvoice(){
      if(!validateCore()) return;
      const inv = collectInvoice();
      const invoices = loadJSON(KEY_INVOICES, []);
      const idx = invoices.findIndex(x=>x.invNo===inv.invNo);
      if(idx>=0) invoices[idx] = inv; else invoices.unshift(inv);
      saveJSON(KEY_INVOICES, invoices);
      setStatus("Rechnung gespeichert", true);
      renderInvoices();
      updateInvoiceCounts();
    }

    function renderInvoices(){
      const invoices = loadJSON(KEY_INVOICES, []);
      $("invCount").textContent = String(invoices.length);
      $("navInvCount").textContent = String(invoices.length);

      const wrap = $("invList");
      wrap.innerHTML = "";
      for(const inv of invoices){
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <b class="mono">${escapeHtml(inv.invNo)}</b>
            <small>${escapeHtml(inv.invDate)} ‚Ä¢ ${escapeHtml(inv.custName)} ‚Ä¢ ${escapeHtml(inv.serviceTitle)}</small><br/>
            <small class="mono">Gesamt: ${escapeHtml(inv.grandTotalFmt)} ‚Ä¢ Zweck: ${escapeHtml(inv.purpose)}</small>
          </div>
          <div class="btns">
            <button type="button" data-act="load" data-no="${escapeAttr(inv.invNo)}">Laden</button>
            <button type="button" data-act="pdf" data-no="${escapeAttr(inv.invNo)}">PDF</button>
            <button type="button" data-act="del" class="danger" data-no="${escapeAttr(inv.invNo)}">L√∂schen</button>
          </div>
        `;
        wrap.appendChild(el);
      }

      wrap.querySelectorAll("button").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const act = b.getAttribute("data-act");
          const no = b.getAttribute("data-no");
          if(act==="load") loadInvoice(no);
          if(act==="del") deleteInvoice(no);
          if(act==="pdf") {
            const inv = loadJSON(KEY_INVOICES, []).find(x=>x.invNo===no);
            if(inv){ await exportPdfFromInvoice(inv); }
          }
        });
      });
    }

    function updateInvoiceCounts(){
      const invoices = loadJSON(KEY_INVOICES, []);
      $("invCount").textContent = String(invoices.length);
      $("navInvCount").textContent = String(invoices.length);
    }

    function loadInvoice(invNo){
      const invoices = loadJSON(KEY_INVOICES, []);
      const inv = invoices.find(x=>x.invNo===invNo);
      if(!inv){ setStatus("Rechnung nicht gefunden", false); return; }
      for(const [k,v] of Object.entries(inv.form || {})){ if($(k)) $(k).value = v; }
      if(inv.logoDataUrl){ setLogo(inv.logoDataUrl, true); }
      setStatus("Rechnung geladen", true);
      calculateDayNight();
      calculate();
      setActiveNav("navCreate","viewCreate");
    }

    function deleteInvoice(invNo){
      const invoices = loadJSON(KEY_INVOICES, []).filter(x=>x.invNo!==invNo);
      saveJSON(KEY_INVOICES, invoices);
      setStatus("Rechnung gel√∂scht", true);
      renderInvoices();
      updateInvoiceCounts();
    }

    // ===== wait images before PDF/Print =====
    function waitImagesLoaded(root){
      const imgs = Array.from(root.querySelectorAll("img")).filter(i=>i.src);
      return Promise.all(imgs.map(img => new Promise(res=>{
        if(img.complete) return res();
        img.onload = ()=>res();
        img.onerror = ()=>res();
      })));
    }

    // ===== Build Print HTML =====
    function buildPrintHtml(inv){
      const f = inv.form;
      const company = String(f.issuerCompany || "Masculine Security").trim();

      const logoSrc = inv.logoDataUrl || $("logoImg").src || "";
      const logo = logoSrc ? `<div class="invLogo"><img src="${escapeAttr(logoSrc)}" alt="Logo"/></div>` : "";

      const vatMode = f.vatMode;
      const vatLine = (vatMode==="kmu")
        ? "Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet."
        : "Umsatzsteuer 19% wird berechnet und ausgewiesen.";

      const mode = f.modus;
      const modeLine = (mode==="percent")
        ? `Zuschl√§ge gem√§√ü Prozent (auf Tagpreis).`
        : `Stundens√§tze laut Vereinbarung (Festpreise).`;

      const m = safeNum(f.mitarbeiter);
      const tagPreis = safeNum(f.tagPreis);
      const tagH = safeNum(f.tagH);
      const nachtH = safeNum(f.nachtH);
      const sonntagH = safeNum(f.sonntagH);
      const feiertagH = safeNum(f.feiertagH);

      let nachtPreisFinal=0, sonntagPreisFinal=0, feiertagPreisFinal=0;
      if(mode==="percent"){
        const nachtP = safeNum(f.nachtPercent);
        const sonntagP = safeNum(f.sonntagPercent);
        const feiertagP = safeNum(f.feiertagPercent);
        nachtPreisFinal = tagPreis + (tagPreis * nachtP/100);
        sonntagPreisFinal = tagPreis + (tagPreis * sonntagP/100);
        feiertagPreisFinal = tagPreis + (tagPreis * feiertagP/100);
      }else{
        nachtPreisFinal = safeNum(f.nachtFest);
        sonntagPreisFinal = safeNum(f.sonntagFest);
        feiertagPreisFinal = safeNum(f.feiertagFest);
      }

      const tagSum = m * tagH * tagPreis;
      const nachtSum = m * nachtH * nachtPreisFinal;
      const sonntagSum = m * sonntagH * sonntagPreisFinal;
      const feiertagSum = m * feiertagH * feiertagPreisFinal;
      const subTotal = tagSum+nachtSum+sonntagSum+feiertagSum;
      const vatRate = (vatMode==="vat19") ? 0.19 : 0;
      const vatAmount = subTotal*vatRate;
      const grand = subTotal+vatAmount;

      const obj = String(f.objekt||"").trim();
      const zr = String(f.zeitraum||"").trim();
      const note = String(f.note||"").trim();
      const nightText = f.nachtRule==="23-06" ? "23:00 ‚Äì 06:00" : (f.nachtRule==="20-06" ? "20:00 ‚Äì 06:00" : "22:00 ‚Äì 06:00");

      return `
        <div class="invHeader">
          <div class="left">
            ${logo}
            <div>
              <p class="invTitle">Rechnung</p>
              <div class="invMeta"><b>${escapeHtml(company)}</b></div>
              <div class="invMeta"><b>${escapeHtml(f.serviceTitle||"")}</b></div>
              ${obj ? `<div class="invMeta">Objekt/Ort: ${escapeHtml(obj)}</div>` : ``}
              ${zr ? `<div class="invMeta">Zeitraum: ${escapeHtml(zr)}</div>` : ``}
            </div>
          </div>
          <div class="invBox" style="min-width:260px">
            <div class="line"><span><b>Rechnungsnr.</b></span><span class="mono">${escapeHtml(f.invNo||"")}</span></div>
            <div class="line"><span>Datum</span><span>${escapeHtml(f.invDate||"")}</span></div>
            <div class="line"><span>F√§llig</span><span>${escapeHtml(f.dueDate||"")}</span></div>
            <div class="line"><span>Zweck</span><span class="mono">${escapeHtml(f.purpose||"")}</span></div>
          </div>
        </div>

        <div class="invGrid2" style="margin-top:12px">
          <div class="invBox">
            <h4>Rechnungssteller</h4>
            <div class="mini"><b>${escapeHtml(company)}</b></div>
            <div class="mini">${escapeHtml(f.issuerAddress||"")}</div>
            <div class="mini">Tel: ${escapeHtml(f.issuerPhone||"")}</div>
            <div class="mini">E-Mail: ${escapeHtml(f.issuerEmail||"")}</div>
            <div class="mini">Steuernr./Hinweis: ${escapeHtml(f.issuerTaxNo||"")}</div>
            ${String(f.issuerVatId||"").trim() ? `<div class="mini">USt-IdNr: ${escapeHtml(f.issuerVatId||"")}</div>` : ``}
          </div>

          <div class="invBox">
            <h4>Rechnung an</h4>
            <div class="mini"><b>${escapeHtml(f.custName||"")}</b></div>
            <div class="mini">${escapeHtml(f.custAddress||"").replaceAll("\n","<br/>")}</div>
            ${String(f.custEmail||"").trim() ? `<div class="mini">E-Mail: ${escapeHtml(f.custEmail||"")}</div>` : ``}
            ${String(f.custContact||"").trim() ? `<div class="mini">Ansprechpartner: ${escapeHtml(f.custContact||"")}</div>` : ``}
          </div>
        </div>

        <div class="invBox" style="margin-top:12px">
          <h4>Leistungs√ºbersicht</h4>
          <div class="mini">Nachtzeit laut Vereinbarung: ${escapeHtml(nightText)}</div>

          <table class="invTable">
            <thead>
              <tr>
                <th>Position</th>
                <th class="invRight">Mitarbeiter</th>
                <th class="invRight">Std.</th>
                <th class="invRight">Preis/Std.</th>
                <th class="invRight">Summe</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Tagdienst</td>
                <td class="invRight">${m}</td>
                <td class="invRight">${tagH}</td>
                <td class="invRight">${fmtEUR(tagPreis)}</td>
                <td class="invRight">${fmtEUR(tagSum)}</td>
              </tr>
              <tr>
                <td>Nachtdienst</td>
                <td class="invRight">${m}</td>
                <td class="invRight">${nachtH}</td>
                <td class="invRight">${fmtEUR(nachtPreisFinal)}</td>
                <td class="invRight">${fmtEUR(nachtSum)}</td>
              </tr>
              <tr>
                <td>Sonntag</td>
                <td class="invRight">${m}</td>
                <td class="invRight">${sonntagH}</td>
                <td class="invRight">${fmtEUR(sonntagPreisFinal)}</td>
                <td class="invRight">${fmtEUR(sonntagSum)}</td>
              </tr>
              <tr>
                <td>Feiertag</td>
                <td class="invRight">${m}</td>
                <td class="invRight">${feiertagH}</td>
                <td class="invRight">${fmtEUR(feiertagPreisFinal)}</td>
                <td class="invRight">${fmtEUR(feiertagSum)}</td>
              </tr>
            </tbody>
          </table>

          <div class="invTotals">
            <div class="tline"><span>Zwischensumme (netto)</span><span>${fmtEUR(subTotal)}</span></div>
            ${vatRate>0 ? `<div class="tline"><span>USt 19%</span><span>${fmtEUR(vatAmount)}</span></div>` : ``}
            <div class="tline grand"><span>Gesamtbetrag</span><span>${fmtEUR(grand)}</span></div>
          </div>

          <div class="invFooter">
            <div>${escapeHtml(vatLine)}</div>
            <div>${escapeHtml(modeLine)} Abrechnung gem√§√ü Einsatzzeiten.</div>
            ${note ? `<div><b>Hinweis:</b> ${escapeHtml(note)}</div>` : ``}
            <div style="margin-top:10px">
              <b>Bankverbindung:</b> IBAN ${escapeHtml(f.issuerIban||"")} ‚Ä¢ BIC ${escapeHtml(f.issuerBic||"")} ‚Ä¢ Inhaber ${escapeHtml(f.issuerHolder||"")}
            </div>
          </div>
        </div>
      `;
    }

    async function exportPdf(){
      if(!validateCore()) return;
      const inv = collectInvoice();
      await exportPdfFromInvoice(inv);
    }

    async function exportPdfFromInvoice(inv){
      const printArea = $("printArea");
      printArea.innerHTML = `<div class="printDoc">${buildPrintHtml(inv)}</div>`;
      $("printAreaWrap").style.display = "block";
      await waitImagesLoaded(printArea);

      const canvas = await html2canvas(printArea, {scale:2, useCORS:true, backgroundColor:"#ffffff"});
      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;

      const pdf = new jsPDF("p","mm","a4");
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const imgProps = pdf.getImageProperties(imgData);
      const imgW = pageW;
      const imgH = (imgProps.height * imgW) / imgProps.width;

      if(imgH <= pageH){
        pdf.addImage(imgData, "PNG", 0, 0, imgW, imgH);
      }else{
        let y = 0;
        let remaining = imgH;
        while(remaining > 0){
          pdf.addImage(imgData, "PNG", 0, y ? -y : 0, imgW, imgH);
          remaining -= pageH;
          if(remaining > 0) pdf.addPage();
          y += pageH;
        }
      }

      pdf.save(`${inv.invNo}.pdf`);
      $("printAreaWrap").style.display = "none";
      setStatus("PDF gespeichert", true);
    }

    // ‚úÖ Print fix: no blank second page + auto cleanup
    async function doPrint(){
      if(!validateCore()) return;
      const inv = collectInvoice();
      $("printArea").innerHTML = `<div class="printDoc">${buildPrintHtml(inv)}</div>`;
      $("printAreaWrap").style.display = "block";
      await waitImagesLoaded($("printArea"));

      const cleanup = ()=>{
        $("printAreaWrap").style.display = "none";
        window.removeEventListener("afterprint", cleanup);
      };
      window.addEventListener("afterprint", cleanup);

      window.print();
      setTimeout(cleanup, 1500);
    }

    // ===== Auto Save =====
    let autoSaveTimer = null;
    function autoSave(){
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(()=>{
        const state = collectInvoice().form;
        saveJSON(KEY_APP, state);
      }, 250);
    }
    function restoreAutoSave(){
      const state = loadJSON(KEY_APP, null);
      if(!state) return;
      for(const [k,v] of Object.entries(state)){
        if($(k)) $(k).value = v;
      }
    }

    // ===== Customers list view =====
    function renderCustomerList(){
      const wrap = $("custList");
      const customers = loadJSON(KEY_CUSTOMERS, []);
      $("custCount").textContent = String(customers.length);
      $("navCustCount").textContent = String(customers.length);

      wrap.innerHTML = "";
      customers.forEach(c=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <b>${escapeHtml(c.name||"")}</b>
            <small>${escapeHtml((c.address||"").slice(0,120))}${(c.address||"").length>120?"‚Ä¶":""}</small>
          </div>
          <div class="btns">
            <button type="button" data-id="${escapeAttr(c.id)}">Ausw√§hlen</button>
          </div>
        `;
        wrap.appendChild(el);
      });

      wrap.querySelectorAll("button[data-id]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-id");
          $("customerPick").value = id;
          $("customerPick").dispatchEvent(new Event("change"));
          setActiveNav("navCreate","viewCreate");
        });
      });
    }

    // ===== Nav =====
    function setActiveNav(btnId, viewId){
      ["navCreate","navInvoices","navCustomers","navSettings"].forEach(id=>{
        const b = $(id);
        if(b) b.classList.toggle("active", id===btnId);
      });
      ["viewCreate","viewInvoices","viewCustomers","viewSettings"].forEach(id=>{
        const v = $(id);
        if(v) v.classList.toggle("active", id===viewId);
      });
    }

    function syncCompanyMirror(){
      const main = $("issuerCompany");
      const mir = $("issuerCompanyMirror");
      if(!main || !mir) return;
      mir.value = main.value || "";
      mir.oninput = ()=>{
        main.value = mir.value;
        syncBrandEverywhere();
        calculate();
      };
    }

    function wireSidebar(){
      $("navCreate")?.addEventListener("click", ()=> setActiveNav("navCreate","viewCreate"));
      $("navInvoices")?.addEventListener("click", ()=>{
        setActiveNav("navInvoices","viewInvoices");
        renderInvoices();
      });
      $("navCustomers")?.addEventListener("click", ()=>{
        setActiveNav("navCustomers","viewCustomers");
        renderCustomerList();
      });
      $("navSettings")?.addEventListener("click", ()=>{
        setActiveNav("navSettings","viewSettings");
        syncCompanyMirror();
      });
      $("btnLogo2")?.addEventListener("click", ()=> $("logoFile")?.click());
    }

    function resetAll(){
      localStorage.removeItem(KEY_APP);
      localStorage.removeItem(KEY_CUSTOMERS);
      localStorage.removeItem(KEY_INVOICES);
      localStorage.removeItem(KEY_COUNTERS);
      // keep logo on reset? user asked "fest logo" -> keep it
      location.reload();
    }

    function newInvoice(){
      const keep = [
        "issuerCompany","issuerAddress","issuerPhone","issuerEmail","issuerTaxNo","issuerVatId","issuerIban","issuerBic","issuerHolder",
        "custName","custEmail","custContact","custAddress","customerPick",
        "vatMode","serviceTitle","objekt","zeitraum",
        "mitarbeiter","tagPreis","modus",
        "nachtPercent","sonntagPercent","feiertagPercent",
        "nachtFest","sonntagFest","feiertagFest",
        "nachtRule"
      ];
      const snapshot = {};
      keep.forEach(id=>{ if($(id)) snapshot[id] = $(id).value; });

      document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.id==="logoFile") return;
        if(el.type==="date") return;
        el.value = "";
      });

      Object.entries(snapshot).forEach(([id,val])=>{ if($(id)) $(id).value = val; });

      $("invDate").value = todayISO();
      $("dueDate").value = addDaysISO($("invDate").value, 14);
      $("invNo").value = nextInvoiceNo($("invDate").value);

      $("shiftStart").value = "18:00";
      $("shiftEnd").value = "06:00";
      calculateDayNight();

      $("sonntagH").value = 0;
      $("feiertagH").value = 0;
      $("note").value = "";
      $("rechnungText").value = "";

      setStatus("Neue Rechnung", true);
      calculate();
    }

    // ===== Wire =====
    function wire(){
      // logo
      $("btnLogo").addEventListener("click", ()=> $("logoFile").click());
      $("logoFile").addEventListener("change", (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        const rd = new FileReader();
        rd.onload = ()=> { setLogo(String(rd.result||""), true); setStatus("Logo gespeichert", true); };
        rd.readAsDataURL(file);
      });

      // header actions
      $("btnPdf").addEventListener("click", exportPdf);
      $("btnPrint").addEventListener("click", doPrint);
      $("btnReset").addEventListener("click", resetAll);
      $("btnNew").addEventListener("click", newInvoice);
      $("btnSave").addEventListener("click", saveInvoice);
      $("btnList").addEventListener("click", ()=>{
        setActiveNav("navInvoices","viewInvoices");
        renderInvoices();
      });

      // customers
      $("btnSaveCustomer").addEventListener("click", saveCustomer);
      $("btnDeleteCustomer").addEventListener("click", deleteCustomer);
      $("customerPick").addEventListener("change", (e)=> loadCustomer(e.target.value));

      // date change
      $("invDate").addEventListener("change", ()=>{
        $("dueDate").value = addDaysISO($("invDate").value, 14);
        $("invNo").value = nextInvoiceNo($("invDate").value);
        calculate();
      });

      // changes
      $("vatMode").addEventListener("change", calculate);
      $("modus").addEventListener("change", calculate);

      // auto day/night
      $("shiftStart").addEventListener("input", ()=>{ calculateDayNight(); calculate(); });
      $("shiftEnd").addEventListener("input", ()=>{ calculateDayNight(); calculate(); });
      $("nachtRule").addEventListener("change", ()=>{ calculateDayNight(); calculate(); });

      // input auto calc
      document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.id==="logoFile") return;
        if(el.id==="shiftStart" || el.id==="shiftEnd" || el.id==="nachtRule") return;
        el.addEventListener("input", calculate);
      });

      wireSidebar();
    }

    // ===== Init =====
    function initDefaults(){
      $("invDate").value = $("invDate").value || todayISO();
      $("dueDate").value = $("dueDate").value || addDaysISO($("invDate").value, 14);
      $("invNo").value = $("invNo").value || nextInvoiceNo($("invDate").value);
      updateVatHint();
      updatePurpose();
      renderCustomers();
      toggleModeUI();
      calculateDayNight();
      renderInvoices();
      renderCustomerList();
      syncCompanyMirror();
      syncBrandEverywhere();
      syncClickableLinks();
      setStatus("Bereit", true);
    }

    window.addEventListener("load", ()=>{
      try{
        loadLogo();
        restoreAutoSave();
        wire();
        initDefaults();
        calculate();
      }catch(e){
        showErr(e);
      }
    });
  </script>
</body>
  </html>
