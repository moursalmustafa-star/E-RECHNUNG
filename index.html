<!doctype html>

<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Rechnung</title>
  <meta name="theme-color" content="#0b1220"/>  <style>
    :root{
      --bg:#f3f5f8;
      --paper:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --line2:#cbd5e1;
      --accent:#0b3a78;
      --accent2:#0ea5e9;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --r:16px;
      --shadow: 0 18px 45px rgba(2,6,23,.10);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;}

    /* App Shell */
    .wrap{max-width:1050px;margin:22px auto;padding:0 14px;}
    .topbar{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px;}
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:44px;height:44px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent),#06254f);
      box-shadow:0 10px 26px rgba(11,58,120,.22);
      display:grid;place-items:center;color:#fff;font-weight:800;
      letter-spacing:.5px;overflow:hidden;
    }
    .brand h1{margin:0;font-size:18px;line-height:1.1}
    .brand .sub{margin-top:4px;color:var(--muted);font-size:12px}

    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{border:1px solid var(--line2);background:#fff;border-radius:12px;padding:10px 12px;font-weight:600;font-size:13px;cursor:pointer;box-shadow:0 10px 24px rgba(2,6,23,.06)}
    .btn.primary{border-color:transparent;background:var(--accent);color:#fff}
    .btn:active{transform:translateY(1px)}

    /* Paper */
    .paper{background:var(--paper);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;}

    .paperHeader{padding:22px 22px 16px;border-bottom:1px solid var(--line);display:grid;grid-template-columns:1.25fr .75fr;gap:18px;}

    .boxTitle{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px}

    .company{display:grid;gap:2px;font-size:13px;}
    .company b{font-size:14px}
    .company a{color:inherit;text-decoration:none;border-bottom:1px dotted var(--line2)}

    .meta{border:1px solid var(--line);border-radius:14px;padding:14px;display:grid;gap:10px}
    .metaRow{display:flex;justify-content:space-between;gap:10px;font-size:13px}
    .metaRow span{color:var(--muted)}
    .metaRow code{font-family:var(--mono);font-size:12px;background:#f8fafc;border:1px solid var(--line);padding:3px 6px;border-radius:8px}

    /* Editable form area */
    .paperBody{padding:18px 22px 8px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .field{display:grid;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input,textarea,select{
      width:100%;border:1px solid var(--line2);border-radius:12px;padding:10px 12px;
      font-size:14px;outline:none;background:#fff;
    }
    textarea{min-height:84px;resize:vertical}
    input:focus,textarea:focus,select:focus{border-color:rgba(14,165,233,.55);box-shadow:0 0 0 4px rgba(14,165,233,.12)}

    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    /* Table */
    .tableWrap{margin-top:14px;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{background:#f8fafc;border-bottom:1px solid var(--line);text-align:left;padding:12px 12px;color:#0f172a}
    tbody td{border-bottom:1px solid var(--line);padding:10px 12px;vertical-align:top}
    tbody tr:last-child td{border-bottom:none}
    .muted{color:var(--muted)}
    .right{text-align:right}

    .cellInput input{padding:8px 10px;font-size:13px;border-radius:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#f8fafc;padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}

    /* Totals */
    .totals{display:grid;grid-template-columns:1fr 360px;gap:14px;align-items:start;margin-top:14px}
    .notes{border:1px solid var(--line);border-radius:14px;padding:12px 12px;background:#fff}
    .notes p{margin:0;color:var(--muted);font-size:12.5px;line-height:1.4}

    .sumBox{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .sumRow{display:flex;justify-content:space-between;gap:10px;padding:7px 0;font-size:13px}
    .sumRow span{color:var(--muted)}
    .sumRow strong{font-variant-numeric:tabular-nums}
    .sumRow.total{border-top:1px dashed var(--line2);margin-top:6px;padding-top:12px;font-size:15px}

    /* Footer */
    .paperFooter{padding:16px 22px 22px;border-top:1px solid var(--line);display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .footCard{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .footCard h3{margin:0 0 8px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .footCard p{margin:0;font-size:12.8px;line-height:1.45;color:#0f172a}
    .footCard .small{color:var(--muted)}

    /* Print */
    @media print{
      body{background:#fff}
      .wrap{max-width:none;margin:0;padding:0}
      .topbar{display:none !important}
      .paper{border:none;border-radius:0;box-shadow:none}
      input,textarea,select{border:none;padding:0;box-shadow:none}
      .tableWrap,.meta,.notes,.sumBox,.footCard{border-color:#d1d5db}
      a{border:none;text-decoration:none}
    }

    @media (max-width:900px){
      .paperHeader{grid-template-columns:1fr}
      .totals{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
    }
  </style></head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" id="logoBox">
            <img id="logoImg" alt="Logo" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:12px"/>
            <span id="logoFallback">MS</span>
          </div>
        <div>
          <h1>Masculine Security — Rechnung <span id="statusBadge" style="display:inline-block;margin-left:8px;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#f8fafc;color:var(--muted);vertical-align:middle">Offen</span></h1>
          <div class="sub">Professionelle Rechnung (Lexoffice-Style) · automatisch: Datum, Rechnungsnummer, Summen</div>
        </div>
      </div>
      <div class="actions">
        <label class="btn" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
          Logo hochladen
          <input id="logoInput" type="file" accept="image/*" style="display:none"/>
        </label>
        <button class="btn" id="btnReset" type="button">Reset</button>
        <button class="btn" id="btnCopy" type="button">Rechnungsdaten kopieren</button>
        <button class="btn primary" type="button" onclick="window.print()">PDF drucken</button>
      </div>
    </div><section class="paper" id="paper">
  <header class="paperHeader">
    <div>
      <div class="boxTitle">Rechnungssteller</div>
      <div class="company">
        <b>Masculine Security</b>
        <div>Werschenregerstraße 6</div>
        <div>28237 Bremen</div>
        <div>Tel: <a href="tel:+4915778697052">015778697052</a></div>
        <div>E‑Mail: <a href="mailto:Kontakt.mass.bremen@hotmail.com">Kontakt.mass.bremen@hotmail.com</a></div>
        <div class="muted" style="margin-top:6px">Steuernummer: <span id="taxno">(in Bearbeitung)</span></div>
      </div>
    </div>

    <div>
      <div class="boxTitle">Rechnungsdaten</div>
      <div class="meta">
        <div class="metaRow"><span>Rechnungsdatum</span>
          <input id="invDateInput" type="date" oninput="recalcDatesFromInput();scheduleSave()" style="max-width:190px">
        </div>
        <div class="metaRow"><span>Rechnungsnummer</span>
          <input id="invNoInput" type="text" oninput="syncInvNo();scheduleSave()" style="max-width:190px;font-family:var(--mono)">
        </div>
        <div class="metaRow"><span>Status</span>
          <select id="invStatus" onchange="scheduleSave();updateStatusBadge()">
            <option value="Entwurf">Entwurf</option>
            <option value="Offen" selected>Offen</option>
            <option value="Bezahlt">Bezahlt</option>
            <option value="Überfällig">Überfällig</option>
          </select>
        </div>
        <div class="metaRow"><span>Fällig am</span>
          <input id="dueDateInput" type="date" oninput="scheduleSave()" style="max-width:190px">
        </div>
        <div class="metaRow"><span>Zahlungsziel</span>
          <select id="payTerm" onchange="recalcDates()">
            <option value="custom">Manuell</option>
            <option value="7">7 Tage</option>
            <option value="14" selected>14 Tage</option>
            <option value="30">30 Tage</option>
          </select>
        </div>
        <div class="metaRow"><span>Auto</span>
          <button class="btn" type="button" style="padding:8px 10px;border-radius:10px" onclick="regenInvoiceMeta()">Neu generieren</button>
        </div>
      </div>
    </div>
  </header>

  <div class="paperBody">
    <div class="grid">
      <div class="field">
        <label>Kunde / Rechnungsempfänger</label>

        <div class="split" style="grid-template-columns:1fr auto;align-items:center">
          <select id="kundeSelect" onchange="loadCustomerFromSelect();scheduleSave()">
            <option value="">— Kunde wählen —</option>
          </select>
          <button class="btn" type="button" style="padding:8px 10px;border-radius:10px" onclick="newCustomer()">Neu</button>
        </div>

        <div class="split" style="margin-top:8px;grid-template-columns:1fr auto auto;align-items:center">
          <input id="kundeName" placeholder="Kundenname (zum Speichern)"/>
          <button class="btn" type="button" style="padding:8px 10px;border-radius:10px" onclick="saveCustomer()">Speichern</button>
          <button class="btn" type="button" style="padding:8px 10px;border-radius:10px" onclick="deleteCustomer()">Löschen</button>
        </div>

        <textarea id="kunde" placeholder="Firma / Name&#10;Straße Hausnr.&#10;PLZ Ort&#10;(optional: Ansprechpartner)" oninput="scheduleSave()"></textarea>
        <div class="muted" style="font-size:12px;margin-top:6px">Tipp: Speichere häufige Kunden einmal – beim nächsten Mal nur auswählen.</div>
      </div>

      <div class="field">
        <label>Leistungsbeschreibung</label>
        <textarea id="leistung" placeholder="z.B. Objektschutz / Empfangsdienst / Baustellenbewachung">Security Dienstleistung</textarea>
      </div>

      <div class="field">
        <label>Leistungszeitraum</label>
        <div class="split">
          <input id="von" type="date" oninput="syncZeitraum()"/>
          <input id="bis" type="date" oninput="syncZeitraum()"/>
        </div>
        <div class="pill" style="margin-top:8px">
          Zeitraum: <strong id="zeitraumText">—</strong>
        </div>
      </div>

      <div class="field">
        <label>Interne Notiz (optional)</label>
        <input id="memo" placeholder="z.B. Objekt, Ansprechpartner, Schichtplan"/>
      </div>
    </div>

    <div class="tableWrap" style="margin-top:18px">
      <table>
        <thead>
          <tr>
            <th style="width:30%">Position</th>
            <th style="width:20%">Stunden</th>
            <th style="width:20%">Satz (€/h)</th>
            <th style="width:15%">Zuschlag %</th>
            <th class="right" style="width:15%">Betrag</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <strong>Grundlohn</strong><div class="muted">Arbeitszeit (normal)</div>
            </td>
            <td class="cellInput"><input id="hours" type="number" min="0" step="0.25" oninput="calc()" placeholder="z.B. 216"></td>
            <td class="cellInput"><input id="rate" type="number" min="0" step="0.01" value="25" oninput="calc()"></td>
            <td class="muted">—</td>
            <td class="right" id="sum_base">0,00 €</td>
          </tr>

          <tr>
            <td>
              <strong>Nachtschicht</strong><div class="muted">Zuschlag auf Grundsatz</div>
            </td>
            <td class="cellInput"><input id="night_hours" type="number" min="0" step="0.25" oninput="calc()" placeholder="z.B. 48"></td>
            <td class="muted">(wie Grundlohn)</td>
            <td class="cellInput" style="max-width:220px">
              <div style="display:flex;gap:8px;align-items:center">
                <input id="night_pct" type="number" min="0" step="0.1" value="5" oninput="calc()" style="max-width:110px"> <span class="muted">%</span>
              </div>
            </td>
            <td class="right" id="sum_night">0,00 €</td>
          </tr>

          <tr>
            <td>
              <strong>Sonntag</strong><div class="muted">Zuschlag (optional)</div>
            </td>
            <td class="cellInput"><input id="sun_hours" type="number" min="0" step="0.25" oninput="calc()" placeholder="0"></td>
            <td class="muted">(wie Grundlohn)</td>
            <td class="cellInput">
              <div style="display:flex;gap:8px;align-items:center">
                <input id="sun_pct" type="number" min="0" step="0.1" value="50" oninput="calc()" style="max-width:110px"> <span class="muted">%</span>
              </div>
            </td>
            <td class="right" id="sum_sun">0,00 €</td>
          </tr>

          <tr>
            <td>
              <strong>Feiertag</strong><div class="muted">Zuschlag (optional)</div>
            </td>
            <td class="cellInput"><input id="hol_hours" type="number" min="0" step="0.25" oninput="calc()" placeholder="0"></td>
            <td class="muted">(wie Grundlohn)</td>
            <td class="cellInput">
              <div style="display:flex;gap:8px;align-items:center">
                <input id="hol_pct" type="number" min="0" step="0.1" value="100" oninput="calc()" style="max-width:110px"> <span class="muted">%</span>
              </div>
            </td>
            <td class="right" id="sum_hol">0,00 €</td>
          </tr>

          <tr>
            <td>
              <strong>Rabatt / Abschlag</strong><div class="muted">optional (negativer Betrag)</div>
            </td>
            <td class="muted">—</td>
            <td class="muted">—</td>
            <td class="muted">—</td>
            <td class="cellInput right"><input id="discount" type="number" step="0.01" value="0" oninput="calc()" style="text-align:right" placeholder="0"></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="totals">
      <div class="notes">
        <p><strong>Hinweis:</strong> Zuschläge sind in der Rechnung als separate Positionen ausgewiesen. Passe die Prozentwerte nach Vertrag an (z. B. Nachtschicht 5% → 10%).</p>

        <div style="margin-top:10px;display:grid;gap:8px">
          <div class="pill" style="justify-content:space-between">
            <span><strong>USt-Status</strong></span>
            <select id="vatMode" onchange="calc();updateVatNote();scheduleSave()" style="max-width:260px">
              <option value="kru" selected>Kleinunternehmer (§19 UStG) — 0%</option>
              <option value="vat19">Regelbesteuerung — 19%</option>
              <option value="custom">Individuell (frei wählbar)</option>
            </select>
          </div>
          <div class="field" id="vatCustomWrap" style="display:none">
            <label>USt-Satz (%)</label>
            <input id="vatPct" type="number" min="0" step="0.1" value="19" oninput="calc();scheduleSave()"/>
          </div>
        </div>

        <p style="margin-top:10px"><em id="vatNote">Gemäß §19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).</em></p>
      </div>

      <div class="sumBox">
        <div class="sumRow"><span>Zwischensumme</span><strong id="subTotal">0,00 €</strong></div>
        <div class="sumRow"><span>Umsatzsteuer</span><strong id="vatTotal">0,00 €</strong></div>
        <div class="sumRow total"><span>Gesamtbetrag</span><strong id="grandTotal">0,00 €</strong></div>
      </div>
    </div>
  </div>

  <footer class="paperFooter">
    <div class="footCard">
      <h3>Zahlungsinformation</h3>
      <p>
        Bitte überweisen Sie den Gesamtbetrag unter Angabe der Rechnungsnummer.<br>
        <span class="small">Bankdaten (Beispiel / anpassen):</span><br>
        <strong>Kontoinhaber:</strong> <span id="accName">MUSTAFA MURSAL ABDI</span><br>
        <strong>IBAN:</strong> <span id="iban">DE98 1001 1001 2333 0146 96</span><br>
        <strong>BIC:</strong> <span id="bic">NTSBDEB1XXX</span>
      </p>
    </div>
    <div class="footCard">
      <h3>Kontakt</h3>
      <p>
        Masculine Security · Werschenregerstraße 6 · 28237 Bremen<br>
        Tel: <a href="tel:+4915778697052">015778697052</a> · E‑Mail: <a href="mailto:Kontakt.mass.bremen@hotmail.com">Kontakt.mass.bremen@hotmail.com</a><br>
        <span class="small">Vielen Dank für Ihren Auftrag.</span>
      </p>
    </div>
  </footer>
</section>

  </div>  <script>
    // ---------- Helpers ----------
    const $ = (id)=>document.getElementById(id);
    const LS_KEY = 'ms_invoice_app_v3';
    const LS_CUSTOMERS = 'ms_invoice_customers_v1';
    function num(id){
      const v = parseFloat($(id).value);
      return Number.isFinite(v) ? v : 0;
    }
    function money(x){
      return x.toLocaleString('de-DE',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' €';
    }
    function pad2(n){return String(n).padStart(2,'0')}
    function fmtDate(d){
      return pad2(d.getDate()) + '.' + pad2(d.getMonth()+1) + '.' + d.getFullYear();
    }

    function formatISOToDE(iso){
      if(!iso) return '';
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return String(iso);
      return fmtDate(d);
    }

    function saveState(){
      const state = {
        invNo: ($('invNoInput') ? $('invNoInput').value : ($('invNo') ? $('invNo').textContent : '')),
        invDate: $('invDateInput') ? $('invDateInput').value : '',
        dueDate: $('dueDateInput') ? $('dueDateInput').value : '',
        payTerm: $('payTerm').value,
        kunde: $('kunde').value,
        leistung: $('leistung').value,
        von: $('von').value,
        bis: $('bis').value,
        memo: $('memo').value,
        hours: $('hours').value,
        rate: $('rate').value,
        night_hours: $('night_hours').value,
        night_pct: $('night_pct').value,
        sun_hours: $('sun_hours').value,
        sun_pct: $('sun_pct').value,
        hol_hours: $('hol_hours').value,
        hol_pct: $('hol_pct').value,
        discount: $('discount').value,
        logoDataUrl: ($('logoImg') && $('logoImg').getAttribute('src')) ? $('logoImg').getAttribute('src') : '',
        invStatus: $('invStatus').value,
        kundeName: $('kundeName') ? $('kundeName').value : '',
        kundeSelected: $('kundeSelect') ? $('kundeSelect').value : ''
        vatMode: $('vatMode').value,
        vatPct: $('vatPct') ? $('vatPct').value : '19'
      };
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return;
        const s = JSON.parse(raw);
        if(s.invNo){
          if($('invNoInput')) $('invNoInput').value = s.invNo;
          if($('invNo')) $('invNo').textContent = s.invNo;
        }
        if(s.invDate && $('invDateInput')) $('invDateInput').value = s.invDate;
        if(s.dueDate && $('dueDateInput')) $('dueDateInput').value = s.dueDate;
        if(s.payTerm) $('payTerm').value = s.payTerm;
        $('kunde').value = s.kunde || '';
        $('leistung').value = s.leistung || 'Security Dienstleistung';
        $('von').value = s.von || '';
        $('bis').value = s.bis || '';
        $('memo').value = s.memo || '';
        $('hours').value = s.hours || '';
        $('rate').value = s.rate || '25';
        $('night_hours').value = s.night_hours || '';
        $('night_pct').value = s.night_pct || '5';
        $('sun_hours').value = s.sun_hours || '';
        $('sun_pct').value = s.sun_pct || '50';
        $('hol_hours').value = s.hol_hours || '';
        $('hol_pct').value = s.hol_pct || '100';
        $('discount').value = s.discount || '0';
        if(s.invStatus) $('invStatus').value = s.invStatus;
        if(s.vatMode) $('vatMode').value = s.vatMode;
        if(s.vatPct && $('vatPct')) $('vatPct').value = s.vatPct;
        if(s.logoDataUrl){
          applyLogo(s.logoDataUrl);
        }
        // Optional: restore selected customer name
        if(s.kundeName && $('kundeName')) $('kundeName').value = s.kundeName;
        if(s.kundeSelected && $('kundeSelect')) $('kundeSelect').value = s.kundeSelected;
      }catch(e){/* ignore */}
    }

    // ---------- Customers (Kundenliste) ----------
    function getCustomers(){
      try{
        const raw = localStorage.getItem(LS_CUSTOMERS);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function setCustomers(arr){
      localStorage.setItem(LS_CUSTOMERS, JSON.stringify(arr));
    }

    function refreshCustomerSelect(selectedName=''){
      const sel = $('kundeSelect');
      if(!sel) return;
      const customers = getCustomers().sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'de'));
      sel.innerHTML = '<option value="">— Kunde wählen —</option>' + customers.map(c=>{
        const n = (c.name||'').replace(/"/g,'&quot;');
        return `<option value="${n}">${n}</option>`;
      }).join('');
      sel.value = selectedName || '';
    }

    function loadCustomerFromSelect(){
      const sel = $('kundeSelect');
      const name = sel ? sel.value : '';
      const customers = getCustomers();
      const c = customers.find(x=>x.name===name);
      if(c){
        $('kunde').value = c.text || '';
        if($('kundeName')) $('kundeName').value = c.name || '';
      }
      scheduleSave();
    }

    function newCustomer(){
      if($('kundeSelect')) $('kundeSelect').value = '';
      if($('kundeName')) $('kundeName').value = '';
      $('kunde').value = '';
      scheduleSave();
    }

    function saveCustomer(){
      const name = ($('kundeName')?.value || '').trim();
      const text = ($('kunde')?.value || '').trim();
      if(!name){
        alert('Bitte Kundenname eingeben.');
        return;
      }
      if(!text){
        alert('Bitte Kundendaten eingeben.');
        return;
      }
      const customers = getCustomers();
      const idx = customers.findIndex(x=>x.name===name);
      const entry = { name, text, updatedAt: Date.now() };
      if(idx>=0) customers[idx]=entry; else customers.push(entry);
      setCustomers(customers);
      refreshCustomerSelect(name);
      if($('kundeSelect')) $('kundeSelect').value = name;
      scheduleSave();
    }

    function deleteCustomer(){
      const name = ($('kundeSelect')?.value || $('kundeName')?.value || '').trim();
      if(!name){
        alert('Bitte zuerst einen Kunden auswählen.');
        return;
      }
      if(!confirm(`Kunde "${name}" löschen?`)) return;
      const customers = getCustomers().filter(x=>x.name!==name);
      setCustomers(customers);
      refreshCustomerSelect('');
      newCustomer();
      scheduleSave();
    }

    let saveTimer;
    function scheduleSave(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveState, 250);
    }

    // ---------- Status badge ----------
    function updateStatusBadge(){
      const s = $('invStatus') ? $('invStatus').value : 'Offen';
      const b = $('statusBadge');
      if(!b) return;
      b.textContent = s;
      // simple styling
      if(s === 'Bezahlt'){
        b.style.background = 'rgba(22,163,74,.12)';
        b.style.borderColor = 'rgba(22,163,74,.35)';
        b.style.color = '#166534';
      }else if(s === 'Überfällig'){
        b.style.background = 'rgba(239,68,68,.10)';
        b.style.borderColor = 'rgba(239,68,68,.35)';
        b.style.color = '#991b1b';
      }else if(s === 'Entwurf'){
        b.style.background = 'rgba(59,130,246,.10)';
        b.style.borderColor = 'rgba(59,130,246,.25)';
        b.style.color = '#1e3a8a';
      }else{
        b.style.background = '#f8fafc';
        b.style.borderColor = 'var(--line)';
        b.style.color = 'var(--muted)';
      }
    }

    // ---------- VAT Note ----------
    function updateVatNote(){
      const mode = $('vatMode') ? $('vatMode').value : 'kru';
      const note = $('vatNote');
      if(!note) return;
      if(mode === 'kru'){
        note.textContent = 'Gemäß §19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).';
      }else if(mode === 'vat19'){
        note.textContent = 'Umsatzsteuer wird gemäß Regelbesteuerung ausgewiesen (19%).';
      }else{
        const p = num('vatPct');
        note.textContent = `Umsatzsteuer wird ausgewiesen (${p || 0}%).`;
      }
    }

    // ---------- Logo ----------
    function applyLogo(dataUrl){
      const img = $('logoImg');
      const fb = $('logoFallback');
      if(!img || !fb) return;
      img.src = dataUrl;
      img.style.display = 'block';
      fb.style.display = 'none';
    }

    function clearLogo(){
      const img = $('logoImg');
      const fb = $('logoFallback');
      if(!img || !fb) return;
      img.removeAttribute('src');
      img.style.display = 'none';
      fb.style.display = 'block';
    }

    function handleLogoFile(file){
      if(!file) return;
      const maxMB = 2;
      if(file.size > maxMB*1024*1024){
        alert('Logo ist zu groß. Bitte eine Datei unter 2 MB wählen.');
        return;
      }
      const reader = new FileReader();
      reader.onload = ()=>{
        applyLogo(String(reader.result));
        scheduleSave();
      };
      reader.readAsDataURL(file);
    }

    // ---------- Invoice No & Dates ----------
    function makeInvoiceNo(){
      const d = new Date();
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const day = pad2(d.getDate());
      const rand = String(Math.floor(Math.random()*900)+100);
      return `MS-${y}${m}${day}-${rand}`;
    }

    function toISODate(d){
      const x = new Date(d);
      const y = x.getFullYear();
      const m = pad2(x.getMonth()+1);
      const day = pad2(x.getDate());
      return `${y}-${m}-${day}`;
    }

    function syncInvNo(){
      // keep legacy spans (if present) in sync
      const v = $('invNoInput')?.value || '';
      if($('invNo')) $('invNo').textContent = v;
    }

    function recalcDatesFromInput(){
      // When user edits invoice date, recompute due date if payTerm is not manual
      const inv = $('invDateInput')?.value;
      if(!inv) return;
      const term = $('payTerm')?.value || '14';
      if(term === 'custom') return;
      const days = parseInt(term,10) || 14;
      const base = new Date(inv);
      const due = new Date(base);
      due.setDate(due.getDate() + days);
      if($('dueDateInput')) $('dueDateInput').value = toISODate(due);
    }

    function regenInvoiceMeta(){
      // Generate new invoice number + set invoice date to today
      const today = new Date();
      if($('invNoInput')) $('invNoInput').value = makeInvoiceNo();
      if($('invDateInput')) $('invDateInput').value = toISODate(today);
      // if term not manual, recalc due
      if(($('payTerm')?.value || '14') !== 'custom'){
        recalcDatesFromInput();
      }
      syncInvNo();
      scheduleSave();
    }

    function recalcDates(){
      // If user chose manual, do nothing.
      const term = $('payTerm') ? $('payTerm').value : '14';
      if(term === 'custom'){
        scheduleSave();
        return;
      }
      // Ensure invoice date exists
      const invVal = $('invDateInput')?.value;
      if(invVal){
        recalcDatesFromInput();
        scheduleSave();
        return;
      }
      // Fallback: set today
      const today = new Date();
      if($('invDateInput')) $('invDateInput').value = toISODate(today);
      recalcDatesFromInput();
      scheduleSave();
    }

    function syncZeitraum(){
      const v = $('von').value;
      const b = $('bis').value;
      if(!v && !b){
        $('zeitraumText').textContent = '—';
        scheduleSave();
        return;
      }
      const parts = [];
      if(v) parts.push(fmtDate(new Date(v)));
      else parts.push('…');
      parts.push('–');
      if(b) parts.push(fmtDate(new Date(b)));
      else parts.push('…');
      $('zeitraumText').textContent = parts.join(' ');
      scheduleSave();
    }

    // ---------- Calculations ----------
    function calc(){
      const h = num('hours');
      const r = num('rate');

      const nh = num('night_hours');
      const np = num('night_pct');

      const sh = num('sun_hours');
      const sp = num('sun_pct');

      const fh = num('hol_hours');
      const fp = num('hol_pct');

      const disc = num('discount'); // discount amount (positive number => reduce)

      const base = h * r;
      const night = nh * r * (np/100);
      const sun = sh * r * (sp/100);
      const hol = fh * r * (fp/100);

      // Discount: treated as subtraction
      const net = Math.max(0, base + night + sun + hol - disc);

      // VAT logic
      const mode = $('vatMode') ? $('vatMode').value : 'kru';
      let vatRate = 0;
      if(mode === 'vat19') vatRate = 0.19;
      if(mode === 'custom'){
        const p = num('vatPct');
        vatRate = Math.max(0, p) / 100;
      }
      const vat = net * vatRate;
      const gross = net + vat;

      $('sum_base').textContent = money(base);
      $('sum_night').textContent = money(night);
      $('sum_sun').textContent = money(sun);
      $('sum_hol').textContent = money(hol);

      $('subTotal').textContent = money(net);
      $('vatTotal').textContent = money(vat);
      $('grandTotal').textContent = money(gross);

      // toggle custom VAT UI
      if($('vatCustomWrap')) $('vatCustomWrap').style.display = (mode === 'custom') ? 'block' : 'none';

      scheduleSave();
    }

    // ---------- Copy helper ----------
    async function copyData(){
      const txt = [
        `Rechnungsnummer: ${$('invNoInput')?.value || $('invNo')?.textContent || ''}`, 
        `Rechnungsdatum: ${formatISOToDE($('invDateInput')?.value)}`, 
        `Faellig am: ${formatISOToDE($('dueDateInput')?.value)}`, 
        `Kunde:
${$('kunde').value}`,
        `Leistung:
${$('leistung').value}`,
        `Zeitraum: ${$('zeitraumText').textContent}`,
        `Grundlohn: ${$('hours').value || 0}h x ${$('rate').value || 0} €/h` ,
        `Nachtschicht: ${$('night_hours').value || 0}h @ ${$('night_pct').value || 0}%` ,
        `Sonntag: ${$('sun_hours').value || 0}h @ ${$('sun_pct').value || 0}%` ,
        `Feiertag: ${$('hol_hours').value || 0}h @ ${$('hol_pct').value || 0}%` ,
        `Rabatt/Abschlag: ${$('discount').value || 0} €` ,
        `Gesamt: ${$('grandTotal').textContent}`
      ]
      ].join('
');

      try{
        await navigator.clipboard.writeText(txt);
        $('btnCopy').textContent = 'Kopiert ✓';
        setTimeout(()=> $('btnCopy').textContent = 'Rechnungsdaten kopieren', 1500);
      }catch(e){
        alert('Kopieren nicht möglich. Bitte manuell markieren.');
      }
    }

    function resetAll(){
      if(!confirm('Alle Eingaben löschen?')) return;
      $('kunde').value='';
      $('leistung').value='Security Dienstleistung';
      $('von').value='';
      $('bis').value='';
      $('memo').value='';
      $('hours').value='';
      $('rate').value='25';
      $('night_hours').value='';
      $('night_pct').value='5';
      $('sun_hours').value='';
      $('sun_pct').value='50';
      $('hol_hours').value='';
      $('hol_pct').value='100';
      $('discount').value='0';
      $('invStatus').value='Offen';
      $('vatMode').value='kru';
      if($('vatPct')) $('vatPct').value='19';
      clearLogo();
      if($('invNoInput')) $('invNoInput').value = makeInvoiceNo();
      if($('invNo')) $('invNo').textContent = $('invNoInput') ? $('invNoInput').value : '';
      // default invoice date today
      if($('invDateInput')) $('invDateInput').value = toISODate(new Date());
      syncZeitraum();
      recalcDates();
      updateStatusBadge();
      updateVatNote();
      calc();
      saveState();
    }

    // ---------- Init ----------
    (function init(){
      // set defaults first
      if($('invNoInput')) $('invNoInput').value = makeInvoiceNo();
      if($('invNo')) $('invNo').textContent = $('invNoInput') ? $('invNoInput').value : '';
      if($('invDateInput')) $('invDateInput').value = toISODate(new Date());
      recalcDates();
      syncZeitraum();
      updateStatusBadge();
      updateVatNote();
      calc();

      // customers
      refreshCustomerSelect('');

      // load saved state (overrides defaults)
      loadState();
      refreshCustomerSelect($('kundeSelect') ? $('kundeSelect').value : '');
      recalcDates();
      syncZeitraum();
      updateStatusBadge();
      updateVatNote();
      calc();

      $('btnCopy').addEventListener('click', copyData);
      $('btnReset').addEventListener('click', resetAll);

      // invoice meta inputs
      if($('invNoInput')) $('invNoInput').addEventListener('input', ()=>{ syncInvNo(); scheduleSave(); });
      if($('invDateInput')) $('invDateInput').addEventListener('input', ()=>{ recalcDatesFromInput(); scheduleSave(); });
      if($('dueDateInput')) $('dueDateInput').addEventListener('input', scheduleSave);
      if($('payTerm')) $('payTerm').addEventListener('change', recalcDates);

      $('invStatus').addEventListener('change', ()=>{ updateStatusBadge(); scheduleSave(); });
      $('vatMode').addEventListener('change', ()=>{ updateVatNote(); calc(); scheduleSave(); });
      if($('vatPct')) $('vatPct').addEventListener('input', ()=>{ updateVatNote(); calc(); scheduleSave(); });

      // autosave on text fields
      ['kunde','kundeName','leistung','memo','hours','rate','night_hours','night_pct','sun_hours','sun_pct','hol_hours','hol_pct','discount'].forEach(id=>{
        if($(id)) $(id).addEventListener('input', scheduleSave);
      });

      // logo upload
      $('logoInput').addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        handleLogoFile(f);
        e.target.value = '';
      });
    })();
  </script></body>
</html>
