<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Masculine Security ‚Äî B2B Rechnung (Simple)</title>

  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand:#0b5fa8;
      --brand2:#0a4d86;
      --bg:#f6f8fc;
      --card:#ffffff;
      --ink:#0b1220;
      --muted:#64748b;
      --line:#e2e8f0;
      --r:16px;
      --shadow:0 18px 50px rgba(15,23,42,.10);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--ink);
      background:
        radial-gradient(1000px 500px at 10% -10%, rgba(11,95,168,.16), transparent 55%),
        radial-gradient(900px 500px at 90% 0%, rgba(10,77,134,.12), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px 12px 50px}
    .top{
      position:sticky;top:0;z-index:9;
      background:rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(226,232,240,.9);
    }
    .topInner{max-width:1100px;margin:0 auto;padding:12px 12px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;min-width:240px}
    .logo{
      width:44px;height:44px;border-radius:14px;overflow:hidden;
      border:1px solid rgba(11,95,168,.18);
      background:linear-gradient(180deg, rgba(11,95,168,.12), rgba(11,95,168,.04));
      box-shadow:0 10px 26px rgba(15,23,42,.08);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:950;color:#0a2540;line-height:1.1}
    .sub{font-size:12px;color:var(--muted)}
    .actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    button{
      border:1px solid var(--line);
      background:#fff;
      color:#0a2540;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
    }
    button:hover{box-shadow:0 10px 24px rgba(15,23,42,.10)}
    button.primary{
      background:linear-gradient(180deg, var(--brand), var(--brand2));
      color:#fff;border-color:rgba(11,95,168,.28);
      box-shadow:0 14px 32px rgba(11,95,168,.22);
    }
    button.ok{
      background:linear-gradient(180deg, #17b897, #12a988);
      color:#fff;border-color:rgba(18,169,136,.28);
      box-shadow:0 14px 32px rgba(18,169,136,.20);
    }
    button.danger{
      background:linear-gradient(180deg, #ff4d6d, #e11d48);
      color:#fff;border-color:rgba(225,29,72,.28);
      box-shadow:0 14px 32px rgba(225,29,72,.18);
    }
    .chips{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;font-size:12px;color:var(--muted)}
    .chipLink{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:#fff;color:#0a2540;font-weight:900;text-decoration:none;
      box-shadow:0 8px 20px rgba(15,23,42,.06);
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:#fff;color:var(--muted);font-weight:800;
      box-shadow:0 8px 20px rgba(15,23,42,.06);
    }
    .dot{width:8px;height:8px;border-radius:99px;background:#22c55e}

    .grid{display:grid;gap:14px;margin-top:14px}
    @media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{
      background:var(--card);
      border:1px solid rgba(226,232,240,.95);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;padding:14px 16px;
      font-size:13px;color:#0a2540;font-weight:950;
      background:linear-gradient(180deg,#fff,#fbfdff);
      border-bottom:1px solid rgba(226,232,240,.95);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .body{padding:14px 16px}
    .row2{display:grid;gap:10px}
    @media(min-width:720px){.row2{grid-template-columns:1fr 1fr}}
    .row3{display:grid;gap:10px}
    @media(min-width:720px){.row3{grid-template-columns:1fr 1fr 1fr}}

    label{display:block;font-size:12px;color:var(--muted);font-weight:800;margin:0 0 6px}
    input,select,textarea{
      width:100%;
      border:1px solid rgba(226,232,240,.98);
      border-radius:14px;
      padding:11px 12px;
      background:#fff;
      outline:none;
      font:inherit;
    }
    input:focus,select:focus,textarea:focus{
      border-color:rgba(11,95,168,.45);
      box-shadow:0 0 0 4px rgba(11,95,168,.10);
    }
    textarea{min-height:92px;resize:vertical}
    .mono{font-family:var(--mono)}
    .hr{height:1px;background:rgba(226,232,240,.95);margin:12px 0}
    .note{
      font-size:12px;color:var(--muted);
      border:1px solid rgba(226,232,240,.98);
      background:linear-gradient(180deg,#fff,#fbfdff);
      border-radius:14px;
      padding:10px;
    }
    .kpi{display:grid;gap:10px}
    @media(min-width:720px){.kpi{grid-template-columns:1fr 1fr}}
    .kpi .box{
      border:1px solid rgba(226,232,240,.98);
      border-radius:16px;
      padding:12px;background:linear-gradient(180deg,#fff,#fbfdff);
    }
    .kpi .big{font-size:22px;font-weight:950}
    .kpi .small{font-size:12px;color:var(--muted);font-weight:800}

    table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      border:1px solid rgba(226,232,240,.98);
      border-radius:16px;overflow:hidden;
    }
    th,td{padding:10px;border-bottom:1px solid rgba(226,232,240,.98);font-size:13px}
    th{background:#f7fafc;text-align:left;font-weight:950;color:#0a2540}
    tr:last-child td{border-bottom:0}
    .right{text-align:right}

    .list{display:grid;gap:10px}
    .item{
      border:1px solid rgba(226,232,240,.98);
      border-radius:16px;padding:12px;
      display:flex;gap:12px;justify-content:space-between;align-items:flex-start;
      box-shadow:0 10px 26px rgba(15,23,42,.06);
      background:#fff;
    }
    .item small{color:var(--muted)}
    .item .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .item .btns button{border-radius:12px}

    /* PRINT/PDF */
    @page { size: A4; margin: 10mm; }
    #printWrap{display:none;background:#fff}
    #printArea{width:190mm;margin:0 auto;color:#111;background:#fff}
    .a4{width:190mm;page-break-inside:avoid;break-inside:avoid}
    @media print{
      body{background:#fff}
      .top,.wrap{display:none!important}
      #printWrap{display:block!important}
    }
    .invHeader{display:flex;justify-content:space-between;gap:14px;align-items:flex-start}
    .invLeft{display:flex;gap:10px;align-items:center}
    .invLogo{width:52px;height:52px;border-radius:16px;overflow:hidden;border:1px solid #e5e8ef;flex:0 0 auto}
    .invLogo img{width:100%;height:100%;object-fit:cover}
    .invTitle{margin:0;font-size:22px;font-weight:950}
    .invMeta{font-size:12px;color:#334155}
    .invBox{border:1px solid #e5e8ef;border-radius:16px;padding:10px}
    .invBox h4{margin:0 0 8px;font-size:12px;color:#0a2540}
    .invLine{display:flex;justify-content:space-between;gap:10px;font-size:12px;margin:4px 0}
    .invGrid2{display:grid;gap:10px;margin-top:12px;grid-template-columns:1fr 1fr}
    .invTable{width:100%;border-collapse:collapse;margin-top:10px}
    .invTable th,.invTable td{border:1px solid #e5e8ef;padding:7px;font-size:12px}
    .invTable th{background:#f5f7fb}
    .invRight{text-align:right}
    .invTotals{display:grid;gap:6px;margin-top:10px}
    .invTotals .tline{display:flex;justify-content:space-between;font-size:12px}
    .invTotals .grand{font-size:14px;font-weight:950}
    .invFooter{margin-top:12px;font-size:11px;color:#334155}
  </style>
</head>

<body>
  <div class="top">
    <div class="topInner">
      <div class="row">
        <div class="brand">
          <div class="logo" title="Logo (fest gespeichert)">
            <img id="logoImg" alt="Logo"/>
          </div>
          <div>
            <div class="title" id="topBrand">Masculine Security</div>
            <div class="sub">Simple B2B Rechnung ‚Ä¢ Festpreise ‚Ä¢ Auto-Save</div>
          </div>
        </div>

        <div class="actions">
          <button type="button" id="btnLogo">Logo √§ndern</button>
          <button type="button" id="btnNew">Neu</button>
          <button type="button" class="ok" id="btnSaveInv">Rechnung speichern</button>
          <button type="button" id="btnShowInv">Rechnungen</button>
          <button type="button" class="danger" id="btnReset">Reset</button>
          <button type="button" class="primary" id="btnPdf">PDF</button>
          <button type="button" class="primary" id="btnPrint">Print</button>
        </div>
      </div>

      <div class="chips">
        <span class="badge"><span class="dot"></span> Auto-Save</span>
        <a class="chipLink" id="telLink" href="tel:015778697052">üìû <span id="telText">015778697052</span></a>
        <a class="chipLink" id="mailLink" href="mailto:Kontakt.mass.bremen@hotmail.com">‚úâÔ∏è <span id="mailText">Kontakt.mass.bremen@hotmail.com</span></a>
        <span class="badge">B2B Ready</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- FORM -->
      <div class="card" id="viewForm">
        <h2><span>Rechnung erstellen</span><span class="badge" id="status">Bereit</span></h2>
        <div class="body">
          <div class="row2">
            <div>
              <label>Firmenname / Brand *</label>
              <input id="issuerCompany" value="Masculine Security"/>
            </div>
            <div>
              <label>Adresse *</label>
              <input id="issuerAddress" value="Werschenregerstra√üe 6 ‚Ä¢ 28237 Bremen"/>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Telefon</label>
              <input id="issuerPhone" value="015778697052"/>
            </div>
            <div>
              <label>E-Mail *</label>
              <input id="issuerEmail" value="Kontakt.mass.bremen@hotmail.com"/>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Steuernummer / Hinweis *</label>
              <input id="issuerTax" value="wird nachgereicht"/>
            </div>
            <div>
              <label>USt-IdNr (optional)</label>
              <input id="issuerVat" placeholder="DE123456789"/>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>IBAN *</label>
              <input id="iban" value="DE98 1001 1001 2333 0146 96"/>
            </div>
            <div>
              <label>BIC *</label>
              <input id="bic" value="NTSBDEB1XXX"/>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Kontoinhaber *</label>
              <input id="holder" value="MUSTAFA MURSAL ABDI"/>
            </div>
            <div>
              <label>USt-Status *</label>
              <select id="vatMode">
                <option value="kmu">0% (Kleinunternehmer ¬ß19)</option>
                <option value="vat19">19% USt</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <!-- CUSTOMER -->
          <div class="row2">
            <div>
              <label>Kunde w√§hlen (100% working)</label>
              <select id="customerSelect"></select>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
                <button type="button" id="btnSaveCustomer">Kunde speichern</button>
                <button type="button" class="danger" id="btnDeleteCustomer">Kunde l√∂schen</button>
              </div>
              <div class="note" style="margin-top:10px">
                Tipp: Kunde speichern ‚Üí danach dropdown ka ka dooro.
              </div>
            </div>

            <div>
              <label>Kundenname *</label>
              <input id="custName" placeholder="Firma / Name"/>
              <div class="row2" style="margin-top:10px">
                <div>
                  <label>E-Mail (optional)</label>
                  <input id="custEmail" placeholder="kunde@email.de"/>
                </div>
                <div>
                  <label>Ansprechpartner (optional)</label>
                  <input id="custContact" placeholder="Ansprechpartner"/>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Kundendaten (Adresse) *</label>
            <textarea id="custAddress" placeholder="Stra√üe ‚Ä¢ PLZ Ort&#10;Ansprechpartner"></textarea>
          </div>

          <div class="hr"></div>

          <div class="row3">
            <div>
              <label>Rechnungsdatum *</label>
              <input id="invDate" type="date"/>
            </div>
            <div>
              <label>F√§llig am *</label>
              <input id="dueDate" type="date"/>
            </div>
            <div>
              <label>Rechnungsnummer *</label>
              <input id="invNo" class="mono"/>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Leistungsbeschreibung *</label>
              <input id="serviceTitle" value="Sicherheitsdienstleistung ‚Äì Objektschutz"/>
            </div>
            <div>
              <label>Objekt/Ort (optional)</label>
              <input id="objekt" placeholder="z.B. Bremen"/>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Zeitraum (optional)</label>
              <input id="zeitraum" placeholder="z.B. 08.03.2026 ‚Äì 09.03.2026"/>
            </div>
            <div>
              <label>Verwendungszweck (auto)</label>
              <input id="purpose" class="mono" readonly/>
            </div>
          </div>

          <div class="hr"></div>

          <!-- PRICES -->
          <div class="row2">
            <div>
              <label>Anzahl Mitarbeiter *</label>
              <input id="mCount" type="number" min="0" value="5"/>
            </div>
            <div>
              <label>Tag (‚Ç¨ / Std.) *</label>
              <input id="pTag" type="number" step="0.01" value="23"/>
            </div>
          </div>

          <div class="row3" style="margin-top:10px">
            <div>
              <label>Nacht (‚Ç¨ / Std.) *</label>
              <input id="pNacht" type="number" step="0.01" value="24"/>
            </div>
            <div>
              <label>Sonntag (‚Ç¨ / Std.) *</label>
              <input id="pSonntag" type="number" step="0.01" value="32"/>
            </div>
            <div>
              <label>Feiertag (‚Ç¨ / Std.) *</label>
              <input id="pFeiertag" type="number" step="0.01" value="36"/>
            </div>
          </div>

          <div class="note" style="margin-top:10px">
            B2B firms badanaa waxay jecel yihiin <b>Festpreise</b> (Tag/Nacht/Sonntag/Feiertag) ‚Äî waa cad oo sahlan.
          </div>

          <div class="hr"></div>

          <!-- HOURS -->
          <div class="row3">
            <div>
              <label>Tagstunden</label>
              <input id="hTag" type="number" step="0.25" value="0"/>
            </div>
            <div>
              <label>Nachtstunden</label>
              <input id="hNacht" type="number" step="0.25" value="0"/>
            </div>
            <div>
              <label>Sonntagstunden</label>
              <input id="hSonntag" type="number" step="0.25" value="0"/>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>Feiertagstunden</label>
              <input id="hFeiertag" type="number" step="0.25" value="0"/>
              <div class="note" style="margin-top:8px">Stunden kaliya hal category ku qor (no double).</div>
            </div>
            <div>
              <label>Notiz (optional)</label>
              <textarea id="note" placeholder="z.B. laut Vereinbarung / Ansprechpartner..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- SUMMARY + LISTS -->
      <div class="card">
        <h2><span>Summe & Listen</span><span class="badge mono" id="badgeMode">B2B</span></h2>
        <div class="body">

          <div class="kpi">
            <div class="box">
              <div class="small">Zwischensumme (netto)</div>
              <div class="big mono" id="subTotal">0,00 ‚Ç¨</div>
            </div>
            <div class="box">
              <div class="small">Gesamt (brutto)</div>
              <div class="big mono" id="grandTotal">0,00 ‚Ç¨</div>
            </div>
          </div>

          <div class="hr"></div>

          <table>
            <thead>
              <tr>
                <th>Position</th>
                <th class="right">Std.</th>
                <th class="right">Preis</th>
                <th class="right">Summe</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Tag</td><td class="right mono" id="tH1">0</td><td class="right mono" id="tP1">0,00 ‚Ç¨</td><td class="right mono" id="tS1">0,00 ‚Ç¨</td></tr>
              <tr><td>Nacht</td><td class="right mono" id="tH2">0</td><td class="right mono" id="tP2">0,00 ‚Ç¨</td><td class="right mono" id="tS2">0,00 ‚Ç¨</td></tr>
              <tr><td>Sonntag</td><td class="right mono" id="tH3">0</td><td class="right mono" id="tP3">0,00 ‚Ç¨</td><td class="right mono" id="tS3">0,00 ‚Ç¨</td></tr>
              <tr><td>Feiertag</td><td class="right mono" id="tH4">0</td><td class="right mono" id="tP4">0,00 ‚Ç¨</td><td class="right mono" id="tS4">0,00 ‚Ç¨</td></tr>
            </tbody>
          </table>

          <div class="hr"></div>

          <div class="note">
            <b>Formel:</b> Mitarbeiter √ó Stunden √ó Preis/Std.
            <div class="mono" style="margin-top:6px" id="formulaLine">5 √ó 0 √ó 23,00 ‚Ç¨</div>
          </div>

          <div class="hr"></div>

          <div class="row2">
            <div>
              <h3 style="margin:0 0 8px;font-size:13px;color:#0a2540">Rechnungen</h3>
              <div class="list" id="invList"></div>
            </div>
            <div>
              <h3 style="margin:0 0 8px;font-size:13px;color:#0a2540">Kunden</h3>
              <div class="list" id="custList"></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- PRINT -->
  <div id="printWrap"><div id="printArea"></div></div>

  <input id="logoFile" type="file" accept="image/*" style="display:none"/>

  <script>
    // ===== Keys =====
    const KEY = {
      APP: "ms_b2b_simple_app_v1",
      LOGO:"ms_b2b_simple_logo_v1",
      CUSTOMERS:"ms_b2b_simple_customers_v1",
      INVOICES:"ms_b2b_simple_invoices_v1",
      COUNTERS:"ms_b2b_simple_counters_v1"
    };

    const $ = (id)=>document.getElementById(id);

    const fmtEUR = (n)=>{
      const v = Number(n||0);
      return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨";
    };
    const safeNum = (v)=> {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };
    const todayISO = ()=>{
      const d=new Date();
      const yyyy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const addDaysISO=(iso,days)=>{
      const d=new Date(iso+"T00:00:00");
      d.setDate(d.getDate()+days);
      const yyyy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const yyyymmdd=(iso)=>String(iso||"").replaceAll("-","");
    const loadJSON=(k,fallback)=>{
      try{const v=localStorage.getItem(k);return v?JSON.parse(v):fallback;}catch(e){return fallback;}
    };
    const saveJSON=(k,v)=>localStorage.setItem(k, JSON.stringify(v));

    function setStatus(txt, ok=true){
      $("status").innerHTML = (ok?`<span class="dot"></span> `:`‚ö†Ô∏è `) + txt;
      $("status").style.borderColor = ok ? "rgba(34,197,94,.25)" : "rgba(225,29,72,.25)";
    }

    // ===== Logo =====
    function setLogo(dataUrl, persist=true){
      $("logoImg").src = dataUrl;
      if(persist) localStorage.setItem(KEY.LOGO, dataUrl);
    }
    function loadLogo(){
      const saved = localStorage.getItem(KEY.LOGO);
      if(saved){ setLogo(saved,false); return; }
      const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="120" height="120" rx="24" fill="#0b5fa8"/><text x="60" y="72" font-size="54" text-anchor="middle" fill="white" font-family="Arial" font-weight="900">M</text></svg>`);
      setLogo(`data:image/svg+xml,${svg}`, false);
    }

    // ===== Invoice number =====
    function nextInvoiceNo(dateISO){
      const counters = loadJSON(KEY.COUNTERS,{});
      const d = yyyymmdd(dateISO || todayISO());
      const cur = safeNum(counters[d]) || 0;
      const next = cur + 1;
      counters[d]=next;
      saveJSON(KEY.COUNTERS,counters);
      return `MS-${d}-${String(next).padStart(4,"0")}`;
    }
    function updatePurpose(){
      $("purpose").value = `Rechnung: ${$("invNo").value||""}`;
    }

    // ===== Clickable contacts =====
    function syncContacts(){
      const tel = String($("issuerPhone").value||"").replace(/\s+/g,"");
      const mail = String($("issuerEmail").value||"").trim();
      if(tel){
        $("telLink").href = `tel:${tel}`;
        $("telText").textContent = tel;
      }
      if(mail){
        $("mailLink").href = `mailto:${mail}`;
        $("mailText").textContent = mail;
      }
      $("topBrand").textContent = $("issuerCompany").value || "Masculine Security";
    }

    // ===== Customers (100% working select) =====
    function customers(){
      return loadJSON(KEY.CUSTOMERS, []);
    }
    function saveCustomers(arr){
      saveJSON(KEY.CUSTOMERS, arr);
    }
    function refreshCustomerSelect(selectedId=""){
      const list = customers();
      const sel = $("customerSelect");
      sel.innerHTML = "";
      const o0 = document.createElement("option");
      o0.value = "";
      o0.textContent = "‚Äî ausw√§hlen ‚Äî";
      sel.appendChild(o0);

      for(const c of list){
        const o = document.createElement("option");
        o.value = c.id;
        o.textContent = c.name;
        sel.appendChild(o);
      }
      sel.value = selectedId || "";
      renderCustomerList();
    }

    function cryptoId(){
      if(window.crypto?.getRandomValues){
        const a=new Uint32Array(2);
        window.crypto.getRandomValues(a);
        return a[0].toString(16)+a[1].toString(16);
      }
      return String(Date.now()) + Math.random().toString(16).slice(2);
    }

    function saveCustomer(){
      const name = String($("custName").value||"").trim();
      const addr = String($("custAddress").value||"").trim();
      if(!name || !addr){ setStatus("Kunde: Name/Adresse fehlt", false); return; }

      const list = customers();
      const id = cryptoId();
      list.unshift({
        id,
        name,
        email: String($("custEmail").value||"").trim(),
        contact: String($("custContact").value||"").trim(),
        address: addr
      });
      saveCustomers(list);
      refreshCustomerSelect(id);
      setStatus("Kunde gespeichert", true);
    }

    function loadCustomerById(id){
      if(!id) return;
      const c = customers().find(x=>x.id===id);
      if(!c) return;
      $("custName").value = c.name || "";
      $("custEmail").value = c.email || "";
      $("custContact").value = c.contact || "";
      $("custAddress").value = c.address || "";
      setStatus("Kunde geladen", true);
      autoSave();
    }

    function deleteCustomer(){
      const id = $("customerSelect").value;
      if(!id){ setStatus("Kein Kunde ausgew√§hlt", false); return; }
      const list = customers().filter(x=>x.id!==id);
      saveCustomers(list);
      refreshCustomerSelect("");
      setStatus("Kunde gel√∂scht", true);
    }

    function renderCustomerList(){
      const wrap = $("custList");
      const list = customers();
      wrap.innerHTML = "";
      for(const c of list.slice(0,10)){
        const el=document.createElement("div");
        el.className="item";
        el.innerHTML = `
          <div>
            <b>${escapeHtml(c.name)}</b>
            <small>${escapeHtml((c.address||"").slice(0,80))}${(c.address||"").length>80?"‚Ä¶":""}</small>
          </div>
          <div class="btns">
            <button type="button" data-id="${escapeAttr(c.id)}">W√§hlen</button>
          </div>
        `;
        wrap.appendChild(el);
      }
      wrap.querySelectorAll("button[data-id]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id=b.getAttribute("data-id");
          $("customerSelect").value=id;
          loadCustomerById(id);
        });
      });
    }

    // ===== Invoices =====
    function invoices(){ return loadJSON(KEY.INVOICES, []); }
    function saveInvoices(arr){ saveJSON(KEY.INVOICES, arr); }

    function requiredOk(){
      const must = [
        ["issuerCompany","Firmenname"],["issuerAddress","Adresse"],["issuerEmail","E-Mail"],
        ["issuerTax","Steuernr./Hinweis"],["iban","IBAN"],["bic","BIC"],["holder","Kontoinhaber"],
        ["custName","Kundenname"],["custAddress","Kundenadresse"],
        ["invDate","Rechnungsdatum"],["dueDate","F√§llig"],["invNo","Rechnungsnummer"],
        ["serviceTitle","Leistungsbeschreibung"]
      ];
      for(const [id,label] of must){
        if(!String($(id).value||"").trim()){
          setStatus(`Fehlt: ${label}`, false);
          return false;
        }
      }
      return true;
    }

    function collectForm(){
      const ids = [
        "issuerCompany","issuerAddress","issuerPhone","issuerEmail","issuerTax","issuerVat",
        "iban","bic","holder","vatMode",
        "custName","custEmail","custContact","custAddress",
        "invDate","dueDate","invNo","purpose",
        "serviceTitle","objekt","zeitraum","note",
        "mCount","pTag","pNacht","pSonntag","pFeiertag",
        "hTag","hNacht","hSonntag","hFeiertag"
      ];
      const f={};
      ids.forEach(id=>f[id]=$(id).value);
      f.logo = $("logoImg").src||"";
      f.subTotal = $("subTotal").textContent;
      f.grandTotal = $("grandTotal").textContent;
      return f;
    }

    function saveInvoice(){
      if(!requiredOk()) return;
      const f=collectForm();
      const list=invoices();
      const idx=list.findIndex(x=>x.invNo===f.invNo);
      if(idx>=0) list[idx]=f; else list.unshift(f);
      saveInvoices(list);
      setStatus("Rechnung gespeichert", true);
      renderInvoiceList();
    }

    function loadInvoice(no){
      const inv = invoices().find(x=>x.invNo===no);
      if(!inv){ setStatus("Rechnung nicht gefunden", false); return; }
      Object.entries(inv).forEach(([k,v])=>{
        if($(k)) $(k).value = v;
      });
      if(inv.logo) setLogo(inv.logo, true);
      syncContacts();
      updatePurpose();
      calculate();
      setStatus("Rechnung geladen", true);
    }

    function deleteInvoice(no){
      const list=invoices().filter(x=>x.invNo!==no);
      saveInvoices(list);
      renderInvoiceList();
      setStatus("Rechnung gel√∂scht", true);
    }

    function renderInvoiceList(){
      const wrap=$("invList");
      const list=invoices();
      wrap.innerHTML="";
      for(const inv of list.slice(0,10)){
        const el=document.createElement("div");
        el.className="item";
        el.innerHTML=`
          <div>
            <b class="mono">${escapeHtml(inv.invNo||"")}</b>
            <small>${escapeHtml(inv.invDate||"")} ‚Ä¢ ${escapeHtml(inv.custName||"")}</small><br/>
            <small class="mono">Gesamt: ${escapeHtml(inv.grandTotal||"")}</small>
          </div>
          <div class="btns">
            <button type="button" data-act="load" data-no="${escapeAttr(inv.invNo)}">Load</button>
            <button type="button" data-act="pdf" data-no="${escapeAttr(inv.invNo)}">PDF</button>
            <button type="button" class="danger" data-act="del" data-no="${escapeAttr(inv.invNo)}">Del</button>
          </div>
        `;
        wrap.appendChild(el);
      }
      wrap.querySelectorAll("button[data-act]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const act=b.getAttribute("data-act");
          const no=b.getAttribute("data-no");
          if(act==="load") loadInvoice(no);
          if(act==="del") deleteInvoice(no);
          if(act==="pdf"){
            const inv=invoices().find(x=>x.invNo===no);
            if(inv) await exportPdfFromForm(inv);
          }
        });
      });
    }

    // ===== Calculation =====
    function calculate(){
      syncContacts();
      updatePurpose();

      const m=safeNum($("mCount").value);
      const h1=safeNum($("hTag").value);
      const h2=safeNum($("hNacht").value);
      const h3=safeNum($("hSonntag").value);
      const h4=safeNum($("hFeiertag").value);

      const p1=safeNum($("pTag").value);
      const p2=safeNum($("pNacht").value);
      const p3=safeNum($("pSonntag").value);
      const p4=safeNum($("pFeiertag").value);

      const s1=m*h1*p1, s2=m*h2*p2, s3=m*h3*p3, s4=m*h4*p4;
      const sub=s1+s2+s3+s4;

      const vatMode=$("vatMode").value;
      const vatRate = (vatMode==="vat19")?0.19:0;
      const vatAmount=sub*vatRate;
      const grand=sub+vatAmount;

      $("tH1").textContent=String(h1); $("tH2").textContent=String(h2); $("tH3").textContent=String(h3); $("tH4").textContent=String(h4);
      $("tP1").textContent=fmtEUR(p1); $("tP2").textContent=fmtEUR(p2); $("tP3").textContent=fmtEUR(p3); $("tP4").textContent=fmtEUR(p4);
      $("tS1").textContent=fmtEUR(s1); $("tS2").textContent=fmtEUR(s2); $("tS3").textContent=fmtEUR(s3); $("tS4").textContent=fmtEUR(s4);

      $("subTotal").textContent=fmtEUR(sub);
      $("grandTotal").textContent=fmtEUR(grand);

      $("formulaLine").textContent = `${m} √ó ${h1} √ó ${fmtEUR(p1)}`;

      autoSave();
    }

    // ===== AutoSave =====
    let t=null;
    function autoSave(){
      clearTimeout(t);
      t=setTimeout(()=>{
        saveJSON(KEY.APP, collectForm());
      },250);
    }
    function restoreAutoSave(){
      const f=loadJSON(KEY.APP,null);
      if(!f) return;
      Object.entries(f).forEach(([k,v])=>{
        if($(k)) $(k).value=v;
      });
      if(f.logo) setLogo(f.logo,false);
    }

    // ===== Print/PDF =====
    function buildPrintHtml(f){
      const company=escapeHtml(f.issuerCompany||"");
      const logo = f.logo ? `<div class="invLogo"><img src="${escapeAttr(f.logo)}"/></div>` : "";
      const vatMode=f.vatMode;
      const vatLine = (vatMode==="kmu")
        ? "Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet."
        : "Umsatzsteuer 19% wird berechnet und ausgewiesen.";

      const m=safeNum(f.mCount);
      const h1=safeNum(f.hTag), h2=safeNum(f.hNacht), h3=safeNum(f.hSonntag), h4=safeNum(f.hFeiertag);
      const p1=safeNum(f.pTag), p2=safeNum(f.pNacht), p3=safeNum(f.pSonntag), p4=safeNum(f.pFeiertag);
      const s1=m*h1*p1, s2=m*h2*p2, s3=m*h3*p3, s4=m*h4*p4;
      const sub=s1+s2+s3+s4;
      const vatRate=(vatMode==="vat19")?0.19:0;
      const vatAmount=sub*vatRate;
      const grand=sub+vatAmount;

      const obj=escapeHtml(f.objekt||"");
      const zr=escapeHtml(f.zeitraum||"");
      const note=escapeHtml(f.note||"");
      const custAddr=escapeHtml(f.custAddress||"").replaceAll("\n","<br/>");

      return `
        <div class="a4">
          <div class="invHeader">
            <div class="invLeft">
              ${logo}
              <div>
                <p class="invTitle">Rechnung</p>
                <div class="invMeta"><b>${company}</b></div>
                <div class="invMeta"><b>${escapeHtml(f.serviceTitle||"")}</b></div>
                ${obj?`<div class="invMeta">Objekt/Ort: ${obj}</div>`:""}
                ${zr?`<div class="invMeta">Zeitraum: ${zr}</div>`:""}
              </div>
            </div>

            <div class="invBox" style="min-width:260px">
              <div class="invLine"><span><b>Rechnungsnr.</b></span><span class="mono">${escapeHtml(f.invNo||"")}</span></div>
              <div class="invLine"><span>Datum</span><span>${escapeHtml(f.invDate||"")}</span></div>
              <div class="invLine"><span>F√§llig</span><span>${escapeHtml(f.dueDate||"")}</span></div>
              <div class="invLine"><span>Zweck</span><span class="mono">${escapeHtml(f.purpose||"")}</span></div>
            </div>
          </div>

          <div class="invGrid2">
            <div class="invBox">
              <h4>Rechnungssteller</h4>
              <div class="invMeta"><b>${company}</b></div>
              <div class="invMeta">${escapeHtml(f.issuerAddress||"")}</div>
              <div class="invMeta">Tel: ${escapeHtml(f.issuerPhone||"")}</div>
              <div class="invMeta">E-Mail: ${escapeHtml(f.issuerEmail||"")}</div>
              <div class="invMeta">Steuernr./Hinweis: ${escapeHtml(f.issuerTax||"")}</div>
              ${String(f.issuerVat||"").trim()?`<div class="invMeta">USt-IdNr: ${escapeHtml(f.issuerVat||"")}</div>`:""}
            </div>

            <div class="invBox">
              <h4>Rechnung an</h4>
              <div class="invMeta"><b>${escapeHtml(f.custName||"")}</b></div>
              <div class="invMeta">${custAddr}</div>
              ${String(f.custEmail||"").trim()?`<div class="invMeta">E-Mail: ${escapeHtml(f.custEmail||"")}</div>`:""}
              ${String(f.custContact||"").trim()?`<div class="invMeta">Ansprechpartner: ${escapeHtml(f.custContact||"")}</div>`:""}
            </div>
          </div>

          <div class="invBox" style="margin-top:12px">
            <h4>Leistungs√ºbersicht</h4>
            <table class="invTable">
              <thead>
                <tr>
                  <th>Position</th>
                  <th class="invRight">Mitarbeiter</th>
                  <th class="invRight">Std.</th>
                  <th class="invRight">Preis/Std.</th>
                  <th class="invRight">Summe</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Tag</td><td class="invRight">${m}</td><td class="invRight">${h1}</td><td class="invRight">${fmtEUR(p1)}</td><td class="invRight">${fmtEUR(s1)}</td></tr>
                <tr><td>Nacht</td><td class="invRight">${m}</td><td class="invRight">${h2}</td><td class="invRight">${fmtEUR(p2)}</td><td class="invRight">${fmtEUR(s2)}</td></tr>
                <tr><td>Sonntag</td><td class="invRight">${m}</td><td class="invRight">${h3}</td><td class="invRight">${fmtEUR(p3)}</td><td class="invRight">${fmtEUR(s3)}</td></tr>
                <tr><td>Feiertag</td><td class="invRight">${m}</td><td class="invRight">${h4}</td><td class="invRight">${fmtEUR(p4)}</td><td class="invRight">${fmtEUR(s4)}</td></tr>
              </tbody>
            </table>

            <div class="invTotals">
              <div class="tline"><span>Zwischensumme (netto)</span><span>${fmtEUR(sub)}</span></div>
              ${vatRate>0?`<div class="tline"><span>USt 19%</span><span>${fmtEUR(vatAmount)}</span></div>`:""}
              <div class="tline grand"><span>Gesamtbetrag</span><span>${fmtEUR(grand)}</span></div>
            </div>

            <div class="invFooter">
              <div>${vatLine}</div>
              ${note?`<div><b>Hinweis:</b> ${note}</div>`:""}
              <div style="margin-top:10px">
                <b>Bankverbindung:</b> IBAN ${escapeHtml(f.iban||"")} ‚Ä¢ BIC ${escapeHtml(f.bic||"")} ‚Ä¢ Inhaber ${escapeHtml(f.holder||"")}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function waitImagesLoaded(root){
      const imgs = Array.from(root.querySelectorAll("img")).filter(i=>i.src);
      return Promise.all(imgs.map(img=>new Promise(res=>{
        if(img.complete) return res();
        img.onload=()=>res(); img.onerror=()=>res();
      })));
    }

    async function exportPdfFromForm(f){
      $("printArea").innerHTML = buildPrintHtml(f);
      $("printWrap").style.display="block";
      await waitImagesLoaded($("printArea"));

      const canvas = await html2canvas($("printArea"), {scale:2, useCORS:true, backgroundColor:"#ffffff"});
      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p","mm","a4");
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const imgProps = pdf.getImageProperties(imgData);
      const imgW = pageW;
      const imgH = (imgProps.height * imgW) / imgProps.width;

      const EPS=1;
      if(imgH <= pageH){
        pdf.addImage(imgData,"PNG",0,0,imgW,imgH);
      }else{
        let y=0, remaining=imgH;
        while(remaining>EPS){
          pdf.addImage(imgData,"PNG",0,y? -y : 0,imgW,imgH);
          remaining -= pageH;
          if(remaining>EPS) pdf.addPage();
          y += pageH;
        }
      }
      pdf.save(`${f.invNo||"Rechnung"}.pdf`);
      $("printWrap").style.display="none";
      setStatus("PDF gespeichert", true);
    }

    async function exportPdf(){
      if(!requiredOk()) return;
      await exportPdfFromForm(collectForm());
    }
    async function doPrint(){
      if(!requiredOk()) return;
      $("printArea").innerHTML = buildPrintHtml(collectForm());
      $("printWrap").style.display="block";
      await waitImagesLoaded($("printArea"));
      window.print();
      $("printWrap").style.display="none";
    }

    // ===== Reset + New =====
    function resetAll(){
      Object.values(KEY).forEach(k=>localStorage.removeItem(k));
      location.reload();
    }
    function newInvoice(){
      // keep issuer + prices + vatMode
      const keep = ["issuerCompany","issuerAddress","issuerPhone","issuerEmail","issuerTax","issuerVat","iban","bic","holder","vatMode","pTag","pNacht","pSonntag","pFeiertag","mCount","serviceTitle"];
      const snap={}; keep.forEach(id=>snap[id]=$(id).value);

      document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.id==="logoFile") return;
        if(el.type==="date") return;
        el.value="";
      });
      Object.entries(snap).forEach(([k,v])=>{ if($(k)) $(k).value=v; });

      $("invDate").value=todayISO();
      $("dueDate").value=addDaysISO($("invDate").value,14);
      $("invNo").value=nextInvoiceNo($("invDate").value);
      updatePurpose();

      $("hTag").value=0; $("hNacht").value=0; $("hSonntag").value=0; $("hFeiertag").value=0;
      $("note").value=""; $("objekt").value=""; $("zeitraum").value="";
      $("customerSelect").value="";
      setStatus("Neue Rechnung", true);
      calculate();
    }

    // ===== Escape =====
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

    // ===== Wire =====
    function wire(){
      $("btnLogo").addEventListener("click", ()=> $("logoFile").click());
      $("logoFile").addEventListener("change",(e)=>{
        const file=e.target.files?.[0];
        if(!file) return;
        const rd=new FileReader();
        rd.onload=()=>{ setLogo(String(rd.result||""),true); setStatus("Logo gespeichert", true); };
        rd.readAsDataURL(file);
      });

      $("btnPdf").addEventListener("click", exportPdf);
      $("btnPrint").addEventListener("click", doPrint);
      $("btnReset").addEventListener("click", resetAll);
      $("btnNew").addEventListener("click", newInvoice);

      $("btnSaveInv").addEventListener("click", saveInvoice);
      $("btnShowInv").addEventListener("click", ()=>{ renderInvoiceList(); setStatus("Rechnungen aktualisiert", true); });

      $("btnSaveCustomer").addEventListener("click", saveCustomer);
      $("btnDeleteCustomer").addEventListener("click", deleteCustomer);

      $("customerSelect").addEventListener("change", (e)=> loadCustomerById(e.target.value));

      $("invDate").addEventListener("change", ()=>{
        $("dueDate").value = addDaysISO($("invDate").value,14);
        $("invNo").value = nextInvoiceNo($("invDate").value);
        updatePurpose();
        calculate();
      });

      // auto-calc on inputs
      document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.id==="logoFile") return;
        el.addEventListener("input", calculate);
        el.addEventListener("change", calculate);
      });
    }

    // ===== Init =====
    function init(){
      loadLogo();
      restoreAutoSave();

      $("invDate").value = $("invDate").value || todayISO();
      $("dueDate").value = $("dueDate").value || addDaysISO($("invDate").value,14);
      $("invNo").value = $("invNo").value || nextInvoiceNo($("invDate").value);
      updatePurpose();

      refreshCustomerSelect("");
      renderInvoiceList();
      syncContacts();
      calculate();

      setStatus("Bereit", true);
    }

    window.addEventListener("load", ()=>{
      wire();
      init();
    });
  </script>
</body>
</html>
