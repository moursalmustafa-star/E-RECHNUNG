<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Rechnung (Pro)</title>
  <meta name="theme-color" content="#0b3a78"/>

  <!-- PDF libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --blue:#0b3a78;
      --blue2:#0a2f62;
      --ink:#0f172a;
      --muted:#6b7280;
      --bg:#f4f6fa;
      --card:#ffffff;
      --line:#e5e7eb;
      --soft:#f8fafc;
      --good:#16a34a;
      --warn:#b45309;
      --danger:#b91c1c;
      --r:16px;
      --shadow: 0 10px 25px rgba(15,23,42,.08);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      color:var(--ink);
      background:linear-gradient(180deg,#eaf0ff 0%, var(--bg) 22%, var(--bg) 100%);
    }
    a{color:inherit; text-decoration:underline}
    .topbar{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(90deg,var(--blue) 0%, #1362c7 60%, #1aa1ff 130%);
      color:#fff;
      box-shadow: 0 6px 18px rgba(2,6,23,.20);
    }
    .topbar-inner{
      max-width:1200px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:280px;
      flex:1;
    }
    .brand .logo{
      width:38px;height:38px;border-radius:10px;
      background:rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      flex:0 0 auto;
    }
    .brand .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .brand h1{margin:0; font-size:16px; font-weight:700; letter-spacing:.2px; line-height:1.1}
    .brand .sub{font-size:12px; opacity:.9; margin-top:2px}
    .pill{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tag{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
      white-space:nowrap;
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      border-radius:999px;
      padding:9px 12px;
      font-weight:800;
      font-size:13px;
      background:rgba(255,255,255,.92);
      color:#0b2b55;
      box-shadow: 0 8px 18px rgba(2,6,23,.16);
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:rgba(255,255,255,.14); color:#fff; border:1px solid rgba(255,255,255,.22); box-shadow:none}
    .btn.danger{background:#fff; color:var(--danger)}
    .wrap{max-width:1200px;margin:18px auto;padding:0 14px 30px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; align-items:start}
    @media(max-width:980px){ .grid{grid-template-columns:1fr} .brand{min-width:auto} .pill{justify-content:flex-start} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      background:linear-gradient(180deg,#ffffff 0%, #f7fbff 100%);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd h2{
      margin:0; font-size:13px; letter-spacing:.4px;
      text-transform:uppercase;
      color:#0b2b55;
    }
    .card .bd{padding:14px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    @media(max-width:680px){ .row, .row3{grid-template-columns:1fr} }
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted)}
    .field input, .field select, .field textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 11px;
      font-size:14px;
      background:#fff;
      outline:none;
    }
    .field textarea{min-height:88px; resize:vertical}
    .field input[readonly]{background:var(--soft); color:#111827}
    .hint{font-size:12px; color:var(--muted); line-height:1.35}
    .mini-actions{display:flex; gap:10px; flex-wrap:wrap}
    .mini{
      border:1px solid var(--line);
      background:var(--soft);
      border-radius:999px;
      padding:8px 10px;
      font-size:13px;
      cursor:pointer;
      font-weight:800;
      color:#0b2b55;
    }
    .mini:active{transform:translateY(1px)}
    .mini.red{color:var(--danger)}
    .mono{font-family:var(--mono)}
    .right{text-align:right}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--soft);
      font-size:13px;
      font-weight:900;
      color:#0b2b55;
      white-space:nowrap;
    }
    .badge.ok{border-color:#b7f7c7;background:#ecfdf3;color:#064e3b}
    .badge.warn{border-color:#f4d7ad;background:#fff7ed;color:#7c2d12}
    .badge.info{border-color:#b7d7ff;background:#eff6ff;color:#1e3a8a}

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align:middle;
    }
    .table th{
      background:linear-gradient(180deg,#f7fbff 0%, #eef6ff 100%);
      color:#0b2b55;
      text-align:left;
      font-weight:900;
    }
    .table tr:last-child td{border-bottom:0}

    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media(max-width:980px){ .split{grid-template-columns:1fr} }
    .hr{height:1px;background:var(--line);margin:12px 0}

    /* PAPER preview (for PDF) */
    .paper{
      margin-top:14px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .paper .ph{
      padding:14px 16px;
      background:linear-gradient(180deg,#ffffff 0%, #f7fbff 100%);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .paper .ph .left{display:flex; gap:10px; align-items:center}
    .paper .ph .logo2{
      width:38px;height:38px;border-radius:12px;
      border:1px solid var(--line);
      overflow:hidden;
      background:var(--soft);
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;
    }
    .paper .ph .logo2 img{width:100%;height:100%;object-fit:cover;display:block}
    .paper .ph .ttl{display:flex;flex-direction:column}
    .paper .ph .ttl b{font-size:14px}
    .paper .ph .ttl span{font-size:12px;color:var(--muted)}
    .paper .pb{padding:16px}
    .paper .cols{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    @media(max-width:900px){ .paper .cols{grid-template-columns:1fr} }
    .kv{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .kv h4{
      margin:0 0 10px 0;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.45px;
      color:#0b2b55;
    }
    .kv .line{
      display:flex; justify-content:space-between; gap:10px;
      padding:6px 0;
      border-bottom:1px dashed #edf2f7;
      font-size:13px;
    }
    .kv .line:last-child{border-bottom:0}
    .kv .k{color:var(--muted)}
    .kv .v{font-weight:900; text-align:right}
    .foot{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      border-top:1px solid var(--line);
      background:linear-gradient(180deg,#ffffff 0%, #f8fafc 100%);
      font-size:12px;
      color:var(--muted);
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background:rgba(15,23,42,.55);
      z-index:999;
      padding:14px;
    }
    .modal.open{display:flex}
    .modal .box{
      width:min(920px, 100%);
      max-height:86vh;
      overflow:auto;
      background:#fff;
      border:1px solid rgba(255,255,255,.18);
      border-radius:18px;
      box-shadow: 0 28px 70px rgba(2,6,23,.35);
    }
    .modal .box .mhd{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(90deg,var(--blue) 0%, #1362c7 60%, #1aa1ff 130%);
      color:#fff;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
    }
    .modal .box .mhd h3{margin:0;font-size:14px;letter-spacing:.3px}
    .modal .box .bd{padding:14px}
    .modal .close{
      background:rgba(255,255,255,.14);
      color:#fff;
      border:1px solid rgba(255,255,255,.2);
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
    }
    .list{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
    }
    .list .item{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      align-items:center;
    }
    .list .item:last-child{border-bottom:0}
    .list .item .t{font-weight:900}
    .list .item .s{font-size:12px;color:var(--muted);margin-top:2px}
    .list .item .acts{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .smallbtn{
      border:1px solid var(--line);
      background:var(--soft);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      color:#0b2b55;
      white-space:nowrap;
    }
    .smallbtn.red{color:var(--danger)}
    .smallbtn.blue{background:#eff6ff;border-color:#bfdcff;color:#1e3a8a}

    /* Print (only paper) */
    @media print{
      .topbar, .grid, .modal{display:none !important}
      .wrap{max-width:unset;margin:0;padding:0}
      .paper{border:0; box-shadow:none; border-radius:0}
      @page{ size: A4; margin: 10mm; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" title="Logo">
          <img id="topLogo" alt="Logo" src="logo.png">
        </div>
        <div>
          <h1>Masculine Security — Rechnung</h1>
          <div class="sub">99% Auto • Auto Datum • Auto Rechnungsnummer • Kunden • Zuschläge • PDF • Save</div>
        </div>
      </div>

      <div class="pill">
        <span class="tag" id="statusTag">Status: Entwurf</span>
        <button class="btn secondary" id="btnLogo">Logo ändern</button>
        <button class="btn secondary" id="btnNeu">Neu</button>
        <button class="btn" id="btnSaveInvoice">Rechnung speichern</button>
        <button class="btn" id="btnListInvoices">Rechnungen</button>
        <button class="btn danger" id="btnReset">Reset</button>
        <button class="btn" id="btnPDF">PDF speichern</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <h2>Rechnungssteller & Kunde</h2>
          <span class="badge info">Professional Firmen-Workflow</span>
        </div>
        <div class="bd">
          <div class="split">
            <div class="kv">
              <h4>Rechnungssteller</h4>
              <div class="line"><span class="k">Firma</span><span class="v">Masculine Security</span></div>
              <div class="line"><span class="k">Adresse</span><span class="v">Werschenregerstraße 6 • 28237 Bremen</span></div>
              <div class="line"><span class="k">Telefon</span><span class="v"><a href="tel:+4915778697052">015778697052</a></span></div>
              <div class="line"><span class="k">E-Mail</span><span class="v"><a href="mailto:Kontakt.mass.bremen@hotmail.com">Kontakt.mass.bremen@hotmail.com</a></span></div>
              <div class="line"><span class="k">Steuernummer</span><span class="v">in Bearbeitung</span></div>
              <div class="line"><span class="k">Bank</span><span class="v mono">IBAN DE98 1001 1001 2333 0146 96 • BIC NTSBDEB1XXX</span></div>
              <div class="line"><span class="k">Status</span><span class="v" id="sellerStatusPreview">Entwurf</span></div>
            </div>

            <div class="card" style="box-shadow:none">
              <div class="bd" style="padding:0">
                <div class="row">
                  <div class="field">
                    <label>Kunde (Auswahl)</label>
                    <select id="customerSelect">
                      <option value="">— Kunde wählen —</option>
                    </select>
                    <div class="hint">Kunden werden lokal (Browser) gespeichert.</div>
                  </div>
                  <div class="field">
                    <label>&nbsp;</label>
                    <div class="mini-actions">
                      <button class="mini" id="btnCustomerNew">Neu</button>
                      <button class="mini red" id="btnCustomerDelete">Kunde löschen</button>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="field">
                    <label>Kundenname (zum Speichern)</label>
                    <input id="custName" placeholder="Firma / Name"/>
                  </div>
                  <div class="field">
                    <label>E-Mail (optional)</label>
                    <input id="custEmail" placeholder="kunde@email.de"/>
                  </div>
                </div>

                <div class="field">
                  <label>Kundendaten (Adresse / Ansprechpartner)</label>
                  <textarea id="custData" placeholder="Straße Hausnr.\nPLZ Ort\nAnsprechpartner (optional)"></textarea>
                </div>

                <div class="mini-actions">
                  <button class="mini" id="btnCustomerSave">Kunde speichern</button>
                </div>

                <div class="hr"></div>

                <div class="row">
                  <div class="field">
                    <label>Einsatzort / Objekt</label>
                    <input id="objekt" placeholder="z. B. Hotel / Baustelle / Adresse"/>
                  </div>
                  <div class="field">
                    <label>Leistungszeitraum</label>
                    <input id="zeitraum" placeholder="z. B. 01.02.2026 – 15.02.2026"/>
                  </div>
                </div>

                <div class="field">
                  <label>Leistungsbeschreibung</label>
                  <textarea id="leistung" placeholder="Security Dienstleistung"></textarea>
                </div>

                <div class="field">
                  <label>Referenz / PO (optional)</label>
                  <input id="po" placeholder="z. B. Auftrag-Nr. / Ansprechpartner"/>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hd">
          <h2>Rechnungsdaten & Berechnung</h2>
          <span class="badge ok">Auto aktiv</span>
        </div>
        <div class="bd">
          <div class="row">
            <div class="field">
              <label>Rechnungsdatum (Auto, klickbar)</label>
              <input id="invDate" type="date"/>
              <div class="hint">Standard = heute (du kannst ändern).</div>
            </div>
            <div class="field">
              <label>Zahlungsziel</label>
              <select id="payTerm">
                <option value="7">7 Tage</option>
                <option value="14" selected>14 Tage</option>
                <option value="30">30 Tage</option>
                <option value="0">Sofort</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Fällig am (Auto, klickbar)</label>
              <input id="dueDate" type="date"/>
              <div class="hint">Auto berechnet – du kannst auch manuell ändern.</div>
            </div>
            <div class="field">
              <label>Rechnungsnummer (Auto, klickbar)</label>
              <input id="invNo" class="mono"/>
              <div class="hint mono">Auto-Format: MS-YYYYMMDD-0001 (pro Tag laufend)</div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Status wählen</label>
              <select id="status">
                <option value="Entwurf" selected>Entwurf</option>
                <option value="Offen">Offen</option>
                <option value="Bezahlt">Bezahlt</option>
                <option value="Storniert">Storniert</option>
              </select>
            </div>
            <div class="field">
              <label>USt-Status</label>
              <select id="vatMode">
                <option value="0">0% (Kleinunternehmer §19)</option>
                <option value="19" selected>19% (Regelbesteuerung)</option>
              </select>
              <div class="hint" id="vatHint">Umsatzsteuer wird mit 19% berechnet.</div>
            </div>
          </div>

          <div class="row3">
            <div class="field">
              <label>Stundensatz (€/h)</label>
              <input id="rate" type="number" step="0.01" min="0" value="23"/>
            </div>
            <div class="field">
              <label>Nacht %</label>
              <input id="pctNight" type="number" step="0.01" min="0" value="5"/>
            </div>
            <div class="field">
              <label>Sonntag %</label>
              <input id="pctSun" type="number" step="0.01" min="0" value="50"/>
            </div>
          </div>

          <div class="row3">
            <div class="field">
              <label>Feiertag %</label>
              <input id="pctHol" type="number" step="0.01" min="0" value="100"/>
              <div class="hint">Keine Doppelzählung: Feiertag > Sonntag > Nacht</div>
            </div>
            <div class="field">
              <label>Anzahl Mitarbeiter</label>
              <input id="ma" type="number" min="1" step="1" value="10"/>
            </div>
            <div class="field">
              <label>Stunden gesamt</label>
              <input id="totalHours" type="number" min="0" step="0.01" value="2160"/>
              <div class="hint">Gib nur Gesamtstunden ein → Grundlohn wird automatisch berechnet.</div>
            </div>
          </div>

          <div class="hr"></div>

          <table class="table">
            <thead>
              <tr>
                <th>Position</th>
                <th class="right">Stunden</th>
                <th class="right">Zuschlag %</th>
                <th class="right">Betrag</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><b>Grundlohn</b><div class="hint">Arbeitszeit (normal)</div></td>
                <td class="right mono" id="hBase">0.00</td>
                <td class="right mono">—</td>
                <td class="right mono" id="aBase">0.00 €</td>
              </tr>
              <tr>
                <td><b>Nachtschicht</b><div class="hint">Zuschlag</div></td>
                <td class="right">
                  <input id="hNight" type="number" step="0.01" min="0" value="12" style="width:120px;text-align:right;border-radius:10px;padding:7px 8px;border:1px solid var(--line)"/>
                </td>
                <td class="right mono"><span id="sNight">5</span>%</td>
                <td class="right mono" id="aNight">0.00 €</td>
              </tr>
              <tr>
                <td><b>Sonntag</b><div class="hint">Zuschlag</div></td>
                <td class="right">
                  <input id="hSun" type="number" step="0.01" min="0" value="12" style="width:120px;text-align:right;border-radius:10px;padding:7px 8px;border:1px solid var(--line)"/>
                </td>
                <td class="right mono"><span id="sSun">50</span>%</td>
                <td class="right mono" id="aSun">0.00 €</td>
              </tr>
              <tr>
                <td><b>Feiertag</b><div class="hint">Zuschlag</div></td>
                <td class="right">
                  <input id="hHol" type="number" step="0.01" min="0" value="12" style="width:120px;text-align:right;border-radius:10px;padding:7px 8px;border:1px solid var(--line)"/>
                </td>
                <td class="right mono"><span id="sHol">100</span>%</td>
                <td class="right mono" id="aHol">0.00 €</td>
              </tr>
            </tbody>
          </table>

          <div class="hr"></div>

          <div class="row">
            <div class="badge info">Stunden/MA (Auto): <span class="mono" id="hPerMA">0.00</span></div>
            <div class="badge ok">Stunden gesamt: <span class="mono" id="hTotal">0.00</span></div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="badge">Zwischensumme (Netto): <span class="mono" id="net">0.00 €</span></div>
            <div class="badge">Umsatzsteuer: <span class="mono" id="vat">0.00 €</span></div>
          </div>
          <div style="margin-top:10px" class="badge ok">Gesamt: <span class="mono" id="gross">0.00 €</span></div>

          <div class="hr"></div>
          <div class="hint">
            ✅ Berechnung: Grundlohn-Stunden = Gesamt − (Nacht + Sonntag + Feiertag) • Zuschläge werden nur auf ihre Stunden gerechnet.
          </div>
        </div>
      </div>
    </div>

    <!-- PAPER (for PDF) -->
    <div class="paper" id="paper">
      <div class="ph">
        <div class="left">
          <div class="logo2">
            <img id="paperLogo" alt="Logo" src="logo.png">
          </div>
          <div class="ttl">
            <b>Masculine Security — Rechnung</b>
            <span id="paperMini">Entwurf • Auto • Zuschläge • PDF</span>
          </div>
        </div>
        <div class="badge" id="paperStatus">Entwurf</div>
      </div>

      <div class="pb">
        <div class="cols">
          <div class="kv">
            <h4>Rechnungssteller</h4>
            <div class="line"><span class="k">Firma</span><span class="v">Masculine Security</span></div>
            <div class="line"><span class="k">Adresse</span><span class="v">Werschenregerstraße 6, 28237 Bremen</span></div>
            <div class="line"><span class="k">Telefon</span><span class="v"><a href="tel:+4915778697052">015778697052</a></span></div>
            <div class="line"><span class="k">E-Mail</span><span class="v"><a href="mailto:Kontakt.mass.bremen@hotmail.com">Kontakt.mass.bremen@hotmail.com</a></span></div>
            <div class="line"><span class="k">Steuernummer</span><span class="v">in Bearbeitung</span></div>
          </div>

          <div class="kv">
            <h4>Rechnungsdaten</h4>
            <div class="line"><span class="k">Rechnungsnummer</span><span class="v mono" id="pInvNo">—</span></div>
            <div class="line"><span class="k">Rechnungsdatum</span><span class="v mono" id="pInvDate">—</span></div>
            <div class="line"><span class="k">Fällig am</span><span class="v mono" id="pDue">—</span></div>
            <div class="line"><span class="k">Zahlungsziel</span><span class="v mono" id="pTerm">—</span></div>
            <div class="line"><span class="k">USt-Status</span><span class="v mono" id="pVatMode">—</span></div>
          </div>
        </div>

        <div style="margin-top:14px" class="cols">
          <div class="kv">
            <h4>Kunde / Rechnungsempfänger</h4>
            <div class="line"><span class="k">Kunde</span><span class="v" id="pCustName">—</span></div>
            <div class="line"><span class="k">E-Mail</span><span class="v" id="pCustEmail">—</span></div>
            <div class="line"><span class="k">Kundendaten</span><span class="v" style="text-align:right; white-space:pre-line" id="pCustData">—</span></div>
          </div>

          <div class="kv">
            <h4>Leistung</h4>
            <div class="line"><span class="k">Einsatzort / Objekt</span><span class="v" id="pObjekt">—</span></div>
            <div class="line"><span class="k">Leistungszeitraum</span><span class="v" id="pZeitraum">—</span></div>
            <div class="line"><span class="k">Beschreibung</span><span class="v" style="text-align:right; white-space:pre-line" id="pLeistung">—</span></div>
            <div class="line"><span class="k">Referenz / PO</span><span class="v" id="pPO">—</span></div>
          </div>
        </div>

        <div style="margin-top:14px">
          <table class="table">
            <thead>
              <tr>
                <th>Position</th>
                <th class="right">Std</th>
                <th class="right">Satz</th>
                <th class="right">Zuschlag</th>
                <th class="right">Betrag</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><b>Grundlohn</b><div class="hint">Arbeitszeit (normal)</div></td>
                <td class="right mono" id="ppBaseH">0.00</td>
                <td class="right mono" id="ppRate">0.00 €</td>
                <td class="right mono">—</td>
                <td class="right mono" id="ppBaseA">0.00 €</td>
              </tr>
              <tr>
                <td><b>Nachtschicht</b><div class="hint">Zuschlag</div></td>
                <td class="right mono" id="ppNightH">0.00</td>
                <td class="right mono">wie Grundsatz</td>
                <td class="right mono" id="ppNightP">0%</td>
                <td class="right mono" id="ppNightA">0.00 €</td>
              </tr>
              <tr>
                <td><b>Sonntag</b><div class="hint">Zuschlag</div></td>
                <td class="right mono" id="ppSunH">0.00</td>
                <td class="right mono">wie Grundsatz</td>
                <td class="right mono" id="ppSunP">0%</td>
                <td class="right mono" id="ppSunA">0.00 €</td>
              </tr>
              <tr>
                <td><b>Feiertag</b><div class="hint">Zuschlag</div></td>
                <td class="right mono" id="ppHolH">0.00</td>
                <td class="right mono">wie Grundsatz</td>
                <td class="right mono" id="ppHolP">0%</td>
                <td class="right mono" id="ppHolA">0.00 €</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="margin-top:12px" class="cols">
          <div class="kv">
            <h4>Zahlungsbedingungen</h4>
            <div class="line"><span class="k">Hinweis</span><span class="v" style="text-align:right;white-space:pre-line">Bitte überweisen Sie den Rechnungsbetrag innerhalb der Zahlungsfrist auf das unten angegebene Konto.</span></div>
            <div class="line"><span class="k">Bank</span><span class="v mono">MUSTAFA MURSAL ABDI • IBAN DE98 1001 1001 2333 0146 96 • BIC NTSBDEB1XXX</span></div>
          </div>
          <div class="kv">
            <h4>Summe</h4>
            <div class="line"><span class="k">Zwischensumme (Netto)</span><span class="v mono" id="ppNet">0.00 €</span></div>
            <div class="line"><span class="k">Umsatzsteuer</span><span class="v mono" id="ppVat">0.00 €</span></div>
            <div class="line"><span class="k">Gesamt</span><span class="v mono" id="ppGross">0.00 €</span></div>
          </div>
        </div>
      </div>

      <div class="foot">
        <div>Masculine Security • Werschenregerstraße 6 • 28237 Bremen</div>
        <div class="mono">Erstellt: <span id="pCreated">—</span></div>
      </div>
    </div>
  </div>

  <!-- file input logo -->
  <input id="logoFile" type="file" accept="image/*" style="display:none"/>

  <!-- MODAL -->
  <div class="modal" id="mInvoices" aria-hidden="true">
    <div class="box">
      <div class="mhd">
        <h3>Rechnungen (lokal gespeichert)</h3>
        <button class="close" id="closeInvoices">Schließen</button>
      </div>
      <div class="bd">
        <div class="hint" style="margin-bottom:10px">
          Hinweis: Rechnungen werden im Browser gespeichert (localStorage). Für Backup: PDF speichern.
        </div>
        <div class="list" id="invoiceList"></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmt = (n)=> (isFinite(n)? n:0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2});
    const eur = (n)=> fmt(n) + " €";
    const pad = (n, w=4)=> String(n).padStart(w,"0");
    const safeNum = (v)=> {
      const x = Number(String(v).replace(",","."));
      return isFinite(x)? x:0;
    };
    const todayISO = ()=>{
      const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
      return d.toISOString().slice(0,10);
    };
    const dateToYMD = (d)=> d.toISOString().slice(0,10);
    const addDays = (ymd, days)=>{
      const d = new Date(ymd+"T00:00:00");
      d.setDate(d.getDate()+Number(days||0));
      return dateToYMD(d);
    };
    const ls = {
      get(k,def=null){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def; }catch(e){ return def; } },
      set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
      del(k){ localStorage.removeItem(k); }
    };

    const STORE_KEY="ms_rechnung_pro_v2";
    const INVOICES_KEY="ms_rechnungen_list_v2";
    const CUSTOMERS_KEY="ms_kunden_v2";
    const LOGO_KEY="ms_logo_dataurl_v2";
    const COUNTER_KEY="ms_inv_counter_v2";

    function defaultData(){
      return {
        objekt:"Bremen",
        zeitraum:"01.01.2026 – 31.01.2026",
        leistung:"Security Dienstleistung",
        po:"",
        invDate: todayISO(),
        payTerm: 14,
        dueDate: addDays(todayISO(),14),
        status:"Entwurf",
        vatMode: 19,
        rate: 23,
        pctNight:5,
        pctSun:50,
        pctHol:100,
        ma:10,
        totalHours:2160,
        hNight:12,
        hSun:12,
        hHol:12,
        customerId:"",
        custName:"",
        custEmail:"",
        custData:"",
        invNo:""
      };
    }

    function state(){ return ls.get(STORE_KEY, defaultData()); }
    function apply(d){
      $("objekt").value = d.objekt || "";
      $("zeitraum").value = d.zeitraum || "";
      $("leistung").value = d.leistung || "";
      $("po").value = d.po || "";

      $("invDate").value = d.invDate || todayISO();
      $("payTerm").value = String(d.payTerm ?? 14);
      $("dueDate").value = d.dueDate || addDays($("invDate").value, Number($("payTerm").value||14));
      $("status").value = d.status || "Entwurf";
      $("vatMode").value = String(d.vatMode ?? 19);

      $("rate").value = d.rate ?? 23;
      $("pctNight").value = d.pctNight ?? 5;
      $("pctSun").value = d.pctSun ?? 50;
      $("pctHol").value = d.pctHol ?? 100;

      $("ma").value = d.ma ?? 10;
      $("totalHours").value = d.totalHours ?? 2160;
      $("hNight").value = d.hNight ?? 12;
      $("hSun").value = d.hSun ?? 12;
      $("hHol").value = d.hHol ?? 12;

      renderCustomerSelect(d.customerId || "");
      $("customerSelect").value = d.customerId || "";

      $("custName").value = d.custName || "";
      $("custEmail").value = d.custEmail || "";
      $("custData").value = d.custData || "";

      $("invNo").value = d.invNo || "";
      ensureInvoiceNo();

      recalc();
    }

    function gather(){
      return {
        objekt:$("objekt").value,
        zeitraum:$("zeitraum").value,
        leistung:$("leistung").value,
        po:$("po").value,
        invDate:$("invDate").value,
        payTerm:Number($("payTerm").value||14),
        dueDate:$("dueDate").value,
        status:$("status").value,
        vatMode:Number($("vatMode").value||0),
        rate:safeNum($("rate").value),
        pctNight:safeNum($("pctNight").value),
        pctSun:safeNum($("pctSun").value),
        pctHol:safeNum($("pctHol").value),
        ma:Math.max(1, Math.floor(safeNum($("ma").value)||1)),
        totalHours:safeNum($("totalHours").value),
        hNight:safeNum($("hNight").value),
        hSun:safeNum($("hSun").value),
        hHol:safeNum($("hHol").value),
        customerId:$("customerSelect").value,
        custName:$("custName").value,
        custEmail:$("custEmail").value,
        custData:$("custData").value,
        invNo:$("invNo").value
      };
    }
    function saveState(){ ls.set(STORE_KEY, gather()); }

    // Customers
    function loadCustomers(){ return ls.get(CUSTOMERS_KEY, []); }
    function saveCustomers(arr){ ls.set(CUSTOMERS_KEY, arr); }
    function renderCustomerSelect(selectedId){
      const sel = $("customerSelect");
      const customers = loadCustomers();
      const keep = selectedId || sel.value || "";
      sel.innerHTML = `<option value="">— Kunde wählen —</option>` + customers.map(c=>{
        const t = (c.name||"").replaceAll('"','&quot;');
        return `<option value="${c.id}">${t}</option>`;
      }).join("");
      if(keep) sel.value = keep;
    }
    function loadCustomerToFields(){
      const id = $("customerSelect").value;
      const c = loadCustomers().find(x=>x.id===id);
      if(!c){
        $("custName").value = "";
        $("custEmail").value = "";
        $("custData").value = "";
      }else{
        $("custName").value = c.name || "";
        $("custEmail").value = c.email || "";
        $("custData").value = c.data || "";
      }
      recalc();
      saveState();
    }
    function upsertCustomer(){
      const name = $("custName").value.trim();
      if(!name){ alert("Bitte Kundennamen eingeben."); return; }
      const email = $("custEmail").value.trim();
      const data = $("custData").value.trim();
      const customers = loadCustomers();
      let id = $("customerSelect").value || "";
      if(!id) id = "K-"+Date.now();
      const idx = customers.findIndex(c=>c.id===id);
      const obj = {id, name, email, data, updatedAt: Date.now()};
      if(idx>=0) customers[idx]=obj; else customers.push(obj);
      customers.sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0));
      saveCustomers(customers);
      renderCustomerSelect(id);
      $("customerSelect").value = id;
      alert("Kunde gespeichert.");
      recalc();
      saveState();
    }
    function deleteCustomer(){
      const id = $("customerSelect").value;
      if(!id){ alert("Bitte zuerst einen Kunden wählen."); return; }
      if(!confirm("Kunde wirklich löschen?")) return;
      saveCustomers(loadCustomers().filter(c=>c.id!==id));
      renderCustomerSelect("");
      $("customerSelect").value = "";
      $("custName").value = "";
      $("custEmail").value = "";
      $("custData").value = "";
      recalc();
      saveState();
    }

    // Invoice No (auto per day)
    function nextInvoiceNo(ymd){
      const counters = ls.get(COUNTER_KEY, {});
      const key = ymd.replaceAll("-","");
      const cur = Number(counters[key]||0) + 1;
      counters[key] = cur;
      ls.set(COUNTER_KEY, counters);
      return `MS-${key}-${pad(cur,4)}`;
    }
    function ensureInvoiceNo(){
      const d = $("invDate").value || todayISO();
      const key = d.replaceAll("-","");
      const current = ($("invNo").value || "").trim();
      if(current.startsWith(`MS-${key}-`)) return current;
      // if user already typed something non-empty, keep it
      if(current && !current.startsWith("MS-")) return current;
      const no = nextInvoiceNo(d);
      $("invNo").value = no;
      return no;
    }

    // Calc (SAX 100%)
    function recalc(){
      // auto due if user didn't change it manually today (simple: always recompute from date+term unless dueDate is empty)
      const invDate = $("invDate").value || todayISO();
      const term = Number($("payTerm").value||0);
      if(!$("dueDate").value) $("dueDate").value = addDays(invDate, term);

      ensureInvoiceNo();

      const totalHours = safeNum($("totalHours").value);
      const hNight = safeNum($("hNight").value);
      const hSun = safeNum($("hSun").value);
      const hHol = safeNum($("hHol").value);

      const rate = safeNum($("rate").value);
      const pn = safeNum($("pctNight").value)/100;
      const ps = safeNum($("pctSun").value)/100;
      const ph = safeNum($("pctHol").value)/100;

      const baseHours = Math.max(0, totalHours - (hNight + hSun + hHol));

      const aBase = baseHours * rate;
      const aNight = hNight * rate * pn;
      const aSun = hSun * rate * ps;
      const aHol = hHol * rate * ph;

      const net = aBase + aNight + aSun + aHol;

      const vatRate = Number($("vatMode").value||0)/100;
      const vat = net * vatRate;
      const gross = net + vat;

      $("hBase").textContent = fmt(baseHours);
      $("aBase").textContent = eur(aBase);
      $("aNight").textContent = eur(aNight);
      $("aSun").textContent = eur(aSun);
      $("aHol").textContent = eur(aHol);

      $("sNight").textContent = fmt(safeNum($("pctNight").value)).replace(",00","");
      $("sSun").textContent = fmt(safeNum($("pctSun").value)).replace(",00","");
      $("sHol").textContent = fmt(safeNum($("pctHol").value)).replace(",00","");

      const ma = Math.max(1, Math.floor(safeNum($("ma").value)||1));
      $("hTotal").textContent = fmt(totalHours);
      $("hPerMA").textContent = fmt(totalHours / ma);

      $("net").textContent = eur(net);
      $("vat").textContent = eur(vat);
      $("gross").textContent = eur(gross);

      $("vatHint").textContent = vatRate===0
        ? "Gemäß §19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung)."
        : "Umsatzsteuer wird mit 19% berechnet.";

      const st = $("status").value;
      $("statusTag").textContent = "Status: " + st;
      $("sellerStatusPreview").textContent = st;
      $("paperStatus").textContent = st;
      $("paperMini").textContent = st + " • Auto Datum • Auto Nummer • Zuschläge • PDF";
      $("pCreated").textContent = new Date().toLocaleString("de-DE");

      syncPreview();
      saveState();
    }

    function syncPreview(){
      $("pInvNo").textContent = ($("invNo").value||"—").trim() || "—";
      const invDate = $("invDate").value ? new Date($("invDate").value+"T00:00:00") : new Date();
      const due = $("dueDate").value ? new Date($("dueDate").value+"T00:00:00") : invDate;

      $("pInvDate").textContent = invDate.toLocaleDateString("de-DE");
      $("pDue").textContent = due.toLocaleDateString("de-DE");
      $("pTerm").textContent = ($("payTerm").value||"") + " Tage";
      $("pVatMode").textContent = $("vatMode").value==="0" ? "0% (§19 UStG)" : "19% (Regelbesteuerung)";

      const customers = loadCustomers();
      const selected = customers.find(c=>c.id===$("customerSelect").value);

      const cName = $("custName").value.trim() || (selected?.name) || "—";
      const cEmail = $("custEmail").value.trim() || (selected?.email) || "—";
      const cData = $("custData").value.trim() || (selected?.data) || "—";

      $("pCustName").textContent = cName || "—";
      $("pCustEmail").textContent = cEmail || "—";
      $("pCustData").textContent = cData || "—";

      $("pObjekt").textContent = $("objekt").value.trim() || "—";
      $("pZeitraum").textContent = $("zeitraum").value.trim() || "—";
      $("pLeistung").textContent = $("leistung").value.trim() || "—";
      $("pPO").textContent = $("po").value.trim() || "—";

      $("ppBaseH").textContent = $("hBase").textContent;
      $("ppRate").textContent = eur(safeNum($("rate").value));
      $("ppBaseA").textContent = $("aBase").textContent;

      $("ppNightH").textContent = fmt(safeNum($("hNight").value));
      $("ppNightP").textContent = fmt(safeNum($("pctNight").value)).replace(",00","") + "%";
      $("ppNightA").textContent = $("aNight").textContent;

      $("ppSunH").textContent = fmt(safeNum($("hSun").value));
      $("ppSunP").textContent = fmt(safeNum($("pctSun").value)).replace(",00","") + "%";
      $("ppSunA").textContent = $("aSun").textContent;

      $("ppHolH").textContent = fmt(safeNum($("hHol").value));
      $("ppHolP").textContent = fmt(safeNum($("pctHol").value)).replace(",00","") + "%";
      $("ppHolA").textContent = $("aHol").textContent;

      $("ppNet").textContent = $("net").textContent;
      $("ppVat").textContent = $("vat").textContent;
      $("ppGross").textContent = $("gross").textContent;
    }

    // Logo: make sure it appears in PDF (convert logo.png to dataURL automatically)
    async function fetchLogoToDataURL(){
      try{
        const res = await fetch("logo.png", {cache:"no-store"});
        if(!res.ok) return null;
        const blob = await res.blob();
        const dataUrl = await new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.onload = ()=>resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(blob);
        });
        return dataUrl;
      }catch(e){
        return null;
      }
    }
    function applyLogo(src){
      ["topLogo","paperLogo"].forEach(id=>{
        const img = $(id);
        img.src = src || "logo.png";
      });
    }
    async function loadLogo(){
      const saved = ls.get(LOGO_KEY, null);
      if(saved){
        applyLogo(saved);
        return;
      }
      const auto = await fetchLogoToDataURL();
      if(auto){
        ls.set(LOGO_KEY, auto);
        applyLogo(auto);
      }else{
        applyLogo("logo.png");
      }
    }
    async function setLogoFromFile(file){
      const dataUrl = await new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = ()=>res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
      ls.set(LOGO_KEY, dataUrl);
      applyLogo(dataUrl);
    }

    // Invoices save/list
    function loadInvoices(){ return ls.get(INVOICES_KEY, []); }
    function saveInvoices(list){ ls.set(INVOICES_KEY, list); }

    function saveCurrentInvoice(){
      recalc();
      const d = gather();
      const inv = {
        id: (d.invNo||("INV-"+Date.now())).trim(),
        invNo: (d.invNo||"").trim(),
        date: d.invDate,
        due: d.dueDate,
        status: d.status,
        customer: d.custName || (loadCustomers().find(c=>c.id===d.customerId)?.name) || "",
        net: $("net").textContent,
        gross: $("gross").textContent,
        data: d,
        savedAt: Date.now()
      };
      const list = loadInvoices();
      const idx = list.findIndex(x=>x.id===inv.id);
      if(idx>=0) list[idx]=inv; else list.unshift(inv);
      saveInvoices(list);
      alert("Rechnung gespeichert.");
    }

    function openModal(){ $("mInvoices").classList.add("open"); }
    function closeModal(){ $("mInvoices").classList.remove("open"); }

    function renderInvoiceList(){
      const box = $("invoiceList");
      const list = loadInvoices();
      if(!list.length){
        box.innerHTML = `<div class="item"><div><div class="t">Keine Rechnungen gespeichert</div><div class="s">Klicke „Rechnung speichern“.</div></div><div></div></div>`;
        return;
      }
      box.innerHTML = "";
      list.forEach((inv)=>{
        const el = document.createElement("div");
        el.className="item";
        const when = new Date(inv.savedAt).toLocaleString("de-DE");
        el.innerHTML = `
          <div>
            <div class="t mono">${inv.invNo || inv.id}</div>
            <div class="s">${inv.customer || "—"} • ${inv.status} • Datum ${inv.date} • Netto ${inv.net} • Gesamt ${inv.gross} • gespeichert ${when}</div>
          </div>
          <div class="acts">
            <button class="smallbtn blue" data-load="${inv.id}">Laden</button>
            <button class="smallbtn" data-pdf="${inv.id}">PDF</button>
            <button class="smallbtn red" data-del="${inv.id}">Löschen</button>
          </div>
        `;
        box.appendChild(el);
      });

      box.querySelectorAll("button[data-load]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-load");
          const inv = loadInvoices().find(x=>x.id===id);
          if(!inv) return;
          ls.set(STORE_KEY, inv.data);
          apply(state());
          closeModal();
        });
      });
      box.querySelectorAll("button[data-del]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-del");
          if(!confirm("Rechnung löschen?")) return;
          saveInvoices(loadInvoices().filter(x=>x.id!==id));
          renderInvoiceList();
        });
      });
      box.querySelectorAll("button[data-pdf]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-pdf");
          const inv = loadInvoices().find(x=>x.id===id);
          if(!inv) return;
          ls.set(STORE_KEY, inv.data);
          apply(state());
          await exportPDF();
        });
      });
    }

    // PDF export: FORCE 1 PAGE (fit-to-one-page) to avoid "2 pages"
    async function exportPDF(){
      recalc();
      const { jsPDF } = window.jspdf;

      // Ensure logo is dataurl
      const logo = ls.get(LOGO_KEY, null);
      if(logo) applyLogo(logo);

      const paper = $("paper");
      const scale = 2;
      const canvas = await html2canvas(paper, {scale, useCORS:true, backgroundColor:"#ffffff"});
      const imgData = canvas.toDataURL("image/png");

      const pdf = new jsPDF({orientation:"portrait", unit:"mm", format:"a4"});
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      // Fit image into one page (scale down if needed)
      const imgW = pageW;
      const imgH = (canvas.height * imgW) / canvas.width;

      let drawW = imgW;
      let drawH = imgH;

      if(drawH > pageH){
        const ratio = pageH / drawH;
        drawH = pageH;
        drawW = drawW * ratio;
      }

      const x = (pageW - drawW) / 2;
      const y = 0;

      pdf.addImage(imgData, "PNG", x, y, drawW, drawH, undefined, "FAST");

      const name = (($("invNo").value||"Rechnung").trim() || "Rechnung") + ".pdf";
      pdf.save(name);
    }

    function wire(){
      [
        "objekt","zeitraum","leistung","po",
        "invDate","payTerm","dueDate","invNo",
        "status","vatMode",
        "rate","pctNight","pctSun","pctHol",
        "ma","totalHours","hNight","hSun","hHol",
        "custName","custEmail","custData","customerSelect"
      ].forEach(id=>{
        $(id).addEventListener("input", recalc);
        $(id).addEventListener("change", ()=>{
          if(id==="customerSelect") loadCustomerToFields();
          recalc();
        });
      });

      $("btnCustomerSave").addEventListener("click", upsertCustomer);
      $("btnCustomerDelete").addEventListener("click", deleteCustomer);
      $("btnCustomerNew").addEventListener("click", ()=>{
        $("customerSelect").value="";
        $("custName").value="";
        $("custEmail").value="";
        $("custData").value="";
        recalc();
      });

      $("btnNeu").addEventListener("click", ()=>{
        const keepLogo = ls.get(LOGO_KEY, null);
        ls.set(STORE_KEY, defaultData());
        if(keepLogo) ls.set(LOGO_KEY, keepLogo);
        apply(state());
      });

      $("btnReset").addEventListener("click", ()=>{
        if(!confirm("Alles zurücksetzen (Formular)?")) return;
        ls.set(STORE_KEY, defaultData());
        apply(state());
      });

      $("btnSaveInvoice").addEventListener("click", saveCurrentInvoice);

      $("btnListInvoices").addEventListener("click", ()=>{
        renderInvoiceList();
        openModal();
      });

      $("closeInvoices").addEventListener("click", closeModal);
      $("mInvoices").addEventListener("click", (e)=>{
        if(e.target === $("mInvoices")) closeModal();
      });

      $("btnPDF").addEventListener("click", exportPDF);

      $("btnLogo").addEventListener("click", ()=> $("logoFile").click());
      $("logoFile").addEventListener("change", async ()=>{
        const f = $("logoFile").files?.[0];
        if(!f) return;
        await setLogoFromFile(f);
        alert("Logo gespeichert (auch im PDF).");
      });
    }

    async function init(){
      await loadLogo();
      renderCustomerSelect("");

      // load state
      const d = state();
      apply(d);

      // defaults
      if(!$("invDate").value) $("invDate").value = todayISO();
      if(!$("dueDate").value) $("dueDate").value = addDays($("invDate").value, Number($("payTerm").value||14));

      // if invNo empty, generate
      if(!($("invNo").value||"").trim()) ensureInvoiceNo();

      wire();
      recalc();
    }
    init();
  </script>
</body>
</html>
