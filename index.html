<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security â€” B2B Rechnung System (100% Business Ready)</title>

  <!-- PDF libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --ink:#0b1220;
      --muted:#475569;
      --line:#e5e7eb;
      --paper:#ffffff;
      --bg:#f5f7fb;

      --accent:#0b5fa8;
      --accent2:#0a4d86;

      --r:16px;
      --shadow:0 12px 30px rgba(15,23,42,.08);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:var(--sans);color:var(--ink);background:var(--bg)}

    /* ===== Topbar ===== */
    .topbar{
      position:sticky;top:0;z-index:9;
      background:rgba(255,255,255,.84);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(229,231,235,.95);
    }
    .topbarInner{
      max-width:1180px;margin:0 auto;padding:14px 14px;
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:280px}
    .logo{
      width:44px;height:44px;border-radius:12px;
      border:1px solid rgba(229,231,235,.95);
      overflow:hidden;background:#fff;
      box-shadow:0 10px 24px rgba(15,23,42,.06);
      display:grid;place-items:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .btitle{font-weight:950;letter-spacing:-.3px;line-height:1.1}
    .bsub{font-size:12px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}

    button{
      border:1px solid rgba(229,231,235,.98);
      background:#fff;color:#0a2540;font-weight:900;
      border-radius:12px;padding:10px 12px;cursor:pointer;
      box-shadow:0 8px 20px rgba(15,23,42,.06);
      transition: transform .06s ease, box-shadow .14s ease, border-color .14s ease;
    }
    button:hover{box-shadow:0 12px 26px rgba(15,23,42,.10);border-color:#dbe3ef}
    button:active{transform:translateY(1px)}
    button.primary{
      background:linear-gradient(180deg,var(--accent),var(--accent2));
      color:#fff;border-color:rgba(11,95,168,.35);
      box-shadow:0 14px 34px rgba(11,95,168,.22);
    }
    button.ghost{background:transparent;box-shadow:none}
    button.ok{
      background:linear-gradient(180deg,#17b897,#12a988);
      color:#fff;border-color:rgba(18,169,136,.35);
      box-shadow:0 14px 34px rgba(18,169,136,.18);
    }
    button.danger{
      background:linear-gradient(180deg,#ff4d6d,#e11d48);
      color:#fff;border-color:rgba(225,29,72,.35);
      box-shadow:0 14px 34px rgba(225,29,72,.16);
    }

    .chips{
      max-width:1180px;margin:0 auto;padding:0 14px 12px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      color:var(--muted);font-size:12px;
    }
    .tag{
      display:inline-flex;gap:8px;align-items:center;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(229,231,235,.98);
      background:#fff;
      box-shadow:0 8px 20px rgba(15,23,42,.05);
      font-weight:900;
      color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:99px;background:#22c55e}
    .dot.gray{background:#94a3b8}

    /* CLICKABLE chips as <a> */
    a.chipLink{
      display:inline-flex;gap:8px;align-items:center;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(229,231,235,.98);
      background:#fff;
      box-shadow:0 8px 20px rgba(15,23,42,.05);
      font-weight:950;
      color:#0a2540;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
    }
    a.chipLink:active{transform:translateY(1px)}
    a.chipLink:hover{border-color:#dbe3ef;box-shadow:0 12px 26px rgba(15,23,42,.10)}

    /* ===== Layout ===== */
    .shell{
      max-width:1180px;margin:0 auto;padding:14px 14px 44px;
      display:grid;gap:14px;
    }
    @media (min-width:980px){.shell{grid-template-columns:260px 1fr}}

    .sidebar{
      background:#fff;border:1px solid rgba(229,231,235,.98);
      border-radius:16px;box-shadow:var(--shadow);
      overflow:hidden;position:sticky;top:92px;height:calc(100vh - 110px);
    }
    .shead{padding:14px 14px 10px;border-bottom:1px solid rgba(229,231,235,.98);background:linear-gradient(180deg,#fff,#fbfcff)}
    .shead .h1{font-weight:950;color:#0a2540;font-size:14px}
    .shead .h2{font-size:12px;color:var(--muted);margin-top:4px}
    .snav{padding:10px}
    .sbtn{
      width:100%;text-align:left;display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:14px;border:1px solid transparent;background:transparent;
      font-weight:950;color:#0a2540;cursor:pointer;box-shadow:none;
    }
    .sbtn:hover{background:rgba(11,95,168,.06);border-color:rgba(11,95,168,.12)}
    .sbtn.active{background:linear-gradient(180deg,rgba(11,95,168,.12),rgba(11,95,168,.05));border-color:rgba(11,95,168,.18)}
    .stag{
      font-size:12px;color:var(--muted);border:1px solid rgba(229,231,235,.98);background:#fff;
      padding:4px 8px;border-radius:999px;font-family:var(--mono);
    }

    .main{min-width:0}
    .view{display:none}
    .view.active{display:block}

    .card{
      background:#fff;border:1px solid rgba(229,231,235,.98);
      border-radius:16px;box-shadow:var(--shadow);overflow:hidden;
    }
    .card h2{
      margin:0;padding:14px 16px;font-size:13px;letter-spacing:.2px;color:#0a2540;
      background:linear-gradient(180deg,#fff,#fbfcff);border-bottom:1px solid rgba(229,231,235,.98);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card .body{padding:14px 16px}

    .grid{display:grid;gap:14px}
    @media (min-width:980px){.grid{grid-template-columns:1.35fr .85fr}}

    .row2{display:grid;gap:10px}
    @media (min-width:760px){.row2{grid-template-columns:1fr 1fr}}
    .row3{display:grid;gap:10px}
    @media (min-width:760px){.row3{grid-template-columns:1fr 1fr 1fr}}

    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px;font-weight:800}
    input,select,textarea{
      width:100%;border:1px solid rgba(229,231,235,.99);border-radius:14px;padding:11px 12px;
      font:inherit;background:#fff;outline:none;transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus,select:focus,textarea:focus{border-color:rgba(11,95,168,.45);box-shadow:0 0 0 4px rgba(11,95,168,.10)}
    textarea{min-height:92px;resize:vertical}
    .mono{font-family:var(--mono)}
    .hr{height:1px;background:rgba(229,231,235,.98);margin:12px 0}
    .note{
      font-size:12px;color:var(--muted);
      border:1px solid rgba(229,231,235,.99);border-radius:14px;padding:10px;background:linear-gradient(180deg,#fff,#fbfcff);
    }
    .pill{
      font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(229,231,235,.98);
      background:#fff;color:var(--muted);font-family:var(--mono);white-space:nowrap;
    }

    .kpi{display:grid;gap:10px}
    @media (min-width:760px){.kpi{grid-template-columns:1fr 1fr}}
    .kpi .box{
      border:1px solid rgba(229,231,235,.99);border-radius:16px;padding:12px;background:linear-gradient(180deg,#fff,#fbfcff);
    }
    .kpi .big{font-size:22px;font-weight:950}
    .kpi .small{font-size:12px;color:var(--muted);font-weight:800}

    .table{
      width:100%;border-collapse:separate;border-spacing:0;
      border:1px solid rgba(229,231,235,.99);border-radius:16px;overflow:hidden;
    }
    .table th,.table td{padding:10px 10px;border-bottom:1px solid rgba(229,231,235,.99);font-size:13px}
    .table th{background:#f7fafc;text-align:left;color:#0a2540;font-weight:950}
    .table tr:last-child td{border-bottom:0}
    .right{text-align:right}

    .list{display:grid;gap:10px}
    .item{
      border:1px solid rgba(229,231,235,.99);border-radius:16px;padding:12px;
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;
      background:#fff;box-shadow:0 10px 26px rgba(15,23,42,.06);
    }
    .item b{display:block}
    .item small{color:var(--muted)}
    .item .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    /* ===== PRINT / PDF ===== */
    #printWrap{display:none}
    #printA4{
      background:#fff;color:#111;
      padding:18mm 16mm;width:210mm;min-height:297mm;margin:0 auto;
    }
    .invHead{
      display:flex;justify-content:space-between;gap:16px;
      border-bottom:2px solid #111;padding-bottom:10px;margin-bottom:12px;
    }
    .invLeft{display:flex;gap:12px;align-items:center}
    .invLogo{width:52px;height:52px;border-radius:14px;overflow:hidden;border:1px solid #e5e7eb;background:#fff}
    .invLogo img{width:100%;height:100%;object-fit:cover}
    .invTitle{font-size:28px;font-weight:950;margin:0;letter-spacing:-.5px}
    .invBrand{font-size:13px;color:#111;font-weight:950;margin-top:2px}
    .invMeta{font-size:12px;color:#111;margin-top:2px}
    .metaBox{min-width:280px;border:1px solid #111;padding:10px;font-size:12px}
    .metaLine{display:flex;justify-content:space-between;gap:10px;margin:4px 0}
    .metaLine .k{font-weight:900}
    .metaLine .v{font-family:var(--mono)}
    .cols2{display:grid;gap:12px;margin-top:10px}
    @media (min-width:900px){.cols2{grid-template-columns:1fr 1fr}}
    .boxPrint{border:1px solid #111;padding:10px;font-size:12px;min-height:72px}
    .boxPrint h4{margin:0 0 8px;font-size:12px;font-weight:950}
    .boxPrint .l{margin:2px 0}
    .invTable{width:100%;border-collapse:collapse;margin-top:12px;font-size:12px}
    .invTable th,.invTable td{border:1px solid #111;padding:7px}
    .invTable th{background:#f3f4f6;text-align:left;font-weight:950}
    .invRight{text-align:right}
    .totals{
      margin-top:10px;display:grid;gap:6px;font-size:12px;max-width:380px;margin-left:auto;
    }
    .tline{display:flex;justify-content:space-between;gap:10px}
    .grand{font-size:13px;font-weight:950}
    .footer{
      margin-top:12px;font-size:11px;color:#111;border-top:1px solid #111;padding-top:10px;
    }
    .annexTitle{
      margin-top:14mm;font-size:14px;font-weight:950;border-bottom:1px solid #111;padding-bottom:6px;
    }
    .mutedSmall{font-size:11px;color:#111;margin-top:6px}
    @media print{
      body{background:#fff}
      .topbar,.chips,.shell{display:none!important}
      #printWrap{display:block!important}
      #printA4{box-shadow:none;border:none}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <div class="logo" title="Logo (fest gespeichert)">
          <img id="logoImg" alt="Logo"/>
        </div>
        <div>
          <div class="btitle" id="topCompany">Masculine Security</div>
          <div class="bsub">B2B Rechnung â€¢ Steuerberater-Design â€¢ Anlage Einsatznachweis â€¢ Auto 99%</div>
        </div>
      </div>

      <div class="actions">
        <button class="ghost" id="btnLogo" type="button">Logo Ã¤ndern</button>
        <button class="ghost" id="btnNew" type="button">Neu</button>
        <button class="ok" id="btnSave" type="button">Rechnung speichern</button>
        <button class="ghost" id="btnList" type="button">Rechnungen</button>
        <button class="danger" id="btnReset" type="button">Reset</button>
        <button class="primary" id="btnPdf" type="button">PDF speichern</button>
        <button class="primary" id="btnPrint" type="button">Print</button>
      </div>
    </div>

    <div class="chips">
      <span class="tag"><span class="dot"></span> Auto-Save aktiv</span>
      <span class="tag" id="b2bTag"><span class="dot"></span> B2B: ON (1 Position + Anlage)</span>

      <!-- âœ… CLICKABLE ALWAYS -->
      <a class="chipLink" id="btnCallLink" href="tel:015778697052">â˜Ž <span id="chipTel">015778697052</span></a>
      <a class="chipLink" id="btnMailLink" href="mailto:Kontakt.mass.bremen@hotmail.com">âœ‰ <span id="chipMail">Kontakt.mass.bremen@hotmail.com</span></a>

      <span class="tag" id="statusTag"><span class="dot gray"></span> <span id="liveStatus">Bereit</span></span>
    </div>
  </div>

  <div class="shell">
    <aside class="sidebar">
      <div class="shead">
        <div class="h1">Masculine Security</div>
        <div class="h2">B2B Rechnungssystem</div>
      </div>
      <div class="snav">
        <button class="sbtn active" id="navCreate" type="button"><span>âž• Rechnung</span><span class="stag">FORM</span></button>
        <button class="sbtn" id="navInvoices" type="button"><span>ðŸ“„ Rechnungen</span><span class="stag" id="navInvCount">0</span></button>
        <button class="sbtn" id="navCustomers" type="button"><span>ðŸ‘¤ Kunden</span><span class="stag" id="navCustCount">0</span></button>
        <button class="sbtn" id="navSettings" type="button"><span>âš™ Einstellungen</span><span class="stag">PRO</span></button>
      </div>
    </aside>

    <main class="main">

      <!-- CREATE -->
      <div class="view active" id="viewCreate">
        <div class="grid">

          <!-- FORM -->
          <div class="card">
            <h2>
              <span>Rechnungsdaten</span>
              <span style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                <span class="pill mono" id="modePill">MODE: FEST</span>
                <span class="pill mono" id="b2bPill">B2B: ON</span>
                <span class="pill mono" id="rcPill">RC: OFF</span>
              </span>
            </h2>

            <div class="body">

              <div class="row2">
                <div>
                  <label>Firmenname / Brand *</label>
                  <input id="issuerCompany" value="Masculine Security"/>
                </div>
                <div>
                  <label>Adresse *</label>
                  <input id="issuerAddress" value="WerschenregerstraÃŸe 6 â€¢ 28237 Bremen"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Telefon</label>
                  <input id="issuerPhone" value="015778697052"/>
                </div>
                <div>
                  <label>E-Mail *</label>
                  <input id="issuerEmail" value="Kontakt.mass.bremen@hotmail.com"/>
                </div>
              </div>

              <div class="row3" style="margin-top:10px">
                <div>
                  <label>Steuernummer / Hinweis *</label>
                  <input id="issuerTaxNo" value="wird nachgereicht"/>
                </div>
                <div>
                  <label>USt-IdNr (optional)</label>
                  <input id="issuerVatId" placeholder="DE123456789"/>
                </div>
                <div>
                  <label>Rechtsform (optional)</label>
                  <input id="issuerLegalForm" placeholder="Einzelunternehmen"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>IBAN *</label>
                  <input id="issuerIban" value="DE98 1001 1001 2333 0146 96"/>
                </div>
                <div>
                  <label>BIC *</label>
                  <input id="issuerBic" value="NTSBDEB1XXX"/>
                </div>
              </div>

              <div class="row3" style="margin-top:10px">
                <div>
                  <label>Kontoinhaber *</label>
                  <input id="issuerHolder" value="MUSTAFA MURSAL ABDI"/>
                </div>
                <div>
                  <label>Handelsregister (optional)</label>
                  <input id="issuerRegister" placeholder="HRB ... (falls vorhanden)"/>
                </div>
                <div>
                  <label>Gerichtsstand (optional)</label>
                  <input id="issuerCourt" placeholder="Bremen"/>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row2">
                <div>
                  <label>Kunde auswÃ¤hlen</label>
                  <select id="customerPick"></select>
                  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
                    <button id="btnSaveCustomer" class="ghost" type="button">Kunde speichern</button>
                    <button id="btnDeleteCustomer" class="danger" type="button">Kunde lÃ¶schen</button>
                  </div>
                </div>

                <div>
                  <label>Kundenname (zum Speichern) *</label>
                  <input id="custName" placeholder="Firma / Name"/>
                  <div class="row2" style="margin-top:10px">
                    <div>
                      <label>E-Mail (optional)</label>
                      <input id="custEmail" placeholder="kunde@email.de"/>
                    </div>
                    <div>
                      <label>Ansprechpartner (optional)</label>
                      <input id="custContact" placeholder="Ansprechpartner"/>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Kundendaten (Adresse) *</label>
                  <textarea id="custAddress" placeholder="StraÃŸe â€¢ PLZ Ort"></textarea>
                </div>
                <div>
                  <label>Kunde USt-IdNr (optional, EU B2B)</label>
                  <input id="custVatId" placeholder="z.B. ATU..., NL..., etc."/>
                  <div class="note" style="margin-top:8px">
                    Wenn EU-B2B + Reverse Charge: trage die USt-IdNr des Kunden ein und aktiviere Reverse Charge unten.
                  </div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row3">
                <div>
                  <label>Rechnungsdatum *</label>
                  <input id="invDate" type="date"/>
                </div>
                <div>
                  <label>Zahlungsziel (Tage) *</label>
                  <input id="payDays" type="number" min="0" step="1" value="14"/>
                  <div class="note" style="margin-top:8px">FÃ¤llig am = Rechnungsdatum + Zahlungsziel.</div>
                </div>
                <div>
                  <label>FÃ¤llig am *</label>
                  <input id="dueDate" type="date"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Rechnungsnummer *</label>
                  <input id="invNo" class="mono"/>
                  <div class="note" style="margin-top:8px">Automatisch pro Tag: MS-YYYYMMDD-0001</div>
                </div>
                <div>
                  <label>Verwendungszweck (auto)</label>
                  <input id="purpose" class="mono" readonly/>
                  <div class="note" style="margin-top:8px">Kunde kann bei Ãœberweisung so schreiben.</div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row3">
                <div>
                  <label>USt-Status *</label>
                  <select id="vatMode">
                    <option value="kmu">0% (Kleinunternehmer Â§19)</option>
                    <option value="vat19">19% USt</option>
                  </select>
                  <div class="note" style="margin-top:8px" id="vatHint">GemÃ¤ÃŸ Â§19 UStG wird keine Umsatzsteuer berechnet.</div>
                </div>

                <div>
                  <label>Reverse Charge (EU B2B) *</label>
                  <select id="reverseCharge">
                    <option value="off">OFF</option>
                    <option value="on">ON (VAT 0%, Hinweis im PDF)</option>
                  </select>
                  <div class="note" style="margin-top:8px">
                    Nur aktivieren, wenn wirklich EU-B2B und Bedingungen erfÃ¼llt sind. Bei ON wird VAT = 0% und RC-Hinweis gedruckt.
                  </div>
                </div>

                <div>
                  <label>B2B Darstellung *</label>
                  <select id="b2bMode">
                    <option value="on">ON (1 Position + Anlage Einsatznachweis)</option>
                    <option value="off">OFF (Detail auf Rechnung)</option>
                  </select>
                  <div class="note" style="margin-top:8px"><b>Pro:</b> B2B ON = sauber, Firmen akzeptieren schneller.</div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row2">
                <div>
                  <label>Leistungsbeschreibung *</label>
                  <input id="serviceTitle" value="Sicherheitsdienstleistung â€“ Objektschutz"/>
                  <div class="row2" style="margin-top:10px">
                    <div>
                      <label>Objekt / Ort (optional)</label>
                      <input id="objekt" placeholder="z.B. Baustelle â€“ Bremen"/>
                    </div>
                    <div>
                      <label>Auftragszeitraum (optional)</label>
                      <input id="zeitraum" placeholder="z.B. 08.03.2026 â€“ 09.03.2026"/>
                    </div>
                  </div>
                </div>
                <div>
                  <label>Leistungsdatum (optional, wichtig fÃ¼r B2B)</label>
                  <input id="leistungsdatum" placeholder="z.B. 08.03.2026"/>
                  <div class="note" style="margin-top:8px">Wenn du nur 1 Tag gearbeitet hast, hier Datum eintragen.</div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row2">
                <div>
                  <label>Anzahl Mitarbeiter *</label>
                  <input id="mitarbeiter" type="number" min="0" value="5"/>
                </div>
                <div>
                  <label>Tag-Stundensatz (â‚¬) *</label>
                  <input id="tagPreis" type="number" min="0" step="0.01" value="23"/>
                </div>
              </div>

              <div class="row3" style="margin-top:10px">
                <div>
                  <label>Schicht Beginn</label>
                  <input id="shiftStart" type="time" value="18:00"/>
                </div>
                <div>
                  <label>Schicht Ende</label>
                  <input id="shiftEnd" type="time" value="06:00"/>
                </div>
                <div>
                  <label>Nachtzeit Regel *</label>
                  <select id="nachtRule">
                    <option value="22-06">22:00 â€“ 06:00 (Standard)</option>
                    <option value="23-06">23:00 â€“ 06:00</option>
                    <option value="20-06">20:00 â€“ 06:00</option>
                  </select>
                </div>
              </div>

              <div class="note" style="margin-top:10px">
                Auto berechnet Tag/Nacht-Stunden. Sonntag/Feiertag trÃ¤gst du separat ein (keine DoppelzÃ¤hlung).
              </div>

              <div class="hr"></div>

              <div class="row3">
                <div>
                  <label>Tagstunden</label>
                  <input id="tagH" type="number" min="0" step="0.25" value="0"/>
                </div>
                <div>
                  <label>Nachtstunden</label>
                  <input id="nachtH" type="number" min="0" step="0.25" value="0"/>
                </div>
                <div>
                  <label>Sonntagstunden</label>
                  <input id="sonntagH" type="number" min="0" step="0.25" value="0"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Feiertagstunden</label>
                  <input id="feiertagH" type="number" min="0" step="0.25" value="0"/>
                  <div class="note" style="margin-top:8px">Stunden nur in <b>eine</b> Kategorie.</div>
                </div>
                <div>
                  <label>Zuschlag-StundensÃ¤tze (Festpreise) *</label>
                  <div class="row3">
                    <div>
                      <label style="margin-top:0">Nacht (â‚¬)</label>
                      <input id="nachtFest" type="number" min="0" step="0.01" value="24"/>
                    </div>
                    <div>
                      <label style="margin-top:0">Sonntag (â‚¬)</label>
                      <input id="sonntagFest" type="number" min="0" step="0.01" value="32"/>
                    </div>
                    <div>
                      <label style="margin-top:0">Feiertag (â‚¬)</label>
                      <input id="feiertagFest" type="number" min="0" step="0.01" value="36"/>
                    </div>
                  </div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row2">
                <div>
                  <label>Zahlungsbedingungen (Text) *</label>
                  <textarea id="paymentTermsText">Zahlbar innerhalb von 14 Tagen ohne Abzug.</textarea>
                  <div class="note" style="margin-top:8px">Wird im PDF automatisch angezeigt.</div>
                </div>
                <div>
                  <label>Mahnung / Verzug (optional, Text)</label>
                  <textarea id="dunningText">Bei Zahlungsverzug behalten wir uns vor, MahngebÃ¼hren sowie gesetzliche Verzugszinsen zu berechnen.</textarea>
                  <div class="note" style="margin-top:8px">Optional â€“ B2B Ã¼blich.</div>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Hinweis / Notiz (optional)</label>
                  <textarea id="note" placeholder="z.B. laut Vereinbarung / Ansprechpartner / Referenz..."></textarea>
                </div>
                <div>
                  <label>Interner Hinweis (nicht im PDF)</label>
                  <textarea id="internalNote" placeholder="z.B. interne Kalkulation / Mitarbeiterliste / Auftrag-Nr."></textarea>
                  <div class="note" style="margin-top:8px">Nur intern gespeichert.</div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row2">
                <div>
                  <label>Rechnungstext (auto)</label>
                  <textarea id="rechnungText"></textarea>
                  <div class="note" style="margin-top:8px">Auto-Text ist steuerberater-freundlich.</div>
                </div>
                <div>
                  <label>FuÃŸzeile Zusatz (optional)</label>
                  <textarea id="footerExtra" placeholder="z.B. Versicherung / Rahmenvertrag / Referenznummer..."></textarea>
                  <div class="note" style="margin-top:8px">Wird unten im PDF gedruckt.</div>
                </div>
              </div>

            </div>
          </div>

          <!-- SUMMARY -->
          <div class="card">
            <h2>
              <span>Berechnung & Summe</span>
              <span class="pill mono" id="calcBadge">AUTO</span>
            </h2>
            <div class="body">

              <div class="kpi">
                <div class="box">
                  <div class="small">Zwischensumme (netto)</div>
                  <div class="big mono" id="subTotal">0,00 â‚¬</div>
                </div>
                <div class="box">
                  <div class="small">Gesamt (brutto)</div>
                  <div class="big mono" id="grandTotal">0,00 â‚¬</div>
                </div>
              </div>

              <div class="hr"></div>

              <table class="table">
                <thead>
                  <tr>
                    <th>Position</th>
                    <th class="right">Std.</th>
                    <th class="right">Preis/Std.</th>
                    <th class="right">Summe</th>
                  </tr>
                </thead>
                <tbody>
                  <tr id="rowB2B">
                    <td><b>B2B Pauschale</b> (All-in, Anlage Einsatznachweis)</td>
                    <td class="right mono" id="b2bStd">0</td>
                    <td class="right mono" id="b2bPreis">â€”</td>
                    <td class="right mono" id="b2bSum">0,00 â‚¬</td>
                  </tr>

                  <tr class="rowDetail">
                    <td>Tagdienst</td>
                    <td class="right mono" id="t_tagStd">0</td>
                    <td class="right mono" id="t_tagPreis">0,00 â‚¬</td>
                    <td class="right mono" id="t_tagSum">0,00 â‚¬</td>
                  </tr>
                  <tr class="rowDetail">
                    <td>Nachtdienst</td>
                    <td class="right mono" id="t_nachtStd">0</td>
                    <td class="right mono" id="t_nachtPreis">0,00 â‚¬</td>
                    <td class="right mono" id="t_nachtSum">0,00 â‚¬</td>
                  </tr>
                  <tr class="rowDetail">
                    <td>Sonntag</td>
                    <td class="right mono" id="t_sonntagStd">0</td>
                    <td class="right mono" id="t_sonntagPreis">0,00 â‚¬</td>
                    <td class="right mono" id="t_sonntagSum">0,00 â‚¬</td>
                  </tr>
                  <tr class="rowDetail">
                    <td>Feiertag</td>
                    <td class="right mono" id="t_feiertagStd">0</td>
                    <td class="right mono" id="t_feiertagPreis">0,00 â‚¬</td>
                    <td class="right mono" id="t_feiertagSum">0,00 â‚¬</td>
                  </tr>
                </tbody>
              </table>

              <div class="hr"></div>

              <div class="note">
                <b>Rechenregel:</b> <span class="mono">Summe = Mitarbeiter Ã— Stunden Ã— Preis</span><br/>
                <b>B2B ON:</b> PDF zeigt <b>1 Position Pauschale</b> + Anlage (Detail).<br/>
                <b>Reverse Charge ON:</b> VAT wird automatisch 0% gesetzt + RC-Hinweis im PDF.
              </div>

            </div>
          </div>

        </div>
      </div>

      <!-- INVOICES -->
      <div class="view" id="viewInvoices">
        <div class="card">
          <h2><span>Gespeicherte Rechnungen</span><span class="pill mono" id="invCount">0</span></h2>
          <div class="body"><div class="list" id="invList"></div></div>
        </div>
      </div>

      <!-- CUSTOMERS -->
      <div class="view" id="viewCustomers">
        <div class="card">
          <h2><span>Kunden</span><span class="pill mono" id="custCount">0</span></h2>
          <div class="body">
            <div class="note">Kundenliste. AuswÃ¤hlen lÃ¤dt die Daten zurÃ¼ck ins Formular.</div>
            <div class="hr"></div>
            <div class="list" id="custList"></div>
          </div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="view" id="viewSettings">
        <div class="card">
          <h2><span>Einstellungen (100% Business)</span><span class="pill mono">Backup</span></h2>
          <div class="body">
            <div class="note">âœ… Fest-Logo â€¢ âœ… Auto-Save â€¢ âœ… Backup/Restore â€¢ âœ… Export/Import â€¢ âœ… Reverse Charge Toggle</div>

            <div class="hr"></div>

            <div class="row2">
              <div>
                <label>Firmenname</label>
                <input id="issuerCompanyMirror" placeholder="Masculine Security"/>
              </div>
              <div>
                <label>Logo</label>
                <button class="primary" type="button" id="btnLogo2">Logo Ã¤ndern</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row2">
              <div>
                <label>Backup Export (JSON)</label>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                  <button type="button" class="primary" id="btnExportBackup">Backup herunterladen</button>
                  <button type="button" class="ghost" id="btnCopyBackup">Backup in Clipboard</button>
                </div>
                <div class="note" style="margin-top:8px">Sichert: Einstellungen, Kunden, Rechnungen, ZÃ¤hler, Logo.</div>
              </div>
              <div>
                <label>Backup Import</label>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                  <button type="button" class="primary" id="btnImportBackup">Backup importieren</button>
                  <button type="button" class="danger" id="btnWipeData">Alle Daten lÃ¶schen</button>
                </div>
                <div class="note" style="margin-top:8px">Import Ã¼berschreibt alles.</div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row2">
              <div>
                <label>Quick Export: Rechnungen als JSON</label>
                <button type="button" id="btnExportInvoices">Rechnungen exportieren</button>
              </div>
              <div>
                <label>Quick Export: Kunden als JSON</label>
                <button type="button" id="btnExportCustomers">Kunden exportieren</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="note">
              Tipp: Backup Datei sicher speichern (Google Drive/PC). Dann ist es wirklich â€žbusiness-readyâ€œ.
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- PRINT / PDF -->
  <div id="printWrap"><div id="printA4"></div></div>

  <!-- LOGO upload -->
  <input id="logoFile" type="file" accept="image/*" style="display:none"/>
  <!-- BACKUP import upload -->
  <input id="backupFile" type="file" accept="application/json" style="display:none"/>

  <script>
    // ===== Storage Keys =====
    const KEY_APP       = "ms_b2b_app_100_v1";
    const KEY_CUSTOMERS = "ms_b2b_customers_100_v1";
    const KEY_INVOICES  = "ms_b2b_invoices_100_v1";
    const KEY_COUNTERS  = "ms_b2b_counters_100_v1";
    const KEY_LOGO      = "ms_b2b_logo_100_v1";

    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const safeNum = (v)=> {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };
    const fmtEUR = (n)=>{
      const v = Number(n||0);
      return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}) + " â‚¬";
    };
    const todayISO = ()=>{
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const addDaysISO = (iso, days)=>{
      const d = new Date(iso+"T00:00:00");
      d.setDate(d.getDate()+days);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const yyyymmdd = (iso)=> String(iso||"").replaceAll("-","");

    const loadJSON = (k, fallback)=>{
      try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback; }catch(e){ return fallback; }
    };
    const saveJSON = (k, v)=> localStorage.setItem(k, JSON.stringify(v));

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

    function setStatus(txt, ok=true){
      $("liveStatus").textContent = txt;
      const dot = document.querySelector("#statusTag .dot");
      if(dot){
        dot.classList.toggle("gray", !ok);
        dot.style.background = ok ? "#22c55e" : "#ef4444";
      }
    }

    // ===== FEST LOGO =====
    function setLogo(dataUrl, persist=true){
      $("logoImg").src = dataUrl;
      if(persist) localStorage.setItem(KEY_LOGO, dataUrl);
    }
    function loadLogo(){
      const saved = localStorage.getItem(KEY_LOGO);
      if(saved){
        setLogo(saved, false);
      }else{
        const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="120" height="120" rx="24" fill="#0b5fa8"/><text x="60" y="72" font-size="54" text-anchor="middle" fill="white" font-family="Arial" font-weight="900">M</text></svg>`);
        setLogo(`data:image/svg+xml,${svg}`, false);
      }
    }

    // ===== Invoice number =====
    function nextInvoiceNo(invDateISO){
      const counters = loadJSON(KEY_COUNTERS, {});
      const d = yyyymmdd(invDateISO || todayISO());
      const cur = safeNum(counters[d]) || 0;
      const next = cur + 1;
      counters[d] = next;
      saveJSON(KEY_COUNTERS, counters);
      return `MS-${d}-${String(next).padStart(4,"0")}`;
    }

    function updateVatHint(){
      const rc = $("reverseCharge").value === "on";
      if(rc){
        $("vatHint").textContent = "Reverse Charge aktiv: Umsatzsteuer wird nicht berechnet (0%).";
        return;
      }
      $("vatHint").textContent = ($("vatMode").value==="kmu")
        ? "GemÃ¤ÃŸ Â§19 UStG wird keine Umsatzsteuer berechnet."
        : "Umsatzsteuer 19% wird berechnet und ausgewiesen.";
    }
    function updatePurpose(){
      const no = $("invNo").value || "";
      $("purpose").value = `Rechnung: ${no}`;
    }

    // âœ… UPDATE CLICKABLE TEL/MAIL (ALWAYS)
    function updateClickableChips(){
      const telRaw = String($("issuerPhone").value || "").trim();
      const mailRaw = String($("issuerEmail").value || "").trim();

      const tel = telRaw.replace(/\s+/g,"");
      const mail = mailRaw;

      $("chipTel").textContent = telRaw || "â€”";
      $("chipMail").textContent = mailRaw || "â€”";

      // always set href
      $("btnCallLink").setAttribute("href", tel ? `tel:${tel}` : "#");
      $("btnMailLink").setAttribute("href", mail ? `mailto:${mail}` : "#");
    }

    function syncTopBrand(){
      const name = String($("issuerCompany").value || "Masculine Security").trim();
      $("topCompany").textContent = name;

      const mir = $("issuerCompanyMirror");
      if(mir && document.activeElement !== mir) mir.value = name;

      updateClickableChips();
    }

    function syncPills(){
      const b2bOn = $("b2bMode").value === "on";
      $("b2bPill").textContent = b2bOn ? "B2B: ON" : "B2B: OFF";
      $("b2bTag").innerHTML = b2bOn
        ? `<span class="dot"></span> B2B: ON (1 Position + Anlage)`
        : `<span class="dot gray"></span> B2B: OFF (Detail)`;
      const dot = document.querySelector("#b2bTag .dot");
      if(dot){ dot.style.background = b2bOn ? "#22c55e" : "#94a3b8"; }

      const rc = $("reverseCharge").value === "on";
      $("rcPill").textContent = rc ? "RC: ON" : "RC: OFF";
    }

    // ===== AUTO Tag/Nacht =====
    function parseTimeToMinutes(t){
      if(!t) return null;
      const [h,m] = t.split(":").map(Number);
      if(!Number.isFinite(h) || !Number.isFinite(m)) return null;
      return h*60 + m;
    }
    function getNightWindow(){
      const rule = $("nachtRule").value;
      if(rule==="23-06") return {start: 23*60, end: 30*60};
      if(rule==="20-06") return {start: 20*60, end: 30*60};
      return {start: 22*60, end: 30*60};
    }
    function calculateDayNight(){
      const start = parseTimeToMinutes($("shiftStart").value);
      const endRaw = parseTimeToMinutes($("shiftEnd").value);
      if(start===null || endRaw===null) return;

      let end = endRaw;
      if(end <= start) end += 1440;

      const totalMin = end - start;
      const {start: nightStart, end: nightEnd} = getNightWindow();

      let nightMin = 0;
      const nightEndMod = nightEnd % 1440; // 360
      for(let i=start;i<end;i++){
        const mod = i % 1440;
        const isNight = (mod >= nightStart) || (mod < nightEndMod);
        if(isNight) nightMin++;
      }
      const nightH = nightMin / 60;
      const dayH = (totalMin/60) - nightH;

      $("tagH").value = Math.max(0, dayH).toFixed(2);
      $("nachtH").value = Math.max(0, nightH).toFixed(2);
    }

    // ===== Due date sync =====
    function syncDueDateFromPayDays(){
      const invDate = $("invDate").value || todayISO();
      const days = Math.max(0, Math.floor(safeNum($("payDays").value)));
      $("dueDate").value = addDaysISO(invDate, days);
    }

    // ===== Calculation =====
    function computeAll(form){
      const m = safeNum(form.mitarbeiter);
      const tagPreis = safeNum(form.tagPreis);
      const nachtPreis = safeNum(form.nachtFest);
      const sonntagPreis = safeNum(form.sonntagFest);
      const feiertagPreis = safeNum(form.feiertagFest);
      const tagH = safeNum(form.tagH);
      const nachtH = safeNum(form.nachtH);
      const sonntagH = safeNum(form.sonntagH);
      const feiertagH = safeNum(form.feiertagH);

      const tagSum = m * tagH * tagPreis;
      const nachtSum = m * nachtH * nachtPreis;
      const sonntagSum = m * sonntagH * sonntagPreis;
      const feiertagSum = m * feiertagH * feiertagPreis;
      const sub = tagSum + nachtSum + sonntagSum + feiertagSum;

      const totalHours = tagH + nachtH + sonntagH + feiertagH;
      const manHours = m * totalHours;

      const rc = form.reverseCharge === "on";
      const vatMode = form.vatMode;
      const vatRate = rc ? 0 : ((vatMode==="vat19") ? 0.19 : 0);
      const vatAmount = sub * vatRate;
      const grand = sub + vatAmount;

      return {m,tagPreis,nachtPreis,sonntagPreis,feiertagPreis,tagH,nachtH,sonntagH,feiertagH,tagSum,nachtSum,sonntagSum,feiertagSum,sub,totalHours,manHours,vatRate,vatAmount,grand};
    }

    function collectFormOnly(){
      const fields = [
        "issuerCompany","issuerAddress","issuerPhone","issuerEmail","issuerTaxNo","issuerVatId","issuerLegalForm","issuerRegister","issuerCourt",
        "issuerIban","issuerBic","issuerHolder",
        "custName","custEmail","custContact","custAddress","custVatId",
        "invDate","payDays","dueDate","invNo","purpose",
        "vatMode","reverseCharge","b2bMode",
        "serviceTitle","objekt","zeitraum","leistungsdatum",
        "mitarbeiter","tagPreis",
        "shiftStart","shiftEnd","nachtRule",
        "tagH","nachtH","sonntagH","feiertagH",
        "nachtFest","sonntagFest","feiertagFest",
        "paymentTermsText","dunningText","note","internalNote","rechnungText","footerExtra"
      ];
      const form = {};
      for(const id of fields){ if($(id)) form[id] = $(id).value; }
      return form;
    }

    function calculate(){
      updateVatHint();
      updatePurpose();
      syncTopBrand();
      syncPills();

      const b2bOn = $("b2bMode").value === "on";
      document.querySelectorAll(".rowDetail").forEach(r => r.style.display = b2bOn ? "none" : "");
      $("rowB2B").style.display = b2bOn ? "" : "none";
      $("modePill").textContent = "MODE: FEST";

      const form = collectFormOnly();
      const c = computeAll(form);

      $("t_tagStd").textContent = String(c.tagH);
      $("t_nachtStd").textContent = String(c.nachtH);
      $("t_sonntagStd").textContent = String(c.sonntagH);
      $("t_feiertagStd").textContent = String(c.feiertagH);

      $("t_tagPreis").textContent = fmtEUR(c.tagPreis);
      $("t_nachtPreis").textContent = fmtEUR(c.nachtPreis);
      $("t_sonntagPreis").textContent = fmtEUR(c.sonntagPreis);
      $("t_feiertagPreis").textContent = fmtEUR(c.feiertagPreis);

      $("t_tagSum").textContent = fmtEUR(c.tagSum);
      $("t_nachtSum").textContent = fmtEUR(c.nachtSum);
      $("t_sonntagSum").textContent = fmtEUR(c.sonntagSum);
      $("t_feiertagSum").textContent = fmtEUR(c.feiertagSum);

      $("b2bStd").textContent = String(c.manHours.toFixed(2)) + " Std";
      $("b2bPreis").textContent = "Pauschale";
      $("b2bSum").textContent = fmtEUR(c.sub);

      $("subTotal").textContent = fmtEUR(c.sub);
      $("grandTotal").textContent = fmtEUR(c.grand);

      const nightText = ($("nachtRule").value==="23-06") ? "23:00 â€“ 06:00" : (($("nachtRule").value==="20-06") ? "20:00 â€“ 06:00" : "22:00 â€“ 06:00");
      const obj = String($("objekt").value||"").trim();
      const zr = String($("zeitraum").value||"").trim();
      const ld = String($("leistungsdatum").value||"").trim();
      const note = String($("note").value||"").trim();

      const rc = $("reverseCharge").value === "on";
      const vatLine = rc
        ? "Steuerschuldnerschaft des LeistungsempfÃ¤ngers (Reverse Charge). Umsatzsteuer wird nicht berechnet."
        : (($("vatMode").value==="kmu")
            ? "GemÃ¤ÃŸ Â§19 UStG wird keine Umsatzsteuer berechnet."
            : `Umsatzsteuer 19%: ${fmtEUR(c.vatAmount)} (in Gesamtbetrag enthalten).`);

      const payTxt = String($("paymentTermsText").value||"").trim();
      const dunTxt = String($("dunningText").value||"").trim();

      if(b2bOn){
        $("rechnungText").value = [
          `${$("serviceTitle").value} â€” B2B Abrechnung`,
          obj ? `Objekt/Ort: ${obj}` : "",
          zr ? `Zeitraum: ${zr}` : "",
          ld ? `Leistungsdatum: ${ld}` : "",
          `Einsatz mit ${c.m} Mitarbeitern.`,
          `Abrechnung als Pauschale (All-in). Einsatznachweis als Anlage.`,
          `Mitarbeiterstunden gesamt: ${c.manHours.toFixed(2)} Std`,
          `Zwischensumme (netto): ${fmtEUR(c.sub)}`,
          vatLine,
          `Gesamtbetrag: ${fmtEUR(c.grand)}`,
          `Nachtzeit laut Vereinbarung: ${nightText}`,
          payTxt ? `Zahlungsbedingungen: ${payTxt}` : "",
          dunTxt ? `Verzug/Mahnung: ${dunTxt}` : "",
          note ? `Hinweis: ${note}` : ""
        ].filter(Boolean).join("\n");
      }else{
        $("rechnungText").value = [
          `${$("serviceTitle").value} â€” Detailabrechnung`,
          obj ? `Objekt/Ort: ${obj}` : "",
          zr ? `Zeitraum: ${zr}` : "",
          ld ? `Leistungsdatum: ${ld}` : "",
          `Einsatz mit ${c.m} Mitarbeitern.`,
          `Zwischensumme (netto): ${fmtEUR(c.sub)}`,
          vatLine,
          `Gesamtbetrag: ${fmtEUR(c.grand)}`,
          `Nachtzeit laut Vereinbarung: ${nightText}`,
          payTxt ? `Zahlungsbedingungen: ${payTxt}` : "",
          dunTxt ? `Verzug/Mahnung: ${dunTxt}` : "",
          note ? `Hinweis: ${note}` : ""
        ].filter(Boolean).join("\n");
      }

      autoSave();
    }

    function validateCore(){
      const must = [
        ["issuerCompany","Firmenname"],
        ["issuerAddress","Adresse"],
        ["issuerEmail","E-Mail"],
        ["issuerTaxNo","Steuernummer/Hinweis"],
        ["issuerIban","IBAN"],
        ["issuerBic","BIC"],
        ["issuerHolder","Kontoinhaber"],
        ["custName","Kundenname"],
        ["custAddress","Kundendaten"],
        ["invDate","Rechnungsdatum"],
        ["dueDate","FÃ¤llig am"],
        ["invNo","Rechnungsnummer"],
        ["serviceTitle","Leistungsbeschreibung"],
        ["paymentTermsText","Zahlungsbedingungen"]
      ];
      for(const [id,label] of must){
        if(!String($(id).value||"").trim()){
          setStatus(`Fehlt: ${label}`, false);
          return false;
        }
      }
      if($("reverseCharge").value==="on" && !String($("custVatId").value||"").trim()){
        setStatus("Warnung: Reverse Charge ON, aber Kunden USt-IdNr fehlt", false);
      }else{
        setStatus("OK", true);
      }
      return true;
    }

    // ===== Customers =====
    function cryptoRandomId(){
      if(window.crypto?.getRandomValues){
        const a = new Uint32Array(2);
        window.crypto.getRandomValues(a);
        return a[0].toString(16)+a[1].toString(16);
      }
      return String(Date.now()) + Math.random().toString(16).slice(2);
    }

    function renderCustomerList(){
      const wrap = $("custList");
      if(!wrap) return;
      const customers = loadJSON(KEY_CUSTOMERS, []);
      wrap.innerHTML = "";
      customers.forEach(c=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <b>${escapeHtml(c.name||"")}</b>
            <small>${escapeHtml((c.address||"").slice(0,120))}${(c.address||"").length>120?"â€¦":""}</small><br/>
            ${c.vatId ? `<small class="mono">USt-IdNr: ${escapeHtml(c.vatId)}</small>` : `<small class="mono">USt-IdNr: â€”</small>`}
          </div>
          <div class="btns">
            <button type="button" data-id="${escapeAttr(c.id)}">AuswÃ¤hlen</button>
          </div>
        `;
        wrap.appendChild(el);
      });
      wrap.querySelectorAll("button[data-id]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-id");
          $("customerPick").value = id;
          $("customerPick").dispatchEvent(new Event("change"));
          setActiveNav("navCreate","viewCreate");
        });
      });
    }

    function renderCustomers(){
      const customers = loadJSON(KEY_CUSTOMERS, []);
      const sel = $("customerPick");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "â€” auswÃ¤hlen â€”";
      sel.appendChild(opt0);
      for(const c of customers){
        const o = document.createElement("option");
        o.value = c.id;
        o.textContent = c.name;
        sel.appendChild(o);
      }
      $("custCount").textContent = String(customers.length);
      $("navCustCount").textContent = String(customers.length);
      renderCustomerList();
    }

    function saveCustomer(){
      const name = String($("custName").value||"").trim();
      const address = String($("custAddress").value||"").trim();
      if(!name || !address){ setStatus("Kunde: Name/Adresse fehlt", false); return; }
      const customers = loadJSON(KEY_CUSTOMERS, []);
      const id = cryptoRandomId();
      customers.push({
        id,
        name,
        email: String($("custEmail").value||"").trim(),
        contact: String($("custContact").value||"").trim(),
        address,
        vatId: String($("custVatId").value||"").trim()
      });
      saveJSON(KEY_CUSTOMERS, customers);
      renderCustomers();
      $("customerPick").value = id;
      setStatus("Kunde gespeichert", true);
      calculate();
    }

    function loadCustomer(id){
      const customers = loadJSON(KEY_CUSTOMERS, []);
      const c = customers.find(x=>x.id===id);
      if(!c) return;
      $("custName").value = c.name || "";
      $("custEmail").value = c.email || "";
      $("custContact").value = c.contact || "";
      $("custAddress").value = c.address || "";
      $("custVatId").value = c.vatId || "";
      setStatus("Kunde geladen", true);
      calculate();
    }

    function deleteCustomer(){
      const id = $("customerPick").value;
      if(!id){ setStatus("Kein Kunde ausgewÃ¤hlt", false); return; }
      const customers = loadJSON(KEY_CUSTOMERS, []).filter(x=>x.id!==id);
      saveJSON(KEY_CUSTOMERS, customers);
      $("customerPick").value = "";
      renderCustomers();
      setStatus("Kunde gelÃ¶scht", true);
      calculate();
    }

    // ===== Invoices =====
    function collectInvoice(){
      const form = collectFormOnly();
      return {
        invNo: form.invNo,
        invDate: form.invDate,
        custName: form.custName,
        serviceTitle: form.serviceTitle,
        purpose: form.purpose,
        subTotalFmt: $("subTotal").textContent,
        grandTotalFmt: $("grandTotal").textContent,
        logoDataUrl: $("logoImg").src || "",
        form
      };
    }

    function saveInvoice(){
      if(!validateCore()) return;
      const inv = collectInvoice();
      const invoices = loadJSON(KEY_INVOICES, []);
      const idx = invoices.findIndex(x=>x.invNo===inv.invNo);
      if(idx>=0) invoices[idx] = inv; else invoices.unshift(inv);
      saveJSON(KEY_INVOICES, invoices);
      setStatus("Rechnung gespeichert", true);
      renderInvoices();
    }

    function renderInvoices(){
      const invoices = loadJSON(KEY_INVOICES, []);
      $("invCount").textContent = String(invoices.length);
      $("navInvCount").textContent = String(invoices.length);

      const wrap = $("invList");
      wrap.innerHTML = "";
      invoices.forEach(inv=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <b class="mono">${escapeHtml(inv.invNo)}</b>
            <small>${escapeHtml(inv.invDate)} â€¢ ${escapeHtml(inv.custName)} â€¢ ${escapeHtml(inv.serviceTitle)}</small><br/>
            <small class="mono">Gesamt: ${escapeHtml(inv.grandTotalFmt)} â€¢ Zweck: ${escapeHtml(inv.purpose)}</small>
          </div>
          <div class="btns">
            <button type="button" data-act="load" data-no="${escapeAttr(inv.invNo)}">Laden</button>
            <button type="button" data-act="pdf" data-no="${escapeAttr(inv.invNo)}">PDF</button>
            <button type="button" data-act="del" class="danger" data-no="${escapeAttr(inv.invNo)}">LÃ¶schen</button>
          </div>
        `;
        wrap.appendChild(el);
      });

      wrap.querySelectorAll("button").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const act = b.getAttribute("data-act");
          const no = b.getAttribute("data-no");
          if(act==="load") loadInvoice(no);
          if(act==="del") deleteInvoice(no);
          if(act==="pdf"){
            const inv = loadJSON(KEY_INVOICES, []).find(x=>x.invNo===no);
            if(inv) await exportPdfFromInvoice(inv);
          }
        });
      });
    }

    function loadInvoice(invNo){
      const invoices = loadJSON(KEY_INVOICES, []);
      const inv = invoices.find(x=>x.invNo===invNo);
      if(!inv){ setStatus("Rechnung nicht gefunden", false); return; }
      for(const [k,v] of Object.entries(inv.form || {})){ if($(k)) $(k).value = v; }
      if(inv.logoDataUrl) setLogo(inv.logoDataUrl, true);
      setStatus("Rechnung geladen", true);
      calculateDayNight();
      calculate();
      setActiveNav("navCreate","viewCreate");
    }

    function deleteInvoice(invNo){
      const invoices = loadJSON(KEY_INVOICES, []).filter(x=>x.invNo!==invNo);
      saveJSON(KEY_INVOICES, invoices);
      setStatus("Rechnung gelÃ¶scht", true);
      renderInvoices();
    }

    // ===== Auto Save =====
    let autoSaveTimer = null;
    function autoSave(){
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(()=>{
        saveJSON(KEY_APP, collectFormOnly());
      }, 250);
    }
    function restoreAutoSave(){
      const state = loadJSON(KEY_APP, null);
      if(!state) return;
      for(const [k,v] of Object.entries(state)){
        if($(k)) $(k).value = v;
      }
    }

    // ===== Nav =====
    function setActiveNav(btnId, viewId){
      ["navCreate","navInvoices","navCustomers","navSettings"].forEach(id=>{
        const b = $(id); if(b) b.classList.toggle("active", id===btnId);
      });
      ["viewCreate","viewInvoices","viewCustomers","viewSettings"].forEach(id=>{
        const v = $(id); if(v) v.classList.toggle("active", id===viewId);
      });
    }

    function syncCompanyMirror(){
      const main = $("issuerCompany");
      const mir = $("issuerCompanyMirror");
      if(!main || !mir) return;
      mir.value = main.value || "";
      mir.oninput = ()=>{
        main.value = mir.value;
        calculate();
      };
    }

    // ===== PDF helpers =====
    function waitImagesLoaded(root){
      const imgs = Array.from(root.querySelectorAll("img")).filter(i=>i.src);
      return Promise.all(imgs.map(img => new Promise(res=>{
        if(img.complete) return res();
        img.onload = ()=>res();
        img.onerror = ()=>res();
      })));
    }

    // Build two-page HTML
    function buildPrintHtml(inv){
      const f = inv.form;
      const company = String(f.issuerCompany || "Masculine Security").trim();
      const b2bOn = String(f.b2bMode||"on") === "on";
      const rc = String(f.reverseCharge||"off") === "on";

      const c = computeAll(f);

      const logoSrc = inv.logoDataUrl || $("logoImg").src || "";
      const logo = logoSrc ? `<div class="invLogo"><img src="${escapeAttr(logoSrc)}"/></div>` : "";

      const obj = String(f.objekt||"").trim();
      const zr = String(f.zeitraum||"").trim();
      const ld = String(f.leistungsdatum||"").trim();
      const note = String(f.note||"").trim();
      const footerExtra = String(f.footerExtra||"").trim();

      const nightText = f.nachtRule==="23-06" ? "23:00 â€“ 06:00" : (f.nachtRule==="20-06" ? "20:00 â€“ 06:00" : "22:00 â€“ 06:00");

      const vatLine = rc
        ? "Steuerschuldnerschaft des LeistungsempfÃ¤ngers (Reverse Charge). Umsatzsteuer wird nicht berechnet."
        : (f.vatMode==="kmu"
            ? "GemÃ¤ÃŸ Â§19 UStG wird keine Umsatzsteuer berechnet."
            : `Umsatzsteuer 19%: ${fmtEUR(c.vatAmount)} (in Gesamtbetrag enthalten).`);

      const payTxt = String(f.paymentTermsText||"").trim();
      const dunTxt = String(f.dunningText||"").trim();

      const header = `
        <div class="invHead">
          <div class="invLeft">
            ${logo}
            <div>
              <p class="invTitle">Rechnung</p>
              <div class="invBrand">${escapeHtml(company)}${String(f.issuerLegalForm||"").trim()?` â€¢ ${escapeHtml(f.issuerLegalForm)}`:""}</div>
              <div class="invMeta"><b>${escapeHtml(f.serviceTitle||"")}</b></div>
              ${obj ? `<div class="invMeta">Objekt/Ort: ${escapeHtml(obj)}</div>` : ``}
              ${zr ? `<div class="invMeta">Zeitraum: ${escapeHtml(zr)}</div>` : ``}
              ${ld ? `<div class="invMeta">Leistungsdatum: ${escapeHtml(ld)}</div>` : ``}
            </div>
          </div>

          <div class="metaBox">
            <div class="metaLine"><span class="k">Rechnungsnr.</span><span class="v">${escapeHtml(f.invNo||"")}</span></div>
            <div class="metaLine"><span class="k">Datum</span><span>${escapeHtml(f.invDate||"")}</span></div>
            <div class="metaLine"><span class="k">FÃ¤llig</span><span>${escapeHtml(f.dueDate||"")}</span></div>
            <div class="metaLine"><span class="k">Zweck</span><span class="v">${escapeHtml(f.purpose||"")}</span></div>
          </div>
        </div>
      `;

      const parties = `
        <div class="cols2">
          <div class="boxPrint">
            <h4>Rechnungssteller</h4>
            <div class="l"><b>${escapeHtml(company)}</b></div>
            <div class="l">${escapeHtml(f.issuerAddress||"")}</div>
            <div class="l">Tel: ${escapeHtml(f.issuerPhone||"")}</div>
            <div class="l">E-Mail: ${escapeHtml(f.issuerEmail||"")}</div>
            <div class="l">Steuernr./Hinweis: ${escapeHtml(f.issuerTaxNo||"")}</div>
            ${String(f.issuerVatId||"").trim() ? `<div class="l">USt-IdNr: ${escapeHtml(f.issuerVatId||"")}</div>` : ``}
            ${String(f.issuerRegister||"").trim() ? `<div class="l">Register: ${escapeHtml(f.issuerRegister||"")}</div>` : ``}
          </div>

          <div class="boxPrint">
            <h4>Rechnung an</h4>
            <div class="l"><b>${escapeHtml(f.custName||"")}</b></div>
            <div class="l">${escapeHtml(f.custAddress||"").replaceAll("\n","<br/>")}</div>
            ${String(f.custEmail||"").trim() ? `<div class="l">E-Mail: ${escapeHtml(f.custEmail||"")}</div>` : ``}
            ${String(f.custContact||"").trim() ? `<div class="l">Ansprechpartner: ${escapeHtml(f.custContact||"")}</div>` : ``}
            ${String(f.custVatId||"").trim() ? `<div class="l">USt-IdNr Kunde: ${escapeHtml(f.custVatId||"")}</div>` : ``}
          </div>
        </div>
      `;

      const oneLine = `
        <table class="invTable">
          <thead>
            <tr>
              <th>Position</th>
              <th class="invRight">Menge</th>
              <th class="invRight">Einzelpreis</th>
              <th class="invRight">Betrag</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Sicherheitsdienstleistung (Pauschale, All-in) <br/><span style="font-size:11px">Einsatznachweis als Anlage</span></td>
              <td class="invRight">${c.manHours.toFixed(2)} Std</td>
              <td class="invRight">Pauschale</td>
              <td class="invRight">${fmtEUR(c.sub)}</td>
            </tr>
          </tbody>
        </table>
        <div class="mutedSmall">Nachtzeit laut Vereinbarung: ${escapeHtml(nightText)} â€¢ Einsatz: ${c.m} Mitarbeiter</div>
      `;

      const detailTable = `
        <table class="invTable">
          <thead>
            <tr>
              <th>Position</th>
              <th class="invRight">Mitarbeiter</th>
              <th class="invRight">Std.</th>
              <th class="invRight">Preis/Std.</th>
              <th class="invRight">Summe</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Tagdienst</td>
              <td class="invRight">${c.m}</td>
              <td class="invRight">${c.tagH}</td>
              <td class="invRight">${fmtEUR(c.tagPreis)}</td>
              <td class="invRight">${fmtEUR(c.tagSum)}</td>
            </tr>
            <tr>
              <td>Nachtdienst</td>
              <td class="invRight">${c.m}</td>
              <td class="invRight">${c.nachtH}</td>
              <td class="invRight">${fmtEUR(c.nachtPreis)}</td>
              <td class="invRight">${fmtEUR(c.nachtSum)}</td>
            </tr>
            <tr>
              <td>Sonntag</td>
              <td class="invRight">${c.m}</td>
              <td class="invRight">${c.sonntagH}</td>
              <td class="invRight">${fmtEUR(c.sonntagPreis)}</td>
              <td class="invRight">${fmtEUR(c.sonntagSum)}</td>
            </tr>
            <tr>
              <td>Feiertag</td>
              <td class="invRight">${c.m}</td>
              <td class="invRight">${c.feiertagH}</td>
              <td class="invRight">${fmtEUR(c.feiertagPreis)}</td>
              <td class="invRight">${fmtEUR(c.feiertagSum)}</td>
            </tr>
          </tbody>
        </table>
        <div class="mutedSmall">Keine DoppelzÃ¤hlung: Stunden nur in eine Kategorie.</div>
      `;

      const totals = `
        <div class="totals">
          <div class="tline"><span>Zwischensumme (netto)</span><span>${fmtEUR(c.sub)}</span></div>
          ${c.vatRate>0 ? `<div class="tline"><span>USt 19%</span><span>${fmtEUR(c.vatAmount)}</span></div>` : ``}
          <div class="tline grand"><span>Gesamtbetrag</span><span>${fmtEUR(c.grand)}</span></div>
        </div>
      `;

      const footer = `
        <div class="footer">
          <div><b>Zahlungsbedingungen:</b> ${escapeHtml(payTxt||"")}</div>
          ${dunTxt ? `<div><b>Verzug/Mahnung:</b> ${escapeHtml(dunTxt)}</div>` : ``}
          <div style="margin-top:6px">${escapeHtml(vatLine)}</div>
          ${note ? `<div style="margin-top:6px"><b>Hinweis:</b> ${escapeHtml(note)}</div>` : ``}
          ${footerExtra ? `<div style="margin-top:6px">${escapeHtml(footerExtra)}</div>` : ``}
          <div style="margin-top:10px">
            <b>Bankverbindung:</b> IBAN ${escapeHtml(f.issuerIban||"")} â€¢ BIC ${escapeHtml(f.issuerBic||"")} â€¢ Inhaber ${escapeHtml(f.issuerHolder||"")}
          </div>
          ${String(f.issuerCourt||"").trim() ? `<div style="margin-top:6px">Gerichtsstand: ${escapeHtml(f.issuerCourt||"")}</div>` : ``}
        </div>
      `;

      const page1 = `${header}${parties}${b2bOn ? oneLine : detailTable}${totals}${footer}`;

      if(!b2bOn) return page1;

      const annex = `
        <div style="page-break-before: always;"></div>
        <div class="invHead">
          <div class="invLeft">
            ${logo}
            <div>
              <p class="invTitle" style="font-size:20px">Anlage: Einsatznachweis</p>
              <div class="invBrand">${escapeHtml(company)}</div>
              <div class="invMeta">zu Rechnung ${escapeHtml(f.invNo||"")}</div>
              <div class="invMeta">${escapeHtml(f.serviceTitle||"")}</div>
              ${obj ? `<div class="invMeta">Objekt/Ort: ${escapeHtml(obj)}</div>` : ``}
              ${zr ? `<div class="invMeta">Zeitraum: ${escapeHtml(zr)}</div>` : ``}
              ${ld ? `<div class="invMeta">Leistungsdatum: ${escapeHtml(ld)}</div>` : ``}
            </div>
          </div>
          <div class="metaBox">
            <div class="metaLine"><span class="k">Mitarbeiter</span><span class="v">${c.m}</span></div>
            <div class="metaLine"><span class="k">Nachtzeit</span><span>${escapeHtml(nightText)}</span></div>
            <div class="metaLine"><span class="k">Std gesamt</span><span class="v">${c.manHours.toFixed(2)}</span></div>
            <div class="metaLine"><span class="k">Netto</span><span class="v">${fmtEUR(c.sub)}</span></div>
          </div>
        </div>

        <div class="annexTitle">DetailÃ¼bersicht (Einsatzzeiten & Zuschlagskategorien)</div>
        ${detailTable}

        <div class="footer">
          <div><b>Hinweis:</b> Diese Anlage dient als Nachweis der Einsatzzeiten.</div>
          <div style="margin-top:10px">Unterschrift Kunde (optional): _____________________________</div>
          <div style="margin-top:8px">Ort/Datum: _____________________________</div>
        </div>
      `;
      return page1 + annex;
    }

    async function exportPdf(){
      if(!validateCore()) return;
      const inv = collectInvoice();
      await exportPdfFromInvoice(inv);
    }

    async function exportPdfFromInvoice(inv){
      const root = $("printA4");
      root.innerHTML = buildPrintHtml(inv);
      $("printWrap").style.display = "block";
      await waitImagesLoaded(root);

      const canvas = await html2canvas(root, {scale:2, useCORS:true, backgroundColor:"#ffffff"});
      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;

      const pdf = new jsPDF("p","mm","a4");
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const imgProps = pdf.getImageProperties(imgData);
      const imgW = pageW;
      const imgH = (imgProps.height * imgW) / imgProps.width;

      if(imgH <= pageH){
        pdf.addImage(imgData, "PNG", 0, 0, imgW, imgH);
      }else{
        let y = 0;
        let remaining = imgH;
        while(remaining > 0){
          pdf.addImage(imgData, "PNG", 0, y ? -y : 0, imgW, imgH);
          remaining -= pageH;
          if(remaining > 0) pdf.addPage();
          y += pageH;
        }
      }

      pdf.save(`${inv.invNo}.pdf`);
      $("printWrap").style.display = "none";
      setStatus("PDF gespeichert", true);
    }

    async function doPrint(){
      if(!validateCore()) return;
      const inv = collectInvoice();
      $("printA4").innerHTML = buildPrintHtml(inv);
      $("printWrap").style.display = "block";
      await waitImagesLoaded($("printA4"));
      window.print();
      $("printWrap").style.display = "none";
    }

    // ===== Backup / Export =====
    function downloadText(filename, text, mime="application/json"){
      const blob = new Blob([text], {type:mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function buildBackup(){
      return {
        version: "MS-B2B-100-v1",
        exportedAt: new Date().toISOString(),
        data: {
          app: loadJSON(KEY_APP, null),
          customers: loadJSON(KEY_CUSTOMERS, []),
          invoices: loadJSON(KEY_INVOICES, []),
          counters: loadJSON(KEY_COUNTERS, {}),
          logo: localStorage.getItem(KEY_LOGO) || ""
        }
      };
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        setStatus("Backup in Clipboard kopiert", true);
      }catch(e){
        setStatus("Clipboard nicht erlaubt. Nutze Download.", false);
      }
    }

    function exportBackup(){
      const b = buildBackup();
      downloadText(`ms_backup_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(b, null, 2));
      setStatus("Backup heruntergeladen", true);
    }

    function exportInvoices(){
      const invoices = loadJSON(KEY_INVOICES, []);
      downloadText(`ms_invoices_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(invoices, null, 2));
      setStatus("Rechnungen exportiert", true);
    }

    function exportCustomers(){
      const customers = loadJSON(KEY_CUSTOMERS, []);
      downloadText(`ms_customers_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(customers, null, 2));
      setStatus("Kunden exportiert", true);
    }

    function importBackupFromObject(obj){
      try{
        if(!obj || !obj.data) throw new Error("UngÃ¼ltiges Backup");
        const d = obj.data;

        if(d.app) saveJSON(KEY_APP, d.app);
        if(d.customers) saveJSON(KEY_CUSTOMERS, d.customers);
        if(d.invoices) saveJSON(KEY_INVOICES, d.invoices);
        if(d.counters) saveJSON(KEY_COUNTERS, d.counters);
        if(typeof d.logo === "string" && d.logo) localStorage.setItem(KEY_LOGO, d.logo);

        setStatus("Backup importiert (Reload)", true);
        setTimeout(()=>location.reload(), 300);
      }catch(e){
        setStatus("Backup Import fehlgeschlagen", false);
      }
    }

    function wipeAllData(){
      localStorage.removeItem(KEY_APP);
      localStorage.removeItem(KEY_CUSTOMERS);
      localStorage.removeItem(KEY_INVOICES);
      localStorage.removeItem(KEY_COUNTERS);
      localStorage.removeItem(KEY_LOGO);
      setStatus("Alle Daten gelÃ¶scht (Reload)", true);
      setTimeout(()=>location.reload(), 300);
    }

    // ===== Actions =====
    function resetAll(){
      localStorage.removeItem(KEY_APP);
      setStatus("Form reset (Reload)", true);
      setTimeout(()=>location.reload(), 300);
    }

    function newInvoice(){
      const keep = [
        "issuerCompany","issuerAddress","issuerPhone","issuerEmail","issuerTaxNo","issuerVatId","issuerLegalForm","issuerRegister","issuerCourt",
        "issuerIban","issuerBic","issuerHolder",
        "custName","custEmail","custContact","custAddress","custVatId","customerPick",
        "vatMode","reverseCharge","b2bMode",
        "serviceTitle","objekt","zeitraum","leistungsdatum",
        "mitarbeiter","tagPreis",
        "nachtFest","sonntagFest","feiertagFest",
        "nachtRule",
        "payDays","paymentTermsText","dunningText","footerExtra"
      ];
      const snapshot = {};
      keep.forEach(id=>{ if($(id)) snapshot[id] = $(id).value; });

      document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.id==="logoFile" || el.id==="backupFile") return;
        if(el.type==="date") return;
        el.value = "";
      });

      Object.entries(snapshot).forEach(([id,val])=>{ if($(id)) $(id).value = val; });

      $("invDate").value = todayISO();
      syncDueDateFromPayDays();
      $("invNo").value = nextInvoiceNo($("invDate").value);

      $("shiftStart").value = "18:00";
      $("shiftEnd").value = "06:00";
      calculateDayNight();

      $("sonntagH").value = 0;
      $("feiertagH").value = 0;
      $("note").value = "";
      $("internalNote").value = "";
      $("rechnungText").value = "";

      setStatus("Neue Rechnung", true);
      calculate();
    }

    // ===== Wire =====
    function wireSidebar(){
      $("navCreate")?.addEventListener("click", ()=> setActiveNav("navCreate","viewCreate"));
      $("navInvoices")?.addEventListener("click", ()=>{
        setActiveNav("navInvoices","viewInvoices");
        renderInvoices();
      });
      $("navCustomers")?.addEventListener("click", ()=>{
        setActiveNav("navCustomers","viewCustomers");
        renderCustomerList();
      });
      $("navSettings")?.addEventListener("click", ()=>{
        setActiveNav("navSettings","viewSettings");
        syncCompanyMirror();
      });
      $("btnLogo2")?.addEventListener("click", ()=> $("logoFile")?.click());
    }

    function wire(){
      // Make sure links never navigate to "#" without data
      $("btnCallLink").addEventListener("click", (e)=>{
        const tel = String($("issuerPhone").value||"").replace(/\s+/g,"");
        if(!tel){ e.preventDefault(); setStatus("Telefon fehlt", false); }
      });
      $("btnMailLink").addEventListener("click", (e)=>{
        const mail = String($("issuerEmail").value||"").trim();
        if(!mail){ e.preventDefault(); setStatus("E-Mail fehlt", false); }
      });

      // Logo
      $("btnLogo").addEventListener("click", ()=> $("logoFile").click());
      $("logoFile").addEventListener("change", (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        const rd = new FileReader();
        rd.onload = ()=> { setLogo(String(rd.result||""), true); setStatus("Logo gespeichert", true); };
        rd.readAsDataURL(file);
      });

      // Header actions
      $("btnPdf").addEventListener("click", exportPdf);
      $("btnPrint").addEventListener("click", doPrint);
      $("btnReset").addEventListener("click", resetAll);
      $("btnNew").addEventListener("click", newInvoice);
      $("btnSave").addEventListener("click", saveInvoice);
      $("btnList").addEventListener("click", ()=>{
        setActiveNav("navInvoices","viewInvoices");
        renderInvoices();
      });

      // Customers
      $("btnSaveCustomer").addEventListener("click", saveCustomer);
      $("btnDeleteCustomer").addEventListener("click", deleteCustomer);
      $("customerPick").addEventListener("change", (e)=> loadCustomer(e.target.value));

      // Dates
      $("invDate").addEventListener("change", ()=>{
        syncDueDateFromPayDays();
        $("invNo").value = nextInvoiceNo($("invDate").value);
        calculate();
      });
      $("payDays").addEventListener("input", ()=>{
        syncDueDateFromPayDays();
        const d = Math.max(0, Math.floor(safeNum($("payDays").value)));
        $("paymentTermsText").value = `Zahlbar innerhalb von ${d} Tagen ohne Abzug.`;
        calculate();
      });

      // Reverse Charge effects
      $("reverseCharge").addEventListener("change", ()=>{
        if($("reverseCharge").value==="on"){
          $("vatMode").value = "kmu";
        }
        calculate();
      });

      // Auto day/night
      $("shiftStart").addEventListener("input", ()=>{ calculateDayNight(); calculate(); });
      $("shiftEnd").addEventListener("input", ()=>{ calculateDayNight(); calculate(); });
      $("nachtRule").addEventListener("change", ()=>{ calculateDayNight(); calculate(); });

      // Inputs trigger calc + clickable update
      ["issuerPhone","issuerEmail","issuerCompany"].forEach(id=>{
        $(id).addEventListener("input", ()=>{ syncTopBrand(); calculate(); });
      });

      document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.id==="logoFile" || el.id==="backupFile") return;
        if(el.id==="shiftStart" || el.id==="shiftEnd" || el.id==="nachtRule") return;
        if(el.id==="invDate" || el.id==="payDays" || el.id==="reverseCharge") return;
        el.addEventListener("input", calculate);
        el.addEventListener("change", calculate);
      });

      // Settings: backup/export
      $("btnExportBackup").addEventListener("click", exportBackup);
      $("btnCopyBackup").addEventListener("click", async ()=> copyToClipboard(JSON.stringify(buildBackup(), null, 2)));
      $("btnImportBackup").addEventListener("click", ()=> $("backupFile").click());
      $("backupFile").addEventListener("change", (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        const rd = new FileReader();
        rd.onload = ()=>{
          try{
            const obj = JSON.parse(String(rd.result||"{}"));
            importBackupFromObject(obj);
          }catch(err){
            setStatus("Backup Datei ungÃ¼ltig", false);
          }
        };
        rd.readAsText(file);
      });

      $("btnWipeData").addEventListener("click", wipeAllData);
      $("btnExportInvoices").addEventListener("click", exportInvoices);
      $("btnExportCustomers").addEventListener("click", exportCustomers);

      wireSidebar();
    }

    function initDefaults(){
      $("b2bMode").value = $("b2bMode").value || "on";
      $("payDays").value = String(Math.max(0, Math.floor(safeNum($("payDays").value || 14)))) || "14";

      $("invDate").value = $("invDate").value || todayISO();
      syncDueDateFromPayDays();
      $("invNo").value = $("invNo").value || nextInvoiceNo($("invDate").value);

      if(!String($("paymentTermsText").value||"").trim()){
        const d = Math.max(0, Math.floor(safeNum($("payDays").value)));
        $("paymentTermsText").value = `Zahlbar innerhalb von ${d} Tagen ohne Abzug.`;
      }

      renderCustomers();
      renderInvoices();
      syncCompanyMirror();
      setStatus("Bereit", true);

      calculateDayNight();
      syncTopBrand();        // âœ… sets hrefs
      calculate();
    }

    // ===== Boot =====
    window.addEventListener("load", ()=>{
      loadLogo();
      restoreAutoSave();
      wire();
      initDefaults();
    });
  </script>
</body>
</html>
