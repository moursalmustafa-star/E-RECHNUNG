<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Masculine Security — Rechnung (Pro · Auto · Archiv + PDF)</title>

<style>
:root{
  --ink:#0b1220;
  --muted:#4b5563;
  --line:#e5e7eb;
  --panel:#ffffff;
  --bg:#f7f9fc;
  --accent:#1e4ed8;
  --accent2:#0ea5e9;
  --soft:#f1f5ff;
  --radius:14px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.topbar{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  border-radius:18px;
  padding:14px;
  color:#fff;
  box-shadow:0 10px 24px rgba(2,6,23,.12);
}
.brandRow{display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
.brandLeft{display:flex;align-items:center;gap:12px}
.logoBox{width:46px;height:46px;border-radius:12px;background:#fff;display:grid;place-items:center;overflow:hidden}
.logoBox img{width:100%;height:100%;object-fit:cover;display:block}
.h1{font-weight:900;font-size:18px;line-height:1.2}
.sub{opacity:.9;font-size:12px;margin-top:2px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{
  border:1px solid rgba(255,255,255,.35);
  background:rgba(255,255,255,.12);
  color:#fff;
  padding:9px 12px;
  border-radius:12px;
  font-weight:900;
  font-size:13px;
  cursor:pointer;
  backdrop-filter: blur(6px);
}
.btn.white{background:#fff;color:var(--ink);border-color:#fff}
.btn.white:hover{background:#f7f7f7}
.btn:hover{filter:brightness(1.05)}
.main{margin-top:12px;display:grid;grid-template-columns:1.05fr .95fr;gap:12px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:12px}
.title{font-size:12px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px}
label{display:block;font-size:12px;font-weight:900;color:var(--ink);margin-top:10px}
input,select,textarea{
  width:100%;padding:10px 11px;border:1px solid var(--line);
  border-radius:12px;font-size:14px;background:#fff;outline:none
}
textarea{min-height:78px;resize:vertical}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.small{font-size:12px;color:var(--muted);line-height:1.45}
a{color:inherit}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
.pill{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--soft);border:1px solid #dbeafe;color:#0b3aa6;
  border-radius:999px;padding:6px 10px;font-size:12px;font-weight:900
}
.tableWrap{margin-top:12px;background:#fff;border:1px solid var(--line);border-radius:var(--radius);overflow:hidden}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:13.5px}
th{background:#f8fafc;color:#334155;font-size:12px;text-transform:uppercase;letter-spacing:.06em}
td.right,th.right{text-align:right}
.kpiRow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
.kpi{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff}
.kpi .k{font-size:12px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.08em}
.kpi .v{margin-top:6px;font-weight:900;font-size:18px}
.sumBox{margin-top:12px;background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:12px}
.sumRow{display:flex;justify-content:space-between;gap:10px;padding:6px 0}
.sumRow span{color:var(--muted);font-weight:900}
.sumRow b{font-weight:900}
.sumRow.total{border-top:1px dashed #cbd5e1;margin-top:8px;padding-top:10px;font-size:16px}
.badge{font-weight:900;font-size:12px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff}
.rowBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.btn2{border:1px solid var(--line);background:#fff;color:var(--ink);padding:9px 12px;border-radius:12px;font-weight:900;font-size:13px;cursor:pointer}
.btn2.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn2:hover{filter:brightness(1.02)}
.shiftHead{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.toggle{display:flex;align-items:center;gap:8px}
.toggle input{width:18px;height:18px}
.shiftTableWrap{margin-top:10px;border:1px solid var(--line);border-radius:14px;overflow:auto;background:#fff}
.shiftTable{min-width:980px}
.shiftTable th, .shiftTable td{border-bottom:1px solid #eef2f7}
.shiftTable input{border-radius:10px;padding:8px 9px;font-size:13px}
.miniBtn{padding:7px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:900}
.miniBtn.danger{border-color:#fecaca;color:#b91c1c;background:#fff5f5}
.noteBox{margin-top:10px;background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px}
.printOnly{display:none}
.callout{
  margin-top:10px;
  background:#eff6ff;
  border:1px solid #bfdbfe;
  color:#0b3aa6;
  border-radius:14px;
  padding:10px;
  font-size:12px;
  line-height:1.5;
  font-weight:900;
}

/* Drawer (Archiv) */
.drawer{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(2,6,23,.45);z-index:9999;padding:14px}
.drawer.open{display:flex}
.drawerPanel{
  width:min(920px,100%);background:#fff;border:1px solid var(--line);
  border-radius:18px;box-shadow:0 30px 80px rgba(2,6,23,.35);overflow:hidden;
}
.drawerHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;background:linear-gradient(90deg,#0b2a5a,#0ea5e9);color:#fff}
.drawerHead b{font-size:14px}
.drawerBody{padding:12px 14px;max-height:70vh;overflow:auto}
.archRow{
  display:grid;grid-template-columns:1.2fr .8fr .6fr auto;gap:10px;align-items:center;
  border:1px solid var(--line);border-radius:14px;padding:10px;margin-bottom:10px;background:#fff;
}
.archRow .meta{font-size:12px;color:var(--muted)}
.archBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.sep{height:1px;background:#eef2f7;margin:10px 0}

@page{size:A4;margin:10mm}
@media (max-width:980px){.main{grid-template-columns:1fr}}
@media print{
  body{background:#fff}
  .wrap{padding:0}
  .topbar,.rowBtns,.miniBtn,.shiftHead .toggle,.noteBox,.drawer,.callout{display:none !important}
  .printOnly{display:block}
  input,select,textarea{border:none !important;padding:0 !important}
  textarea{min-height:0 !important}
  .card,.tableWrap,.sumBox{box-shadow:none !important}
}
</style>
</head>

<body>
<div class="wrap" id="app">
  <div class="topbar">
    <div class="brandRow">
      <div class="brandLeft">
        <div class="logoBox"><img id="logoImg" src="logo.png" alt="Logo"></div>
        <div>
          <div class="h1">Masculine Security — Rechnung</div>
          <div class="sub">Pro Style · Auto Kundenliste · Auto Rechnungsnummer · Auto Zuschläge (Schichten) · Rechnung-Archiv · PDF</div>
        </div>
      </div>
      <div class="actions">
        <label class="btn" style="margin:0">
          Logo ändern <input id="logoFile" type="file" accept="image/*" style="display:none">
        </label>
        <button class="btn white" id="btnNew" type="button">Neu</button>
        <button class="btn white" id="btnSave" type="button">Rechnung speichern</button>
        <button class="btn white" id="btnArchive" type="button">Rechnungen</button>
        <button class="btn white" id="btnReset" type="button">Reset</button>
        <button class="btn" id="btnPdf" type="button">PDF speichern</button>
      </div>
    </div>
  </div>

  <div class="printOnly" style="margin:12px 0 8px 0;">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="logoBox" style="border:1px solid #ddd"><img id="logoImg2" src="logo.png" alt="Logo"></div>
      <div>
        <div style="font-weight:900;font-size:16px">Masculine Security — Rechnung</div>
        <div class="small">Automatisch · Zuschläge · USt · Kundenliste · Archiv</div>
      </div>
    </div>
  </div>

  <div class="main">
    <!-- LEFT -->
    <div class="card">
      <div class="title">Rechnungssteller & Kunde</div>

      <div style="font-size:14px;line-height:1.5">
        <b>Masculine Security</b><br>
        Werschenregerstraße 6 · 28237 Bremen<br>
        Tel: <a href="tel:+4915778697052">015778697052</a> ·
        E-Mail: <a href="mailto:Kontakt.mass.bremen@hotmail.com">Kontakt.mass.bremen@hotmail.com</a><br>
        <span class="small">Steuernummer: (in Bearbeitung)</span>
      </div>

      <label>Kunde (Auswahl)</label>
      <div class="grid2" style="grid-template-columns:1fr auto">
        <select id="kundeSelect"></select>
        <button class="btn2" id="btnKundeNew" type="button">Neu</button>
      </div>

      <div class="grid2">
        <div>
          <label>Kundenname (zum Speichern)</label>
          <input id="kundeName" placeholder="Firma / Name">
        </div>
        <div>
          <label>E-Mail (optional)</label>
          <input id="kundeEmail" placeholder="kunde@example.com">
        </div>
      </div>

      <label>Kundendaten</label>
      <textarea id="kundeText" placeholder="Firma / Name&#10;Straße Hausnr.&#10;PLZ Ort&#10;Ansprechpartner (optional)"></textarea>

      <div class="rowBtns">
        <button class="btn2" id="btnKundeSave" type="button">Kunde speichern</button>
        <button class="btn2" id="btnKundeDelete" type="button">Kunde löschen</button>
      </div>

      <hr>

      <div class="grid2">
        <div>
          <label>Einsatzort / Objekt</label>
          <input id="objekt" placeholder="z.B. Hotel / Baustelle / Adresse">
        </div>
        <div>
          <label>Leistungszeitraum</label>
          <input id="zeitraum" placeholder="z.B. 01.02.2026 – 15.02.2026">
        </div>
      </div>

      <label>Leistungsbeschreibung</label>
      <textarea id="leistung">Security Dienstleistung</textarea>

      <label>Referenz / PO (optional)</label>
      <input id="ref" placeholder="z.B. Auftrag-Nr. / Ansprechpartner">
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="shiftHead">
        <div>
          <div class="title" style="margin-bottom:6px">Rechnungsdaten & Berechnung</div>
          <span class="pill">Auto-Zuschläge: Nacht 22–06 · Sonntag · Feiertag (Bremen)</span>
          <div class="callout">
            ✅ Für automatische Beträge: bitte oben <b>+ Schicht hinzufügen</b> → Start + Ende + Mitarbeiter eingeben.
            Dann kommen Stunden & Betrag automatisch.
          </div>
        </div>
        <div class="toggle">
          <input id="modeShifts" type="checkbox" checked>
          <label for="modeShifts" style="margin:0;font-weight:900">Schicht-Modus (Auto)</label>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Rechnungsdatum</label>
          <input id="invDate" type="date">
        </div>
        <div>
          <label>Zahlungsziel</label>
          <select id="terms">
            <option value="7">7 Tage</option>
            <option value="14" selected>14 Tage</option>
            <option value="21">21 Tage</option>
            <option value="30">30 Tage</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Fällig am (Auto)</label>
          <input id="dueDate" type="date" readonly>
        </div>
        <div>
          <label>Rechnungsnummer (Auto)</label>
          <input id="invNo" readonly>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Status wählen</label>
          <select id="status">
            <option>Entwurf</option>
            <option>Offen</option>
            <option>Bezahlt</option>
            <option>Storniert</option>
          </select>
        </div>
        <div>
          <label>Stundensatz (€/h)</label>
          <input id="rate" type="number" min="0" step="0.01" value="23">
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>USt-Status</label>
          <select id="vatMode">
            <option value="0" selected>0% (Kleinunternehmer §19)</option>
            <option value="19">19% (Regelbesteuerung)</option>
          </select>
        </div>
        <div>
          <label>Zuschläge editierbar</label>
          <div class="grid3">
            <input id="p_night" type="number" min="0" step="0.1" value="5" title="Nachtschicht %">
            <input id="p_sun" type="number" min="0" step="0.1" value="50" title="Sonntag %">
            <input id="p_hol" type="number" min="0" step="0.1" value="100" title="Feiertag %">
          </div>
          <div class="small">Reihenfolge (keine Doppelzählung): Feiertag &gt; Sonntag &gt; Nacht.</div>
        </div>
      </div>

      <div class="kpiRow">
        <div class="kpi"><div class="k">Stunden gesamt</div><div class="v" id="k_total">0,00</div></div>
        <div class="kpi"><div class="k">Netto</div><div class="v" id="k_net">0,00 €</div></div>
        <div class="kpi"><div class="k">Gesamt</div><div class="v" id="k_all">0,00 €</div></div>
      </div>

      <div class="noteBox" id="vatHint"></div>
    </div>
  </div>

  <!-- SHIFT MODE -->
  <div class="card" style="margin-top:12px" id="shiftModeBox">
    <div class="shiftHead">
      <div>
        <div class="title" style="margin-bottom:6px">Schichten (Auto-Berechnung)</div>
        <div class="small">Start/Ende + Mitarbeiter → System berechnet automatisch: Grundlohn, Nacht, Sonntag, Feiertag (Bremen).</div>
      </div>
      <div class="rowBtns" style="margin:0">
        <button class="btn2" id="btnAddShift" type="button">+ Schicht hinzufügen</button>
        <button class="btn2" id="btnDemoShift" type="button">Demo füllen</button>
        <span class="badge" id="holidayInfo">Feiertage: Bremen</span>
      </div>
    </div>

    <div class="shiftTableWrap">
      <table class="shiftTable" id="shiftTable">
        <thead>
          <tr>
            <th style="width:220px">Start (Datum+Zeit)</th>
            <th style="width:220px">Ende (Datum+Zeit)</th>
            <th style="width:140px">Mitarbeiter</th>
            <th class="right" style="width:140px">Stunden</th>
            <th style="width:140px">Aktion</th>
          </tr>
        </thead>
        <tbody id="shiftBody"></tbody>
      </table>
    </div>

    <div class="small" style="margin-top:8px">Tipp: Einsatz über Mitternacht → Ende am nächsten Tag wählen.</div>
  </div>

  <!-- POSITIONS -->
  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Position</th>
          <th style="width:160px">Stunden</th>
          <th style="width:140px">Zuschlag %</th>
          <th class="right" style="width:180px">Betrag</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><b>Grundlohn</b><div class="small">Arbeitszeit (normal)</div></td>
          <td><input id="h_base" type="number" readonly></td>
          <td class="small">—</td>
          <td class="right" id="sum_base">0,00 €</td>
        </tr>
        <tr>
          <td><b>Nachtschicht</b><div class="small">22:00–06:00</div></td>
          <td><input id="h_night" type="number" readonly></td>
          <td><input id="p_night2" type="number" min="0" step="0.1" value="5"></td>
          <td class="right" id="sum_night">0,00 €</td>
        </tr>
        <tr>
          <td><b>Sonntag</b><div class="small">Auto</div></td>
          <td><input id="h_sun" type="number" readonly></td>
          <td><input id="p_sun2" type="number" min="0" step="0.1" value="50"></td>
          <td class="right" id="sum_sun">0,00 €</td>
        </tr>
        <tr>
          <td><b>Feiertag</b><div class="small">Bremen · Auto</div></td>
          <td><input id="h_hol" type="number" readonly></td>
          <td><input id="p_hol2" type="number" min="0" step="0.1" value="100"></td>
          <td class="right" id="sum_hol">0,00 €</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="sumBox">
    <div class="sumRow"><span>Zwischensumme (Netto)</span><b id="netto">0,00 €</b></div>
    <div class="sumRow"><span>Umsatzsteuer</span><b id="vat">0,00 €</b></div>
    <div class="sumRow total"><span>Gesamt</span><b id="total">0,00 €</b></div>
    <div class="small" id="legalNote" style="margin-top:6px"></div>
    <div class="small" style="margin-top:10px">
      <b>Bank:</b> MUSTAFA MURSAL ABDI · IBAN: DE98 1001 1001 2333 0146 96 · BIC: NTSBDEB1XXX
    </div>
  </div>

</div>

<!-- ARCHIV DRAWER -->
<div class="drawer" id="drawer">
  <div class="drawerPanel">
    <div class="drawerHead">
      <b>Rechnungen (Archiv)</b>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn white" id="btnExportJson" type="button">Export JSON</button>
        <button class="btn white" id="btnImportJson" type="button">Import JSON</button>
        <button class="btn" id="btnCloseDrawer" type="button">Schließen</button>
        <input id="importFile" type="file" accept="application/json" style="display:none">
      </div>
    </div>
    <div class="drawerBody">
      <div class="small">Speichert jede Rechnung im Browser. PDF kannst du jederzeit pro Rechnung erzeugen.</div>
      <div class="sep"></div>
      <div id="archList"></div>
      <div class="small" id="archEmpty"></div>
    </div>
  </div>
</div>

<script>
/* ========= STORAGE KEYS ========= */
const LS_STATE="ms_pro_invoice_v4";
const LS_CUSTOMERS="ms_customers_pro_v2";
const LS_COUNTER="ms_counter_pro_v2";
const LS_ARCHIVE="ms_invoice_archive_v1";

/* ========= HELPERS ========= */
const $=id=>document.getElementById(id);
const pad2=n=>String(n).padStart(2,"0");
const toISO=d=>{const x=new Date(d);return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;}
const toISODayKey=d=>{const x=new Date(d);return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;}
const numVal=v=>{const n=parseFloat(String(v).replace(",",".")); return Number.isFinite(n)?n:0;}
const num=id=>numVal($(id).value);
const money=x=>(x||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+" €";
const round2=x=>Math.round((x||0)*100)/100;
const safeJSON=(v,fallback)=>{try{return JSON.parse(v);}catch(e){return fallback;}};
let _tickLock=false;

function nextInvoiceNo(){
  const d=new Date();
  const key=`${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}`;
  let store=safeJSON(localStorage.getItem(LS_COUNTER)||"{}",{});
  store[key]=(store[key]||0)+1;
  localStorage.setItem(LS_COUNTER,JSON.stringify(store));
  return `MS-${key}-${store[key]}`;
}

function setDue(){
  const days=parseInt($("terms").value,10)||14;
  const inv=$("invDate").value||toISO(new Date());
  $("invDate").value=inv;
  const base=new Date(inv); const due=new Date(base); due.setDate(due.getDate()+days);
  $("dueDate").value=toISO(due);
}

function updateVatText(){
  const v=$("vatMode").value;
  if(v==="0"){
    $("vatHint").innerHTML = `<div class="small"><b>Hinweis:</b> Gemäß §19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).</div>`;
    $("legalNote").textContent = "Gemäß §19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).";
  }else{
    $("vatHint").innerHTML = `<div class="small"><b>Hinweis:</b> Umsatzsteuer wird gemäß Regelbesteuerung ausgewiesen (19%).</div>`;
    $("legalNote").textContent = "Umsatzsteuer wird gemäß Regelbesteuerung ausgewiesen (19%).";
  }
}

/* ========= CUSTOMERS ========= */
function getCustomers(){
  const a=safeJSON(localStorage.getItem(LS_CUSTOMERS)||"[]",[]);
  return Array.isArray(a)?a:[];
}
function setCustomers(a){localStorage.setItem(LS_CUSTOMERS,JSON.stringify(a))}
function refreshCustomerSelect(selected=""){
  const sel=$("kundeSelect");
  const list=getCustomers().slice().sort((a,b)=>(a.name||"").localeCompare(b.name||"","de"));
  sel.innerHTML=`<option value="">— Kunde wählen —</option>`+list.map(c=>{
    const n=(c.name||"").replace(/"/g,"&quot;");
    return `<option value="${n}">${n}</optio
