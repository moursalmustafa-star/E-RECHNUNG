<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security â€” Invoice Suite</title>

  <!-- PDF libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand:#0b5fa8;
      --brand2:#0a4d86;
      --bg:#f6f8fc;
      --card:#ffffff;
      --ink:#0b1220;
      --muted:#66758f;
      --line:#e3e9f2;

      --r:18px;
      --shadow:0 18px 55px rgba(15,23,42,.10);
      --shadow2:0 10px 26px rgba(15,23,42,.08);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(11,95,168,.14), transparent 55%),
        radial-gradient(1000px 600px at 90% 0%, rgba(10,77,134,.10), transparent 50%),
        var(--bg);
    }

    /* ===== Topbar (Enterprise) ===== */
    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.72);
      backdrop-filter: blur(12px);
      border-bottom:1px solid rgba(227,233,242,.75);
    }
    .topbarInner{
      max-width:1240px;
      margin:0 auto;
      padding:14px 16px;
    }
    .row{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:280px;
    }
    .logo{
      width:46px;height:46px;border-radius:14px;
      display:grid;place-items:center;overflow:hidden;
      background:linear-gradient(180deg, rgba(11,95,168,.10), rgba(11,95,168,.02));
      border:1px solid rgba(11,95,168,.18);
      box-shadow: var(--shadow2);
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .title{
      font-weight:950;
      letter-spacing:-.2px;
      line-height:1.1;
      font-size:15px;
      color:#0a2540;
    }
    .subtitle{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-left:auto}

    /* ===== Buttons (enterprise) ===== */
    button{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:#0a2540;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: transform .06s ease, box-shadow .15s ease, border-color .15s ease;
    }
    button:hover{box-shadow:0 10px 24px rgba(15,23,42,.10); border-color:#d7e2f0}
    button:active{transform: translateY(1px)}
    button.primary{
      background:linear-gradient(180deg, var(--brand), var(--brand2));
      color:#fff;
      border-color:rgba(11,95,168,.35);
      box-shadow:0 14px 32px rgba(11,95,168,.22);
    }
    button.primary:hover{box-shadow:0 18px 42px rgba(11,95,168,.28)}
    button.ghost{background:transparent; box-shadow:none}
    button.ok{
      background:linear-gradient(180deg, #17b897, #12a988);
      border-color:rgba(18,169,136,.35);
      color:#fff;
      box-shadow:0 14px 32px rgba(18,169,136,.20);
    }
    button.danger{
      background:linear-gradient(180deg, #ff4d6d, #e11d48);
      border-color:rgba(225,29,72,.35);
      color:#fff;
      box-shadow:0 14px 32px rgba(225,29,72,.18);
    }

    /* Contact chips */
    .brandSub{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .linkbtn{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:#0a2540;
      font-weight:900;
      box-shadow:0 8px 20px rgba(15,23,42,.06);
      cursor:pointer;
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      box-shadow:0 8px 20px rgba(15,23,42,.06);
    }
    .dot{width:8px;height:8px;border-radius:99px;background:#22c55e}

    /* ===== Sidebar Layout (Enterprise) ===== */
    .appShell{
      max-width:1240px;
      margin:0 auto;
      padding:18px 14px 50px;
      display:grid;
      gap:14px;
    }
    @media (min-width:1020px){
      .appShell{ grid-template-columns: 260px 1fr; }
    }
    .sidebar{
      background:#fff;
      border:1px solid rgba(227,233,242,.85);
      border-radius:18px;
      box-shadow: 0 18px 55px rgba(15,23,42,.08);
      overflow:hidden;
      position:sticky;
      top:92px;
      height: calc(100vh - 110px);
    }
    .sideHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(227,233,242,.85);
      background:linear-gradient(180deg,#ffffff,#fbfdff);
    }
    .sideHead .h1{font-weight:950;color:#0a2540;font-size:14px}
    .sideHead .h2{font-size:12px;color:#66758f;margin-top:4px}
    .sideNav{padding:10px}
    .sideBtn{
      width:100%;
      text-align:left;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid transparent;
      background:transparent;
      cursor:pointer;
      font-weight:950;
      color:#0a2540;
      box-shadow:none;
    }
    .sideBtn:hover{background:rgba(11,95,168,.06);border-color:rgba(11,95,168,.12)}
    .sideBtn.active{
      background:linear-gradient(180deg, rgba(11,95,168,.12), rgba(11,95,168,.05));
      border-color:rgba(11,95,168,.18);
    }
    .sideTag{
      font-size:12px;
      color:#66758f;
      border:1px solid rgba(227,233,242,.95);
      background:#fff;
      padding:4px 8px;
      border-radius:999px;
      font-family: var(--mono);
    }
    .mainArea{min-width:0}
    .view{display:none}
    .view.active{display:block}

    /* ===== Cards ===== */
    .grid{display:grid;gap:14px}
    @media (min-width:1020px){.grid{grid-template-columns:1.35fr .85fr}}
    .card{
      background:var(--card);
      border:1px solid rgba(227,233,242,.85);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:14px 16px;
      font-size:13px;
      letter-spacing:.2px;
      color:#0a2540;
      background:linear-gradient(180deg,#ffffff,#fbfdff);
      border-bottom:1px solid rgba(227,233,242,.85);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .body{padding:14px 16px}

    .row2{display:grid;gap:10px}
    @media (min-width:760px){.row2{grid-template-columns:1fr 1fr}}
    .row3{display:grid;gap:10px}
    @media (min-width:760px){.row3{grid-template-columns:1fr 1fr 1fr}}

    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px;font-weight:700}
    input, select, textarea{
      width:100%;
      border:1px solid rgba(227,233,242,.95);
      border-radius:14px;
      padding:11px 12px;
      font:inherit;
      background:#fff;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(11,95,168,.45);
      box-shadow:0 0 0 4px rgba(11,95,168,.10);
    }
    textarea{min-height:92px;resize:vertical}

    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-family:var(--mono);
      white-space:nowrap;
    }
    .mono{font-family:var(--mono)}
    .hr{height:1px;background:rgba(227,233,242,.85);margin:12px 0}

    .note{
      font-size:12px;
      color:var(--muted);
      background:linear-gradient(180deg,#ffffff,#fbfdff);
      border:1px solid rgba(227,233,242,.95);
      border-radius:14px;
      padding:10px;
    }

    /* ===== KPI ===== */
    .kpi{display:grid;gap:10px}
    @media (min-width:760px){.kpi{grid-template-columns:1fr 1fr}}
    .kpi .box{
      border:1px solid rgba(227,233,242,.95);
      border-radius:16px;
      padding:12px;
      background:linear-gradient(180deg,#fff,#fbfdff);
    }
    .kpi .big{font-size:22px;font-weight:950}
    .kpi .small{font-size:12px;color:var(--muted);font-weight:700}

    /* ===== Table ===== */
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid rgba(227,233,242,.95);
      border-radius:16px;
      overflow:hidden;
    }
    .table th,.table td{padding:10px 10px;border-bottom:1px solid rgba(227,233,242,.95);font-size:13px}
    .table th{background:#f7fafc;text-align:left;color:#0a2540;font-weight:900}
    .table tr:last-child td{border-bottom:0}
    .right{text-align:right}

    /* ===== Lists ===== */
    .list{display:grid;gap:10px}
    .item{
      border:1px solid rgba(227,233,242,.95);
      border-radius:16px;
      padding:12px;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      background:#fff;
      box-shadow:0 10px 26px rgba(15,23,42,.06);
    }
    .item b{display:block}
    .item small{color:var(--muted)}
    .item .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .item .btns button{border-radius:12px}

    /* ===== PRINT/PDF ===== */
    #printArea{background:#fff;color:#111;padding:18px;width:210mm;min-height:297mm;margin:0 auto}
    @media print{
      body{background:#fff}
      .topbar,.appShell{display:none!important}
      #printArea{display:block!important;box-shadow:none;border:none}
    }
    #printAreaWrap{display:none}
    .mini{font-size:11px;color:#444}

    .invHeader{display:flex;justify-content:space-between;gap:16px}
    .invHeader .left{display:flex;gap:12px;align-items:center}
    .invLogo{width:54px;height:54px;border-radius:16px;overflow:hidden;border:1px solid #e5e8ef}
    .invLogo img{width:100%;height:100%;object-fit:cover}
    .invTitle{font-size:26px;font-weight:950;margin:0;letter-spacing:-.4px}
    .invBrand{font-size:13px;color:#0a2540;font-weight:950;margin-top:2px}
    .invMeta{font-size:12px;color:#334155}
    .invGrid2{display:grid;gap:10px}
    @media (min-width:900px){.invGrid2{grid-template-columns:1fr 1fr}}
    .invBox{border:1px solid #e5e8ef;border-radius:16px;padding:12px}
    .invBox h4{margin:0 0 8px;font-size:12px;color:#0a2540}
    .invBox .line{display:flex;justify-content:space-between;gap:10px;font-size:12px;margin:4px 0}
    .invTable{width:100%;border-collapse:collapse;margin-top:10px}
    .invTable th,.invTable td{border:1px solid #e5e8ef;padding:8px;font-size:12px}
    .invTable th{background:#f5f7fb;text-align:left}
    .invRight{text-align:right}
    .invTotals{display:grid;gap:8px;margin-top:10px}
    .invTotals .tline{display:flex;justify-content:space-between;font-size:12px}
    .invTotals .grand{font-size:14px;font-weight:950}
    .invFooter{margin-top:14px;font-size:11px;color:#334155}
  </style>
</head>

<body>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbarInner">

      <div class="row">
        <div class="brand">
          <div class="logo" title="Logo (fest gespeichert)">
            <img id="logoImg" alt="Logo"/>
          </div>
          <div>
            <div class="title" id="brandTopTitle">Masculine Security</div>
            <div class="subtitle">Invoice Suite â€¢ Security Services â€¢ Corporate Billing System</div>
          </div>
        </div>

        <div class="actions">
          <button class="ghost" id="btnLogo" type="button">Logo Ã¤ndern</button>
          <button class="ghost" id="btnNew" type="button">Neu</button>
          <button class="ok" id="btnSave" type="button">Rechnung speichern</button>
          <button class="ghost" id="btnList" type="button">Rechnungen</button>
          <button class="danger" id="btnReset" type="button">Reset</button>
          <button class="primary" id="btnPdf" type="button">PDF speichern</button>
          <button class="primary" id="btnPrint" type="button">Print</button>
        </div>
      </div>

      <div class="brandSub">
        Tel:
        <button class="linkbtn" id="btnCall" type="button">015778697052</button>
        â€¢ E-Mail:
        <button class="linkbtn" id="btnMail" type="button">Kontakt.mass.bremen@hotmail.com</button>
        <span class="badge"><span class="dot"></span> Auto-Save aktiv</span>
        <span class="badge" id="b2bBadge"><span class="dot" style="background:#22c55e"></span> B2B Mode: OFF</span>
      </div>

    </div>
  </div>

  <!-- APP SHELL (SIDEBAR + MAIN) -->
  <div class="appShell">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sideHead">
        <div class="h1">Masculine Security</div>
        <div class="h2">Corporate Invoice Suite</div>
      </div>

      <div class="sideNav">
        <button class="sideBtn active" id="navCreate" type="button">
          <span>âž• Rechnung erstellen</span>
          <span class="sideTag">FORM</span>
        </button>

        <button class="sideBtn" id="navInvoices" type="button">
          <span>ðŸ“„ Rechnungen</span>
          <span class="sideTag" id="navInvCount">0</span>
        </button>

        <button class="sideBtn" id="navCustomers" type="button">
          <span>ðŸ‘¤ Kunden</span>
          <span class="sideTag" id="navCustCount">0</span>
        </button>

        <button class="sideBtn" id="navSettings" type="button">
          <span>âš™ Einstellungen</span>
          <span class="sideTag">LOGO</span>
        </button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="mainArea">

      <!-- VIEW: CREATE -->
      <div class="view active" id="viewCreate">
        <div class="grid">

          <!-- LEFT: FORM -->
          <div class="card">
            <h2>
              <span>Rechnungsdaten</span>
              <span class="pill" id="liveStatus">Bereit</span>
            </h2>

            <div class="body">

              <div class="row2">
                <div>
                  <label>Firmenname / Brand *</label>
                  <input id="issuerCompany" value="Masculine Security"/>
                </div>
                <div>
                  <label>Adresse *</label>
                  <input id="issuerAddress" value="WerschenregerstraÃŸe 6 â€¢ 28237 Bremen"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Telefon</label>
                  <input id="issuerPhone" value="015778697052"/>
                </div>
                <div>
                  <label>E-Mail *</label>
                  <input id="issuerEmail" value="Kontakt.mass.bremen@hotmail.com"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Steuernummer / Hinweis *</label>
                  <input id="issuerTaxNo" value="wird nachgereicht"/>
                  <div class="note" style="margin-top:8px">Wenn du noch keine Steuernummer hast: â€žwird nachgereichtâ€œ ist ok.</div>
                </div>
                <div>
                  <label>USt-IdNr (optional)</label>
                  <input id="issuerVatId" placeholder="DE123456789"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>IBAN *</label>
                  <input id="issuerIban" value="DE98 1001 1001 2333 0146 96"/>
                </div>
                <div>
                  <label>BIC *</label>
                  <input id="issuerBic" value="NTSBDEB1XXX"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Kontoinhaber *</label>
                  <input id="issuerHolder" value="MUSTAFA MURSAL ABDI"/>
                </div>
                <div>
                  <label>â€”</label>
                  <input disabled value=""/>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row2">
                <div>
                  <label>Kunde auswÃ¤hlen</label>
                  <select id="customerPick"></select>

                  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
                    <button id="btnSaveCustomer" class="ghost" type="button">Kunde speichern</button>
                    <button id="btnDeleteCustomer" class="danger" type="button">Kunde lÃ¶schen</button>
                  </div>
                </div>

                <div>
                  <label>Kundenname (zum Speichern) *</label>
                  <input id="custName" placeholder="Firma / Name"/>
                  <div class="row2" style="margin-top:10px">
                    <div>
                      <label>E-Mail (optional)</label>
                      <input id="custEmail" placeholder="kunde@email.de"/>
                    </div>
                    <div>
                      <label>Ansprechpartner (optional)</label>
                      <input id="custContact" placeholder="Ansprechpartner"/>
                    </div>
                  </div>
                </div>
              </div>

              <div style="margin-top:10px">
                <label>Kundendaten (Adresse / Ansprechpartner) *</label>
                <textarea id="custAddress" placeholder="StraÃŸe â€¢ PLZ Ort&#10;Ansprechpartner"></textarea>
              </div>

              <div class="hr"></div>

              <div class="row3">
                <div>
                  <label>Rechnungsdatum *</label>
                  <input id="invDate" type="date"/>
                </div>
                <div>
                  <label>FÃ¤llig am *</label>
                  <input id="dueDate" type="date"/>
                  <div class="note" style="margin-top:8px">Standard = +14 Tage (du kannst Ã¤ndern).</div>
                </div>
                <div>
                  <label>Rechnungsnummer *</label>
                  <input id="invNo" class="mono"/>
                  <div class="note" style="margin-top:8px">Auto pro Tag laufend (YYYYMMDD-0001).</div>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>USt-Status *</label>
                  <select id="vatMode">
                    <option value="kmu">0% (Kleinunternehmer Â§19)</option>
                    <option value="vat19">19% USt</option>
                  </select>
                  <div class="note" style="margin-top:8px" id="vatHint">GemÃ¤ÃŸ Â§19 UStG wird keine Umsatzsteuer berechnet.</div>
                </div>

                <div>
                  <label>Leistungsbeschreibung *</label>
                  <input id="serviceTitle" value="Sicherheitsdienstleistung â€“ Objektschutz"/>
                  <div class="row2" style="margin-top:10px">
                    <div>
                      <label>Objekt / Ort (optional)</label>
                      <input id="objekt" placeholder="z.B. Baustelle â€“ Bremen"/>
                    </div>
                    <div>
                      <label>Auftragszeitraum (optional)</label>
                      <input id="zeitraum" placeholder="z.B. 08.03.2026 â€“ 09.03.2026"/>
                    </div>
                  </div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row2">
                <div>
                  <label>Anzahl Mitarbeiter *</label>
                  <input id="mitarbeiter" type="number" min="0" value="1"/>
                </div>
                <div>
                  <label>Basis-Stundensatz Tag (â‚¬) *</label>
                  <input id="tagPreis" type="number" min="0" step="0.01" value="23"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Berechnungsart ZuschlÃ¤ge *</label>
                  <select id="modus">
                    <option value="fixed">Festpreis (eigener Preis pro Std.)</option>
                    <option value="percent">Zuschlag % (auf Tagpreis)</option>
                  </select>
                  <div class="note" style="margin-top:8px">B2B Empfehlung: <b>Festpreise</b> (All-in). Prozent ist optional.</div>
                </div>
                <div>
                  <label>B2B Modus (All-in Darstellung) *</label>
                  <select id="b2bMode">
                    <option value="off">OFF (Detail: Tag/Nacht/Sonntag/Feiertag)</option>
                    <option value="on">ON (B2B: 1 Position, All-in)</option>
                  </select>
                  <div class="note" style="margin-top:8px">
                    ON = Rechnung/PDF zeigt <b>nur eine Position</b> (professionell B2B). Intern bleibt die genaue Berechnung korrekt.
                  </div>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Verwendungszweck (auto)</label>
                  <input id="purpose" class="mono" readonly/>
                  <div class="note" style="margin-top:8px">Kunde kann bei Ãœberweisung so schreiben.</div>
                </div>
                <div>
                  <label>â€”</label>
                  <input disabled value=""/>
                </div>
              </div>

              <div class="hr"></div>

              <!-- AUTO Tag/Nacht -->
              <div class="row3">
                <div>
                  <label>Schicht Beginn</label>
                  <input id="shiftStart" type="time" value="18:00"/>
                </div>
                <div>
                  <label>Schicht Ende</label>
                  <input id="shiftEnd" type="time" value="06:00"/>
                </div>
                <div>
                  <label>Nachtzeit Regel</label>
                  <select id="nachtRule">
                    <option value="22-06">22:00 â€“ 06:00 (Standard)</option>
                    <option value="23-06">23:00 â€“ 06:00</option>
                    <option value="20-06">20:00 â€“ 06:00</option>
                  </select>
                </div>
              </div>

              <div class="note" style="margin-top:10px">
                Auto-Funktion berechnet <b>Tagstunden</b> und <b>Nachtstunden</b> aus Beginn/Ende.
                Sonntag/Feiertag trÃ¤gst du separat ein.
              </div>

              <div class="hr"></div>

              <div class="row3">
                <div>
                  <label>Tagstunden</label>
                  <input id="tagH" type="number" min="0" step="0.25" value="0"/>
                </div>
                <div>
                  <label>Nachtstunden</label>
                  <input id="nachtH" type="number" min="0" step="0.25" value="0"/>
                </div>
                <div>
                  <label>Sonntagstunden</label>
                  <input id="sonntagH" type="number" min="0" step="0.25" value="0"/>
                </div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div>
                  <label>Feiertagstunden</label>
                  <input id="feiertagH" type="number" min="0" step="0.25" value="0"/>
                  <div class="note" style="margin-top:8px">Keine DoppelzÃ¤hlung: Stunden nur in <b>eine</b> Kategorie eintragen.</div>
                </div>
                <div>
                  <label>Hinweis / Notiz (optional)</label>
                  <textarea id="note" placeholder="z.B. laut Vereinbarung / Einsatzzeiten / Ansprechpartner..."></textarea>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row3">
                <div id="percentBox" style="display:none">
                  <label>Nachtzuschlag (%)</label>
                  <input id="nachtPercent" type="number" min="0" step="0.01" value="0"/>
                  <label style="margin-top:10px">Sonntag (%)</label>
                  <input id="sonntagPercent" type="number" min="0" step="0.01" value="50"/>
                  <label style="margin-top:10px">Feiertag (%)</label>
                  <input id="feiertagPercent" type="number" min="0" step="0.01" value="100"/>
                </div>

                <div id="fixedBox">
                  <label>Festpreis Nacht (â‚¬)</label>
                  <input id="nachtFest" type="number" min="0" step="0.01" value="24"/>
                  <label style="margin-top:10px">Festpreis Sonntag (â‚¬)</label>
                  <input id="sonntagFest" type="number" min="0" step="0.01" value="30"/>
                  <label style="margin-top:10px">Festpreis Feiertag (â‚¬)</label>
                  <input id="feiertagFest" type="number" min="0" step="0.01" value="36"/>
                </div>

                <div>
                  <label>Rechnung Text (auto)</label>
                  <textarea id="rechnungText"></textarea>
                  <div class="note" style="margin-top:8px">Text wird automatisch aktualisiert (du kannst trotzdem manuell Ã¤ndern).</div>
                </div>
              </div>

            </div>
          </div>

          <!-- RIGHT: SUMMARY -->
          <div class="card">
            <h2>
              <span>Berechnung & Summe</span>
              <span style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                <span class="pill mono" id="modeBadge">MODE: FEST</span>
                <span class="pill mono" id="b2bModeBadge">B2B: OFF</span>
              </span>
            </h2>
            <div class="body">
              <div class="kpi">
                <div class="box">
                  <div class="small">Zwischensumme (netto)</div>
                  <div class="big mono" id="subTotal">0,00 â‚¬</div>
                </div>
                <div class="box">
                  <div class="small">Gesamt (brutto)</div>
                  <div class="big mono" id="grandTotal">0,00 â‚¬</div>
                </div>
              </div>

              <div class="hr"></div>

              <table class="table">
                <thead>
                  <tr>
                    <th>Position</th>
                    <th class="right">Std.</th>
                    <th class="right">Preis/Std.</th>
                    <th class="right">Summe</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- B2B Single Line -->
                  <tr id="row_b2b" style="display:none">
                    <td>Sicherheitsdienstleistung (All-in)</td>
                    <td class="right mono" id="t_b2bStd">0</td>
                    <td class="right mono" id="t_b2bPreis">0,00 â‚¬</td>
                    <td class="right mono" id="t_b2bSum">0,00 â‚¬</td>
                  </tr>

                  <!-- Detail Lines -->
                  <tr class="detailRow">
                    <td>Tagdienst</td>
                    <td class="right mono" id="t_tagStd">0</td>
                    <td class="right mono" id="t_tagPreis">0,00 â‚¬</td>
                    <td class="right mono" id="t_tagSum">0,00 â‚¬</td>
                  </tr>
                  <tr class="detailRow">
                    <td>Nachtdienst</td>
                    <td class="right mono" id="t_nachtStd">0</td>
                    <td class="right mono" id="t_nachtPreis">0,00 â‚¬</td>
                    <td class="right mono" id="t_nachtSum">0,00 â‚¬</td>
                  </tr>
                  <tr class="detailRow">
                    <td>Sonntag</td>
                    <td class="right mono" id="t_sonntagStd">0</td>
                    <td class="right mono" id="t_sonntagPreis">0,00 â‚¬</td>
                    <td class="right mono" id="t_sonntagSum">0,00 â‚¬</td>
                  </tr>
                  <tr class="detailRow">
                    <td>Feiertag</td>
                    <td class="right mono" id="t_feiertagStd">0</td>
                    <td class="right mono" id="t_feiertagPreis">0,00 â‚¬</td>
                    <td class="right mono" id="t_feiertagSum">0,00 â‚¬</td>
                  </tr>
                </tbody>
              </table>

              <div class="hr"></div>

              <div class="note">
                <b>Wichtig:</b> Mitarbeiter werden automatisch multipliziert:
                <span class="mono">(Mitarbeiter Ã— Stunden Ã— Preis)</span>.
                <br/>
                <b>B2B Mode ON:</b> Anzeige/PDF = 1 Position, intern bleibt die Berechnung korrekt.
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- VIEW: INVOICES -->
      <div class="view" id="viewInvoices">
        <div class="card">
          <h2>
            <span>Gespeicherte Rechnungen</span>
            <span class="pill mono" id="invCount">0</span>
          </h2>
          <div class="body">
            <div class="list" id="invList"></div>
          </div>
        </div>
      </div>

      <!-- VIEW: CUSTOMERS -->
      <div class="view" id="viewCustomers">
        <div class="card">
          <h2>
            <span>Kunden</span>
            <span class="pill mono" id="custCount">0</span>
          </h2>
          <div class="body">
            <div class="note">Liste deiner gespeicherten Kunden (AuswÃ¤hlen fÃ¼hrt zurÃ¼ck zum Formular).</div>
            <div class="hr"></div>
            <div class="list" id="custList"></div>
          </div>
        </div>
      </div>

      <!-- VIEW: SETTINGS -->
      <div class="view" id="viewSettings">
        <div class="card">
          <h2>
            <span>Einstellungen</span>
            <span class="pill mono">Brand</span>
          </h2>
          <div class="body">
            <div class="note">Logo (fest gespeichert) + Firmenname kannst du hier schnell Ã¤ndern.</div>
            <div class="hr"></div>
            <div class="row2">
              <div>
                <label>Firmenname / Brand</label>
                <input id="issuerCompanyMirror" placeholder="Masculine Security"/>
              </div>
              <div>
                <label>Logo</label>
                <button class="primary" type="button" id="btnLogo2">Logo Ã¤ndern</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- PRINT/PDF AREA -->
  <div id="printAreaWrap"><div id="printArea"></div></div>

  <!-- FEST LOGO upload -->
  <input id="logoFile" type="file" accept="image/*" style="display:none"/>

  <script>
    // ===== Storage Keys =====
    const KEY_APP = "ms_rechnung_app_v3";
    const KEY_CUSTOMERS = "ms_customers_v1";
    const KEY_INVOICES = "ms_invoices_v1";
    const KEY_COUNTERS = "ms_inv_counters_v1";
    const KEY_LOGO = "ms_logo_v1";

    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const fmtEUR = (n)=>{
      const v = Number(n||0);
      return v.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}) + " â‚¬";
    };
    const todayISO = ()=>{
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const addDaysISO = (iso, days)=>{
      const d = new Date(iso+"T00:00:00");
      d.setDate(d.getDate()+days);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };
    const yyyymmdd = (iso)=> iso.replaceAll("-","");
    const safeNum = (v)=> {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };
    const setStatus = (txt, ok=true)=>{
      $("liveStatus").textContent = txt;
      $("liveStatus").style.borderColor = ok ? "rgba(34,197,94,.35)" : "rgba(225,29,72,.35)";
      $("liveStatus").style.color = ok ? "var(--muted)" : "#b91c1c";
    };

    const loadJSON = (k, fallback)=>{
      try{ const v = localStorage.getItem(k); return v? JSON.parse(v) : fallback; }catch(e){ return fallback; }
    };
    const saveJSON = (k, v)=> localStorage.setItem(k, JSON.stringify(v));

    // ===== FEST LOGO =====
    function setLogo(dataUrl, persist=true){
      $("logoImg").src = dataUrl;
      if(persist) localStorage.setItem(KEY_LOGO, dataUrl);
    }
    function loadLogo(){
      const saved = localStorage.getItem(KEY_LOGO);
      if(saved){
        setLogo(saved, false);
      }else{
        const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="120" height="120" rx="24" fill="#0b5fa8"/><text x="60" y="72" font-size="54" text-anchor="middle" fill="white" font-family="Arial" font-weight="900">M</text></svg>`);
        setLogo(\`data:image/svg+xml,\${svg}\`, false);
      }
    }

    // ===== Invoice number =====
    function nextInvoiceNo(invDateISO){
      const counters = loadJSON(KEY_COUNTERS, {});
      const d = yyyymmdd(invDateISO || todayISO());
      const cur = safeNum(counters[d]) || 0;
      const next = cur + 1;
      counters[d] = next;
      saveJSON(KEY_COUNTERS, counters);
      return `MS-${d}-${String(next).padStart(4,"0")}`;
    }

    function updateVatHint(){
      $("vatHint").textContent = ($("vatMode").value==="kmu")
        ? "GemÃ¤ÃŸ Â§19 UStG wird keine Umsatzsteuer berechnet."
        : "Umsatzsteuer 19% wird berechnet und ausgewiesen.";
    }

    function updatePurpose(){
      const no = $("invNo").value || "";
      $("purpose").value = `Rechnung: ${no}`;
    }

    function toggleModeUI(){
      const m = $("modus").value;
      $("percentBox").style.display = (m==="percent") ? "" : "none";
      $("fixedBox").style.display = (m==="fixed") ? "" : "none";
      $("modeBadge").textContent = (m==="percent") ? "MODE: %" : "MODE: FEST";
    }

    function toggleB2BUI(){
      const on = $("b2bMode").value === "on";
      $("b2bModeBadge").textContent = on ? "B2B: ON" : "B2B: OFF";
      $("b2bBadge").innerHTML = on
        ? `<span class="dot" style="background:#22c55e"></span> B2B Mode: ON`
        : `<span class="dot" style="background:#94a3b8"></span> B2B Mode: OFF`;
      $("b2bBadge").style.color = on ? "#0f172a" : "var(--muted)";
      $("b2bBadge").style.borderColor = on ? "rgba(34,197,94,.28)" : "var(--line)";

      // Summary table rows
      $("row_b2b").style.display = on ? "" : "none";
      document.querySelectorAll(".detailRow").forEach(r=> r.style.display = on ? "none" : "");
    }

    function validateCore(){
      const must = [
        ["issuerCompany","Firmenname"],
        ["issuerAddress","Adresse"],
        ["issuerEmail","E-Mail"],
        ["issuerTaxNo","Steuernummer/Hinweis"],
        ["issuerIban","IBAN"],
        ["issuerBic","BIC"],
        ["issuerHolder","Kontoinhaber"],
        ["custName","Kundenname"],
        ["custAddress","Kundendaten"],
        ["invDate","Rechnungsdatum"],
        ["dueDate","FÃ¤llig am"],
        ["invNo","Rechnungsnummer"],
        ["serviceTitle","Leistungsbeschreibung"]
      ];
      for(const [id,label] of must){
        if(!String($(id).value||"").trim()){
          setStatus(`Fehlt: ${label}`, false);
          return false;
        }
      }
      setStatus("OK", true);
      return true;
    }

    // ===== AUTO Tag/Nacht =====
    function parseTimeToMinutes(t){
      if(!t) return null;
      const [h,m] = t.split(":").map(Number);
      if(!Number.isFinite(h) || !Number.isFinite(m)) return null;
      return h*60 + m;
    }
    function getNightWindow(){
      const rule = $("nachtRule").value;
      if(rule==="23-06") return {start: 23*60, end: 30*60};
      if(rule==="20-06") return {start: 20*60, end: 30*60};
      return {start: 22*60, end: 30*60};
    }
    function calculateDayNight(){
      const start = parseTimeToMinutes($("shiftStart").value);
      const endRaw = parseTimeToMinutes($("shiftEnd").value);
      if(start===null || endRaw===null) return;

      let end = endRaw;
      if(end <= start) end += 1440;

      const totalMin = end - start;
      const {start: nightStart, end: nightEnd} = getNightWindow();

      let nightMin = 0;
      const nightEndMod = nightEnd % 1440;
      for(let i=start;i<end;i++){
        const mod = i % 1440;
        const isNight = (mod >= nightStart) || (mod < nightEndMod);
        if(isNight) nightMin++;
      }

      const nightH = nightMin / 60;
      const dayH = (totalMin/60) - nightH;

      $("tagH").value = Math.max(0, dayH).toFixed(2);
      $("nachtH").value = Math.max(0, nightH).toFixed(2);
    }

    // ===== Calculation =====
    function calculate(){
      toggleModeUI();
      toggleB2BUI();
      updateVatHint();
      updatePurpose();

      // Sync top title
      $("brandTopTitle").textContent = ($("issuerCompany").value || "Masculine Security").trim();

      const m = safeNum($("mitarbeiter").value);
      const tagPreis = safeNum($("tagPreis").value);

      const tagH = safeNum($("tagH").value);
      const nachtH = safeNum($("nachtH").value);
      const sonntagH = safeNum($("sonntagH").value);
      const feiertagH = safeNum($("feiertagH").value);

      const mode = $("modus").value;

      let nachtPreisFinal = 0, sonntagPreisFinal = 0, feiertagPreisFinal = 0;
      if(mode==="percent"){
        const nachtP = safeNum($("nachtPercent").value);
        const sonntagP = safeNum($("sonntagPercent").value);
        const feiertagP = safeNum($("feiertagPercent").value);
        nachtPreisFinal = tagPreis + (tagPreis * nachtP/100);
        sonntagPreisFinal = tagPreis + (tagPreis * sonntagP/100);
        feiertagPreisFinal = tagPreis + (tagPreis * feiertagP/100);
      }else{
        nachtPreisFinal = safeNum($("nachtFest").value);
        sonntagPreisFinal = safeNum($("sonntagFest").value);
        feiertagPreisFinal = safeNum($("feiertagFest").value);
      }

      const tagSum = m * tagH * tagPreis;
      const nachtSum = m * nachtH * nachtPreisFinal;
      const sonntagSum = m * sonntagH * sonntagPreisFinal;
      const feiertagSum = m * feiertagH * feiertagPreisFinal;

      const subTotal = tagSum + nachtSum + sonntagSum + feiertagSum;

      const vatMode = $("vatMode").value;
      const vatRate = (vatMode==="vat19") ? 0.19 : 0;
      const vatAmount = subTotal * vatRate;
      const grandTotal = subTotal + vatAmount;

      // Detail table values
      $("t_tagStd").textContent = String(tagH);
      $("t_nachtStd").textContent = String(nachtH);
      $("t_sonntagStd").textContent = String(sonntagH);
      $("t_feiertagStd").textContent = String(feiertagH);

      $("t_tagPreis").textContent = fmtEUR(tagPreis);
      $("t_nachtPreis").textContent = fmtEUR(nachtPreisFinal);
      $("t_sonntagPreis").textContent = fmtEUR(sonntagPreisFinal);
      $("t_feiertagPreis").textContent = fmtEUR(feiertagPreisFinal);

      $("t_tagSum").textContent = fmtEUR(tagSum);
      $("t_nachtSum").textContent = fmtEUR(nachtSum);
      $("t_sonntagSum").textContent = fmtEUR(sonntagSum);
      $("t_feiertagSum").textContent = fmtEUR(feiertagSum);

      // B2B single line (blended unit price)
      const totalHours = tagH + nachtH + sonntagH + feiertagH;
      const qty = m * totalHours;
      const blended = (qty > 0) ? (subTotal / qty) : 0;

      $("t_b2bStd").textContent = String(totalHours.toFixed(2));
      $("t_b2bPreis").textContent = fmtEUR(blended);
      $("t_b2bSum").textContent = fmtEUR(subTotal);

      $("subTotal").textContent = fmtEUR(subTotal);
      $("grandTotal").textContent = fmtEUR(grandTotal);

      const obj = String($("objekt").value||"").trim();
      const zr = String($("zeitraum").value||"").trim();
      const note = String($("note").value||"").trim();

      const b2bOn = $("b2bMode").value === "on";
      const modeLine = (mode==="percent")
        ? `ZuschlÃ¤ge gemÃ¤ÃŸ Prozent (auf Tagpreis ${fmtEUR(tagPreis)}).`
        : `StundensÃ¤tze laut Vereinbarung (Festpreise).`;

      const b2bLine = b2bOn
        ? `B2B: All-in Darstellung (eine Position). Abrechnung gemÃ¤ÃŸ Einsatznachweis; Durchschnittspreis ergibt sich aus Einsatzzeiten (inkl. ZuschlÃ¤ge).`
        : `Detail: Tag/Nacht/Sonntag/Feiertag werden einzeln ausgewiesen.`;

      const vatLine = (vatMode==="kmu")
        ? `GemÃ¤ÃŸ Â§19 UStG wird keine Umsatzsteuer berechnet.`
        : `Umsatzsteuer 19%: ${fmtEUR(vatAmount)} (in Gesamtbetrag enthalten).`;

      const nightText = $("nachtRule").value==="23-06" ? "23:00 â€“ 06:00" : ($("nachtRule").value==="20-06" ? "20:00 â€“ 06:00" : "22:00 â€“ 06:00");

      // Auto Rechnung Text
      if(b2bOn){
        $("rechnungText").value = [
          `${$("serviceTitle").value} â€” Einsatz mit ${m} Mitarbeitern`,
          obj ? `Objekt/Ort: ${obj}` : "",
          zr ? `Zeitraum: ${zr}` : "",
          "",
          `Abrechnung (B2B All-in):`,
          `Gesamtstunden: ${totalHours.toFixed(2)} Std`,
          `Durchschnittspreis/Std: ${fmtEUR(blended)}`,
          `Zwischensumme (netto): ${fmtEUR(subTotal)}`,
          `${vatLine}`,
          `Gesamtbetrag: ${fmtEUR(grandTotal)}`,
          "",
          `Einsatzzeiten gemÃ¤ÃŸ Absprache.`,
          `Nachtzeit laut Vereinbarung: ${nightText}`,
          `Leistung im Rahmen eines Subunternehmer-Einsatzes erbracht.`,
          note ? `Hinweis: ${note}` : ""
        ].filter(Boolean).join("\n");
      }else{
        $("rechnungText").value = [
          `${$("serviceTitle").value} â€” Einsatz mit ${m} Mitarbeitern`,
          obj ? `Objekt/Ort: ${obj}` : "",
          zr ? `Zeitraum: ${zr}` : "",
          "",
          `Tagdienst (${fmtEUR(tagPreis)}/Std) â€” ${m} Ã— ${tagH} Std`,
          `Nachtdienst (${fmtEUR(nachtPreisFinal)}/Std) â€” ${m} Ã— ${nachtH} Std`,
          `Sonntag (${fmtEUR(sonntagPreisFinal)}/Std) â€” ${m} Ã— ${sonntagH} Std`,
          `Feiertag (${fmtEUR(feiertagPreisFinal)}/Std) â€” ${m} Ã— ${feiertagH} Std`,
          "",
          `Zwischensumme (netto): ${fmtEUR(subTotal)}`,
          `${vatLine}`,
          `Gesamtbetrag: ${fmtEUR(grandTotal)}`,
          "",
          modeLine,
          b2bLine,
          `Nachtzeit laut Vereinbarung: ${nightText}`,
          "Abrechnung gemÃ¤ÃŸ Einsatzzeiten.",
          note ? `Hinweis: ${note}` : ""
        ].filter(Boolean).join("\n");
      }

      autoSave();
    }

    // ===== Customers =====
    function renderCustomers(){
      const customers = loadJSON(KEY_CUSTOMERS, []);
      const sel = $("customerPick");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "â€” auswÃ¤hlen â€”";
      sel.appendChild(opt0);

      for(const c of customers){
        const o = document.createElement("option");
        o.value = c.id;
        o.textContent = c.name;
        sel.appendChild(o);
      }
      updateCustomerCounts(customers);
    }

    function updateCustomerCounts(customers){
      const cnt = customers.length;
      $("custCount").textContent = String(cnt);
      $("navCustCount").textContent = String(cnt);
    }

    function saveCustomer(){
      const name = String($("custName").value||"").trim();
      const address = String($("custAddress").value||"").trim();
      if(!name || !address){ setStatus("Kunde: Name/Adresse fehlt", false); return; }
      const customers = loadJSON(KEY_CUSTOMERS, []);
      const id = cryptoRandomId();
      customers.push({
        id,
        name,
        email: String($("custEmail").value||"").trim(),
        contact: String($("custContact").value||"").trim(),
        address
      });
      saveJSON(KEY_CUSTOMERS, customers);
      renderCustomers();
      $("customerPick").value = id;
      setStatus("Kunde gespeichert", true);
      renderCustomerList();
    }

    function loadCustomer(id){
      const customers = loadJSON(KEY_CUSTOMERS, []);
      const c = customers.find(x=>x.id===id);
      if(!c) return;
      $("custName").value = c.name || "";
      $("custEmail").value = c.email || "";
      $("custContact").value = c.contact || "";
      $("custAddress").value = c.address || "";
      setStatus("Kunde geladen", true);
      calculate();
    }

    function deleteCustomer(){
      const id = $("customerPick").value;
      if(!id){ setStatus("Kein Kunde ausgewÃ¤hlt", false); return; }
      const customers = loadJSON(KEY_CUSTOMERS, []).filter(x=>x.id!==id);
      saveJSON(KEY_CUSTOMERS, customers);
      renderCustomers();
      $("customerPick").value = "";
      setStatus("Kunde gelÃ¶scht", true);
      renderCustomerList();
    }

    // ===== Invoices =====
    function collectInvoice(){
      const fields = [
        "issuerCompany",
        "issuerAddress","issuerPhone","issuerEmail","issuerTaxNo","issuerVatId",
        "issuerIban","issuerBic","issuerHolder",
        "custName","custEmail","custContact","custAddress",
        "invDate","dueDate","invNo","vatMode","serviceTitle","objekt","zeitraum",
        "mitarbeiter","tagPreis","modus","b2bMode","purpose",
        "shiftStart","shiftEnd","nachtRule",
        "tagH","nachtH","sonntagH","feiertagH",
        "nachtPercent","sonntagPercent","feiertagPercent",
        "nachtFest","sonntagFest","feiertagFest",
        "note","rechnungText"
      ];
      const form = {};
      for(const id of fields){ if($(id)) form[id] = $(id).value; }
      return {
        invNo: $("invNo").value,
        invDate: $("invDate").value,
        custName: $("custName").value,
        serviceTitle: $("serviceTitle").value,
        purpose: $("purpose").value,
        subTotalFmt: $("subTotal").textContent,
        grandTotalFmt: $("grandTotal").textContent,
        logoDataUrl: $("logoImg").src || "",
        form
      };
    }

    function saveInvoice(){
      if(!validateCore()) return;
      const inv = collectInvoice();
      const invoices = loadJSON(KEY_INVOICES, []);
      const idx = invoices.findIndex(x=>x.invNo===inv.invNo);
      if(idx>=0) invoices[idx] = inv; else invoices.unshift(inv);
      saveJSON(KEY_INVOICES, invoices);
      setStatus("Rechnung gespeichert", true);
      renderInvoices();
      updateInvoiceCounts();
    }

    function renderInvoices(){
      const invoices = loadJSON(KEY_INVOICES, []);
      $("invCount").textContent = String(invoices.length);
      $("navInvCount").textContent = String(invoices.length);

      const wrap = $("invList");
      wrap.innerHTML = "";
      for(const inv of invoices){
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <b class="mono">${escapeHtml(inv.invNo)}</b>
            <small>${escapeHtml(inv.invDate)} â€¢ ${escapeHtml(inv.custName)} â€¢ ${escapeHtml(inv.serviceTitle)}</small><br/>
            <small class="mono">Gesamt: ${escapeHtml(inv.grandTotalFmt)} â€¢ Zweck: ${escapeHtml(inv.purpose)}</small>
          </div>
          <div class="btns">
            <button type="button" data-act="load" data-no="${escapeAttr(inv.invNo)}">Laden</button>
            <button type="button" data-act="pdf" data-no="${escapeAttr(inv.invNo)}">PDF</button>
            <button type="button" data-act="del" class="danger" data-no="${escapeAttr(inv.invNo)}">LÃ¶schen</button>
          </div>
        `;
        wrap.appendChild(el);
      }

      wrap.querySelectorAll("button").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const act = b.getAttribute("data-act");
          const no = b.getAttribute("data-no");
          if(act==="load") loadInvoice(no);
          if(act==="del") deleteInvoice(no);
          if(act==="pdf") {
            const inv = loadJSON(KEY_INVOICES, []).find(x=>x.invNo===no);
            if(inv){ await exportPdfFromInvoice(inv); }
          }
        });
      });
    }

    function updateInvoiceCounts(){
      const invoices = loadJSON(KEY_INVOICES, []);
      $("invCount").textContent = String(invoices.length);
      $("navInvCount").textContent = String(invoices.length);
    }

    function loadInvoice(invNo){
      const invoices = loadJSON(KEY_INVOICES, []);
      const inv = invoices.find(x=>x.invNo===invNo);
      if(!inv){ setStatus("Rechnung nicht gefunden", false); return; }
      for(const [k,v] of Object.entries(inv.form || {})){ if($(k)) $(k).value = v; }
      if(inv.logoDataUrl){ setLogo(inv.logoDataUrl, true); }
      setStatus("Rechnung geladen", true);
      calculateDayNight();
      calculate();
      setActiveNav("navCreate","viewCreate");
    }

    function deleteInvoice(invNo){
      const invoices = loadJSON(KEY_INVOICES, []).filter(x=>x.invNo!==invNo);
      saveJSON(KEY_INVOICES, invoices);
      setStatus("Rechnung gelÃ¶scht", true);
      renderInvoices();
      updateInvoiceCounts();
    }

    // ===== wait images before PDF/Print =====
    function waitImagesLoaded(root){
      const imgs = Array.from(root.querySelectorAll("img")).filter(i=>i.src);
      return Promise.all(imgs.map(img => new Promise(res=>{
        if(img.complete) return res();
        img.onload = ()=>res();
        img.onerror = ()=>res();
      })));
    }

    // ===== PDF/Print =====
    function buildPrintHtml(inv){
      const f = inv.form;
      const company = String(f.issuerCompany || "Masculine Security").trim();
      const b2bOn = String(f.b2bMode||"off") === "on";

      const logoSrc = inv.logoDataUrl || $("logoImg").src || "";
      const logo = logoSrc ? `<div class="invLogo"><img src="${escapeAttr(logoSrc)}"/></div>` : "";

      const vatMode = f.vatMode;
      const vatLine = (vatMode==="kmu")
        ? "GemÃ¤ÃŸ Â§19 UStG wird keine Umsatzsteuer berechnet."
        : "Umsatzsteuer 19% wird berechnet und ausgewiesen.";

      const mode = f.modus;
      const modeLine = (mode==="percent")
        ? `ZuschlÃ¤ge gemÃ¤ÃŸ Prozent (auf Tagpreis).`
        : `StundensÃ¤tze laut Vereinbarung (Festpreise).`;

      const m = safeNum(f.mitarbeiter);
      const tagPreis = safeNum(f.tagPreis);
      const tagH = safeNum(f.tagH);
      const nachtH = safeNum(f.nachtH);
      const sonntagH = safeNum(f.sonntagH);
      const feiertagH = safeNum(f.feiertagH);

      let nachtPreisFinal=0, sonntagPreisFinal=0, feiertagPreisFinal=0;
      if(mode==="percent"){
        const nachtP = safeNum(f.nachtPercent);
        const sonntagP = safeNum(f.sonntagPercent);
        const feiertagP = safeNum(f.feiertagPercent);
        nachtPreisFinal = tagPreis + (tagPreis * nachtP/100);
        sonntagPreisFinal = tagPreis + (tagPreis * sonntagP/100);
        feiertagPreisFinal = tagPreis + (tagPreis * feiertagP/100);
      }else{
        nachtPreisFinal = safeNum(f.nachtFest);
        sonntagPreisFinal = safeNum(f.sonntagFest);
        feiertagPreisFinal = safeNum(f.feiertagFest);
      }

      const tagSum = m * tagH * tagPreis;
      const nachtSum = m * nachtH * nachtPreisFinal;
      const sonntagSum = m * sonntagH * sonntagPreisFinal;
      const feiertagSum = m * feiertagH * feiertagPreisFinal;
      const subTotal = tagSum+nachtSum+sonntagSum+feiertagSum;
      const vatRate = (vatMode==="vat19") ? 0.19 : 0;
      const vatAmount = subTotal*vatRate;
      const grand = subTotal+vatAmount;

      const obj = String(f.objekt||"").trim();
      const zr = String(f.zeitraum||"").trim();
      const note = String(f.note||"").trim();
      const nightText = f.nachtRule==="23-06" ? "23:00 â€“ 06:00" : (f.nachtRule==="20-06" ? "20:00 â€“ 06:00" : "22:00 â€“ 06:00");

      const totalHours = tagH + nachtH + sonntagH + feiertagH;
      const qty = m * totalHours;
      const blended = (qty > 0) ? (subTotal / qty) : 0;

      const headerMeta = `
        <div class="invMeta"><b>${escapeHtml(f.serviceTitle||"")}</b></div>
        ${obj ? `<div class="invMeta">Objekt/Ort: ${escapeHtml(obj)}</div>` : ``}
        ${zr ? `<div class="invMeta">Zeitraum: ${escapeHtml(zr)}</div>` : ``}
      `;

      const detailTable = `
        <div class="mini">Nachtzeit laut Vereinbarung: ${escapeHtml(nightText)}</div>
        <table class="invTable">
          <thead>
            <tr>
              <th>Position</th>
              <th class="invRight">Mitarbeiter</th>
              <th class="invRight">Std.</th>
              <th class="invRight">Preis/Std.</th>
              <th class="invRight">Summe</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Tagdienst</td>
              <td class="invRight">${m}</td>
              <td class="invRight">${tagH}</td>
              <td class="invRight">${fmtEUR(tagPreis)}</td>
              <td class="invRight">${fmtEUR(tagSum)}</td>
            </tr>
            <tr>
              <td>Nachtdienst</td>
              <td class="invRight">${m}</td>
              <td class="invRight">${nachtH}</td>
              <td class="invRight">${fmtEUR(nachtPreisFinal)}</td>
              <td class="invRight">${fmtEUR(nachtSum)}</td>
            </tr>
            <tr>
              <td>Sonntag</td>
              <td class="invRight">${m}</td>
              <td class="invRight">${sonntagH}</td>
              <td class="invRight">${fmtEUR(sonntagPreisFinal)}</td>
              <td class="invRight">${fmtEUR(sonntagSum)}</td>
            </tr>
            <tr>
              <td>Feiertag</td>
              <td class="invRight">${m}</td>
              <td class="invRight">${feiertagH}</td>
              <td class="invRight">${fmtEUR(feiertagPreisFinal)}</td>
              <td class="invRight">${fmtEUR(feiertagSum)}</td>
            </tr>
          </tbody>
        </table>
      `;

      const b2bTable = `
        <div class="mini">Einsatzzeiten gemÃ¤ÃŸ Absprache. Abrechnung gemÃ¤ÃŸ Einsatznachweis.</div>
        <table class="invTable">
          <thead>
            <tr>
              <th>Position</th>
              <th class="invRight">Mitarbeiter</th>
              <th class="invRight">Std.</th>
              <th class="invRight">Preis/Std.</th>
              <th class="invRight">Summe</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Sicherheitsdienstleistung (All-in, inkl. ZuschlÃ¤ge)</td>
              <td class="invRight">${m}</td>
              <td class="invRight">${totalHours.toFixed(2)}</td>
              <td class="invRight">${fmtEUR(blended)}</td>
              <td class="invRight">${fmtEUR(subTotal)}</td>
            </tr>
          </tbody>
        </table>
        <div class="mini" style="margin-top:6px">
          Hinweis: Der ausgewiesene Preis/Std. ist ein <b>Durchschnittspreis</b> (berechnet aus Einsatzzeiten inkl. ZuschlÃ¤ge).
        </div>
      `;

      return `
        <div class="invHeader">
          <div class="left">
            ${logo}
            <div>
              <p class="invTitle">Rechnung</p>
              <div class="invBrand">${escapeHtml(company)}</div>
              ${headerMeta}
            </div>
          </div>
          <div class="invBox" style="min-width:260px">
            <div class="line"><span><b>Rechnungsnr.</b></span><span class="mono">${escapeHtml(f.invNo||"")}</span></div>
            <div class="line"><span>Datum</span><span>${escapeHtml(f.invDate||"")}</span></div>
            <div class="line"><span>FÃ¤llig</span><span>${escapeHtml(f.dueDate||"")}</span></div>
            <div class="line"><span>Zweck</span><span class="mono">${escapeHtml(f.purpose||"")}</span></div>
          </div>
        </div>

        <div class="invGrid2" style="margin-top:12px">
          <div class="invBox">
            <h4>Rechnungssteller</h4>
            <div class="mini"><b>${escapeHtml(company)}</b></div>
            <div class="mini">${escapeHtml(f.issuerAddress||"")}</div>
            <div class="mini">Tel: ${escapeHtml(f.issuerPhone||"")}</div>
            <div class="mini">E-Mail: ${escapeHtml(f.issuerEmail||"")}</div>
            <div class="mini">Steuernr./Hinweis: ${escapeHtml(f.issuerTaxNo||"")}</div>
            ${String(f.issuerVatId||"").trim() ? `<div class="mini">USt-IdNr: ${escapeHtml(f.issuerVatId||"")}</div>` : ``}
          </div>

          <div class="invBox">
            <h4>Rechnung an</h4>
            <div class="mini"><b>${escapeHtml(f.custName||"")}</b></div>
            <div class="mini">${escapeHtml(f.custAddress||"").replaceAll("\n","<br/>")}</div>
            ${String(f.custEmail||"").trim() ? `<div class="mini">E-Mail: ${escapeHtml(f.custEmail||"")}</div>` : ``}
            ${String(f.custContact||"").trim() ? `<div class="mini">Ansprechpartner: ${escapeHtml(f.custContact||"")}</div>` : ``}
          </div>
        </div>

        <div class="invBox" style="margin-top:12px">
          <h4>LeistungsÃ¼bersicht</h4>
          ${b2bOn ? b2bTable : detailTable}

          <div class="invTotals">
            <div class="tline"><span>Zwischensumme (netto)</span><span>${fmtEUR(subTotal)}</span></div>
            ${vatRate>0 ? `<div class="tline"><span>USt 19%</span><span>${fmtEUR(vatAmount)}</span></div>` : ``}
            <div class="tline grand"><span>Gesamtbetrag</span><span>${fmtEUR(grand)}</span></div>
          </div>

          <div class="invFooter">
            <div>${escapeHtml(vatLine)}</div>
            <div>${escapeHtml(modeLine)} Abrechnung gemÃ¤ÃŸ Einsatzzeiten.</div>
            <div><b>Leistung:</b> im Rahmen eines Subunternehmer-Einsatzes erbracht.</div>
            ${note ? `<div><b>Hinweis:</b> ${escapeHtml(note)}</div>` : ``}
            <div style="margin-top:10px">
              <b>Bankverbindung:</b> IBAN ${escapeHtml(f.issuerIban||"")} â€¢ BIC ${escapeHtml(f.issuerBic||"")} â€¢ Inhaber ${escapeHtml(f.issuerHolder||"")}
            </div>
          </div>
        </div>
      `;
    }

    async function exportPdf(){
      if(!validateCore()) return;
      const inv = collectInvoice();
      await exportPdfFromInvoice(inv);
    }

    async function exportPdfFromInvoice(inv){
      const printArea = $("printArea");
      printArea.innerHTML = buildPrintHtml(inv);
      $("printAreaWrap").style.display = "block";
      await waitImagesLoaded(printArea);

      const canvas = await html2canvas(printArea, {scale:2, useCORS:true, backgroundColor:"#ffffff"});
      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;

      const pdf = new jsPDF("p","mm","a4");
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const imgProps = pdf.getImageProperties(imgData);
      const imgW = pageW;
      const imgH = (imgProps.height * imgW) / imgProps.width;

      if(imgH <= pageH){
        pdf.addImage(imgData, "PNG", 0, 0, imgW, imgH);
      }else{
        let y = 0;
        let remaining = imgH;
        while(remaining > 0){
          pdf.addImage(imgData, "PNG", 0, y ? -y : 0, imgW, imgH);
          remaining -= pageH;
          if(remaining > 0) pdf.addPage();
          y += pageH;
        }
      }

      pdf.save(`${inv.invNo}.pdf`);
      $("printAreaWrap").style.display = "none";
      setStatus("PDF gespeichert", true);
    }

    async function doPrint(){
      if(!validateCore()) return;
      const inv = collectInvoice();
      $("printArea").innerHTML = buildPrintHtml(inv);
      $("printAreaWrap").style.display = "block";
      await waitImagesLoaded($("printArea"));
      window.print();
      $("printAreaWrap").style.display = "none";
    }

    // ===== Auto Save =====
    let autoSaveTimer = null;
    function autoSave(){
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(()=>{
        const state = collectInvoice().form;
        saveJSON(KEY_APP, state);
      }, 250);
    }
    function restoreAutoSave(){
      const state = loadJSON(KEY_APP, null);
      if(!state) return;
      for(const [k,v] of Object.entries(state)){
        if($(k)) $(k).value = v;
      }
    }

    // ===== Customers list view =====
    function renderCustomerList(){
      const wrap = $("custList");
      if(!wrap) return;
      const customers = loadJSON(KEY_CUSTOMERS, []);
      $("custCount").textContent = String(customers.length);
      $("navCustCount").textContent = String(customers.length);

      wrap.innerHTML = "";
      customers.forEach(c=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <b>${escapeHtml(c.name||"")}</b>
            <small>${escapeHtml((c.address||"").slice(0,120))}${(c.address||"").length>120?"â€¦":""}</small>
          </div>
          <div class="btns">
            <button type="button" data-id="${escapeAttr(c.id)}">AuswÃ¤hlen</button>
          </div>
        `;
        wrap.appendChild(el);
      });

      wrap.querySelectorAll("button[data-id]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-id");
          $("customerPick").value = id;
          $("customerPick").dispatchEvent(new Event("change"));
          setActiveNav("navCreate","viewCreate");
        });
      });
    }

    // ===== Nav =====
    function setActiveNav(btnId, viewId){
      ["navCreate","navInvoices","navCustomers","navSettings"].forEach(id=>{
        const b = $(id);
        if(b) b.classList.toggle("active", id===btnId);
      });
      ["viewCreate","viewInvoices","viewCustomers","viewSettings"].forEach(id=>{
        const v = $(id);
        if(v) v.classList.toggle("active", id===viewId);
      });
    }

    function syncCompanyMirror(){
      const main = $("issuerCompany");
      const mir = $("issuerCompanyMirror");
      if(!main || !mir) return;
      mir.value = main.value || "";
      mir.oninput = ()=>{
        main.value = mir.value;
        calculate();
      };
    }

    function wireSidebar(){
      $("navCreate")?.addEventListener("click", ()=> setActiveNav("navCreate","viewCreate"));
      $("navInvoices")?.addEventListener("click", ()=>{
        setActiveNav("navInvoices","viewInvoices");
        renderInvoices();
      });
      $("navCustomers")?.addEventListener("click", ()=>{
        setActiveNav("navCustomers","viewCustomers");
        renderCustomerList();
      });
      $("navSettings")?.addEventListener("click", ()=>{
        setActiveNav("navSettings","viewSettings");
        syncCompanyMirror();
      });

      $("btnLogo2")?.addEventListener("click", ()=> $("logoFile")?.click());
    }

    // ===== UI actions =====
    function resetAll(){
      localStorage.removeItem(KEY_APP);
      location.reload();
    }

    function newInvoice(){
      const keep = [
        "issuerCompany","issuerAddress","issuerPhone","issuerEmail","issuerTaxNo","issuerVatId","issuerIban","issuerBic","issuerHolder",
        "custName","custEmail","custContact","custAddress","customerPick",
        "vatMode","serviceTitle","objekt","zeitraum",
        "mitarbeiter","tagPreis","modus","b2bMode",
        "nachtPercent","sonntagPercent","feiertagPercent",
        "nachtFest","sonntagFest","feiertagFest",
        "nachtRule"
      ];
      const snapshot = {};
      keep.forEach(id=>{ if($(id)) snapshot[id] = $(id).value; });

      document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.id==="logoFile") return;
        if(el.type==="date") return;
        el.value = "";
      });

      Object.entries(snapshot).forEach(([id,val])=>{ if($(id)) $(id).value = val; });

      $("invDate").value = todayISO();
      $("dueDate").value = addDaysISO($("invDate").value, 14);
      $("invNo").value = nextInvoiceNo($("invDate").value);

      $("shiftStart").value = "18:00";
      $("shiftEnd").value = "06:00";
      calculateDayNight();

      $("sonntagH").value = 0;
      $("feiertagH").value = 0;
      $("note").value = "";
      $("rechnungText").value = "";

      setStatus("Neue Rechnung", true);
      calculate();
    }

    // ===== Security helpers =====
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }
    function cryptoRandomId(){
      if(window.crypto?.getRandomValues){
        const a = new Uint32Array(2);
        window.crypto.getRandomValues(a);
        return a[0].toString(16)+a[1].toString(16);
      }
      return String(Date.now()) + Math.random().toString(16).slice(2);
    }

    // ===== Wire =====
    function wire(){
      $("btnCall").addEventListener("click", ()=>{
        const tel = String($("issuerPhone").value || "015778697052").replace(/\s+/g,"");
        window.location.href = `tel:${tel}`;
      });
      $("btnMail").addEventListener("click", ()=>{
        const mail = String($("issuerEmail").value || "Kontakt.mass.bremen@hotmail.com").trim();
        window.location.href = `mailto:${mail}`;
      });

      // logo
      $("btnLogo").addEventListener("click", ()=> $("logoFile").click());
      $("logoFile").addEventListener("change", (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        const rd = new FileReader();
        rd.onload = ()=> { setLogo(String(rd.result||""), true); setStatus("Logo gespeichert", true); };
        rd.readAsDataURL(file);
      });

      // header actions
      $("btnPdf").addEventListener("click", exportPdf);
      $("btnPrint").addEventListener("click", doPrint);
      $("btnReset").addEventListener("click", resetAll);
      $("btnNew").addEventListener("click", newInvoice);
      $("btnSave").addEventListener("click", saveInvoice);
      $("btnList").addEventListener("click", ()=>{
        setActiveNav("navInvoices","viewInvoices");
        renderInvoices();
      });

      // customers
      $("btnSaveCustomer").addEventListener("click", saveCustomer);
      $("btnDeleteCustomer").addEventListener("click", deleteCustomer);
      $("customerPick").addEventListener("change", (e)=> loadCustomer(e.target.value));

      // date change
      $("invDate").addEventListener("change", ()=>{
        $("dueDate").value = addDaysISO($("invDate").value, 14);
        $("invNo").value = nextInvoiceNo($("invDate").value);
        calculate();
      });

      // changes
      $("vatMode").addEventListener("change", calculate);
      $("modus").addEventListener("change", calculate);
      $("b2bMode").addEventListener("change", calculate);

      // auto day/night
      $("shiftStart").addEventListener("input", ()=>{ calculateDayNight(); calculate(); });
      $("shiftEnd").addEventListener("input", ()=>{ calculateDayNight(); calculate(); });
      $("nachtRule").addEventListener("change", ()=>{ calculateDayNight(); calculate(); });

      // input auto calc
      document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.id==="logoFile") return;
        if(el.id==="shiftStart" || el.id==="shiftEnd" || el.id==="nachtRule") return;
        el.addEventListener("input", calculate);
      });

      wireSidebar();
    }

    // ===== Init =====
    function initDefaults(){
      $("invDate").value = $("invDate").value || todayISO();
      $("dueDate").value = $("dueDate").value || addDaysISO($("invDate").value, 14);
      $("invNo").value = $("invNo").value || nextInvoiceNo($("invDate").value);
      updateVatHint();
      updatePurpose();
      renderCustomers();
      toggleModeUI();
      toggleB2BUI();
      calculateDayNight();
      renderInvoices();
      renderCustomerList();
      syncCompanyMirror();
      setStatus("Bereit", true);
    }

    // ===== Boot =====
    window.addEventListener("load", ()=>{
      loadLogo();
      restoreAutoSave();
      wire();
      initDefaults();
      calculate();
    });
  </script>
</body>
</html>
