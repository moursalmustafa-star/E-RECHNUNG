<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Masculine Security — Rechnung (Auto Stunden)</title>

<style>
/* NO THEME (clean white, professional) */
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#111;padding:18px}
.wrap{max-width:980px;margin:0 auto}
.header{display:flex;align-items:center;justify-content:space-between;gap:14px;border-bottom:2px solid #e5e5e5;padding-bottom:10px;margin-bottom:14px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:44px;height:44px;border:1px solid #ddd;border-radius:8px;overflow:hidden;display:grid;place-items:center;background:#fff}
.logo img{width:100%;height:100%;object-fit:cover;display:block}
.h1{font-weight:900;font-size:18px}
.small{font-size:12px;color:#444}
.actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.btn{border:1px solid #ddd;background:#fff;padding:9px 12px;border-radius:10px;font-weight:800;font-size:13px;cursor:pointer}
.btn.primary{background:#111;color:#fff;border-color:#111}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.card{border:1px solid #ddd;border-radius:12px;padding:12px}
.title{font-size:12px;font-weight:900;color:#333;text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px}
label{display:block;font-size:12px;font-weight:900;color:#222;margin-top:10px}
input,select,textarea{width:100%;padding:9px 10px;border:1px solid #ddd;border-radius:10px;font-size:14px;outline:none;background:#fff}
textarea{min-height:70px;resize:vertical}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.tableWrap{margin-top:12px;border:1px solid #ddd;border-radius:12px;overflow:hidden}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:13.5px}
th{background:#fafafa;font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:#333}
td.right,th.right{text-align:right}
tfoot td{border-bottom:none}
.note{font-size:12px;color:#444;margin-top:8px;line-height:1.5}
.sumBox{margin-top:12px;border:1px solid #ddd;border-radius:12px;padding:12px}
.sumRow{display:flex;justify-content:space-between;gap:10px;padding:6px 0}
.sumRow span{color:#444;font-weight:800}
.sumRow b{font-weight:900}
.sumRow.total{border-top:1px dashed #ccc;margin-top:8px;padding-top:10px;font-size:16px}
a{color:#111}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
@page{size:A4;margin:10mm}
@media print{
  .actions{display:none !important}
  body{padding:0}
  input,select,textarea{border:none !important;padding:0 !important}
  textarea{min-height:0 !important}
}
</style>
</head>

<body>
<div class="wrap" id="app">

  <div class="header">
    <div class="brand">
      <div class="logo"><img id="logoImg" src="logo.png" alt="Logo"></div>
      <div>
        <div class="h1">Masculine Security — Rechnung</div>
        <div class="small">Auto Stunden (Total + Grundlohn) · Zuschläge · USt · Auto-Save</div>
      </div>
    </div>
    <div class="actions">
      <label class="btn" style="margin:0">
        Logo ändern <input id="logoFile" type="file" accept="image/*" style="display:none">
      </label>
      <button class="btn" id="btnNew" type="button">Neu</button>
      <button class="btn" id="btnSave" type="button">Speichern</button>
      <button class="btn" id="btnReset" type="button">Reset</button>
      <button class="btn primary" type="button" onclick="window.print()">PDF drucken</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="title">Rechnungssteller & Kunde</div>

      <div style="font-size:14px;line-height:1.45">
        <b>Masculine Security</b><br>
        Werschenregerstraße 6 · 28237 Bremen<br>
        Tel: <a href="tel:+4915778697052">015778697052</a> ·
        E-Mail: <a href="mailto:Kontakt.mass.bremen@hotmail.com">Kontakt.mass.bremen@hotmail.com</a><br>
        <span class="small">Steuernummer: (in Bearbeitung)</span>
      </div>

      <label>Kunde (Auswahl)</label>
      <div class="row2" style="grid-template-columns:1fr auto">
        <select id="kundeSelect"></select>
        <button class="btn" id="btnKundeNew" type="button">Neu</button>
      </div>

      <div class="row2">
        <div>
          <label>Kundenname (zum Speichern)</label>
          <input id="kundeName" placeholder="Firma / Name">
        </div>
        <div>
          <label>E-Mail (optional)</label>
          <input id="kundeEmail" placeholder="kunde@example.com">
        </div>
      </div>

      <label>Kundendaten</label>
      <textarea id="kundeText" placeholder="Firma / Name&#10;Straße Hausnr.&#10;PLZ Ort&#10;Ansprechpartner (optional)"></textarea>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnKundeSave" type="button">Kunde speichern</button>
        <button class="btn" id="btnKundeDelete" type="button">Kunde löschen</button>
      </div>

      <div class="row2">
        <div>
          <label>Einsatzort / Objekt</label>
          <input id="objekt" placeholder="z.B. Hotel / Baustelle / Adresse">
        </div>
        <div>
          <label>Leistungszeitraum</label>
          <input id="zeitraum" placeholder="z.B. 01.02.2026 – 15.02.2026">
        </div>
      </div>

      <label>Leistungsbeschreibung</label>
      <textarea id="leistung">Security Dienstleistung</textarea>

      <label>Referenz / PO (optional)</label>
      <input id="ref" placeholder="z.B. Auftrag-Nr. / Ansprechpartner">
    </div>

    <div class="card">
      <div class="title">Rechnungsdaten & Auto-Stunden</div>

      <div class="row2">
        <div>
          <label>Rechnungsdatum</label>
          <input id="invDate" type="date">
        </div>
        <div>
          <label>Zahlungsziel</label>
          <select id="terms">
            <option value="7">7 Tage</option>
            <option value="14" selected>14 Tage</option>
            <option value="21">21 Tage</option>
            <option value="30">30 Tage</option>
          </select>
        </div>
      </div>

      <div class="row2">
        <div>
          <label>Fällig am (Auto)</label>
          <input id="dueDate" type="date" readonly>
        </div>
        <div>
          <label>Rechnungsnummer (Auto)</label>
          <input id="invNo" readonly>
        </div>
      </div>

      <div class="row2">
        <div>
          <label>USt-Status</label>
          <select id="vatMode">
            <option value="0" selected>0% (Kleinunternehmer §19)</option>
            <option value="19">19% (Regelbesteuerung)</option>
          </select>
        </div>
        <div>
          <label>Stundensatz (€/h)</label>
          <input id="rate" type="number" min="0" step="0.01" value="25">
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Anzahl Mitarbeiter</label>
          <input id="ma_count" type="number" min="0" step="1" placeholder="z.B. 10">
        </div>
        <div>
          <label>Ø Std/MA</label>
          <input id="hours_per_ma" type="number" min="0" step="0.25" placeholder="z.B. 216">
        </div>
        <div>
          <label>Stunden gesamt (Auto)</label>
          <input id="hours_total" type="number" readonly>
        </div>
      </div>

      <div class="note" id="vatHint"></div>
      <div class="note" style="margin-top:6px">
        <b>Auto-Regel:</b><br>
        1) Wenn Mitarbeiter + Ø Std/MA da sind → Stunden gesamt = MA × Ø<br>
        2) Sonst → Stunden gesamt = Summe der Zeilenstunden<br>
        3) Grundlohn-Stunden = Stunden gesamt − (Nacht + Sonntag + Feiertag)
      </div>
    </div>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Position</th>
          <th style="width:160px">Stunden</th>
          <th style="width:140px">Zuschlag %</th>
          <th class="right" style="width:180px">Betrag</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><b>Grundlohn</b><div class="small">automatisch berechnet</div></td>
          <td><input id="h_base" type="number" readonly></td>
          <td class="small">—</td>
          <td class="right" id="sum_base">0,00 €</td>
        </tr>
        <tr>
          <td><b>Nachtschicht</b><div class="small">Zuschlag</div></td>
          <td><input id="h_night" type="number" min="0" step="0.25" placeholder="0"></td>
          <td><input id="p_night" type="number" min="0" step="0.1" value="5"></td>
          <td class="right" id="sum_night">0,00 €</td>
        </tr>
        <tr>
          <td><b>Sonntag</b><div class="small">Zuschlag</div></td>
          <td><input id="h_sun" type="number" min="0" step="0.25" placeholder="0"></td>
          <td><input id="p_sun" type="number" min="0" step="0.1" value="50"></td>
          <td class="right" id="sum_sun">0,00 €</td>
        </tr>
        <tr>
          <td><b>Feiertag</b><div class="small">Zuschlag</div></td>
          <td><input id="h_hol" type="number" min="0" step="0.25" placeholder="0"></td>
          <td><input id="p_hol" type="number" min="0" step="0.1" value="100"></td>
          <td class="right" id="sum_hol">0,00 €</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="sumBox">
    <div class="sumRow"><span>Zwischensumme (Netto)</span><b id="netto">0,00 €</b></div>
    <div class="sumRow"><span>Umsatzsteuer</span><b id="vat">0,00 €</b></div>
    <div class="sumRow total"><span>Gesamt</span><b id="total">0,00 €</b></div>
    <div class="note" id="legalNote"></div>
    <div class="note" style="margin-top:8px">
      <b>Bank:</b> MUSTAFA MURSAL ABDI · IBAN: DE98 1001 1001 2333 0146 96 · BIC: NTSBDEB1XXX
    </div>
  </div>

</div>

<script>
/* ONE FILE · AUTO STUNDEN · NO THEME */
const LS_STATE="ms_simple_autostunden_v1";
const LS_CUSTOMERS="ms_customers_simple_v1";
const LS_COUNTER="ms_counter_simple_v1";
const $=id=>document.getElementById(id);

const pad2=n=>String(n).padStart(2,"0");
const toISO=d=>{const x=new Date(d);return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;}
const num=el=>{const v=parseFloat(el.value);return Number.isFinite(v)?v:0;}
const money=x=>(x||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})+" €";

function nextInvoiceNo(){
  const d=new Date();
  const key=`${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}`;
  let store={}; try{store=JSON.parse(localStorage.getItem(LS_COUNTER)||"{}")}catch(e){store={}}
  store[key]=(store[key]||0)+1;
  localStorage.setItem(LS_COUNTER,JSON.stringify(store));
  return `MS-${key}-${store[key]}`;
}

function setDue(){
  const days=parseInt($("terms").value,10)||14;
  const inv=$("invDate").value||toISO(new Date());
  $("invDate").value=inv;
  const base=new Date(inv); const due=new Date(base); due.setDate(due.getDate()+days);
  $("dueDate").value=toISO(due);
}

function updateVatText(){
  const v=$("vatMode").value;
  if(v==="0"){
    $("vatHint").textContent="Gemäß §19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).";
    $("legalNote").textContent="Gemäß §19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).";
  }else{
    $("vatHint").textContent="Umsatzsteuer wird gemäß Regelbesteuerung ausgewiesen (19%).";
    $("legalNote").textContent="Umsatzsteuer wird gemäß Regelbesteuerung ausgewiesen (19%).";
  }
}

function getCustomers(){
  try{const a=JSON.parse(localStorage.getItem(LS_CUSTOMERS)||"[]");return Array.isArray(a)?a:[]}catch(e){return []}
}
function setCustomers(a){localStorage.setItem(LS_CUSTOMERS,JSON.stringify(a))}
function refreshCustomerSelect(selected=""){
  const sel=$("kundeSelect");
  const list=getCustomers().slice().sort((a,b)=>(a.name||"").localeCompare(b.name||"","de"));
  sel.innerHTML=`<option value="">— Kunde wählen —</option>`+list.map(c=>{
    const n=(c.name||"").replace(/"/g,"&quot;");
    return `<option value="${n}">${n}</option>`;
  }).join("");
  sel.value=selected||"";
}
function loadCustomer(){
  const name=$("kundeSelect").value;
  const c=getCustomers().find(x=>x.name===name);
  if(!c) return;
  $("kundeName").value=c.name||"";
  $("kundeEmail").value=c.email||"";
  $("kundeText").value=c.text||"";
  saveSoon();
}
function saveCustomer(){
  const name=($("kundeName").value||"").trim();
  const email=($("kundeEmail").value||"").trim();
  const text=($("kundeText").value||"").trim();
  if(!name){alert("Bitte Kundenname eingeben.");return;}
  if(!text){alert("Bitte Kundendaten eingeben.");return;}
  const list=getCustomers();
  const idx=list.findIndex(x=>x.name===name);
  const entry={name,email,text,updatedAt:Date.now()};
  if(idx>=0) list[idx]=entry; else list.push(entry);
  setCustomers(list);
  refreshCustomerSelect(name);
  $("kundeSelect").value=name;
  saveSoon();
}
function deleteCustomer(){
  const name=$("kundeSelect").value || ($("kundeName").value||"").trim();
  if(!name){alert("Kein Kunde ausgewählt.");return;}
  if(!confirm(`Kunde "${name}" löschen?`)) return;
  const list=getCustomers().filter(x=>x.name!==name);
  setCustomers(list);
  refreshCustomerSelect("");
  $("kundeName").value=""; $("kundeEmail").value=""; $("kundeText").value="";
  saveSoon();
}

async function embedLogoIfNeeded(){
  try{
    const img=$("logoImg");
    if((img.getAttribute("src")||"").startsWith("data:")) return;
    const res=await fetch("logo.png",{cache:"no-store"});
    if(!res.ok) return;
    const blob=await res.blob();
    const r=new FileReader();
    r.onload=()=>{img.src=String(r.result);saveSoon();}
    r.readAsDataURL(blob);
  }catch(e){}
}
$("logoFile").addEventListener("change",e=>{
  const f=e.target.files && e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>{$("logoImg").src=String(r.result);saveSoon();}
  r.readAsDataURL(f);
});

function autoHours(){
  // 1) If MA + Ø given => total = MA * Ø
  const ma=Math.max(0,Math.floor(num($("ma_count"))));
  const per=num($("hours_per_ma"));
  const hNight=num($("h_night"));
  const hSun=num($("h_sun"));
  const hHol=num($("h_hol"));

  let total=0;

  if(ma>0 && per>0){
    total=ma*per;
  }else{
    // 2) else total = sum of rows (base+others) but base is auto, so use others + (base current)
    const hBaseCur=num($("h_base"));
    total=hBaseCur+hNight+hSun+hHol;
  }

  // 3) base = total - (others)
  let hBase=total-(hNight+hSun+hHol);
  if(hBase<0) hBase=0;

  $("hours_total").value=total>0?total.toFixed(2):"";
  $("h_base").value=total>0?hBase.toFixed(2):"";

  calc();
}

function calc(){
  const rate=num($("rate"));
  const hBase=num($("h_base"));
  const hNight=num($("h_night"));
  const hSun=num($("h_sun"));
  const hHol=num($("h_hol"));

  const pNight=num($("p_night"));
  const pSun=num($("p_sun"));
  const pHol=num($("p_hol"));

  const base=hBase*rate;
  const night=hNight*rate*(pNight/100);
  const sun=hSun*rate*(pSun/100);
  const hol=hHol*rate*(pHol/100);

  $("sum_base").textContent=money(base);
  $("sum_night").textContent=money(night);
  $("sum_sun").textContent=money(sun);
  $("sum_hol").textContent=money(hol);

  const net=Math.max(0,base+night+sun+hol);
  const vatRate=(parseFloat($("vatMode").value)||0)/100;
  const vat=net*vatRate;
  const total=net+vat;

  $("netto").textContent=money(net);
  $("vat").textContent=money(vat);
  $("total").textContent=money(total);

  saveSoon();
}

let t;
function saveSoon(){clearTimeout(t);t=setTimeout(saveState,140);}
function saveState(){
  const state={
    logoSrc:$("logoImg").src||"logo.png",
    invDate:$("invDate").value, dueDate:$("dueDate").value, invNo:$("invNo").value,
    terms:$("terms").value, vatMode:$("vatMode").value, rate:$("rate").value,

    kundeSelect:$("kundeSelect").value,
    kundeName:$("kundeName").value, kundeEmail:$("kundeEmail").value, kundeText:$("kundeText").value,

    objekt:$("objekt").value, zeitraum:$("zeitraum").value, leistung:$("leistung").value, ref:$("ref").value,

    ma_count:$("ma_count").value, hours_per_ma:$("hours_per_ma").value,
    h_night:$("h_night").value, h_sun:$("h_sun").value, h_hol:$("h_hol").value,
    p_night:$("p_night").value, p_sun:$("p_sun").value, p_hol:$("p_hol").value
  };
  localStorage.setItem(LS_STATE,JSON.stringify(state));
}

function loadState(){
  try{
    const raw=localStorage.getItem(LS_STATE);
    if(!raw) return false;
    const s=JSON.parse(raw);

    if(s.logoSrc) $("logoImg").src=s.logoSrc;

    $("invDate").value=s.invDate||"";
    $("dueDate").value=s.dueDate||"";
    $("invNo").value=s.invNo||"";
    $("terms").value=s.terms||"14";
    $("vatMode").value=s.vatMode||"0";
    $("rate").value=s.rate||"25";

    refreshCustomerSelect(s.kundeSelect||"");
    $("kundeName").value=s.kundeName||"";
    $("kundeEmail").value=s.kundeEmail||"";
    $("kundeText").value=s.kundeText||"";

    $("objekt").value=s.objekt||"";
    $("zeitraum").value=s.zeitraum||"";
    $("leistung").value=s.leistung||"Security Dienstleistung";
    $("ref").value=s.ref||"";

    $("ma_count").value=s.ma_count||"";
    $("hours_per_ma").value=s.hours_per_ma||"";

    $("h_night").value=s.h_night||"";
    $("h_sun").value=s.h_sun||"";
    $("h_hol").value=s.h_hol||"";

    $("p_night").value=s.p_night||"5";
    $("p_sun").value=s.p_sun||"50";
    $("p_hol").value=s.p_hol||"100";

    return true;
  }catch(e){return false;}
}

function newInvoice(){
  $("invNo").value=nextInvoiceNo();
  $("invDate").value=toISO(new Date());
  setDue();
  saveSoon();
}

$("btnNew").addEventListener("click",()=>{newInvoice();autoHours();});
$("btnSave").addEventListener("click",()=>{saveState();alert("Gespeichert ✓");});
$("btnReset").addEventListener("click",()=>{
  if(!confirm("Reset? (Eingaben löschen, Kundenliste bleibt)")) return;
  localStorage.removeItem(LS_STATE);
  location.reload();
});

$("kundeSelect").addEventListener("change",loadCustomer);
$("btnKundeNew").addEventListener("click",()=>{$("kundeSelect").value="";$("kundeName").value="";$("kundeEmail").value="";$("kundeText").value="";saveSoon();});
$("btnKundeSave").addEventListener("click",saveCustomer);
$("btnKundeDelete").addEventListener("click",deleteCustomer);

["invDate","terms"].forEach(id=>$(id).addEventListener("change",()=>{setDue();saveSoon();}));
$("vatMode").addEventListener("change",()=>{updateVatText();calc();});
["rate","p_night","p_sun","p_hol"].forEach(id=>$(id).addEventListener("input",calc));

["ma_count","hours_per_ma","h_night","h_sun","h_hol"].forEach(id=>{
  $(id).addEventListener("input",autoHours);
  $(id).addEventListener("change",autoHours);
});

["kundeName","kundeEmail","kundeText","objekt","zeitraum","leistung","ref"].forEach(id=>{
  $(id).addEventListener("input",saveSoon);
});

(function init(){
  refreshCustomerSelect("");
  const loaded=loadState();

  if(!$("invNo").value) newInvoice();
  if(!$("invDate").value) $("invDate").value=toISO(new Date());
  setDue();
  updateVatText();

  // embed logo for PDF printing
  embedLogoIfNeeded();

  // IMPORTANT: Always enforce automatic hours (no mismatch)
  autoHours();
  calc();
})();
</script>
</body>
</html>
