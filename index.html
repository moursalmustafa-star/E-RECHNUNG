<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Rechnung</title>
  <meta name="theme-color" content="#0b3a78"/>

  <style>
    :root{
      --blue:#0b3a78;
      --blue2:#0a2f62;
      --bg:#f3f6fb;
      --card:#ffffff;
      --ink:#0d1b2a;
      --muted:#5b6b7a;
      --line:#e3e9f2;
      --good:#1aa36f;
      --bad:#c0392b;
      --shadow:0 10px 26px rgba(11,58,120,.12);
      --r:16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", Helvetica;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:var(--bg);color:var(--ink)}
    .topbar{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(90deg,var(--blue),#1b64c8);
      color:#fff;border-bottom:1px solid rgba(255,255,255,.18);
    }
    .topbar .inner{max-width:1180px;margin:0 auto;padding:12px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center;min-width:260px}
    .brandLogo{
      width:36px;height:36px;border-radius:10px;overflow:hidden;
      background:rgba(255,255,255,.14);
      display:grid;place-items:center;border:1px solid rgba(255,255,255,.22)
    }
    .brandLogo img{width:100%;height:100%;object-fit:cover;display:block}
    .brandTitle{display:flex;flex-direction:column;line-height:1.1}
    .brandTitle b{font-size:15px}
    .brandTitle span{font-size:12px;opacity:.9}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:1px solid rgba(255,255,255,.28);
      background:rgba(255,255,255,.14);
      color:#fff;padding:8px 10px;border-radius:999px;
      font-weight:700;font-size:12px;cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;
    }
    .btn:hover{background:rgba(255,255,255,.2)}
    .btn.primary{background:#fff;color:var(--blue);border-color:#fff}
    .btn.primary:hover{background:#eef5ff}
    .btn.danger{background:rgba(192,57,43,.18);border-color:rgba(255,255,255,.35)}
    .badge{
      padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;
      background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.28);
      cursor:pointer;user-select:none;
      display:inline-flex;align-items:center;gap:8px;
    }
    .badge .dot{width:8px;height:8px;border-radius:50%}
    .wrap{max-width:1180px;margin:18px auto;padding:0 14px 22px}
    .grid{display:grid;grid-template-columns:1.05fr 1.1fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--r);
      box-shadow:var(--shadow);overflow:hidden;
    }
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:13px;letter-spacing:.35px;text-transform:uppercase;color:var(--muted)}
    .card .body{padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){.row{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted);font-weight:700}
    input, select, textarea{
      width:100%;
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#fff;color:var(--ink);outline:none;
      font-size:14px;
    }
    textarea{min-height:84px;resize:vertical}
    input:focus, select:focus, textarea:focus{border-color:#b6cdf4;box-shadow:0 0 0 3px rgba(27,100,200,.12)}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    .hr{height:1px;background:var(--line);margin:12px 0}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:14px}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.35px;text-align:left}
    td.r, th.r{text-align:right}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:#f8fbff;font-weight:800;font-size:12px;color:var(--blue2)
    }
    .sumGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media (max-width:680px){.sumGrid{grid-template-columns:1fr}}
    .sumBox{
      border:1px solid var(--line);border-radius:14px;background:#fbfdff;
      padding:12px
    }
    .sumBox b{display:block;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.35px}
    .sumBox .v{font-size:20px;font-weight:900;margin-top:6px}
    .footerNote{
      margin-top:12px;
      border:1px dashed #cfe0ff;background:#f6f9ff;border-radius:14px;padding:10px 12px;
      color:#1e3a66;font-size:12px
    }
    .miniBtns{display:flex;gap:8px;flex-wrap:wrap}
    .mini{
      padding:9px 10px;border-radius:12px;border:1px solid var(--line);
      background:#fff;cursor:pointer;font-weight:800;font-size:12px;color:var(--blue)
    }
    .mini:hover{background:#f3f7ff}
    .mini.red{color:var(--bad)}
    .list{display:flex;flex-direction:column;gap:10px}
    .invItem{
      border:1px solid var(--line);border-radius:14px;background:#fff;padding:10px 12px;
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between
    }
    .invItem b{display:block}
    .invItem small{color:var(--muted)}
    .invItem .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .tiny{padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:800;font-size:12px;color:var(--blue)}
    .tiny:hover{background:#f3f7ff}
    .tiny.red{color:var(--bad)}
    /* PRINT */
    @media print{
      body{background:#fff}
      .topbar,.noPrint{display:none !important}
      .wrap{max-width:860px;margin:0;padding:0}
      .card{box-shadow:none;border:0;border-radius:0}
      .grid{grid-template-columns:1fr;gap:0}
      .card h3{border:0}
      input,select,textarea{border:0;padding:0}
      .sumBox{border:1px solid #ddd}
      .footerNote{border:1px solid #ddd;background:#fff}
      a{color:inherit;text-decoration:none}
    }
  </style>
</head>

<body>
  <div class="topbar noPrint">
    <div class="inner">
      <div class="brand">
        <div class="brandLogo" title="Logo">
          <img id="logoImg" src="logo.png" alt="Logo" onerror="this.style.display='none';"/>
        </div>
        <div class="brandTitle">
          <b>Masculine Security — Rechnung</b>
          <span>99% Auto · Auto Datum · Auto Rechnungsnummer · Kundenliste · Zuschläge · PDF · Save</span>
        </div>
      </div>

      <div class="actions">
        <div id="autoBadge" class="badge" onclick="toggleSchichtMode()" title="Klicken: Modus wechseln">
          <span class="dot" id="autoDot"></span>
          <span id="autoText">Schicht-Modus: AN</span>
        </div>
        <button class="btn" onclick="changeLogo()">Logo ändern</button>
        <button class="btn" onclick="resetForm()">Neu</button>
        <button class="btn primary" onclick="saveInvoice()">Rechnung speichern</button>
        <button class="btn" onclick="openInvoices()">Rechnungen</button>
        <button class="btn danger" onclick="hardReset()">Reset</button>
        <button class="btn primary" onclick="printPDF()">PDF speichern</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: Seller + Customer + Service -->
      <div class="card">
        <h3>Rechnungssteller & Kunde</h3>
        <div class="body">
          <div class="row">
            <div class="field">
              <label>Firma</label>
              <input id="sellerName" value="Masculine Security"/>
            </div>
            <div class="field">
              <label>Status (Auto)</label>
              <div class="pill" id="statusPill">Entwurf</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Adresse</label>
              <input id="sellerAddr" value="Werschenregerstraße 6 · 28237 Bremen"/>
            </div>
            <div class="field">
              <label>Telefon</label>
              <input id="sellerTel" value="015778697052"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>E-Mail</label>
              <input id="sellerMail" value="Kontakt.mass.bremen@hotmail.com"/>
            </div>
            <div class="field">
              <label>Steuernummer</label>
              <input id="sellerTax" value="in Bearbeitung"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>IBAN</label>
              <input id="sellerIBAN" value="DE98 1001 1001 2333 0146 96"/>
            </div>
            <div class="field">
              <label>BIC</label>
              <input id="sellerBIC" value="NTSBDEB1XXX"/>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="field">
              <label>Kunde auswählen</label>
              <select id="customerSelect" onchange="loadCustomerFromSelect()">
                <option value="">— Kunde wählen —</option>
              </select>
              <div class="miniBtns" style="margin-top:8px">
                <button class="mini" onclick="newCustomer()">Neu</button>
                <button class="mini red" onclick="deleteCustomer()">Kunde löschen</button>
              </div>
            </div>
            <div class="field">
              <label>Kundenname (zum Speichern)</label>
              <input id="custName" placeholder="Firma / Name"/>
              <label style="margin-top:6px">E-Mail (optional)</label>
              <input id="custMail" placeholder="kunde@email.de"/>
            </div>
          </div>

          <div class="field" style="margin-top:10px">
            <label>Kundendaten (Adresse / Ansprechpartner)</label>
            <textarea id="custData" placeholder="Straße · PLZ Ort&#10;Ansprechpartner"></textarea>
          </div>

          <div class="miniBtns" style="margin-top:10px">
            <button class="mini" onclick="saveCustomer()">Kunde speichern</button>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="field">
              <label>Einsatzort / Objekt</label>
              <input id="objekt" placeholder="z.B. Hotel / Baustelle / Adresse"/>
            </div>
            <div class="field">
              <label>Leistungszeitraum</label>
              <input id="zeitraum" placeholder="z.B. 01.02.2026 – 15.02.2026"/>
            </div>
          </div>

          <div class="field" style="margin-top:10px">
            <label>Leistungsbeschreibung</label>
            <textarea id="desc">Security Dienstleistung</textarea>
          </div>

          <div class="field" style="margin-top:10px">
            <label>Referenz / PO (optional)</label>
            <input id="refpo" placeholder="z.B. Auftrags-Nr. / Ansprechpartner"/>
          </div>

          <div class="footerNote">
            Tipp: <b>Schicht-Modus AN</b> = du gibst Start/Ende je Schicht (optional) — oder einfach Stunden (unten).<br/>
            <b>Schicht-Modus AUS</b> = du gibst <b>nur Gesamtstunden</b> + Zuschlagsstunden (Nacht/Sonntag/Feiertag). Grundlohn wird automatisch berechnet.
          </div>
        </div>
      </div>

      <!-- RIGHT: Invoice data + calc -->
      <div class="card">
        <h3>Rechnungsdaten & Berechnung</h3>
        <div class="body">
          <div class="row">
            <div class="field">
              <label>Rechnungsdatum (Auto, klickbar)</label>
              <input id="invDate" type="date" onchange="onDateChanged()"/>
              <div class="hint">Standard = heute (du kannst ändern)</div>
            </div>
            <div class="field">
              <label>Zahlungsziel</label>
              <select id="payTerm" onchange="updateDueDate()">
                <option value="7">7 Tage</option>
                <option value="14" selected>14 Tage</option>
                <option value="30">30 Tage</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Fällig am (Auto, klickbar)</label>
              <input id="dueDate" type="date" onchange="recalc()"/>
              <div class="hint">Auto berechnet — du kannst auch manuell ändern</div>
            </div>
            <div class="field">
              <label>Rechnungsnummer (Auto, klickbar)</label>
              <input id="invNo" onchange="saveLastInvoiceNoManual()"/>
              <div class="hint">Format: MS-YYYYMMDD-0001 (pro Tag laufend)</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Status wählen</label>
              <select id="status" onchange="syncStatus()">
                <option value="Entwurf" selected>Entwurf</option>
                <option value="Offen">Offen</option>
                <option value="Bezahlt">Bezahlt</option>
                <option value="Storniert">Storniert</option>
              </select>
            </div>
            <div class="field">
              <label>USt-Status</label>
              <select id="vatMode" onchange="recalc()">
                <option value="0">0% (Kleinunternehmer §19)</option>
                <option value="19" selected>19% (Regelbesteuerung)</option>
              </select>
              <div class="hint" id="vatHint">Umsatzsteuer wird mit 19% berechnet.</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Stundensatz (€/h)</label>
              <input id="rate" type="number" step="0.01" value="23" oninput="recalc()"/>
            </div>
            <div class="field">
              <label>Zuschläge editierbar (%)</label>
              <div class="row" style="grid-template-columns:1fr 1fr 1fr;gap:8px">
                <div class="field">
                  <label>Nacht %</label>
                  <input id="pNight" type="number" step="0.1" value="5" oninput="recalc()"/>
                </div>
                <div class="field">
                  <label>Sonntag %</label>
                  <input id="pSun" type="number" step="0.1" value="50" oninput="recalc()"/>
                </div>
                <div class="field">
                  <label>Feiertag %</label>
                  <input id="pHol" type="number" step="0.1" value="100" oninput="recalc()"/>
                </div>
              </div>
              <div class="hint">Keine Doppelzählung: Feiertag &gt; Sonntag &gt; Nacht</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Anzahl Mitarbeiter</label>
              <input id="ma" type="number" step="1" value="1" min="1" oninput="recalc()"/>
            </div>
            <div class="field">
              <label>Stunden gesamt</label>
              <input id="gesamt" type="number" step="0.01" value="0" oninput="recalc()"/>
              <div class="hint">Gib nur Gesamtstunden ein → Grundlohn wird automatisch berechnet.</div>
            </div>
          </div>

          <div class="hr"></div>

          <table>
            <thead>
              <tr>
                <th>Position</th>
                <th class="r">Stunden</th>
                <th class="r">Zuschlag %</th>
                <th class="r">Betrag</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><b>Grundlohn</b><br/><span class="hint">Arbeitszeit (normal)</span></td>
                <td class="r"><span id="hGrund">0.00</span></td>
                <td class="r">—</td>
                <td class="r"><b><span id="aGrund">0.00</span> €</b></td>
              </tr>
              <tr>
                <td><b>Nachtschicht</b><br/><span class="hint">Zuschlag</span></td>
                <td class="r"><input id="hNight" type="number" step="0.01" value="0" oninput="recalc()" /></td>
                <td class="r"><span id="pNightTxt">5%</span></td>
                <td class="r"><span id="aNight">0.00</span> €</td>
              </tr>
              <tr>
                <td><b>Sonntag</b><br/><span class="hint">Zuschlag</span></td>
                <td class="r"><input id="hSun" type="number" step="0.01" value="0" oninput="recalc()" /></td>
                <td class="r"><span id="pSunTxt">50%</span></td>
                <td class="r"><span id="aSun">0.00</span> €</td>
              </tr>
              <tr>
                <td><b>Feiertag</b><br/><span class="hint">Zuschlag</span></td>
                <td class="r"><input id="hHol" type="number" step="0.01" value="0" oninput="recalc()" /></td>
                <td class="r"><span id="pHolTxt">100%</span></td>
                <td class="r"><span id="aHol">0.00</span> €</td>
              </tr>
            </tbody>
          </table>

          <div class="sumGrid">
            <div class="sumBox">
              <b>Stunden/MA (Auto)</b>
              <div class="v"><span id="hPerMA">0.00</span></div>
            </div>
            <div class="sumBox">
              <b>Stunden gesamt</b>
              <div class="v"><span id="hTotal">0.00</span></div>
            </div>
            <div class="sumBox">
              <b>Zwischensumme (Netto)</b>
              <div class="v"><span id="netto">0.00</span> €</div>
            </div>
            <div class="sumBox">
              <b>Umsatzsteuer</b>
              <div class="v"><span id="ust">0.00</span> €</div>
            </div>
            <div class="sumBox">
              <b>Gesamt</b>
              <div class="v"><span id="gesamtEUR">0.00</span> €</div>
            </div>
            <div class="sumBox">
              <b>Hinweis</b>
              <div class="hint">
                Zahlung bitte innerhalb der Zahlungsfrist auf das unten angegebene Konto.<br/>
                Bank: <b id="bankLine">MUSTAFA MURSAL ABDI · IBAN DE98… · BIC NTSBDEB1XXX</b>
              </div>
            </div>
          </div>

          <div class="footerNote">
            <b>Wichtig:</b> Nacht/Sonntag/Feiertag sind <u>Zuschlags-Stunden</u> (nicht Grundlohn-Stunden).<br/>
            Grundlohn-Stunden = Gesamtstunden − (Nacht + Sonntag + Feiertag). (wenn Modus AUS)
          </div>
        </div>
      </div>
    </div>

    <!-- Invoices modal/list -->
    <div id="invPanel" class="card" style="margin-top:14px;display:none">
      <h3>Gespeicherte Rechnungen</h3>
      <div class="body">
        <div class="hint" style="margin-bottom:10px">
          Hier sind deine gespeicherten Rechnungen (nur im Browser gespeichert). Du kannst öffnen, PDF drucken oder löschen.
        </div>
        <div id="invList" class="list"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   1) STORAGE KEYS
========================= */
const KEY_CUSTOMERS = "ms_customers_v1";
const KEY_INVOICES  = "ms_invoices_v1";
const KEY_LOGO      = "ms_logo_dataurl_v1";
const KEY_INVSEQ    = "ms_inv_seq_v1";
const KEY_LAST_INVNO = "ms_last_invno_v1";
const KEY_MODE      = "ms_schicht_mode_v1";

/* =========================
   2) HELPERS
========================= */
function pad(n, len){ n = String(n); while(n.length < len) n = "0"+n; return n; }
function yyyymmddFromDate(d){
  const y = d.getFullYear();
  const m = pad(d.getMonth()+1,2);
  const day = pad(d.getDate(),2);
  return `${y}${m}${day}`;
}
function toMoney(n){
  n = Number(n || 0);
  return n.toLocaleString("de-DE",{minimumFractionDigits:2, maximumFractionDigits:2});
}
function parseNum(id){
  const el = document.getElementById(id);
  const v = (el && el.value !== undefined) ? el.value : (el ? el.innerText : 0);
  const x = parseFloat(String(v).replace(",","."));
  return isNaN(x) ? 0 : x;
}
function setText(id, txt){ const el = document.getElementById(id); if(el) el.innerText = txt; }
function setValue(id, v){ const el = document.getElementById(id); if(el) el.value = v; }

/* =========================
   3) MODE (Schicht AN/AUS)
========================= */
let schichtMode = true; // AN by default

function applyBadge(){
  const dot = document.getElementById("autoDot");
  const txt = document.getElementById("autoText");
  if(schichtMode){
    dot.style.background = "#1ee08a";
    txt.innerText = "Schicht-Modus: AN";
  }else{
    dot.style.background = "#ffcc00";
    txt.innerText = "Schicht-Modus: AUS";
  }
  // In Modus AN erlauben wir trotzdem Gesamtstunden (weil du es willst),
  // aber die Regel für Grundlohn bleibt:
  // - Modus AUS: Grundlohn = Gesamt - Zuschlagsstunden
  // - Modus AN : Grundlohn = Gesamt (falls Zuschlagsstunden leer) ODER ebenfalls die gleiche Logik.
  // Wir nehmen die gleiche Logik wie Firmen: Grundlohn = Gesamt - Zuschläge (immer),
  // aber du kannst Modus AN für "Auto aktiv" Gefühl.
}
function toggleSchichtMode(){
  schichtMode = !schichtMode;
  localStorage.setItem(KEY_MODE, schichtMode ? "1":"0");
  applyBadge();
  recalc();
}

/* =========================
   4) LOGO (stable in PDF)
   - store as dataURL -> prints always
========================= */
function loadLogo(){
  const data = localStorage.getItem(KEY_LOGO);
  const img = document.getElementById("logoImg");
  if(data && img){
    img.src = data;
    img.style.display = "block";
  }
}
function changeLogo(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "image/*";
  inp.onchange = () => {
    const file = inp.files && inp.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      localStorage.setItem(KEY_LOGO, reader.result);
      loadLogo();
    };
    reader.readAsDataURL(file);
  };
  inp.click();
}

/* =========================
   5) CUSTOMERS
========================= */
function getCustomers(){
  try{ return JSON.parse(localStorage.getItem(KEY_CUSTOMERS) || "[]"); }catch(e){ return []; }
}
function setCustomers(arr){
  localStorage.setItem(KEY_CUSTOMERS, JSON.stringify(arr || []));
}
function refreshCustomerSelect(){
  const sel = document.getElementById("customerSelect");
  if(!sel) return;
  const current = sel.value;
  const customers = getCustomers();
  sel.innerHTML = `<option value="">— Kunde wählen —</option>` + customers
    .map(c => `<option value="${encodeURIComponent(c.id)}">${escapeHtml(c.name || "Kunde")}</option>`)
    .join("");
  // try restore
  if(current){
    const ok = customers.some(c => c.id === decodeURIComponent(current));
    if(ok) sel.value = current;
  }
}
function newCustomer(){
  setValue("customerSelect","");
  setValue("custName","");
  setValue("custMail","");
  setValue("custData","");
}
function saveCustomer(){
  const name = (document.getElementById("custName").value || "").trim();
  if(!name){ alert("Bitte Kundennamen eingeben."); return; }
  const mail = (document.getElementById("custMail").value || "").trim();
  const data = (document.getElementById("custData").value || "").trim();
  const customers = getCustomers();

  // if selected -> update
  const sel = document.getElementById("customerSelect").value;
  let id = sel ? decodeURIComponent(sel) : ("c_"+Date.now());
  const idx = customers.findIndex(c => c.id === id);
  const obj = {id, name, mail, data, updatedAt: Date.now()};
  if(idx >= 0) customers[idx] = obj; else customers.unshift(obj);

  setCustomers(customers);
  refreshCustomerSelect();
  document.getElementById("customerSelect").value = encodeURIComponent(id);
  alert("Kunde gespeichert.");
}
function loadCustomerFromSelect(){
  const sel = document.getElementById("customerSelect").value;
  if(!sel){ newCustomer(); return; }
  const id = decodeURIComponent(sel);
  const c = getCustomers().find(x => x.id === id);
  if(!c) return;
  setValue("custName", c.name || "");
  setValue("custMail", c.mail || "");
  setValue("custData", c.data || "");
}
function deleteCustomer(){
  const sel = document.getElementById("customerSelect").value;
  if(!sel){ alert("Kein Kunde ausgewählt."); return; }
  const id = decodeURIComponent(sel);
  if(!confirm("Kunde wirklich löschen?")) return;
  const customers = getCustomers().filter(c => c.id !== id);
  setCustomers(customers);
  refreshCustomerSelect();
  newCustomer();
}

/* =========================
   6) INVOICE NUMBER (Auto)
   Format: MS-YYYYMMDD-0001
========================= */
function getInvSeq(){
  try{ return JSON.parse(localStorage.getItem(KEY_INVSEQ) || "{}"); }catch(e){ return {}; }
}
function setInvSeq(obj){
  localStorage.setItem(KEY_INVSEQ, JSON.stringify(obj || {}));
}
function generateInvoiceNumber(dateObj){
  const dkey = yyyymmddFromDate(dateObj);
  const seq = getInvSeq();
  const next = (seq[dkey] || 0) + 1;
  seq[dkey] = next;
  setInvSeq(seq);
  return `MS-${dkey}-${pad(next,4)}`;
}
function ensureInvoiceNo(){
  const invDate = new Date(document.getElementById("invDate").value);
  const invNoEl = document.getElementById("invNo");
  if(!invNoEl.value || invNoEl.value.trim()===""){
    invNoEl.value = generateInvoiceNumber(invDate);
    localStorage.setItem(KEY_LAST_INVNO, invNoEl.value);
  }
}
function saveLastInvoiceNoManual(){
  const v = (document.getElementById("invNo").value || "").trim();
  if(v) localStorage.setItem(KEY_LAST_INVNO, v);
}

/* =========================
   7) DATES AUTO
========================= */
function initDates(){
  const today = new Date();
  const invDateEl = document.getElementById("invDate");
  const dueDateEl = document.getElementById("dueDate");
  if(!invDateEl.value){
    invDateEl.valueAsDate = today;
  }
  updateDueDate();
  // invoice number
  const last = localStorage.getItem(KEY_LAST_INVNO);
  if(last){
    document.getElementById("invNo").value = last;
  }else{
    ensureInvoiceNo();
  }
  // due date if empty
  if(!dueDateEl.value){
    updateDueDate();
  }
}
function updateDueDate(){
  const invDateEl = document.getElementById("invDate");
  const dueDateEl = document.getElementById("dueDate");
  const days = parseInt(document.getElementById("payTerm").value || "14",10);
  const d = invDateEl.value ? new Date(invDateEl.value) : new Date();
  const due = new Date(d.getTime() + days*24*60*60*1000);
  dueDateEl.valueAsDate = due;
  recalc();
}
function onDateChanged(){
  updateDueDate();
  // new day -> new invoice number (auto)
  document.getElementById("invNo").value = "";
  ensureInvoiceNo();
}

/* =========================
   8) STATUS SYNC
========================= */
function syncStatus(){
  const v = document.getElementById("status").value;
  document.getElementById("statusPill").innerText = v;
  const pill = document.getElementById("statusPill");
  pill.style.background = "#f8fbff";
  pill.style.border = "1px solid var(--line)";
  pill.style.color = "var(--blue2)";
  if(v==="Bezahlt"){ pill.style.background="#eafaf2"; pill.style.color= "var(--good)"; }
  if(v==="Storniert"){ pill.style.background="#fdecea"; pill.style.color= "var(--bad)"; }
}

/* =========================
   9) CALCULATION (Auto)
   - Grundlohn = Gesamtstunden - (Nacht+Sonntag+Feiertag)
   - Zuschläge: in € nur der Zuschlag-Anteil (wie Firmen)
     z.B. Nacht 5% => NachtStd * Satz * 0.05
   - Netto = GrundlohnStd*Satz + Zuschlag€
   - USt = Netto * VAT
========================= */
function recalc(){
  // badge text
  applyBadge();

  const vat = parseFloat(document.getElementById("vatMode").value || "0");
  document.getElementById("vatHint").innerText = vat===0
    ? "Gemäß §19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung)."
    : "Umsatzsteuer wird mit 19% berechnet.";

  const rate = parseNum("rate");
  const ma = Math.max(1, parseInt(document.getElementById("ma").value || "1",10));
  const totalHours = parseNum("gesamt");

  const hN = Math.max(0, parseNum("hNight"));
  const hS = Math.max(0, parseNum("hSun"));
  const hH = Math.max(0, parseNum("hHol"));

  // Grundlohn always auto from total - extras
  let hG = totalHours - (hN + hS + hH);
  if(hG < 0) hG = 0;

  const pN = Math.max(0, parseNum("pNight"))/100;
  const pS = Math.max(0, parseNum("pSun"))/100;
  const pH = Math.max(0, parseNum("pHol"))/100;

  setText("pNightTxt", (pN*100).toFixed(0) + "%");
  setText("pSunTxt",   (pS*100).toFixed(0) + "%");
  setText("pHolTxt",   (pH*100).toFixed(0) + "%");

  const grundEUR = hG * rate;

  // Zuschläge als separater Betrag (nur Zuschlag-Anteil)
  const nachtEUR = hN * rate * pN;
  const sonEUR   = hS * rate * pS;
  const feiEUR   = hH * rate * pH;

  const netto = grundEUR + nachtEUR + sonEUR + feiEUR;
  const ust = netto * (vat/100);
  const ges = netto + ust;

  setText("hGrund", hG.toFixed(2));
  setText("aGrund", toMoney(grundEUR));
  setText("aNight", toMoney(nachtEUR));
  setText("aSun",   toMoney(sonEUR));
  setText("aHol",   toMoney(feiEUR));

  setText("hPerMA", (totalHours/ma).toFixed(2));
  setText("hTotal", totalHours.toFixed(2));
  setText("netto", toMoney(netto));
  setText("ust",   toMoney(ust));
  setText("gesamtEUR", toMoney(ges));

  // bank line in summary
  const bank = `MUSTAFA MURSAL ABDI · IBAN ${document.getElementById("sellerIBAN").value} · BIC ${document.getElementById("sellerBIC").value}`;
  document.getElementById("bankLine").innerText = bank;
}

/* =========================
   10) INVOICE SAVE + LIST
========================= */
function getInvoices(){
  try{ return JSON.parse(localStorage.getItem(KEY_INVOICES) || "[]"); }catch(e){ return []; }
}
function setInvoices(arr){
  localStorage.setItem(KEY_INVOICES, JSON.stringify(arr || []));
}
function collectData(){
  return {
    savedAt: Date.now(),
    seller: {
      name: val("sellerName"), addr: val("sellerAddr"),
      tel: val("sellerTel"), mail: val("sellerMail"),
      tax: val("sellerTax"), iban: val("sellerIBAN"), bic: val("sellerBIC")
    },
    customer: {
      id: selectedCustomerId(),
      name: val("custName"), mail: val("custMail"), data: val("custData")
    },
    service: { objekt: val("objekt"), zeitraum: val("zeitraum"), desc: val("desc"), refpo: val("refpo") },
    invoice: {
      date: val("invDate"), due: val("dueDate"), no: val("invNo"),
      status: val("status"), vat: val("vatMode"), term: val("payTerm")
    },
    calc: {
      rate: val("rate"), ma: val("ma"), gesamt: val("gesamt"),
      hNight: val("hNight"), hSun: val("hSun"), hHol: val("hHol"),
      pNight: val("pNight"), pSun: val("pSun"), pHol: val("pHol"),
      totals: {
        netto: document.getElementById("netto").innerText,
        ust: document.getElementById("ust").innerText,
        gesamt: document.getElementById("gesamtEUR").innerText
      }
    },
    mode: schichtMode ? 1 : 0,
    logoDataUrl: localStorage.getItem(KEY_LOGO) || null
  };
}
function val(id){ return (document.getElementById(id).value || "").trim(); }
function selectedCustomerId(){
  const sel = document.getElementById("customerSelect").value;
  return sel ? decodeURIComponent(sel) : "";
}
function saveInvoice(){
  ensureInvoiceNo();
  const data = collectData();
  if(!data.customer.name){ alert("Bitte Kundennamen eingeben (oder Kunde auswählen)."); return; }
  if(!data.invoice.no){ alert("Rechnungsnummer fehlt."); return; }

  const invoices = getInvoices();
  // update if same invoice no
  const idx = invoices.findIndex(x => x.invoice && x.invoice.no === data.invoice.no);
  if(idx >= 0) invoices[idx] = data; else invoices.unshift(data);
  setInvoices(invoices);
  localStorage.setItem(KEY_LAST_INVNO, data.invoice.no);
  alert("Rechnung gespeichert.");
}
function openInvoices(){
  const panel = document.getElementById("invPanel");
  panel.style.display = (panel.style.display === "none" || !panel.style.display) ? "block" : "none";
  renderInvoiceList();
  // scroll into view
  if(panel.style.display==="block") panel.scrollIntoView({behavior:"smooth", block:"start"});
}
function renderInvoiceList(){
  const list = document.getElementById("invList");
  const invoices = getInvoices();
  if(!invoices.length){
    list.innerHTML = `<div class="hint">Keine Rechnungen gespeichert.</div>`;
    return;
  }
  list.innerHTML = invoices.map((inv, i) => {
    const no = inv.invoice.no;
    const c = inv.customer.name || "Kunde";
    const d = inv.invoice.date || "";
    const g = inv.calc?.totals?.gesamt || "0,00";
    return `
      <div class="invItem">
        <div>
          <b>${escapeHtml(no)}</b>
          <small>${escapeHtml(c)} · ${escapeHtml(d)} · Gesamt: ${escapeHtml(g)} €</small>
        </div>
        <div class="right">
          <button class="tiny" onclick="loadInvoice('${encodeURIComponent(no)}')">Öffnen</button>
          <button class="tiny" onclick="printInvoice('${encodeURIComponent(no)}')">PDF</button>
          <button class="tiny red" onclick="deleteInvoice('${encodeURIComponent(no)}')">Löschen</button>
        </div>
      </div>
    `;
  }).join("");
}
function loadInvoice(noEnc){
  const no = decodeURIComponent(noEnc);
  const inv = getInvoices().find(x => x.invoice && x.invoice.no === no);
  if(!inv){ alert("Nicht gefunden."); return; }

  // logo
  if(inv.logoDataUrl){
    localStorage.setItem(KEY_LOGO, inv.logoDataUrl);
    loadLogo();
  }

  // seller
  setValue("sellerName", inv.seller.name || "");
  setValue("sellerAddr", inv.seller.addr || "");
  setValue("sellerTel", inv.seller.tel || "");
  setValue("sellerMail", inv.seller.mail || "");
  setValue("sellerTax", inv.seller.tax || "");
  setValue("sellerIBAN", inv.seller.iban || "");
  setValue("sellerBIC", inv.seller.bic || "");

  // customer
  setValue("custName", inv.customer.name || "");
  setValue("custMail", inv.customer.mail || "");
  setValue("custData", inv.customer.data || "");

  // service
  setValue("objekt", inv.service.objekt || "");
  setValue("zeitraum", inv.service.zeitraum || "");
  setValue("desc", inv.service.desc || "");
  setValue("refpo", inv.service.refpo || "");

  // invoice
  setValue("invDate", inv.invoice.date || "");
  setValue("dueDate", inv.invoice.due || "");
  setValue("invNo", inv.invoice.no || "");
  setValue("status", inv.invoice.status || "Entwurf");
  setValue("vatMode", inv.invoice.vat || "19");
  setValue("payTerm", inv.invoice.term || "14");

  // calc
  setValue("rate", inv.calc.rate || "23");
  setValue("ma", inv.calc.ma || "1");
  setValue("gesamt", inv.calc.gesamt || "0");
  setValue("hNight", inv.calc.hNight || "0");
  setValue("hSun", inv.calc.hSun || "0");
  setValue("hHol", inv.calc.hHol || "0");
  setValue("pNight", inv.calc.pNight || "5");
  setValue("pSun", inv.calc.pSun || "50");
  setValue("pHol", inv.calc.pHol || "100");

  schichtMode = inv.mode ? true : false;
  localStorage.setItem(KEY_MODE, schichtMode ? "1":"0");

  syncStatus();
  recalc();
  window.scrollTo({top:0, behavior:"smooth"});
}
function deleteInvoice(noEnc){
  const no = decodeURIComponent(noEnc);
  if(!confirm("Rechnung löschen?")) return;
  const invoices = getInvoices().filter(x => x.invoice && x.invoice.no !== no);
  setInvoices(invoices);
  renderInvoiceList();
}
function printInvoice(noEnc){
  loadInvoice(noEnc);
  setTimeout(() => printPDF(), 150);
}

/* =========================
   11) PDF PRINT (logo stable)
   - just window.print with print CSS
========================= */
function printPDF(){
  // ensure invoice number exists
  ensureInvoiceNo();
  // force clickable mail/tel in print by temporarily converting (optional)
  window.print();
}

/* =========================
   12) RESET
========================= */
function resetForm(){
  // keep logo, customers, invoices
  document.getElementById("objekt").value = "";
  document.getElementById("zeitraum").value = "";
  document.getElementById("desc").value = "Security Dienstleistung";
  document.getElementById("refpo").value = "";

  newCustomer();

  // reset calc
  setValue("rate","23");
  setValue("ma","1");
  setValue("gesamt","0");
  setValue("hNight","0");
  setValue("hSun","0");
  setValue("hHol","0");
  setValue("pNight","5");
  setValue("pSun","50");
  setValue("pHol","100");

  // reset dates + invoice no
  document.getElementById("invDate").value = "";
  document.getElementById("dueDate").value = "";
  document.getElementById("status").value = "Entwurf";
  document.getElementById("vatMode").value = "19";
  document.getElementById("payTerm").value = "14";
  document.getElementById("invNo").value = "";

  initDates();
  syncStatus();
  recalc();
}
function hardReset(){
  if(!confirm("Alles zurücksetzen? (Kunden + Rechnungen bleiben nur wenn du nicht bestätigst)")) return;
  // full clear
  localStorage.removeItem(KEY_CUSTOMERS);
  localStorage.removeItem(KEY_INVOICES);
  localStorage.removeItem(KEY_INVSEQ);
  localStorage.removeItem(KEY_LAST_INVNO);
  localStorage.removeItem(KEY_MODE);
  // keep logo? remove too:
  // localStorage.removeItem(KEY_LOGO);
  location.reload();
}

/* =========================
   13) SECURITY: escape HTML
========================= */
function escapeHtml(str){
  return String(str||"").replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}

/* =========================
   14) INIT
========================= */
(function init(){
  // mode
  const m = localStorage.getItem(KEY_MODE);
  if(m === "0") schichtMode = false;
  applyBadge();

  loadLogo();
  refreshCustomerSelect();
  initDates();
  syncStatus();
  recalc();
})();
</script>
</body>
</html>
