<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Rechnung</title>
  <meta name="theme-color" content="#0b1220"/>

  <style>
    :root{
      --bg:#f3f5f8;
      --paper:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --line2:#cbd5e1;
      --accent:#0b3a78;
      --r:16px;
      --shadow: 0 18px 45px rgba(2,6,23,.10);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif}
    .wrap{max-width:1050px;margin:22px auto;padding:0 14px}
    .topbar{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logoBox{
      width:44px;height:44px;border-radius:12px;overflow:hidden;
      background:linear-gradient(135deg,var(--accent),#06254f);
      box-shadow:0 10px 26px rgba(11,58,120,.22);
      display:grid;place-items:center;color:#fff;font-weight:800;letter-spacing:.5px;
    }
    .logoBox img{width:100%;height:100%;object-fit:cover;display:block}
    .brand h1{margin:0;font-size:18px;line-height:1.1}
    .brand .sub{margin-top:4px;color:var(--muted);font-size:12px}
    .badge{display:inline-block;margin-left:8px;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#f8fafc;color:var(--muted);vertical-align:middle}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{border:1px solid var(--line2);background:#fff;border-radius:12px;padding:10px 12px;font-weight:600;font-size:13px;cursor:pointer;box-shadow:0 10px 24px rgba(2,6,23,.06)}
    .btn.primary{border-color:transparent;background:var(--accent);color:#fff}
    .btn:active{transform:translateY(1px)}
    .paper{background:var(--paper);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .paperHeader{padding:22px 22px 16px;border-bottom:1px solid var(--line);display:grid;grid-template-columns:1.25fr .75fr;gap:18px}
    .boxTitle{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px}
    .company{display:grid;gap:2px;font-size:13px}
    .company b{font-size:14px}
    .company a{color:inherit;text-decoration:none;border-bottom:1px dotted var(--line2)}
    .meta{border:1px solid var(--line);border-radius:14px;padding:14px;display:grid;gap:10px}
    .metaRow{display:flex;justify-content:space-between;gap:10px;font-size:13px;align-items:center}
    .metaRow span{color:var(--muted)}
    .metaRow input,.metaRow select{border:1px solid var(--line2);border-radius:10px;padding:8px 10px;font-size:13px;background:#fff;max-width:220px}
    .metaRow input[type="text"]{font-family:var(--mono)}
    .paperBody{padding:18px 22px 8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .field{display:grid;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input,textarea,select{width:100%;border:1px solid var(--line2);border-radius:12px;padding:10px 12px;font-size:14px;outline:none;background:#fff}
    textarea{min-height:84px;resize:vertical}
    input:focus,textarea:focus,select:focus{border-color:rgba(14,165,233,.55);box-shadow:0 0 0 4px rgba(14,165,233,.12)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .tableWrap{margin-top:14px;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{background:#f8fafc;border-bottom:1px solid var(--line);text-align:left;padding:12px 12px;color:#0f172a}
    tbody td{border-bottom:1px solid var(--line);padding:10px 12px;vertical-align:top}
    tbody tr:last-child td{border-bottom:none}
    .muted{color:var(--muted)}
    .right{text-align:right}
    .cellInput input{padding:8px 10px;font-size:13px;border-radius:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#f8fafc;padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .totals{display:grid;grid-template-columns:1fr 360px;gap:14px;align-items:start;margin-top:14px}
    .notes{border:1px solid var(--line);border-radius:14px;padding:12px 12px;background:#fff}
    .notes p{margin:0;color:var(--muted);font-size:12.5px;line-height:1.4}
    .sumBox{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .sumRow{display:flex;justify-content:space-between;gap:10px;padding:7px 0;font-size:13px}
    .sumRow span{color:var(--muted)}
    .sumRow strong{font-variant-numeric:tabular-nums}
    .sumRow.total{border-top:1px dashed var(--line2);margin-top:6px;padding-top:12px;font-size:15px}
    .paperFooter{padding:16px 22px 22px;border-top:1px solid var(--line);display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .footCard{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .footCard h3{margin:0 0 8px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .footCard p{margin:0;font-size:12.8px;line-height:1.45;color:#0f172a}
    .footCard .small{color:var(--muted)}
    @media print{
      body{background:#fff}
      .wrap{max-width:none;margin:0;padding:0}
      .topbar{display:none !important}
      .paper{border:none;border-radius:0;box-shadow:none}
      input,textarea,select{border:none;padding:0;box-shadow:none}
      a{border:none;text-decoration:none}
      button{display:none !important}
    }
    @media (max-width:900px){
      .paperHeader{grid-template-columns:1fr}
      .totals{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoBox" id="logoBox" title="Logo">
          <span id="logoFallback">MS</span>
          <img id="logoImg" alt="Logo" style="display:none" />
        </div>
        <div>
          <h1>Masculine Security — Rechnung <span class="badge" id="statusBadge">Offen</span></h1>
          <div class="sub">Automatisch: Rechnungsnummer, Summen, Zuschläge, USt · Auto-Save · Kundenliste · Logo</div>
        </div>
      </div>

      <div class="actions">
        <label class="btn" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
          Logo hochladen
          <input id="logoInput" type="file" accept="image/*" style="display:none"/>
        </label>
        <button class="btn" id="btnLogoClear" type="button">Logo löschen</button>
        <button class="btn" id="btnReset" type="button">Reset</button>
        <button class="btn" id="btnCopy" type="button">Rechnungsdaten kopieren</button>
        <button class="btn primary" type="button" onclick="window.print()">PDF drucken</button>
      </div>
    </div>

    <section class="paper" id="paper">
      <header class="paperHeader">
        <div>
          <div class="boxTitle">Rechnungssteller</div>
          <div class="company">
            <b>Masculine Security</b>
            <div>Werschenregerstraße 6</div>
            <div>28237 Bremen</div>
            <div>Tel: <a href="tel:+4915778697052">015778697052</a></div>
            <div>E-Mail: <a href="mailto:Kontakt.mass.bremen@hotmail.com">Kontakt.mass.bremen@hotmail.com</a></div>
            <div class="muted" style="margin-top:6px">Steuernummer: <span id="taxno">(in Bearbeitung)</span></div>
          </div>
        </div>

        <div>
          <div class="boxTitle">Rechnungsdaten</div>
          <div class="meta">
            <div class="metaRow"><span>Rechnungsdatum</span><input id="invDateInput" type="date"></div>

            <div class="metaRow"><span>Rechnungsnummer</span>
              <input id="invNoInput" type="text" readonly>
            </div>

            <div class="metaRow"><span>Status</span>
              <select id="invStatus">
                <option value="Entwurf">Entwurf</option>
                <option value="Offen" selected>Offen</option>
                <option value="Bezahlt">Bezahlt</option>
                <option value="Überfällig">Überfällig</option>
              </select>
            </div>

            <div class="metaRow"><span>Fällig am</span><input id="dueDateInput" type="date"></div>

            <div class="metaRow"><span>Zahlungsziel</span>
              <select id="payTerm">
                <option value="custom">Manuell</option>
                <option value="7">7 Tage</option>
                <option value="14" selected>14 Tage</option>
                <option value="30">30 Tage</option>
              </select>
            </div>

            <div class="metaRow"><span>Auto</span>
              <button class="btn" type="button" style="padding:8px 10px;border-radius:10px" id="btnRegen">Neu generieren</button>
            </div>
          </div>
        </div>
      </header>

      <div class="paperBody">
        <div class="grid">
          <div class="field">
            <label>Kunde / Rechnungsempfänger</label>

            <div class="split" style="grid-template-columns:1fr auto;align-items:center">
              <select id="kundeSelect"></select>
              <button class="btn" type="button" style="padding:8px 10px;border-radius:10px" id="btnKundeNeu">Neu</button>
            </div>

            <div class="split" style="margin-top:8px;grid-template-columns:1fr auto auto;align-items:center">
              <input id="kundeName" placeholder="Kundenname (zum Speichern)"/>
              <button class="btn" type="button" style="padding:8px 10px;border-radius:10px" id="btnKundeSave">Speichern</button>
              <button class="btn" type="button" style="padding:8px 10px;border-radius:10px" id="btnKundeDel">Löschen</button>
            </div>

            <textarea id="kunde" placeholder="Firma / Name&#10;Straße Hausnr.&#10;PLZ Ort&#10;(optional: Ansprechpartner)"></textarea>
            <div class="muted" style="font-size:12px;margin-top:6px">Kunden werden lokal gespeichert (nur in deinem Browser).</div>
          </div>

          <div class="field">
            <label>Leistungsbeschreibung</label>
            <textarea id="leistung" placeholder="z.B. Objektschutz / Empfangsdienst / Baustellenbewachung">Security Dienstleistung</textarea>
          </div>

          <div class="field">
            <label>Leistungszeitraum</label>
            <div class="split">
              <input id="von" type="date"/>
              <input id="bis" type="date"/>
            </div>
            <div class="pill" style="margin-top:8px">
              Zeitraum: <strong id="zeitraumText">—</strong>
            </div>
          </div>

          <div class="field">
            <label>Interne Notiz (optional)</label>
            <input id="memo" placeholder="z.B. Objekt, Ansprechpartner, Schichtplan"/>
          </div>
        </div>

        <div class="tableWrap" style="margin-top:18px">
          <table>
            <thead>
              <tr>
                <th style="width:30%">Position</th>
                <th style="width:20%">Stunden</th>
                <th style="width:20%">Satz (€/h)</th>
                <th style="width:15%">Zuschlag %</th>
                <th class="right" style="width:15%">Betrag</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Grundlohn</strong><div class="muted">Arbeitszeit (normal)</div></td>
                <td class="cellInput"><input id="hours" type="number" min="0" step="0.25" placeholder="z.B. 216"></td>
                <td class="cellInput"><input id="rate" type="number" min="0" step="0.01" value="25"></td>
                <td class="muted">—</td>
                <td class="right" id="sum_base">0,00 €</td>
              </tr>

              <tr>
                <td><strong>Nachtschicht</strong><div class="muted">Zuschlag auf Grundsatz</div></td>
                <td class="cellInput"><input id="night_hours" type="number" min="0" step="0.25" placeholder="z.B. 48"></td>
                <td class="muted">(wie Grundlohn)</td>
                <td class="cellInput">
                  <div style="display:flex;gap:8px;align-items:center">
                    <input id="night_pct" type="number" min="0" step="0.1" value="5" style="max-width:110px"> <span class="muted">%</span>
                  </div>
                </td>
                <td class="right" id="sum_night">0,00 €</td>
              </tr>

              <tr>
                <td><strong>Sonntag</strong><div class="muted">Zuschlag (optional)</div></td>
                <td class="cellInput"><input id="sun_hours" type="number" min="0" step="0.25" placeholder="0"></td>
                <td class="muted">(wie Grundlohn)</td>
                <td class="cellInput">
                  <div style="display:flex;gap:8px;align-items:center">
                    <input id="sun_pct" type="number" min="0" step="0.1" value="50" style="max-width:110px"> <span class="muted">%</span>
                  </div>
                </td>
                <td class="right" id="sum_sun">0,00 €</td>
              </tr>

              <tr>
                <td><strong>Feiertag</strong><div class="muted">Zuschlag (optional)</div></td>
                <td class="cellInput"><input id="hol_hours" type="number" min="0" step="0.25" placeholder="0"></td>
                <td class="muted">(wie Grundlohn)</td>
                <td class="cellInput">
                  <div style="display:flex;gap:8px;align-items:center">
                    <input id="hol_pct" type="number" min="0" step="0.1" value="100" style="max-width:110px"> <span class="muted">%</span>
                  </div>
                </td>
                <td class="right" id="sum_hol">0,00 €</td>
              </tr>

              <tr>
                <td><strong>Rabatt / Abschlag</strong><div class="muted">optional (Betrag wird abgezogen)</div></td>
                <td class="muted">—</td>
                <td class="muted">—</td>
                <td class="muted">—</td>
                <td class="cellInput right"><input id="discount" type="number" step="0.01" value="0" style="text-align:right" placeholder="0"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="totals">
          <div class="notes">
            <p><strong>Hinweis:</strong> Zuschläge sind separat ausgewiesen. Passe die Prozentwerte nach Vertrag an (z. B. Nachtschicht 5% → 10%).</p>

            <div style="margin-top:10px;display:grid;gap:8px">
              <div class="pill" style="justify-content:space-between">
                <span><strong>USt-Status</strong></span>
                <select id="vatMode" style="max-width:260px">
                  <option value="kru" selected>Kleinunternehmer (§19 UStG) — 0%</option>
                  <option value="vat19">Regelbesteuerung — 19%</option>
                  <option value="custom">Individuell (frei wählbar)</option>
                </select>
              </div>
              <div class="field" id="vatCustomWrap" style="display:none">
                <label>USt-Satz (%)</label>
                <input id="vatPct" type="number" min="0" step="0.1" value="19"/>
              </div>
            </div>

            <p style="margin-top:10px"><em id="vatNote">Gemäß §19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).</em></p>
          </div>

          <div class="sumBox">
            <div class="sumRow"><span>Zwischensumme (Netto)</span><strong id="subTotal">0,00 €</strong></div>
            <div class="sumRow"><span>Umsatzsteuer</span><strong id="vatTotal">0,00 €</strong></div>
            <div class="sumRow total"><span>Gesamtbetrag (Brutto)</span><strong id="grandTotal">0,00 €</strong></div>
          </div>
        </div>
      </div>

      <footer class="paperFooter">
        <div class="footCard">
          <h3>Zahlungsinformation</h3>
          <p>
            Bitte überweisen Sie den Gesamtbetrag unter Angabe der Rechnungsnummer.<br>
            <span class="small">Bankdaten:</span><br>
            <strong>Kontoinhaber:</strong> <span id="accName">MUSTAFA MURSAL ABDI</span><br>
            <strong>IBAN:</strong> <span id="iban">DE98 1001 1001 2333 0146 96</span><br>
            <strong>BIC:</strong> <span id="bic">NTSBDEB1XXX</span>
          </p>
        </div>
        <div class="footCard">
          <h3>Kontakt</h3>
          <p>
            Masculine Security · Werschenregerstraße 6 · 28237 Bremen<br>
            Tel: <a href="tel:+4915778697052">015778697052</a> · E-Mail: <a href="mailto:Kontakt.mass.bremen@hotmail.com">Kontakt.mass.bremen@hotmail.com</a><br>
            <span class="small">Vielen Dank für Ihren Auftrag.</span>
          </p>
        </div>
      </footer>
    </section>
  </div>

  <script>
    // ---------- Storage keys ----------
    const LS_STATE = 'ms_invoice_app_state_v3';
    const LS_CUSTOMERS = 'ms_invoice_customers_v1';

    // ---------- Helpers ----------
    const $ = (id)=>document.getElementById(id);
    function pad2(n){return String(n).padStart(2,'0')}
    function toISODate(d){
      const x = new Date(d);
      return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
    }
    function fmtDEFromISO(iso){
      if(!iso) return '';
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return String(iso);
      return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
    }
    function money(x){
      return x.toLocaleString('de-DE',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' €';
    }
    function num(id){
      const v = parseFloat($(id).value);
      return Number.isFinite(v) ? v : 0;
    }

    // ---------- Logo (FIX: no broken icon + works in subfolder like /E-RECHNUNG/) ----------
    function showFallbackLogo(){
      $('logoImg').style.display = 'none';
      $('logoImg').removeAttribute('src');
      $('logoFallback').style.display = 'block';
    }
    function applyLogo(dataUrl){
      const img = $('logoImg');
      const fb = $('logoFallback');
      img.onload = ()=>{ img.style.display = 'block'; fb.style.display = 'none'; };
      img.onerror = ()=>{ showFallbackLogo(); };
      img.src = dataUrl;
    }
    function clearLogo(){
      // also clear any saved/broken logo from localStorage
      showFallbackLogo();
      scheduleSave();
    }
    function handleLogoFile(file){
      if(!file) return;
      const maxMB = 3;
      if(file.size > maxMB*1024*1024){ alert('Logo ist zu groß (max 3MB).'); return; }
      const reader = new FileReader();
      reader.onload = ()=>{ applyLogo(String(reader.result)); scheduleSave(); };
      reader.readAsDataURL(file);
    }

    // Try to load logo.png from SAME folder as index.html (works with GitHub Pages subpath)
    async function tryLoadDefaultLogo(){
      try{
        const url = new URL('logo.png', document.baseURI).toString(); // ✅ correct path
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) return;
        const blob = await res.blob();
        const reader = new FileReader();
        reader.onload = ()=>{ applyLogo(String(reader.result)); scheduleSave(); };
        reader.readAsDataURL(blob);
      }catch(e){ /* ignore */ }
    }

    // ---------- Rechnungsnummer (AUTOMATIC) ----------
    function makeInvoiceNo(){
      const d = new Date();
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const day = pad2(d.getDate());
      const rand = String(Math.floor(Math.random()*900)+100);
      return `MS-${y}${m}${day}-${rand}`;
    }
    function ensureInvoiceNo(){
      const v = ($('invNoInput').value || '').trim();
      if(!v) $('invNoInput').value = makeInvoiceNo();
    }

    // ---------- Due date ----------
    function recalcDueFromInvoiceDate(){
      const inv = $('invDateInput').value;
      const term = $('payTerm').value;
      if(!inv) return;
      if(term === 'custom') return;
      const days = parseInt(term,10) || 14;
      const base = new Date(inv);
      const due = new Date(base);
      due.setDate(due.getDate() + days);
      $('dueDateInput').value = toISODate(due);
    }

    // ---------- Regenerate ----------
    function regenInvoiceMeta(){
      $('invNoInput').value = makeInvoiceNo();
      $('invDateInput').value = toISODate(new Date());
      if($('payTerm').value !== 'custom') recalcDueFromInvoiceDate();
      scheduleSave();
    }

    // ---------- Status badge ----------
    function updateStatusBadge(){
      const s = $('invStatus').value;
      const b = $('statusBadge');
      b.textContent = s;
      if(s === 'Bezahlt'){
        b.style.background = 'rgba(22,163,74,.12)';
        b.style.borderColor = 'rgba(22,163,74,.35)';
        b.style.color = '#166534';
      }else if(s === 'Überfällig'){
        b.style.background = 'rgba(239,68,68,.10)';
        b.style.borderColor = 'rgba(239,68,68,.35)';
        b.style.color = '#991b1b';
      }else if(s === 'Entwurf'){
        b.style.background = 'rgba(59,130,246,.10)';
        b.style.borderColor = 'rgba(59,130,246,.25)';
        b.style.color = '#1e3a8a';
      }else{
        b.style.background = '#f8fafc';
        b.style.borderColor = 'var(--line)';
        b.style.color = 'var(--muted)';
      }
    }

    // ---------- VAT note ----------
    function updateVatNote(){
      const mode = $('vatMode').value;
      if(mode === 'kru'){
        $('vatNote').textContent = 'Gemäß §19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).';
        $('vatCustomWrap').style.display = 'none';
      }else if(mode === 'vat19'){
        $('vatNote').textContent = 'Umsatzsteuer wird gemäß Regelbesteuerung ausgewiesen (19%).';
        $('vatCustomWrap').style.display = 'none';
      }else{
        $('vatCustomWrap').style.display = 'block';
        const p = num('vatPct');
        $('vatNote').textContent = `Umsatzsteuer wird ausgewiesen (${p || 0}%).`;
      }
    }

    // ---------- Calculations ----------
    function calc(){
      const h = num('hours');
      const r = num('rate');
      const nh = num('night_hours');
      const np = num('night_pct');
      const sh = num('sun_hours');
      const sp = num('sun_pct');
      const fh = num('hol_hours');
      const fp = num('hol_pct');
      const disc = num('discount');

      const base = h * r;
      const night = nh * r * (np/100);
      const sun = sh * r * (sp/100);
      const hol = fh * r * (fp/100);

      const net = Math.max(0, base + night + sun + hol - disc);

      let vatRate = 0;
      const mode = $('vatMode').value;
      if(mode === 'vat19') vatRate = 0.19;
      if(mode === 'custom') vatRate = Math.max(0, num('vatPct')) / 100;

      const vat = net * vatRate;
      const gross = net + vat;

      $('sum_base').textContent = money(base);
      $('sum_night').textContent = money(night);
      $('sum_sun').textContent = money(sun);
      $('sum_hol').textContent = money(hol);

      $('subTotal').textContent = money(net);
      $('vatTotal').textContent = money(vat);
      $('grandTotal').textContent = money(gross);

      scheduleSave();
    }

    // ---------- Zeitraum text ----------
    function syncZeitraum(){
      const v = $('von').value;
      const b = $('bis').value;
      if(!v && !b){ $('zeitraumText').textContent = '—'; return; }
      const left = v ? fmtDEFromISO(v) : '…';
      const right = b ? fmtDEFromISO(b) : '…';
      $('zeitraumText').textContent = `${left} – ${right}`;
    }

    // ---------- Customers ----------
    function getCustomers(){
      try{
        const raw = localStorage.getItem(LS_CUSTOMERS);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function setCustomers(arr){
      localStorage.setItem(LS_CUSTOMERS, JSON.stringify(arr));
    }
    function refreshCustomerSelect(selected=''){
      const sel = $('kundeSelect');
      const customers = getCustomers().sort((a,b)=>(a.name||'').localeCompare(b.name||'', 'de'));
      sel.innerHTML = '<option value="">— Kunde wählen —</option>' + customers.map(c=>{
        const n = (c.name||'').replace(/"/g,'&quot;');
        return `<option value="${n}">${n}</option>`;
      }).join('');
      sel.value = selected || '';
    }
    function loadCustomerFromSelect(){
      const name = $('kundeSelect').value;
      const c = getCustomers().find(x=>x.name===name);
      if(c){
        $('kunde').value = c.text || '';
        $('kundeName').value = c.name || '';
      }
      scheduleSave();
    }
    function newCustomer(){
      $('kundeSelect').value = '';
      $('kundeName').value = '';
      $('kunde').value = '';
      scheduleSave();
    }
    function saveCustomer(){
      const name = ($('kundeName').value || '').trim();
      const text = ($('kunde').value || '').trim();
      if(!name){ alert('Bitte Kundenname eingeben.'); return; }
      if(!text){ alert('Bitte Kundendaten eingeben.'); return; }
      const customers = getCustomers();
      const idx = customers.findIndex(x=>x.name===name);
      const entry = {name, text, updatedAt: Date.now()};
      if(idx>=0) customers[idx]=entry; else customers.push(entry);
      setCustomers(customers);
      refreshCustomerSelect(name);
      $('kundeSelect').value = name;
      scheduleSave();
    }
    function deleteCustomer(){
      const name = ($('kundeSelect').value || $('kundeName').value || '').trim();
      if(!name){ alert('Bitte zuerst einen Kunden auswählen.'); return; }
      if(!confirm(`Kunde "${name}" löschen?`)) return;
      const customers = getCustomers().filter(x=>x.name!==name);
      setCustomers(customers);
      refreshCustomerSelect('');
      newCustomer();
      scheduleSave();
    }

    // ---------- Auto-save ----------
    let saveTimer;
    function scheduleSave(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveState, 200);
    }
    function saveState(){
      const state = {
        invDate: $('invDateInput').value,
        invNo: $('invNoInput').value,
        invStatus: $('invStatus').value,
        dueDate: $('dueDateInput').value,
        payTerm: $('payTerm').value,

        kunde: $('kunde').value,
        kundeName: $('kundeName').value,
        kundeSelected: $('kundeSelect').value,

        leistung: $('leistung').value,
        von: $('von').value,
        bis: $('bis').value,
        memo: $('memo').value,

        hours: $('hours').value,
        rate: $('rate').value,
        night_hours: $('night_hours').value,
        night_pct: $('night_pct').value,
        sun_hours: $('sun_hours').value,
        sun_pct: $('sun_pct').value,
        hol_hours: $('hol_hours').value,
        hol_pct: $('hol_pct').value,
        discount: $('discount').value,

        vatMode: $('vatMode').value,
        vatPct: $('vatPct').value,

        logoDataUrl: $('logoImg').getAttribute('src') || '' // may be empty
      };
      localStorage.setItem(LS_STATE, JSON.stringify(state));
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(LS_STATE);
        if(!raw) return false;
        const s = JSON.parse(raw);

        if(s.invDate) $('invDateInput').value = s.invDate;
        if(s.invNo) $('invNoInput').value = s.invNo;
        if(s.invStatus) $('invStatus').value = s.invStatus;
        if(s.dueDate) $('dueDateInput').value = s.dueDate;
        if(s.payTerm) $('payTerm').value = s.payTerm;

        $('kunde').value = s.kunde || '';
        $('kundeName').value = s.kundeName || '';
        refreshCustomerSelect(s.kundeSelected || '');

        $('leistung').value = s.leistung || 'Security Dienstleistung';
        $('von').value = s.von || '';
        $('bis').value = s.bis || '';
        $('memo').value = s.memo || '';

        $('hours').value = s.hours || '';
        $('rate').value = s.rate || '25';
        $('night_hours').value = s.night_hours || '';
        $('night_pct').value = s.night_pct || '5';
        $('sun_hours').value = s.sun_hours || '';
        $('sun_pct').value = s.sun_pct || '50';
        $('hol_hours').value = s.hol_hours || '';
        $('hol_pct').value = s.hol_pct || '100';
        $('discount').value = s.discount || '0';

        $('vatMode').value = s.vatMode || 'kru';
        $('vatPct').value = s.vatPct || '19';

        // If saved logo is invalid, fallback (no broken icon)
        const savedLogo = (s.logoDataUrl || '').trim();
        if(savedLogo) applyLogo(savedLogo); else showFallbackLogo();

        return true;
      }catch(e){
        return false;
      }
    }

    // ---------- Copy ----------
    async function copyData(){
      const txt = [
        `Rechnungsnummer: ${$('invNoInput').value || ''}`,
        `Rechnungsdatum: ${fmtDEFromISO($('invDateInput').value)}`,
        `Status: ${$('invStatus').value}`,
        `Faellig am: ${fmtDEFromISO($('dueDateInput').value)}`,
        `Kunde:\n${$('kunde').value}`,
        `Leistung:\n${$('leistung').value}`,
        `Zeitraum: ${$('zeitraumText').textContent}`,
        `Grundlohn: ${$('hours').value || 0}h x ${$('rate').value || 0} €/h`,
        `Nachtschicht: ${$('night_hours').value || 0}h @ ${$('night_pct').value || 0}%`,
        `Sonntag: ${$('sun_hours').value || 0}h @ ${$('sun_pct').value || 0}%`,
        `Feiertag: ${$('hol_hours').value || 0}h @ ${$('hol_pct').value || 0}%`,
        `Rabatt/Abschlag: ${$('discount').value || 0} €`,
        `Netto: ${$('subTotal').textContent}`,
        `USt: ${$('vatTotal').textContent}`,
        `Gesamt: ${$('grandTotal').textContent}`
      ].join('\n');

      try{
        await navigator.clipboard.writeText(txt);
        $('btnCopy').textContent = 'Kopiert ✓';
        setTimeout(()=> $('btnCopy').textContent = 'Rechnungsdaten kopieren', 1500);
      }catch(e){
        alert('Kopieren nicht möglich. Bitte manuell markieren.');
      }
    }

    // ---------- Reset ----------
    function resetAll(){
      if(!confirm('Alle Eingaben löschen?')) return;
      localStorage.removeItem(LS_STATE);

      $('kunde').value='';
      $('kundeName').value='';
      refreshCustomerSelect('');

      $('leistung').value='Security Dienstleistung';
      $('von').value=''; $('bis').value=''; $('memo').value='';

      $('hours').value=''; $('rate').value='25';
      $('night_hours').value=''; $('night_pct').value='5';
      $('sun_hours').value=''; $('sun_pct').value='50';
      $('hol_hours').value=''; $('hol_pct').value='100';
      $('discount').value='0';

      $('invStatus').value='Offen';
      $('vatMode').value='kru';
      $('vatPct').value='19';

      clearLogo();

      $('payTerm').value = '14';
      regenInvoiceMeta();
      ensureInvoiceNo();
      syncZeitraum();
      updateStatusBadge();
      updateVatNote();
      calc();
      saveState();

      // try repo logo.png again after reset
      tryLoadDefaultLogo();
    }

    // ---------- Init ----------
    (function init(){
      // Always prevent broken logo icon
      $('logoImg').onerror = ()=> showFallbackLogo();

      refreshCustomerSelect('');

      // defaults
      $('invDateInput').value = toISODate(new Date());
      $('payTerm').value = '14';
      ensureInvoiceNo();
      recalcDueFromInvoiceDate();

      // events
      $('logoInput').addEventListener('change', (e)=>{ handleLogoFile(e.target.files?.[0]); e.target.value=''; });
      $('btnLogoClear').addEventListener('click', ()=>{ clearLogo(); });
      $('btnReset').addEventListener('click', resetAll);
      $('btnCopy').addEventListener('click', copyData);
      $('btnRegen').addEventListener('click', regenInvoiceMeta);

      $('invStatus').addEventListener('change', ()=>{ updateStatusBadge(); scheduleSave(); });
      $('payTerm').addEventListener('change', ()=>{ recalcDueFromInvoiceDate(); scheduleSave(); });
      $('invDateInput').addEventListener('input', ()=>{ if($('payTerm').value !== 'custom') recalcDueFromInvoiceDate(); scheduleSave(); });
      $('dueDateInput').addEventListener('input', scheduleSave);

      $('kundeSelect').addEventListener('change', loadCustomerFromSelect);
      $('btnKundeNeu').addEventListener('click', newCustomer);
      $('btnKundeSave').addEventListener('click', saveCustomer);
      $('btnKundeDel').addEventListener('click', deleteCustomer);

      $('von').addEventListener('input', ()=>{ syncZeitraum(); scheduleSave(); });
      $('bis').addEventListener('input', ()=>{ syncZeitraum(); scheduleSave(); });

      [
        'kunde','kundeName','leistung','memo',
        'hours','rate','night_hours','night_pct','sun_hours','sun_pct','hol_hours','hol_pct','discount','vatPct'
      ].forEach(id=>{
        $(id).addEventListener('input', ()=>{
          if(id==='vatPct') updateVatNote();
          calc();
          scheduleSave();
        });
      });

      $('vatMode').addEventListener('change', ()=>{ updateVatNote(); calc(); scheduleSave(); });

      // load saved state
      const had = loadState();

      // invoice number must always exist
      ensureInvoiceNo();

      // UI
      syncZeitraum();
      updateStatusBadge();
      updateVatNote();
      calc();

      // If no saved logo, try logo.png from repo
      const curLogo = ($('logoImg').getAttribute('src') || '').trim();
      if(!curLogo){
        showFallbackLogo();
        tryLoadDefaultLogo();
      }else{
        // if saved logo is broken, onerror will fallback automatically
        $('logoImg').style.display = 'block';
        $('logoFallback').style.display = 'none';
      }
    })();
  </script>
</body>
</html>
