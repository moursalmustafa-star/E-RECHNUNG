<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Rechnung</title>

  <!-- PDF libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#f3f5f7;
      --card:#ffffff;
      --ink:#0b1220;
      --muted:#5f6b7a;
      --line:#e3e7ee;
      --accent:#0a5aa3;
      --accent2:#084a88;
      --r:14px;
      --shadow:0 12px 34px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    a{color:inherit}

    /* top bar */
    .topbar{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--accent2),var(--accent));
      color:#fff;border-bottom:1px solid rgba(255,255,255,.18);
      padding:10px 14px;
    }
    .topbar .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;min-width:260px}
    .brand img{
      width:34px;height:34px;border-radius:10px;object-fit:cover;
      border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.12)
    }
    .brand .t{font-weight:900;letter-spacing:.2px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
    button{
      appearance:none;border:0;cursor:pointer;
      padding:9px 12px;border-radius:999px;
      background:rgba(255,255,255,.16);color:#fff;
      border:1px solid rgba(255,255,255,.18);
      font-weight:800;font-size:13px;
    }
    button:hover{background:rgba(255,255,255,.22)}
    button.primary{background:#fff;color:var(--accent2);border-color:#fff}
    button.danger{background:rgba(255,80,110,.22);border-color:rgba(255,80,110,.28)}
    button.ghost{background:transparent;border-color:rgba(255,255,255,.25)}
    .wrap{max-width:1220px;margin:14px auto;padding:0 14px 26px}
    .grid{display:grid;grid-template-columns: 1fr 1fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h3{
      margin:0;padding:12px 14px;
      background:#fbfcfe;
      border-bottom:1px solid var(--line);
      font-size:13px;letter-spacing:.2px;
      display:flex;align-items:center;justify-content:space-between;
    }
    .pill{
      padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;
      border:1px solid var(--line);background:#fff;color:var(--muted);
    }
    .content{padding:14px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:560px){.two{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,textarea{
      width:100%;padding:10px 11px;border-radius:12px;
      border:1px solid var(--line);background:#fff;color:var(--ink);
      outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#9cc4ea;box-shadow:0 0 0 3px rgba(10,90,163,.10)}
    textarea{min-height:86px;resize:vertical}
    .rowline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .hr{height:1px;background:var(--line);margin:12px 0}

    /* positions editor */
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:13px;vertical-align:top}
    th{font-size:12px;color:var(--muted);text-align:left;background:#fbfcfe}
    tr:last-child td{border-bottom:0}
    td.right{text-align:right}
    .tbl input,.tbl select,.tbl textarea{border-radius:10px;padding:9px 10px}
    .tbl textarea{min-height:40px}
    .iconBtn{
      padding:8px 10px;border-radius:12px;font-weight:900;
      background:#fff;color:var(--ink);border:1px solid var(--line);
      cursor:pointer;
    }
    .iconBtn:hover{background:#fafcff}
    .iconBtn.danger{border-color:rgba(255,80,110,.35);background:rgba(255,80,110,.06)}
    .iconBtn.danger:hover{background:rgba(255,80,110,.10)}

    /* totals */
    .sumGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.sumGrid{grid-template-columns:1fr}}
    .sumBox{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .sumBox .big{font-size:18px;font-weight:950}
    .sumRow{display:flex;justify-content:space-between;gap:10px;align-items:baseline;margin:6px 0}
    .sumRow b{font-weight:950}

    /* invoice document (print/PDF) */
    .docWrap{
      margin-top:14px;
      display:flex;justify-content:center;
    }
    #invoiceDoc{
      width:210mm; min-height:297mm;
      background:#fff;color:#000;
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .doc{
      padding:14mm 14mm 12mm 14mm;
      font-family:Arial,Helvetica,sans-serif;
    }
    .docHeader{
      display:flex;justify-content:space-between;gap:10mm;align-items:flex-start;
      margin-bottom:6mm;
    }
    .docBrand{display:flex;gap:7mm;align-items:center}
    .docBrand img{
      width:20mm;height:20mm;border-radius:6mm;object-fit:cover;
      border:1px solid #e3e7ee;background:#fff;
    }
    .docTitle{margin:0;font-size:18pt;font-weight:800}
    .docMeta{font-size:9.8pt;color:#222;line-height:1.35}
    .docGrid{display:grid;grid-template-columns:1fr 1fr;gap:6mm;margin-top:6mm}
    .box{
      border:1px solid #e3e7ee;border-radius:4mm;padding:6mm;background:#fff;
    }
    .h{margin:0 0 2mm;font-size:9pt;color:#556;font-weight:800;letter-spacing:.2px}
    .t{margin:0;font-size:10pt;color:#111}
    .muted{color:#667}
    .docTable{margin-top:6mm;border:1px solid #e3e7ee;border-radius:4mm;overflow:hidden}
    .docTable table{width:100%;border-collapse:collapse}
    .docTable th,.docTable td{border-bottom:1px solid #e3e7ee;padding:3.6mm 3.6mm;font-size:9.8pt}
    .docTable th{background:#f6f8fb;color:#445;font-size:9pt}
    .docTable tr:last-child td{border-bottom:0}
    .docTotals{
      margin-top:6mm;display:grid;grid-template-columns:1fr 1fr;gap:6mm;
    }
    .totRight .sumRow{margin:4px 0}
    .totRight .sumRow span{font-size:10pt}
    .totRight .sumRow b{font-size:10pt}
    .grand b{font-size:12pt}
    .docFoot{
      margin-top:6mm;border-top:1px solid #e3e7ee;padding-top:3mm;
      font-size:8.8pt;color:#667;display:flex;justify-content:space-between;gap:6mm;flex-wrap:wrap
    }

    /* print */
    @media print{
      body{background:#fff}
      .topbar,.wrap .grid,.toast,.docHint{display:none !important}
      .docWrap{margin:0;padding:0;display:block}
      #invoiceDoc{border:0;border-radius:0;box-shadow:none;width:210mm;min-height:297mm}
      @page{size:A4;margin:0}
    }

    /* toast */
    .toast{
      position:fixed;right:14px;bottom:14px;z-index:99;
      background:#0b1220;color:#fff;border-radius:14px;
      padding:10px 12px;box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.10);
      display:none;max-width:380px;font-size:13px
    }
    .toast.show{display:block}
    .docHint{font-size:12px;color:var(--muted);margin:10px 2px 0}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="row">
      <div class="brand">
        <img id="logoTop" alt="Logo"/>
        <div class="t">Masculine Security — Rechnung</div>
      </div>

      <div class="actions">
        <button class="ghost" id="btnLogo">Logo ändern</button>
        <button id="btnNew">Neu</button>
        <button class="primary" id="btnSave">Speichern</button>
        <button id="btnLoad">Letzte laden</button>
        <button id="btnPrint">Print</button>
        <button class="primary" id="btnPdf">PDF</button>
        <button class="danger" id="btnReset">Reset</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- SETTINGS -->
      <div class="card">
        <h3>
          <span>Rechnungsteller & Kunde</span>
          <span class="pill" id="pillStatus">Entwurf</span>
        </h3>
        <div class="content">
          <div class="two">
            <div>
              <label>Status</label>
              <select id="status">
                <option>Entwurf</option>
                <option>Offen</option>
                <option>Bezahlt</option>
                <option>Storniert</option>
              </select>
            </div>
            <div>
              <label>USt</label>
              <select id="vatMode">
                <option value="Klein">0% (Kleinunternehmer §19)</option>
                <option value="Regel">19% (Regelbesteuerung)</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <div class="two">
            <div>
              <label>Firma</label>
              <input id="firmName" value="Masculine Security"/>
            </div>
            <div>
              <label>Telefon</label>
              <input id="firmTel" value="015778697052"/>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Adresse</label>
              <input id="firmAddr" value="Werschenregerstraße 6 • 28237 Bremen"/>
            </div>
            <div>
              <label>E-Mail</label>
              <input id="firmMail" value="Kontakt.mass.bremen@hotmail.com"/>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Steuernummer</label>
              <input id="firmTax" value="in Bearbeitung"/>
            </div>
            <div>
              <label>Zahlungsziel (Tage)</label>
              <select id="payTerm">
                <option value="7">7</option>
                <option value="14" selected>14</option>
                <option value="30">30</option>
              </select>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>IBAN</label>
              <input id="firmIban" value="DE98 1001 1001 2333 0146 96"/>
            </div>
            <div>
              <label>BIC</label>
              <input id="firmBic" value="NTSBDEB1XXX"/>
            </div>
          </div>

          <div class="hr"></div>

          <div class="two">
            <div>
              <label>Kunde auswählen</label>
              <select id="custSelect"></select>
              <div class="rowline" style="margin-top:8px">
                <button class="iconBtn" id="custNew">Neu</button>
                <button class="iconBtn danger" id="custDel">Löschen</button>
              </div>
            </div>
            <div>
              <label>Kundenname</label>
              <input id="custName" placeholder="Firma / Name"/>
              <label style="margin-top:10px">E-Mail (optional)</label>
              <input id="custMail" placeholder="kunde@email.de"/>
            </div>
          </div>

          <label style="margin-top:10px">Kundendaten (Adresse / Ansprechpartner)</label>
          <textarea id="custData" placeholder="Straße • PLZ Ort&#10;Ansprechpartner"></textarea>

          <div class="rowline" style="margin-top:10px">
            <button class="iconBtn" id="custSave" style="border-color:rgba(10,90,163,.35);background:rgba(10,90,163,.06)">Kunde speichern</button>
            <span class="small">Speicherung im Browser (localStorage).</span>
          </div>

          <div class="hr"></div>

          <div class="two">
            <div>
              <label>Rechnungsdatum</label>
              <input id="invDate" type="date"/>
            </div>
            <div>
              <label>Fällig am</label>
              <input id="dueDate" type="date"/>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Rechnungsnummer</label>
              <input id="invNo"/>
              <div class="small">Auto: MS-YYYYMMDD-0001 (pro Tag)</div>
            </div>
            <div>
              <label>Referenz / PO (optional)</label>
              <input id="refpo" placeholder="Auftrag-Nr. / Ansprechpartner"/>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Einsatzort / Objekt</label>
              <input id="place" value="Bremen"/>
            </div>
            <div>
              <label>Leistungszeitraum</label>
              <input id="period" placeholder="z. B. 01.02.2026 – 15.02.2026"/>
            </div>
          </div>

          <label style="margin-top:10px">Leistungsbeschreibung</label>
          <textarea id="desc">Security Dienstleistung</textarea>

          <div class="small" style="margin-top:10px">
            Auto-Save aktiv: jede Änderung wird gespeichert. PDF & Print nutzen das Dokument unten (A4).
          </div>
        </div>
      </div>

      <!-- POSITIONS -->
      <div class="card">
        <h3>
          <span>Positionen</span>
          <span class="pill" id="pillTotal">0,00 €</span>
        </h3>
        <div class="content">
          <div class="rowline" style="justify-content:space-between">
            <div class="small">Tipp: Menge/Einzelpreis eingeben → Summe berechnet automatisch.</div>
            <button class="iconBtn" id="addRow">+ Position</button>
          </div>

          <div class="hr"></div>

          <div class="tbl" style="border:1px solid var(--line);border-radius:14px;overflow:hidden">
            <table>
              <thead>
                <tr>
                  <th style="width:44%">Beschreibung</th>
                  <th style="width:10%">Menge</th>
                  <th style="width:14%">Einheit</th>
                  <th style="width:14%">Einzelpreis</th>
                  <th style="width:10%">Steuer</th>
                  <th class="right" style="width:8%">Summe</th>
                  <th style="width:0%"></th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>

          <div class="hr"></div>

          <div class="sumGrid">
            <div class="sumBox">
              <div class="small"><b>Hinweis / Zahlungsbedingungen</b></div>
              <textarea id="payNote" style="min-height:86px">Bitte überweisen Sie den Rechnungsbetrag innerhalb der Zahlungsfrist auf das unten angegebene Konto.</textarea>
            </div>
            <div class="sumBox">
              <div class="sumRow"><span>Zwischensumme (Netto)</span><b id="net">0,00 €</b></div>
              <div class="sumRow"><span>Umsatzsteuer</span><b id="vat">0,00 €</b></div>
              <div class="sumRow grand" style="border-top:1px solid var(--line);padding-top:8px;margin-top:8px">
                <span><b>Gesamt</b></span><b id="gross">0,00 €</b>
              </div>
              <div class="small" id="vatHint" style="margin-top:8px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- A4 DOCUMENT (Print + PDF) -->
    <div class="docHint">Dokument-Vorschau (A4). Print/PDF nimmt exakt dieses Layout.</div>
    <div class="docWrap">
      <div id="invoiceDoc">
        <div class="doc" id="docInner">
          <!-- filled by JS -->
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <input id="logoFile" type="file" accept="image/*" style="display:none"/>

<script>
;(()=>{

  const $ = (id)=>document.getElementById(id);

  // --- storage keys ---
  const KEY_DRAFT="MS_LEX_STYLE_INV_DRAFT_V1";
  const KEY_CUSTOMERS="MS_LEX_STYLE_INV_CUSTOMERS_V1";
  const KEY_LASTSAVED="MS_LEX_STYLE_INV_LAST_V1";
  const KEY_LOGO="MS_LEX_STYLE_INV_LOGO_V1";
  const KEY_SEQ="MS_LEX_STYLE_INV_SEQ_V1";

  // repo logo file (must exist in GitHub repo root)
  const DEFAULT_LOGO_PATH="logo.png";

  // --- helpers ---
  const fmtEUR = (n)=> (Number(n||0)).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}) + " €";
  const fmtN = (n)=> (Number(n||0)).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2});
  const num = (v)=>{ const n=parseFloat(String(v??"").replace(",", ".")); return isNaN(n)?0:n; };
  const ymd = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  const compact = (dateStr)=>String(dateStr||"").replaceAll("-","");
  const escapeHtml = (s)=>String(s||"").replace(/[&<>"']/g,(c)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));
  const toast=(msg)=>{
    const t=$("toast"); t.textContent=msg; t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"),2200);
  };
  const safeFile=(s)=>String(s||"Rechnung").replace(/[^\w\-\.]+/g,"_");

  function loadJSON(key, fallback){
    try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch{ return fallback; }
  }
  function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  function calcDue(dateStr, days){
    const d = new Date((dateStr||ymd(new Date()))+"T00:00:00");
    d.setDate(d.getDate()+parseInt(days||"14",10));
    return ymd(d);
  }

  function loadSeq(){ return loadJSON(KEY_SEQ, {}); }
  function saveSeq(seq){ saveJSON(KEY_SEQ, seq); }

  function makeInvNo(dateStr){
    const key=compact(dateStr || ymd(new Date()));
    const seq=loadSeq();
    if(!seq[key]) seq[key]=1;
    const n=String(seq[key]).padStart(4,"0");
    return `MS-${key}-${n}`;
  }
  function bumpSeq(dateStr, invNo){
    const key=compact(dateStr);
    const seq=loadSeq();
    const m=String(invNo||"").match(/^MS-(\d{8})-(\d{4})$/);
    if(m && m[1]===key){
      const used=parseInt(m[2],10);
      seq[key]=Math.max(seq[key]||1, used+1);
      saveSeq(seq);
    }
  }

  // --- logo: FEST (always dataURL) ---
  let logoDataUrl = localStorage.getItem(KEY_LOGO) || "";

  function blobToDataURL(blob){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(r.result);
      r.onerror=reject;
      r.readAsDataURL(blob);
    });
  }

  async function ensureLogo(){
    if(logoDataUrl && logoDataUrl.startsWith("data:image/")){
      applyLogo(logoDataUrl);
      return;
    }
    // fetch repo logo.png and store as dataURL => FIXED for App + PDF (no CORS blank)
    try{
      const res = await fetch(DEFAULT_LOGO_PATH + "?v=" + Date.now(), {cache:"no-store"});
      if(!res.ok) throw new Error("logo not found");
      const blob = await res.blob();
      logoDataUrl = await blobToDataURL(blob);
      localStorage.setItem(KEY_LOGO, logoDataUrl);
      applyLogo(logoDataUrl);
    }catch{
      // fallback: transparent 1x1 (still "fest", but no image)
      const tiny = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";
      logoDataUrl = tiny;
      localStorage.setItem(KEY_LOGO, logoDataUrl);
      applyLogo(logoDataUrl);
    }
  }

  function applyLogo(dataUrl){
    $("logoTop").src=dataUrl;
  }

  // --- customers ---
  let customers = loadJSON(KEY_CUSTOMERS, []);

  function renderCustomers(selectedId){
    const sel=$("custSelect");
    sel.innerHTML="";
    const o0=document.createElement("option");
    o0.value=""; o0.textContent="— Kunde wählen —";
    sel.appendChild(o0);
    customers.forEach(c=>{
      const o=document.createElement("option");
      o.value=c.id; o.textContent=c.name || "(ohne Name)";
      sel.appendChild(o);
    });
    sel.value = selectedId || "";
  }

  function currentCustomer(){
    const id=$("custSelect").value || "";
    return customers.find(x=>x.id===id) || null;
  }

  // --- rows (positions) ---
  function defaultRow(){
    return { desc:"", qty:1, unit:"Std", price:0, tax:"AUTO" };
  }

  function getGlobalTaxRate(){
    return $("vatMode").value==="Regel" ? 0.19 : 0;
  }

  function rowTaxRate(row){
    // AUTO follows global. Otherwise 0 or 19.
    if(row.tax==="0") return 0;
    if(row.tax==="19") return 0.19;
    return getGlobalTaxRate();
  }

  function buildRowEl(row, idx){
    const tr=document.createElement("tr");

    tr.innerHTML = `
      <td>
        <textarea data-k="desc" data-i="${idx}" placeholder="z. B. Sicherheitsdienst / Bewachung">${escapeHtml(row.desc||"")}</textarea>
      </td>
      <td>
        <input data-k="qty" data-i="${idx}" type="number" min="0" step="0.01" value="${Number(row.qty||0)}"/>
      </td>
      <td>
        <select data-k="unit" data-i="${idx}">
          <option ${row.unit==="Std"?"selected":""}>Std</option>
          <option ${row.unit==="Pauschal"?"selected":""}>Pauschal</option>
          <option ${row.unit==="Tag"?"selected":""}>Tag</option>
        </select>
      </td>
      <td>
        <input data-k="price" data-i="${idx}" type="number" min="0" step="0.01" value="${Number(row.price||0)}"/>
      </td>
      <td>
        <select data-k="tax" data-i="${idx}">
          <option value="AUTO" ${row.tax==="AUTO"?"selected":""}>Auto</option>
          <option value="0" ${row.tax==="0"?"selected":""}>0%</option>
          <option value="19" ${row.tax==="19"?"selected":""}>19%</option>
        </select>
      </td>
      <td class="right"><b id="rowSum_${idx}">0,00 €</b></td>
      <td class="right">
        <button class="iconBtn danger" data-del="${idx}" title="Löschen">✕</button>
      </td>
    `;
    return tr;
  }

  function renderRows(rows){
    const tb=$("rows");
    tb.innerHTML="";
    rows.forEach((r,i)=>tb.appendChild(buildRowEl(r,i)));
  }

  // --- draft state ---
  let draft = loadJSON(KEY_DRAFT, {
    status:"Entwurf",
    vatMode:"Regel",
    payTerm:"14",
    firmName:"Masculine Security",
    firmAddr:"Werschenregerstraße 6 • 28237 Bremen",
    firmTel:"015778697052",
    firmMail:"Kontakt.mass.bremen@hotmail.com",
    firmTax:"in Bearbeitung",
    firmIban:"DE98 1001 1001 2333 0146 96",
    firmBic:"NTSBDEB1XXX",
    custId:"",
    custName:"",
    custMail:"",
    custData:"",
    invDate:"",
    dueDate:"",
    invNo:"",
    refpo:"",
    place:"Bremen",
    period:"",
    desc:"Security Dienstleistung",
    payNote:"Bitte überweisen Sie den Rechnungsbetrag innerhalb der Zahlungsfrist auf das unten angegebene Konto.",
    rows:[ defaultRow() ],
    touched:{ invNo:false, dueDate:false }
  });

  function setFieldValues(){
    $("status").value = draft.status || "Entwurf";
    $("vatMode").value = draft.vatMode || "Regel";
    $("payTerm").value = draft.payTerm || "14";

    $("firmName").value = draft.firmName || "";
    $("firmAddr").value = draft.firmAddr || "";
    $("firmTel").value  = draft.firmTel || "";
    $("firmMail").value = draft.firmMail || "";
    $("firmTax").value  = draft.firmTax || "";
    $("firmIban").value = draft.firmIban || "";
    $("firmBic").value  = draft.firmBic || "";

    renderCustomers(draft.custId || "");
    if(draft.custId){
      const c=customers.find(x=>x.id===draft.custId);
      if(c){
        $("custName").value=c.name||"";
        $("custMail").value=c.mail||"";
        $("custData").value=c.data||"";
      }
    }else{
      $("custName").value = draft.custName || "";
      $("custMail").value = draft.custMail || "";
      $("custData").value = draft.custData || "";
    }

    // dates
    const today=ymd(new Date());
    $("invDate").value = draft.invDate || today;

    // auto invNo if empty or not touched
    if(!draft.invNo || !draft.touched?.invNo){
      $("invNo").value = makeInvNo($("invDate").value);
      draft.invNo = $("invNo").value;
      draft.touched = draft.touched || {};
      draft.touched.invNo = false;
    }else{
      $("invNo").value = draft.invNo;
    }

    if(!draft.dueDate || !draft.touched?.dueDate){
      $("dueDate").value = calcDue($("invDate").value, $("payTerm").value);
      draft.dueDate = $("dueDate").value;
      draft.touched = draft.touched || {};
      draft.touched.dueDate = false;
    }else{
      $("dueDate").value = draft.dueDate;
    }

    $("refpo").value = draft.refpo || "";
    $("place").value = draft.place || "";
    $("period").value = draft.period || "";
    $("desc").value = draft.desc || "";
    $("payNote").value = draft.payNote || "";

    renderRows(draft.rows || [defaultRow()]);
    syncPills();
    recalcAndRenderDoc();
    saveDraft();
  }

  function collectDraft(){
    // rows from DOM
    const rows = (draft.rows || []).map((r,i)=>{
      const d = document.querySelector(`[data-k="desc"][data-i="${i}"]`);
      const q = document.querySelector(`[data-k="qty"][data-i="${i}"]`);
      const u = document.querySelector(`[data-k="unit"][data-i="${i}"]`);
      const p = document.querySelector(`[data-k="price"][data-i="${i}"]`);
      const t = document.querySelector(`[data-k="tax"][data-i="${i}"]`);
      return {
        desc: d ? d.value : (r.desc||""),
        qty:  q ? num(q.value) : num(r.qty),
        unit: u ? u.value : (r.unit||"Std"),
        price:p ? num(p.value) : num(r.price),
        tax:  t ? t.value : (r.tax||"AUTO")
      };
    });

    const custSel = $("custSelect").value || "";
    return {
      status:$("status").value,
      vatMode:$("vatMode").value,
      payTerm:$("payTerm").value,

      firmName:$("firmName").value.trim(),
      firmAddr:$("firmAddr").value.trim(),
      firmTel:$("firmTel").value.trim(),
      firmMail:$("firmMail").value.trim(),
      firmTax:$("firmTax").value.trim(),
      firmIban:$("firmIban").value.trim(),
      firmBic:$("firmBic").value.trim(),

      custId:custSel,
      custName:$("custName").value.trim(),
      custMail:$("custMail").value.trim(),
      custData:$("custData").value,

      invDate:$("invDate").value,
      dueDate:$("dueDate").value,
      invNo:$("invNo").value.trim(),
      refpo:$("refpo").value.trim(),

      place:$("place").value.trim(),
      period:$("period").value.trim(),
      desc:$("desc").value,
      payNote:$("payNote").value,

      rows,
      touched: draft.touched || {invNo:false, dueDate:false}
    };
  }

  function saveDraft(){
    draft = collectDraft();
    saveJSON(KEY_DRAFT, draft);
  }

  function syncPills(){
    $("pillStatus").textContent = draft.status || "Entwurf";
  }

  function fmtDateDE(dateStr){
    if(!dateStr) return "-";
    const [y,m,d]=dateStr.split("-");
    return `${d}.${m}.${y}`;
  }

  function totalsFromRows(rows){
    let net=0, vat=0;
    rows.forEach(r=>{
      const qty=Math.max(0, num(r.qty));
      const price=Math.max(0, num(r.price));
      const lineNet = qty*price;
      const rate = rowTaxRate(r);
      const lineVat = lineNet * rate;
      net += lineNet;
      vat += lineVat;
    });
    return {net, vat, gross: net+vat};
  }

  function recalcAndRenderDoc(){
    draft = collectDraft();

    // VAT hint
    $("vatHint").textContent = (draft.vatMode==="Regel")
      ? "Umsatzsteuer: 19% (Regelbesteuerung)."
      : "Kleinunternehmer: keine Umsatzsteuer gemäß §19 UStG.";

    // due date auto if not touched
    if(!draft.touched?.dueDate){
      $("dueDate").value = calcDue($("invDate").value, $("payTerm").value);
      draft.dueDate = $("dueDate").value;
    }

    // invNo auto if not touched
    if(!draft.touched?.invNo){
      $("invNo").value = makeInvNo($("invDate").value);
      draft.invNo = $("invNo").value;
    }

    // calculate row sums
    const rows = draft.rows || [];
    rows.forEach((r,i)=>{
      const qty=Math.max(0,num(r.qty));
      const price=Math.max(0,num(r.price));
      const lineNet = qty*price;
      const lineVat = lineNet * rowTaxRate(r);
      const sum = lineNet + lineVat;
      const el=$("rowSum_"+i);
      if(el) el.textContent = fmtEUR(sum);
    });

    const {net, vat, gross} = totalsFromRows(rows);

    $("net").textContent = fmtEUR(net);
    $("vat").textContent = fmtEUR(vat);
    $("gross").textContent = fmtEUR(gross);
    $("pillTotal").textContent = fmtEUR(gross);

    // document HTML (A4)
    const custName = draft.custId ? (currentCustomer()?.name || draft.custName || "-") : (draft.custName || "-");
    const custMail = draft.custId ? (currentCustomer()?.mail || draft.custMail || "-") : (draft.custMail || "-");
    const custData = draft.custId ? (currentCustomer()?.data || draft.custData || "-") : (draft.custData || "-");

    const vatLabel = draft.vatMode==="Regel" ? "19% (Regelbesteuerung)" : "0% (Kleinunternehmer §19)";
    const vatLine = draft.vatMode==="Regel"
      ? "Umsatzsteuer wird mit 19% berechnet."
      : "Gemäß §19 UStG wird keine Umsatzsteuer berechnet.";

    const refLine = draft.refpo ? `<p class="t"><b>Referenz / PO:</b> ${escapeHtml(draft.refpo)}</p>` : `<p class="t"><b>Referenz / PO:</b> -</p>`;

    const posRows = rows.map(r=>{
      const qty=Math.max(0,num(r.qty));
      const price=Math.max(0,num(r.price));
      const lineNet = qty*price;
      const taxRate = rowTaxRate(r);
      const taxPct = Math.round(taxRate*100);
      const lineVat = lineNet*taxRate;
      const lineGross = lineNet+lineVat;
      return `
        <tr>
          <td><b>${escapeHtml(r.desc || "-")}</b></td>
          <td style="text-align:right">${fmtN(qty)}</td>
          <td>${escapeHtml(r.unit || "")}</td>
          <td style="text-align:right">${fmtEUR(price)}</td>
          <td style="text-align:right">${taxPct}%</td>
          <td style="text-align:right">${fmtEUR(lineGross)}</td>
        </tr>
      `;
    }).join("");

    $("docInner").innerHTML = `
      <div class="docHeader">
        <div class="docBrand">
          <img id="logoDoc" alt="Logo" src="${logoDataUrl}"/>
          <div>
            <p class="docTitle">${escapeHtml(draft.firmName)} — Rechnung</p>
          </div>
        </div>
        <div class="docMeta">
          <div><b>Status:</b> ${escapeHtml(draft.status||"Entwurf")}</div>
          <div><b>Rechnungsnummer:</b> ${escapeHtml(draft.invNo || "-")}</div>
          <div><b>Rechnungsdatum:</b> ${fmtDateDE(draft.invDate)}</div>
          <div><b>Fällig am:</b> ${fmtDateDE(draft.dueDate)}</div>
          <div><b>Zahlungsziel:</b> ${escapeHtml(draft.payTerm)} Tage</div>
        </div>
      </div>

      <div class="docGrid">
        <div class="box">
          <p class="h">RECHNUNGSSTELLER</p>
          <p class="t"><b>${escapeHtml(draft.firmName)}</b></p>
          <p class="t">${escapeHtml(draft.firmAddr)}</p>
          <p class="t">Tel: ${escapeHtml(draft.firmTel)}</p>
          <p class="t">E-Mail: ${escapeHtml(draft.firmMail)}</p>
          <p class="t">Steuernummer: ${escapeHtml(draft.firmTax)}</p>
        </div>
        <div class="box">
          <p class="h">KUNDE / RECHNUNGSEMPFÄNGER</p>
          <p class="t"><b>${escapeHtml(custName)}</b></p>
          <p class="t">${escapeHtml(custMail)}</p>
          <p class="t" style="white-space:pre-line">${escapeHtml(custData)}</p>
        </div>
      </div>

      <div class="docGrid">
        <div class="box">
          <p class="h">LEISTUNG</p>
          <p class="t"><b>Einsatzort / Objekt:</b> ${escapeHtml(draft.place || "-")}</p>
          <p class="t"><b>Leistungszeitraum:</b> ${escapeHtml(draft.period || "-")}</p>
          <p class="t"><b>Beschreibung:</b> <span style="white-space:pre-line">${escapeHtml(draft.desc || "-")}</span></p>
          ${refLine}
        </div>
        <div class="box">
          <p class="h">STEUER / BANK</p>
          <p class="t"><b>USt-Status:</b> ${vatLabel}</p>
          <p class="t">${vatLine}</p>
          <p class="t" style="margin-top:2mm"><b>Bank:</b> ${escapeHtml(draft.firmIban)} • BIC ${escapeHtml(draft.firmBic)}</p>
        </div>
      </div>

      <div class="docTable">
        <table>
          <thead>
            <tr>
              <th style="width:44%">Position</th>
              <th style="width:12%;text-align:right">Menge</th>
              <th style="width:10%">Einheit</th>
              <th style="width:14%;text-align:right">Einzelpreis</th>
              <th style="width:8%;text-align:right">USt</th>
              <th style="width:12%;text-align:right">Betrag</th>
            </tr>
          </thead>
          <tbody>
            ${posRows || `<tr><td colspan="6" class="muted">Keine Positionen</td></tr>`}
          </tbody>
        </table>
      </div>

      <div class="docTotals">
        <div class="box">
          <p class="h">ZAHLUNGSBEDINGUNGEN</p>
          <p class="t" style="white-space:pre-line">${escapeHtml(draft.payNote || "")}</p>
        </div>
        <div class="box totRight">
          <p class="h">SUMME</p>
          <div class="sumRow"><span>Zwischensumme (Netto)</span><b>${fmtEUR(net)}</b></div>
          <div class="sumRow"><span>Umsatzsteuer</span><b>${fmtEUR(vat)}</b></div>
          <div class="sumRow grand" style="border-top:1px solid #e3e7ee;padding-top:6px;margin-top:6px">
            <span><b>Gesamt</b></span><b>${fmtEUR(gross)}</b>
          </div>
        </div>
      </div>

      <div class="docFoot">
        <div>${escapeHtml(draft.firmName)} • ${escapeHtml(draft.firmAddr)}</div>
        <div>Erstellt: ${fmtDateDE(ymd(new Date()))}</div>
      </div>
    `;

    syncPills();
    saveDraft();
  }

  // --- actions ---
  function addRow(){
    draft.rows = draft.rows || [];
    draft.rows.push(defaultRow());
    renderRows(draft.rows);
    recalcAndRenderDoc();
  }

  function deleteRow(i){
    draft.rows = (draft.rows || []).filter((_,idx)=>idx!==i);
    if(!draft.rows.length) draft.rows=[defaultRow()];
    renderRows(draft.rows);
    recalcAndRenderDoc();
  }

  async function savePDF(){
    // ensure seq advanced
    bumpSeq($("invDate").value, $("invNo").value);

    // ensure logo data url is present (FEST)
    await ensureLogo();
    recalcAndRenderDoc();

    const target = $("invoiceDoc");

    // wait for logo image to fully load
    await new Promise(res=>{
      const img = target.querySelector("#logoDoc");
      if(!img) return res();
      if(img.complete && img.naturalWidth>0) return res();
      img.onload=()=>res();
      img.onerror=()=>res();
    });

    // small delay for layout
    await new Promise(r=>setTimeout(r,120));

    const canvas = await html2canvas(target,{
      scale: 2,
      useCORS: true,
      allowTaint: true,
      backgroundColor:"#ffffff",
      logging:false
    });

    const imgData = canvas.toDataURL("image/jpeg", 0.98);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({orientation:"p",unit:"mm",format:"a4"});

    const pageW=210, pageH=297;
    const imgW=pageW;
    const imgH = canvas.height * (imgW / canvas.width);

    if(imgH <= pageH){
      pdf.addImage(imgData,"JPEG",0,0,imgW,imgH);
    }else{
      // multi page (rare)
      let y=0, remaining=imgH;
      while(remaining>0){
        pdf.addImage(imgData,"JPEG",0,y,imgW,imgH);
        remaining -= pageH;
        y -= pageH;
        if(remaining>1) pdf.addPage();
      }
    }

    const name = safeFile($("invNo").value || "Rechnung") + ".pdf";
    pdf.save(name);
    toast("PDF gespeichert ✅");
  }

  function printDoc(){
    bumpSeq($("invDate").value, $("invNo").value);
    window.print();
  }

  function saveLast(){
    const d = collectDraft();
    saveJSON(KEY_LASTSAVED, {when:Date.now(), draft:d});
    bumpSeq(d.invDate, d.invNo);
    toast("Gespeichert ✅");
  }

  function loadLast(){
    const last = loadJSON(KEY_LASTSAVED, null);
    if(!last || !last.draft){ toast("Keine gespeicherte Rechnung"); return; }
    draft = last.draft;
    // keep touched flags safe
    draft.touched = draft.touched || {invNo:true, dueDate:true};
    setFieldValues();
    toast("Geladen ✅");
  }

  function newInvoice(){
    const today=ymd(new Date());
    draft = {
      ...draft,
      status:"Entwurf",
      invDate:today,
      payTerm:$("payTerm").value || "14",
      dueDate:"",
      invNo:"",
      refpo:"",
      place:draft.place || "Bremen",
      period:"",
      desc:draft.desc || "Security Dienstleistung",
      rows:[ defaultRow() ],
      custId:"",
      custName:"",
      custMail:"",
      custData:"",
      touched:{invNo:false, dueDate:false}
    };
    saveDraft();
    setFieldValues();
    toast("Neu ✅");
  }

  // --- wiring ---
  function wire(){
    // inputs autosave + recalc
    const all = document.querySelectorAll("input,select,textarea");
    all.forEach(el=>{
      el.addEventListener("input", ()=>{
        if(el.id==="invNo"){ draft.touched = draft.touched||{}; draft.touched.invNo = true; }
        if(el.id==="dueDate"){ draft.touched = draft.touched||{}; draft.touched.dueDate = true; }
        if(el.id==="invDate"){
          // if invoice date changed and invNo not touched -> regenerate
          if(!draft.touched?.invNo){
            $("invNo").value = makeInvNo($("invDate").value);
          }
          // due date auto if not touched
          if(!draft.touched?.dueDate){
            $("dueDate").value = calcDue($("invDate").value, $("payTerm").value);
          }
        }
        if(el.id==="payTerm"){
          if(!draft.touched?.dueDate){
            $("dueDate").value = calcDue($("invDate").value, $("payTerm").value);
          }
        }
        recalcAndRenderDoc();
      });
    });

    // rows change (delegation)
    $("rows").addEventListener("input", (e)=>{
      const k=e.target?.dataset?.k;
      const i=parseInt(e.target?.dataset?.i,10);
      if(!k || isNaN(i)) return;
      // update draft row base structure length safe
      draft.rows = draft.rows || [];
      if(!draft.rows[i]) draft.rows[i]=defaultRow();
      // just recalc from DOM
      recalcAndRenderDoc();
    });

    $("rows").addEventListener("click",(e)=>{
      const btn=e.target?.closest?.("[data-del]");
      if(!btn) return;
      const i=parseInt(btn.getAttribute("data-del"),10);
      if(!isNaN(i)) deleteRow(i);
    });

    // customer selection
    $("custSelect").addEventListener("change", ()=>{
      const c=currentCustomer();
      if(c){
        $("custName").value=c.name||"";
        $("custMail").value=c.mail||"";
        $("custData").value=c.data||"";
      }else{
        $("custName").value=draft.custName||"";
        $("custMail").value=draft.custMail||"";
        $("custData").value=draft.custData||"";
      }
      recalcAndRenderDoc();
    });

    $("custNew").addEventListener("click", ()=>{
      $("custSelect").value="";
      $("custName").value="";
      $("custMail").value="";
      $("custData").value="";
      recalcAndRenderDoc();
      toast("Neuer Kunde");
    });

    $("custSave").addEventListener("click", ()=>{
      const name=$("custName").value.trim();
      if(!name){ toast("Bitte Kundenname eingeben"); return; }
      const id = ($("custSelect").value) || ("c_"+Date.now());
      const obj={id,name,mail:$("custMail").value.trim(),data:$("custData").value};
      const idx=customers.findIndex(x=>x.id===id);
      if(idx>=0) customers[idx]=obj; else customers.push(obj);
      saveJSON(KEY_CUSTOMERS, customers);
      renderCustomers(id);
      recalcAndRenderDoc();
      toast("Kunde gespeichert ✅");
    });

    $("custDel").addEventListener("click", ()=>{
      const id=$("custSelect").value;
      if(!id){ toast("Kein Kunde gewählt"); return; }
      customers = customers.filter(x=>x.id!==id);
      saveJSON(KEY_CUSTOMERS, customers);
      renderCustomers("");
      $("custName").value=""; $("custMail").value=""; $("custData").value="";
      recalcAndRenderDoc();
      toast("Kunde gelöscht");
    });

    // buttons
    $("addRow").addEventListener("click", addRow);
    $("btnSave").addEventListener("click", saveLast);
    $("btnLoad").addEventListener("click", loadLast);
    $("btnNew").addEventListener("click", newInvoice);
    $("btnPrint").addEventListener("click", printDoc);
    $("btnPdf").addEventListener("click", async ()=>{
      try{ await savePDF(); }catch(e){ console.error(e); toast("PDF Fehler ❌"); }
    });

    $("btnReset").addEventListener("click", ()=>{
      if(!confirm("Alles zurücksetzen? (Draft + Logo + Kunden + Save)")) return;
      localStorage.removeItem(KEY_DRAFT);
      localStorage.removeItem(KEY_LOGO);
      localStorage.removeItem(KEY_CUSTOMERS);
      localStorage.removeItem(KEY_LASTSAVED);
      localStorage.removeItem(KEY_SEQ);
      location.reload();
    });

    // logo upload
    $("btnLogo").addEventListener("click", ()=> $("logoFile").click());
    $("logoFile").addEventListener("change", async (e)=>{
      const f=e.target.files && e.target.files[0];
      if(!f) return;
      const dataUrl = await blobToDataURL(f);
      logoDataUrl = dataUrl;
      localStorage.setItem(KEY_LOGO, logoDataUrl);
      applyLogo(logoDataUrl);
      recalcAndRenderDoc();
      toast("Logo fest gespeichert ✅");
    });

    // status pill
    $("status").addEventListener("change", ()=>{
      $("pillStatus").textContent = $("status").value;
      recalcAndRenderDoc();
    });
  }

  // --- init ---
  async function init(){
    // logo must be FEST (dataURL) at start
    await ensureLogo();

    // initial customers select
    renderCustomers(draft.custId || "");

    // set fields
    setFieldValues();

    // wire
    wire();

    toast("Bereit ✅");
  }

  init();

})();
</script>
</body>
</html>
